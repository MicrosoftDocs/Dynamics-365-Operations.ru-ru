---
title: "Обновление данных в песочнице"
description: "В этой теме рассматривается, как выполнить обновление данных AX 2012 Dynamics 365 для использования в Dynamics 365 for Finance and Operations в среде-песочнице."
author: tariqbell
manager: AnnBe
ms.date: 06/16/2017
ms.topic: article
ms.prod: 
ms.service: dynamics-ax-platform
ms.technology: 
audience: Developer, IT Pro
ms.reviewer: margoc
ms.search.scope: Operations, UnifiedOperations, Platform
ms.search.region: Global
ms.author: tabell
ms.search.validFrom: 2017-06-16
ms.dyn365.ops.version: Platform update 8
ms.translationtype: Human Translation
ms.sourcegitcommit: 6816e3820ab77c71bbf9bde4a068375448331671
ms.openlocfilehash: 7140bf740f37a5eb970a5103750a7095d12a33cc
ms.contentlocale: ru-ru
ms.lasthandoff: 06/15/2017

---

# <a name="data-upgrade-in-a-sandbox-environment"></a>Обновление данных в песочнице

[!include[banner](../includes/banner.md)]

[!include[upgrade banner](../includes/upgrade-banner.md)]

Результатом выполнения этой задачи является обновленная базы данных, которую можно использовать в песочнице. Песочница — это среда, в которой бизнес-пользователи и члены функциональной группы могут заниматься проверкой функциональности приложения. Эта функциональность включает в себя пользовательские настройки и данные, перенесенные из Microsoft Dynamics AX 2012.

Настоятельно рекомендуется выполнить процесс обновления данных в среде разработки, прежде чем выполнять его в общей песочнице, поскольку такой подход позволяет сократить общее время, необходимое для успешного обновления данных. Дополнительные сведения см. в разделе [Обновление данных в среде разработки](prepare-data-upgrade.md).

## <a name="overview-of-the-sandbox-data-upgrade-process"></a>Обзор процесса обновления данных в песочнице

Перед обновлением данных в песочнице вы должны уже обновить данные в среде разработки, как описано в разделе [Обновления данных в среде разработки](prepare-data-upgrade.md). Эти два процесса очень похожи. Основное различие заключается в том, что в песочнице для хранения данных используется база данных SQL Microsoft Azure, тогда как в среде разработки — Microsoft SQL Server. Это техническое различие на уровне базы данных требует внесения небольших изменений в процедуру обновления данных в песочнице, потому что резервную копию из экземпляра базы данных AX 2012 нельзя просто восстановить в виде базы данных SQL.

![Процесс обновления данных в песочнице](./media/data-upgrade-sandbox.png)

Процесс обновления включает в себя следующие основные шаги.

1. Создайте копию базы данных AX 2012. Настоятельно рекомендуется использовать копию, так как вам понадобится удалить из экспортируемой копии некоторые объекты.
2. Экспортируйте скопированную базу данных в BACPAC-файл с помощью бесплатного средства для SQL Server, которое называется SQLPackage.exe. Это средство позволяет получить специальный тип резервной копии базы данных, который может быть импортирован в базу данных SQL.
3. Отправьте BACPAC-файл в хранилище Azure.
4. Загрузите BACPAC-файл на компьютер Application Object Server (AOS) в песочнице, а затем импортируйте его с помощью SQLPackage.exe. Затем необходимо запустить сценарий в импортированной базе данных, чтобы сбросить пользователей базы данных SQL.
5. Запустите пакет MajorVersionDataUpgrade.zip, чтобы выполнить обновление данных импортированной базы данных.

## <a name="create-a-copy-of-the-ax-2012-database"></a>Создание копии базы данных AX 2012

Необходимо создать копию базы данных AX 2012, которую вы обновляете, поскольку некоторые объекты из базы данных нужно будет удалить. К этим объектам относятся пользователи проверки подлинности Microsoft Windows, если они есть. После этих изменений измененную базу данных нельзя будет использовать в AX 2012. На этом шаге вам предстоит создать копию базы данных и удалить эти объекты.

Этот шаг должен выполняться администратором базы данных (DBA) или другим человеком, располагающим аналогичными знаниями и опытом.

Чтобы создать копию базы данных, создайте резервную копию исходной базы данных и восстановите ее под новым именем. Убедитесь в наличии достаточного места для обеих баз данных. Можно создать копию на другом сервере. Версия экземпляра SQL Server, на котором запущена база данных, не имеет значения.

Ниже приведен пример кода, который создает копию базы данных. Вам необходимо внести в этот пример изменения, отражающие используемые у вас имена баз данных.

    BACKUP DATABASE [AxDB] TO  DISK = N'D:\Backups\axdb_copyForUpgrade.bak' WITH NOFORMAT, NOINIT,  
    NAME = N'AxDB_copyForUpgrade-Full Database Backup', SKIP, NOREWIND, NOUNLOAD, COMPRESSION,  STATS = 10
    GO

    RESTORE DATABASE [AxDB_copyForUpgrade] FROM  DISK = N'D:\Backups\axdb_copyForUpgrade.bak'   WITH  FILE = 1,  
    MOVE N'AXDBBuild_Data' TO N'F:\MSSQL_DATA\AxDB_copyForUpgrade.mdf',  
    MOVE N'AXDBBuild_Log' TO N'G:\MSSQL_LOGS\AxDB_CopyForUpgrade.ldf',  
    NOUNLOAD,  STATS = 5

После создания копии запустите следующий сценарий Transact-SQL (T-SQL) для этой копии.
Список действий 

### <a name="export-the-copied-database-to-a-bacpac-file"></a>Экспорт скопированной базы данных в BACPAC-файл

Экспортируйте скопированную базу данных в BACPAC-файл с помощью SQLPackage.exe. Этот шаг должен выполняться администратором базы данных или другим сотрудником, располагающим эквивалентными знаниями.

Очень важно установить последнюю версию SQL Server Management Studio, прежде чем приступать к этому шагу. Несмотря на то, что средство SQLPackage присутствует в предыдущих версиях Management Studio, оно не будет работать корректно на этом шаге, если сначала не установить последнюю версию.

Этот шаг важен, поскольку экспорт понадобится выполнить снова во время отключения перед вводом в эксплуатацию. Некоторые советы:

- Процесс создания BACPAC-файла создает очень большую нагрузку на подсистему ввода-вывода и ЦП. По этой причине выполнять экспорт следует на мощном компьютере.
- SQLPackage необходимо запускать локально на машине, на котором размещена база данных. Не запускайте SQLPackage на локальном ноутбуке, подключенном к компьютеру с базой данных, поскольку этот процесс также создает большую нагрузку на сеть.

Далее, откройте окно **Командная строка** от имени администратора и выполните следующую команду:

    cd C:\Program Files (x86)\Microsoft SQL Server\130\DAC\bin\

    SqlPackage.exe /a:export /ssn:localhost /sdn:<database to export> /tf:D:\Exportedbacpac\my.bacpac /p:CommandTimeout=1200 /p:VerifyFullTextDocumentTypesSupported=false

Ниже приводится объяснение параметров:

- **ssn** (source server name) — имя экземпляра SQL Server, с которого необходимо экспортировать данные. Для нашего процесса этот параметр всегда должен иметь значение **localhost**.
- **sdn** (source database name) — имя экспортируемой базы данных.
- **tf** (target file) — путь и имя файла, в который экспортируются данные. Эта папка должна уже существовать, но файл будет создан процессом.
- **/p:CommandTimeout** — значение времени ожидания для запроса. Этот параметр позволяет экспортировать большие таблицы без превышения времени ожидания.

### <a name="upload-the-bacpac-file-to-azure-storage"></a>Отправка BACPAC-файла в хранилище Azure

Отправьте полученный BACPAC-файл в хранилище Azure. См. список действий в UsingStorageExplorer.docx

### <a name="import-the-bacpac-file-into-sql-database"></a>Импортировать BACPAC-файла в базу данных SQL

На этом шаге вам предстоит импортировать экспортированный BACPAC-файл в экземпляр базы данных SQL, используемый в вашей песочнице. Во-первых, необходимо установить последнюю версию Management Studio на компьютере AOS песочницы. Затем необходимо импортировать файл с помощью средства SQLPackage.exe.

Эти задачи необходимо выполнять непосредственно на компьютере AOS в песочнице, поскольку существуют правила брандмауэра, которые ограничивают доступ к экземпляру базы данных SQL. Использование компьютера AOS, однако, позволяет получить к ней доступ.

Как и на шаге экспорта, перед началом импорта необходимо установить последнюю версию Management Studio. Со старой версией этот шаг работать не будет.

Из соображений производительности рекомендуется поместить BACPAC-файл на диск D на компьютере AOS. На виртуальных машинах Azure диск D — это физический диск, который, как правило, имеет более высокую производительность, чем другие доступные диски.

Откройте окно **Командная строка** от имени администратора и выполните следующую команду:

    cd C:\Program Files (x86)\Microsoft SQL Server\130\DAC\bin\

    SqlPackage.exe /a:import /sf:D:\Exportedbacpac\my.bacpac /tsn:<azure sql database server name>.database.windows.net /tu:sqladmin /tp:<password from LCS> /tdn:<New database name> /p:CommandTimeout=1200 /p:DatabaseEdition=Premium /p:DatabaseServiceObjective=P1

Ниже приводится объяснение параметров:

- **tsn** (target server name) — имя сервера SQL Azure, на который необходимо импортировать данные. Это имя можно найти в LCS. Добавьте к нему суффикс **.database.windows.net**.
- **tdn** (target database name) — имя базы данных, в которую импортируются данные. На момент выполнения команды эта база данных существовать не должна. Она будет создана процессом импорта.
- **sf** (source file) — путь и имя файла, откуда необходимо импортировать данные.
- **tp** (target password) — пароль SQL для целевого экземпляра базы данных SQL.
- **tu** (target user) — имя пользователя SQL для целевого экземпляра базы данных SQL. Рекомендуется использовать **sqladmin**. Пароль для этого пользователя можно получить из проекта LCS.
- **/p:CommandTimeout** — значение времени ожидания для запроса. Этот параметр позволяет экспортировать большие таблицы без превышения времени ожидания.
- **/p:DatabaseServiceObjective** — уровень служб создаваемой базы данных. Узнать это значение для существующей базы данных можно с помощью Management Studio. Щелкните базу данных правой кнопкой мыши и выберите **Свойства**.

После выполнения команд будет выведено следующее предупреждение. Можно проигнорировать его.

![Ошибка песочницы](./media/sandbox-2.png)
 
### <a name="run-the-majorversiondataupgradezip-package"></a>Запуск пакета MajorVersionDataUpgrade.zip

Запустите пакет развертывания для обновления данных, как описано в разделе [Обновление данных в среде разработки, демонстрационной среде или песочнице](upgrade-data-to-latest-update.md).

### <a name="upgrade-a-copy-of-the-database-in-a-development-environment"></a>Обновление копии базы данных в среде разработки

Желательно обновить ту же базу данных в среде разработки. Имея копию базы данных для среды разработки, вам будет намного легче исследовать ошибки, обнаруженные в обновленной песочнице.

