---
title: "Синхронизация заказов на продажу непосредственно между Sales и Finance and Operations"
description: "В этой теме рассматриваются шаблоны и базовые задачи, которые используются для выполнения синхронизации заказов на продажу напрямую между Microsoft Dynamics 365 for Sales и Microsoft Dynamics 365 for Finance and Operations."
author: ChristianRytt
manager: AnnBe
ms.date: 03/13/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-ax-applications
ms.technology: 
ms.search.form: 
audience: Application User, IT Pro
ms.reviewer: josaw
ms.search.scope: Core, Operations
ms.custom: 
ms.assetid: 
ms.search.region: global
ms.search.industry: 
ms.author: crytt
ms.dyn365.ops.version: July 2017 update
ms.search.validFrom: 2017-07-8
ms.translationtype: HT
ms.sourcegitcommit: a0739304723d19b910388893d08e8c36a1f49d13
ms.openlocfilehash: e26244ffc380291a40edfbd2c2cb5911b0d8b3cb
ms.contentlocale: ru-ru
ms.lasthandoff: 03/26/2018

---

# <a name="synchronization-of-sales-orders-directly-between-sales-and-finance-and-operations"></a>Синхронизация заказов на продажу непосредственно между Sales и Finance and Operations

[!include [banner](../includes/banner.md)]

В этой теме рассматриваются шаблоны и базовые задачи, которые используются для выполнения синхронизации заказов на продажу напрямую между Microsoft Dynamics 365 for Sales и Microsoft Dynamics 365 for Finance and Operations.

## <a name="templates-and-tasks"></a>Шаблоны и задачи

Чтобы получить доступ к доступным шаблонам, откройте [Центр администрирования PowerApps](https://preview.admin.powerapps.com/dataintegration). Выберите **Проекты**, затем в правом верхнем углу выберите **Создать проект**, чтобы выбрать общие шаблоны.

Следующие шаблоны и базовые задачи используются для выполнения синхронизации заказов на продажу напрямую между Sales и Finance and Operations:

- **Имена шаблонов в интеграции данных:** 

    - Заказы на продажу (из Sales в Fin and Ops) - напрямую
    - Заказы на продажу (из Fin and Ops в Sales) - напрямую

- **Имена задач в проекте интеграции данных:**

    - OrderHeader
    - OrderLine

Перед синхронизацией заголовков и строк накладных по продаже требуются следующие задачи синхронизации:

- Продукты (из Fin and Ops в Sales) — напрямую
- Счета (из Sales в Fin and Ops) — напрямую (если используются)
- Из контактов в клиенты (из Sales в Fin and Ops) - напрямую (если используются)

## <a name="entity-set"></a>Набор объектов

| Finance and Operations  | Прод.             |
|-------------------------|-------------------|
| Заголовки заказов на продажу CDS | SalesOrders       |
| Строки заказа на продажу CDS   | SalesOrderDetails |

## <a name="entity-flow"></a>Поток объектов

Заказы на продажу создаются в Sales и синхронизируются в Finance and Operations, когда запущена команда **Выполнить проект** для проекта, основанного на шаблоне **Заказы на продажу (из Sales в Fin and Ops) - напрямую**. Можно активировать и синхронизировать заказы из Sales только в том случае, если весь **Заказ продуктов** состоит только из продуктов, которые управляются извне. Таким образом, не может быть вписываемых продуктов. После активизации заказа заказ на продажу становится доступным только для чтения в интерфейсе пользователя (UI). На этом этапе обновления выполняются из Finance and Operations. После того как заказ на продажу получает статус **Подтверждено**, проект на основе шаблона **Заказы на продажу (из Fin and Ops в Sales) - напрямую** может использоваться для синхронизации любых обновлений или статуса выполнения из Finance and Operations в Sales.

Не нужно создавать заказы в Sales. Вместо этого можно создавать новые заказы на продажу в Finance and Operations. После того как заказ на продажу получил статус **Подтверждено**, он синхронизируется с Sales, как описано в предыдущем параграфе.

В Finance and Operations фильтры в шаблоне помогают гарантировать, что в синхронизацию включаются только необходимые заказы на продажу:

- В заказе на продажу как заказывающий клиент, так и клиент для выставления накладной должны быть взяты из Sales, чтобы они включались в синхронизацию. В Finance and Operations поля **OrderingCustomerIsExternallyMaintained** и **InvoiceCustomerIsExternallyMaintained** используются для фильтрации заказов на продажу из информационных объектов.
- Заказ на продажу в Finance and Operations должен быть подтвержден. С Sales синхронизируются только подтвержденные заказы на продажу или заказы на продажу с более высоким статусом обработки, например **Отгружено** или **Выставлена накладная**.
- После того, как заказ на продажу создан или изменен, необходимо выполнить в Finance and Operations пакетное задание **Рассчитать итоги продаж**. Только заказы на продажу, для которых рассчитаны итоговые значения продаж, будут синхронизироваться с Sales.

## <a name="freight-tax"></a>Налог на фрахт

Sales не поддерживает налог на уровне заголовка, так как налог хранится на уровне строк. Для поддержки налога на уровне заголовка из Finance and Operations, например налога на фрахт, система синхронизирует налог с Sales как вписанный продукт с именем **Налог на фрахт**, который имеет сумму налога из Finance and Operations. Таким образом, стандартный расчет цены в Sales может использоваться для итоговых значений, даже если налог на уровне заголовка взят из Finance and Operations.

## <a name="discount-calculation-and-rounding"></a>Расчет и округление скидок

Модель расчета скидки в Sales отличается от модели расчета скидки в Finance and Operations. В Finance and Operations конечная сумма скидка по строке продаж могут возникнуть в результате сочетания сумм скидок и процентов скидок. Если эта конечная сумма скидки делится на количество в строке, может произойти округление. Однако это округление не учитывается, если округленная сумма скидки на единицу синхронизируется с Sales. Чтобы обеспечить, чтобы полная сумма скидки из строки продаж в Finance and Operations правильно синхронизировалась с Sales, должна синхронизироваться полная сумма без деления на количество в строке. Таким образом, необходимо определить **Способ расчета скидки** как **Позиция строки** в Sales.

Когда строки заказа на продажу синхронизируется из Sales в Finance and Operations, используется полная сумма скидки по строке. Поскольку в Finance and Operations нет поля для хранения полной суммы скидки для строки, эта сумма делится на количество и хранится в поле **Скидка по строке**. Все округления, возникающие при этом делении, хранятся в поле **Накладные расходы на продажи** в строке продажи.

### <a name="example"></a>Пример

**Синхронизация из Sales в Finance and Operations**

- **Sales:** количество = 3, скидка по строке = $10,00
- **Finance and Operations:** количество = 3, сумма скидки по строке = $3,33, накладные расходы на продажи =-$0,01 

**Синхронизация из Finance and Operations в Sales**

- **Finance and Operations:** количество = 3, сумма скидки по строке = $3,33, накладные расходы на продажи =-$0,01
- **Sales:** количество = 3, скидка по строке = (3 × $3,33) + $0,01 = $10,00

## <a name="prospect-to-cash-solution-for-sales"></a>Решение "Перспективный клиент в наличные деньги" для Sales

В сущность **Заказ** добавлены новые поля, которые отображаются на странице:

- **Хранится во внешней системе** — задайте значение **Да**, когда заказ поступает из Finance and Operations.
- **Состояние обработки** — в этом поле отображается статус обработки заказа в Finance and Operations. Доступны следующие значения:

    - **Черновик** — исходный статус, когда заказ создается в Sales. В Sales только заказы с этим статусом обработки допускают редактирование.
    - **Активный** — статус после того, как заказ активируется в Sales с помощью кнопки **Активировать**.
    - **Подтверждено**
    - **Отборочная накладная**
    - **Выставлена накладная**
    - **Скомплектовано**
    - **Частично скомплектовано**
    - **Частично упаковано**
    - **Отгружено**
    - **Частично отправлено**
    - **Частично выставлен счет**
    - **Отменено**

Настройка **Имеет только управляемые извне продукты** используется при активации заказа для постоянного отслеживания того, состоит ли заказ на продажу полностью из управляемых извне продуктов. Если заказ на продажу состоит исключительно из управляемых извне продуктов, продукты управляются в Finance and Operations. Эта настройка помогает гарантировать, что вы не будете активировать и пытаться синхронизировать строки заказа на продажу, содержащие продукты, которые неизвестны для Finance and Operations.

Кнопки **Создать накладную**, **Отменить заказ**, **Пересчитать**, **Получить продукты** и **Искать адрес** на странице **Заказ на продажу** скрываются для заказов, хранящихся во внешней системе, потому что накладные будут создаваться в Finance and Operations и синхронизироваться в Sales. Эти заказы не могут редактироваться, потому что информация заказа на продажу будет синхронизироваться из Finance and Operations после активации.

Статус заказа на продажу будет оставаться **Активный**, чтобы помочь гарантировать, что изменения из Finance and Operations будут передаваться в заказ на продажу в Sales. Для управления таким поведением задайте для **Statecode \[Статус\]** значение по умолчанию **Active** в проекте интеграции данных.

## <a name="preconditions-and-mapping-setup"></a>Предварительные условия и настройка сопоставления

Перед синхронизацией заказов на продажу необходимо обновить следующие параметры в системах.

### <a name="setup-in-sales"></a>Настройка в Sales

- Убедитесь, что настроены разрешения для группы, которой назначен пользователь, из вашего набора подключений Sales. Если вы используете демонстрационные данные, обычно пользователь имеет доступ администратора, но группа не имеет доступа администратора. Если группа не имеет доступа администратора при запуске проекта из интеграции данных, вы получите сообщение об ошибке, в котором будет указано, что рабочая группа-участник отсутствует.

    Откройте **Параметры** &gt; **Безопасность** &gt; **Группы**, выберите необходимую группу, выберите **Управление ролями** и выберите роль с требуемыми разрешениями, например **Системный администратор**.

- Для обеспечения правильного расчета скидок как в Sales, так и в Finance and Operations для параметра **Способ расчета скидки** должно быть установлено значение **Номенклатура строки**.
- Откройте **Параметры** &gt; **Администрирование** &gt; **Параметры системы** &gt; **Продажи** и убедитесь, что используются следующие настройки:

    - Для параметра **Использовать системный расчет цен** установлено значение **Да**.
    - Для параметра **Способ расчета скидки** установлено значение **Номенклатура строки**.

### <a name="setup-in-finance-and-operations"></a>Настройка в Finance and Operations

- Откройте **Продажи и маркетинг** &gt; **Периодические задачи** &gt; **Рассчитать итоги продаж** и настройте задание для выполнения в качестве пакетного задания. Задайте для параметра **Рассчитанные итоги для заказов на продажу** значение **Да**. Этот шаг важен, так как только заказы на продажу, для которых рассчитаны итоговые значения продаж, будут синхронизироваться с Sales. Частота пакетного задания должна соответствовать частоте синхронизации заказов на продажу.

### <a name="setup-in-the-sales-orders-sales-to-fin-and-ops---direct-data-integration-project"></a>Настройка в проекте интеграции данных "Заказы на продажу (из Sales в Fin and Ops) - напрямую"

- Убедитесь в наличии необходимого сопоставления для **Shipto\_country** в **DeliveryAddressCountryRegionISOCode**. Можно сделать пустым значение по умолчанию в карте соответствия, чтобы избежать необходимости ввода страны для заказов внутри страны. Задайте в левой стороне значение "Пусто", а с правой стороны задайте нужную страну или регион.

    Значение шаблона является схемой значений, где сопоставляются нескольких стран или регионов, и где "Пусто" = США.

### <a name="setup-in-the-sales-orders-fin-and-ops-to-sales---direct-data-integration-project"></a>Настройка в проекте интеграции данных "Заказы на продажу (из Fin and Ops в Sales) - напрямую"

#### <a name="salesheader-task"></a>Задача SalesHeader

- Для создания заказов в Sales требуется прайс-лист. Обновите схему сопоставления для **pricelevelid.name \[имя прайс-листа\]** на прайс-лист, используемый в Sales для данной валюты. Можно использовать прайс-лист по умолчанию для одной валюты. Если имеются прайс-листы в нескольких валютах, можно использовать схему сопоставления.

    Значение по умолчанию шаблона для **pricelevelid.name \[имя прайс-листа\]** — **CRM Service USA (sample)**.

#### <a name="salesline-task"></a>Задача SalesLine

- Убедитесь, что существует требуемая схема сопоставления значений для **SalesUnitSymbol** в Finance and Operations.
- Убедитесь в том, что требуемые единицы определены в Sales.

    Значение шаблона, которое имеет сопоставление значений, определено для **SalesUnitSymbol** в **oumid.name**.

## <a name="template-mapping-in-data-integration"></a>Сопоставление шаблона в интеграции данных

> [!NOTE]
> Поля **Условия оплаты**, **Условия фрахта**, **Условия поставки**, **Способ доставки** и **Режим доставки** не являются частью сопоставлений по умолчанию. Чтобы сопоставить эти поля, необходимо настроить преобразование значений, характерное для данных в организациях, между которыми синхронизируется объект.

На следующем рисунке показан пример сопоставления шаблона в интеграции данных.

> [!NOTE]
> Сопоставление показывает, какие данные полей будут синхронизированы из Sales в Finance and Operations или из Finance and Operations в Sales.

### <a name="sales-orders-fin-and-ops-to-sales---direct-orderheader"></a>Заказы на продажу (из Fin and Ops в Sales) - напрямую: OrderHeader

[![Сопоставление шаблона в интеграции данных](./media/sales-order-direct-template-mapping-data-integrator-1.png)](./media/sales-order-direct-template-mapping-data-integrator-1.png)

### <a name="sales-orders-fin-and-ops-to-sales---direct-orderline"></a>Заказы на продажу (из Fin and Ops в Sales) - напрямую: OrderLine

[![Сопоставление шаблона в интеграции данных](./media/sales-order-direct-template-mapping-data-integrator-2.png)](./media/sales-order-direct-template-mapping-data-integrator-2.png)

### <a name="sales-orders-sales-to-fin-and-ops---direct-orderheader"></a>Заказы на продажу (из Sales в Fin and Ops) - напрямую: OrderHeader

[![Сопоставление шаблона в интеграции данных](./media/sales-order-direct-template-mapping-data-integrator-3.png)](./media/sales-order-direct-template-mapping-data-integrator-3.png)

### <a name="sales-orders-sales-to-fin-and-ops---direct-orderline"></a>Заказы на продажу (из Sales в Fin and Ops) - напрямую: OrderLine

[![Сопоставление шаблона в интеграции данных](./media/sales-order-direct-template-mapping-data-integrator-4.png)](./media/sales-order-direct-template-mapping-data-integrator-4.png)

## <a name="related-topics"></a>Связанные разделы

[Решение "Перспективный клиент в наличные деньги"](prospect-to-cash.md)

