---
title: Распределение запасов Inventory Visibility
description: В этой статье объясняется, как настроить и использовать функцию распределения запасов, которая позволяет отложить выделенные запасы, чтобы обеспечить выполнение самых выгодных каналов или клиентов.
author: yufeihuang
ms.date: 11/04/2022
ms.topic: article
ms.search.form: ''
audience: Application User
ms.reviewer: kamaybac
ms.search.region: Global
ms.author: yufeihuang
ms.search.validFrom: 2022-05-13
ms.dyn365.ops.version: 10.0.27
ms.openlocfilehash: 449ca0616405ba589b92fba1ef078a4350d1e3b1
ms.sourcegitcommit: 49f8973f0e121eac563876d50bfff00c55344360
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2022
ms.locfileid: "9762681"
---
# <a name="inventory-visibility-inventory-allocation"></a>Распределение запасов Inventory Visibility

[!include [banner](../includes/banner.md)]

## <a name="business-background-and-purpose"></a>Сведения о деятельности и назначение

Организациям часто приходится распределять свои запасы в наличии на наиболее важные каналы продаж, группы клиентов, регионы и рекламные события, чтобы гарантировать, что предварительно распределенные запасы защищены от любого другого использования и могут быть потреблены только через проводки по продажам, относящимся к распределению. Распределение запасов в видимости запасов — это компонент процесса планирования операций по продажам и выполняется перед любыми фактическими действиями по продажам или созданием заказов на продажу.

Например, компания под названием Contoso производит популярный велосипед. К сожалению, поскольку последнее нарушение цепочки поставок повлияло на все транзитные запасы этого велосипеда, компания Contoso имеет ограниченные запасы в наличии, и она должна быть оптимальной в их использовании. Contoso осуществляет продажи как в Интернете, так и в магазине. В каждом канале продаж у компании есть несколько важных партнеров (marketplace и крупные розничные продавцы), требующих, чтобы для них была оставлена определенная часть запасов велосипеда. Таким образом, компания по продаже велосипедов должна иметь возможность сбалансировать распределение запасов по каналам, а также управлять ожиданиями VIP-партнеров. Наилучшим способом достижения обеих целей является использование распределения запасов, благодаря чему каждый канал и продавец могут получить определенное выделенное количество товара, которое может быть продано клиентам позже.

Распределение запасов имеет две основные цели:

- **Защита запасов (выделение на самостоятельный баланс)** — организации хотят предварительно распределить ограниченный запас по приоритетным каналам, регионам, VIP-клиентам и дочерним компаниям. Функция распределения "Видимость запасов" предназначена для защиты распределенных запасов для того, чтобы другие распределения, резервирования или другие потребности в продажах не влияли на ранее распределенные запасы.
- **Управление перепродажами** — функция распределения "Видимость запасов" предназначена для установки ограничения на ранее распределенное количество запасов для того, чтобы получающая сторона (например, канал или группа клиентов) не перерасходовала их на момент выполнения фактической проводки по продажам на основе предварительного резервирования.

## <a name="allocation-definition-in-inventory-visibility-service"></a>Определение распределения в службе видимости запасов

### <a name="allocation-virtual-pool"></a>Виртуальный пул распределения

Хотя функция распределения в видимости запасов не размещает количество физических запасов, она обращается к доступному количеству физических запасов, чтобы определить начальное количество виртуального пула *Доступно для распределения*. Распределение запасов с помощью функции "Видимость запасов" является предварительным распределением. Это выполняется до осуществления фактических проводок продаж и не зависит от заказов на продажу. Например, можно распределить запасы на наиболее важные каналы продаж или крупные предприятия розничной торговли, прежде чем все конечные пользователи посетят этот канал продаж или магазин розничной торговли для покупки.

### <a name="difference-between-inventory-allocation-and-soft-reservation"></a>Разница между распределением запасов и предварительным резервированием

[Предварительные резервирования](inventory-visibility-reservations.md) обычно связаны с фактическими проводками по продажам (строками заказа на продажу). Как распределение, так и предварительное резервирование могут использоваться независимо, но если их необходимо использовать вместе, предварительное резервирование должно быть выполнено после распределения. Рекомендуется сначала выполнить распределение запасов, затем выполнить их предварительное резервирование в соответствии с распределенными количествами, чтобы достичь потребления почти в режиме реального времени относительно распределения. Дополнительные сведения см. в разделе [Потребление в качестве предварительного резервирования](#consume-to-soft-reserved).

Функция распределения запасов позволяет планировщикам сбыта или управляющим основных счетов управлять и предварительно распределять важные запасы по группам распределения (например, по каналам, областям и группам клиентов). Она также поддерживает отслеживание в реальном времени, корректировку и аналитику потребления для распределенных количеств, чтобы обеспечить, что пополнение или распределение могут быть выполнены вовремя. Наличие функции видимости в режиме реального времени в распределении, потреблении и сальдо распределения особенно важно при быстрых продажах или рекламных акциях.

## <a name="terminology"></a>Терминология

Следующие термины и понятия помогут при обсуждении распределения запасов:

- **Группа распределения** — группа, которая владеет распределением, например канал продаж, группа клиентов или тип заказа.
- **Значение группы распределения** — значение каждой группы распределения. Например, *веб-сайт* или *магазин* могут быть значением группы распределения канала продаж, а *VIP* или *Обычный* могут быть значением группы распределения клиентов.
- **Иерархия распределения** — средство для объединения групп распределения в иерархическом порядке. Например, можно определить *канал* как уровень иерархии 1, *регион* — как уровень 2, а *группу клиентов* — как уровень 3. Во время распределения запасов нужно следовать последовательности иерархии распределения при указании значения группы распределения. Например, можно выделить 200 красных велосипедов для канала *веб-сайт*, региона *Лондон* и группы клиентов *VIP*.
- **Доступно для распределения** — *виртуальный общий пул*, который показывает количество, доступное для дальнейшего распределения. Это вычисляемая мера, которую можно свободно определять с помощью собственной формулы. Если используется также функция предварительного резервирования, рекомендуется использовать одну и ту же формулу для расчета доступных для распределения и доступных для резервирования запасов.
- **Распределено** — физическая мера, в которой отображается распределенная квота, которая может быть потреблена группами распределения. Она вычитается одновременно с добавлением потребленного количества.
- **Потреблено** — физическая мера, которая указывает на то, что количества были потреблены относительно исходного распределенного количества. При добавлении номеров в эту физическую меру, физическая мера "Распределено" автоматически уменьшается.

Следующая иллюстрация показывает рабочий процесс для распределения запасов.

![Рабочий процесс распределения видимости запасов](media/inventory-visibility-allocation-flow.png "Рабочий процесс распределения видимости запасов.")

На следующем рисунке показана иерархия распределения и группы распределения. *Виртуальный общий пул*, показанный здесь, является количеством, доступным для распределения.

[<img src="media/inventory-visibility-allocation-hierarchy.png" alt="Inventory Visibility allocation hierarchy." title="Иерархия распределения видимости запасов" width="720" />](media/inventory-visibility-allocation-hierarchy.png)

## <a name="set-up-inventory-allocation"></a>Настройка распределения запасов

Функция распределения запасов состоит из указанных ниже компонентов.

- Предопределенные источник данных, физические меры и рассчитываемые меры, связанные с распределением.
- Настраиваемые группы распределения, которые имеют максимум 8 уровней.
- Набор интерфейсов прикладного программирования (API) распределения:

    - распределить
    - перераспределить
    - не распределять
    - использовать
    - запросить

Процесс настройки функции распределения состоит из трех этапов:

- Включите функцию в приложении "Видимость запасов", перейдя в раздел **Конфигурация \> Управление функциями и параметры \> Распределение**.
- Настройка [источника данных](inventory-visibility-configuration.md#data-source-configuration) и его [мер](inventory-visibility-configuration.md#data-source-configuration-physical-measures).
- Настройка имени и иерархии группы распределения.

### <a name="predefined-data-source"></a>Предопределенный источник данных

При включении функции распределения и вызове API обновления конфигурации функция видимости запасов создает один предопределенный источник данных и несколько начальных показателей.

Источник данных называется `@iv`. Он включает набор физических мер по умолчанию. Их можно просмотреть в приложении "Видимость запасов", перейдя в раздел **Конфигурация \> Источник данных**. Вы должны увидеть **Datasource - @IV**. Разверните источник данных `@iv` для просмотра списка исходных физических мер:

- `@iv`

    - `@allocated`
    - `@cumulative_allocated`
    - `@consumed`
    - `@cumulative_consumed`

Выберите вкладку **Вычисляемые меры** для просмотра исходной вычисляемой меры, которая называется `@iv.@available_to_allocate`:

- `@iv`

    - `@iv.@available_to_allocate` = `??` – `??` – `@iv.@allocated`

### <a name="add-other-physical-measures-to-the-available-to-allocate-calculated-measure"></a>Добавьте другие физические меры в вычисляемую меру "Доступно для распределения"

Для использования распределения необходимо правильно настроить формулу для вычисляемой меры "Доступно для распределения" (`@iv.@available_to_allocate`). Например, у вас есть источник данных `fno` и мера `onordered`, а также источник данных `pos` и мера `inbound`, и необходимо выполнить распределение имеющихся в наличии запасов для суммы `fno.onordered` и `pos.inbound`. В этом случае `@iv.@available_to_allocate` должно содержать `pos.inbound` и `fno.onordered` в формуле. Рассмотрим пример:

`@iv.@available_to_allocate` = `fno.onordered` + `pos.inbound` – `@iv.@allocated`

> [!NOTE]
> Источник данных `@iv` является заранее определенным источником данных, а физические меры, определенные в поле `@iv` с префиксом `@`, являются предопределенными мерами. Эти меры представляют собой предварительно определенную конфигурацию для функции распределения, поэтому не изменяйте и не удаляйте их, иначе вы можете столкнуться в непредвиденными ошибками при использовании функции распределения.
>
> Можно добавлять новые физические меры к заранее определенной вычисляемой мере `@iv.@available_to_allocate`, но изменять ее имя нельзя.

### <a name="manage-allocation-groups"></a>Управление группами распределения

Можно задать не более восьми имен групп распределения. Группы имеют иерархию. Выполните следующие шаги, чтобы просмотреть и обновить группы распределения.

1. Выполните вход в среду Power Apps и откройте область **Видимость запасов**.
1. Откройте страницу **Конфигурация**, затем на вкладке **Распределение** выберите **Изменить конфигурацию**. По умолчанию имеется иерархия распределения с четырьмя слоями: `Channel` (верхний слой), `customerGroup` (второй слой), `Region` (третий слой) и `OrderType` (четвертый слой).
1. Можно удалить существующую группу распределения, щелкнув значок **X** рядом с ней. Можно также добавить в иерархию новые группы распределения, вводя имя каждой новой группы непосредственно в поле.

    > [!IMPORTANT]
    > Будьте внимательны при удалении или изменении сопоставления иерархии распределения. Инструкции см. в разделе [Советы по использованию распределения](#allocation-tips).

1. После завершения настройки параметров группы распределения и иерархии сохраните изменения, затем выберите **Обновить конфигурацию** в правом верхнем углу. Значения настроенных групп распределения будут обновляться при создании распределения с использованием интерфейса пользователя или процедуры API POST (/api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/allocate). Подробные сведения об обоих подходах приведены далее в этой статье.

Если используются четыре имени группы, и для них заданы значения \[`channel`, `customerGroup`, `region`, `orderType`\], эти имена будут действительны для запросов, связанных с распределением, при вызове API обновления конфигурации.

### <a name="tips-for-using-allocation"></a><a name="allocation-tips"></a>Рекомендации по использованию распределения

- Для каждого продукта функция распределения должна использоваться на том же *уровне аналитики*, что и иерархия индексов продуктов, заданная в [конфигурации иерархии индекса продуктов](inventory-visibility-configuration.md#index-configuration). Например, предположим, что индекс имеет иерархию \[`Site`, `Location`, `Color`, `Size`\]. При распределении некоторого количества для одного продукта на уровне аналитики \[`Site`, `Location`, `Color`\], в следующий раз, когда необходимо распределить этот продукт, следует также распределить на том же уровне, \[`Site`, `Location`, `Color`\]. При использовании уровня \[`Site`, `Location`, `Color`, `Size`\] или \[`Site`, `Location`\] данные будут несогласованными.
- **Изменение групп распределения и иерархии:** если данные распределения уже существуют в системе, удаление существующих групп распределения или сдвиг в иерархии групп распределения приведет к повреждению существующего сопоставления между группами распределения. Поэтому перед обновлением новой конфигурации необходимо вручную очистить все старые данные. Однако, поскольку добавление новых групп распределения в самую нижнюю иерархию не влияет на существующие сопоставления, очистка данных не требуется.
- Распределение будет успешно выполнено только в том случае, если продукт имеет положительное количество `available_to_allocate`.
- Для распределения продуктов из группы высокого *уровня распределения* в подгруппу используйте API `Reallocate`. Например, имеется иерархия групп распределения \[`channel`, `customerGroup`, `region`, `orderType`\] и требуется распределить некоторый продукт из группы распределения \[По Интернету, VIP\] в подгруппу распределения \[По Интернету, VIP, ЕС\], используйте API `Reallocate` для перемещения количества. При использовании API-интерфейса `Allocate` он будет распределять количество из виртуального общего пула.
- Чтобы просмотреть общую доступность продукта (общий пул), используйте API [запроса в наличии](inventory-visibility-api.md#query-on-hand) для запроса суммы запасов, *доступных для распределения*. Затем можно выполнять распределения на основе этих сведений.

## <a name="use-the-allocation-api"></a><a name="using-allocation-api"></a>Использование API распределения

В данный момент открыты пять API распределения:

- **POST /api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/allocate** — этот API используется для создания начального распределения.
- **POST /api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/unallocate** — этот API используется для отмены или удаления распределенных количеств.
- **POST /api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/reallocate** — этот API используется для перемещения распределенного количества из существующего распределения в другие группы распределения.
- **POST /api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/consume** — этот API используется для отгрузки (использования) распределенного количества.
- **POST /api<wbr>/environment<wbr>/\{environmentId\}<wbr>/allocation<wbr>/query** — этот API используется для проверки существующих записей распределения на соответствие группам распределения и иерархии.

### <a name="allocate"></a>Распределить

Вызовите API `Allocate` для распределения продукта с отдельными аналитиками. Вот схема для текста запроса.

```json
{
    "id": "string",
    "productId": "string",
    "dimensionDataSource": "string",
    "groups": {
        "groupA": "string",
        "groupB": "string",
        "groupC": "string"
    },
    "quantity": 0,
    "organizationId": "string",
    "dimensions": {
        "dimension1": "string",
        "dimension2": "string",
        "dimension3": "string"
    }
}
```

Например, необходимо распределить количество 10 для продукта *Велосипед*, сайта *1*, местоположения *11*, цвета *красный*, канала *Интернет*, группы клиентов *VIP* и региона *США*. Чтобы выполнить это распределение, можно выполнить вызов, который имеет следующее содержание текста.

```json
{
    "id": "test101",
    "productId": "Bike",
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
    "quantity": 10,
    "organizationId": "usmf",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    }
}
```

Количество должно быть всегда больше 0 (нуля).

### <a name="unallocate"></a>Не распределять

Используйте API `Unallocate` для сторнирования операции `Allocate`. Отрицательное количество в операции `Allocate` не разрешено. Текст `Unallocate` совпадает с текстом `Allocate`.

### <a name="reallocate"></a>Перераспределить

Используйте API `Reallocate` для перемещения некоторого распределенного количества в другую комбинацию группы. Вот схема для текста запроса.

```json
{
    "id": "string",
    "productId": "string",
    "dimensionDataSource": "string",
    "sourceGroups": {
        "groupA": "string",
        "groupB": "string",
        "groupC": "string"
    },
    "groups": {
        "groupD": "string",
        "groupE": "string",
        "groupF": "string"
    },
    "quantity": 0,
    "organizationId": "string",
    "dimensions": {
        "dimension1": "string",
        "dimension2": "string",
        "dimension3": "string"
    }
}
```

Например, можно переместить два велосипеда с аналитиками \[сайт = 1, местоположение = 11, цвет = красный\] из группы распределения \[Интернет, VIP, США\] в группу распределения \[Интернет, VIP, ЕС\], вызвав API `Reallocate` и указав следующий текст.

```json
{
    "id": "test102",
    "productId": "Bike",
    "sourceGroups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "EU"
    },
    "quantity": 2,
    "organizationId": "usmf",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    }
}
```

### <a name="consume"></a>Потребление

Используйте API `Consume` для разноски количества потребления в соответствии с распределением. Например, этот API можно использовать для перемещения распределенного количества по некоторым реальным мерам. Вот схема для текста запроса.

```json
{
    "id": "string",
    "productId": "string",
    "dimensionDataSource": "string",
    "groups": {
        "groupA": "string",
        "groupB": "string",
        "groupC": "string"
    },
    "quantity": 0,
    "organizationId": "string",
    "dimensions": {
        "dimension1": "string",
        "dimension2": "string",
        "dimension3": "string"
    },
    "physicalMeasures": {
        "datasource1": {
            "measure": "string" // Addition or Subtraction
        }
    }
}
```

Например, имеется восемь распределенных велосипедов с аналитиками \[сайт = 1, местоположение = 11, цвет = красный\] для группы распределения \[Интернет, VIP, США\]. Используется следующая формула "доступно для распределения":

`@iv.@available_to_allocate` = `fno.onordered` + `pos.inbound` – `@iv.@allocated`

Восемь велосипедов распределяются из меры `pos.inbound`.

Теперь три велосипеда продаются, и они берутся из пула распределения. Чтобы зарегистрировать это перемещение, можно выполнить вызов, который имеет следующий текст запроса.

```json
{
    "id": "test103",
    "organizationId": "usmf",
    "productId": "Bike",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    },
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
    "quantity": 3,
    "physicalMeasures": {
        "pos": {
            "inbound": "Subtraction"
        }
    }
}
```

После этого вызова распределенное количество для продукта будет уменьшено на 3. Кроме того, видимость запасов создаст событие изменения запасов в наличии, где `pos.inbound` = *-3*. В качестве альтернативы можно сохранить значение `pos.inbound` без изменений и потребить распределенное количество. Однако в этом случае необходимо либо создать другую физическую меру для сохранения потребленных количеств, либо использовать предопределенную меру `@iv.@consumed`.

Обратите внимание, что в этом запросе физическая мера, используемая в тексте запроса для потребления, должна использовать противоположный тип модификатора (сложение или вычитание) в сравнении с типом модификатора, используемым в рассчитываемой мере. Таким образом, в тексте для потребления `iv.inbound` имеет значение `Subtraction`, а не `Addition`.

Источник данных `fno` не может использоваться в тексте для потребления, так как всегда подчеркивалось, что видимость запасов не может изменить никакие данные для источника данных `fno`. Поток данных является однонаправленным, что означает, что все изменения количества для источника данных `fno` должны поступать из среды Supply Chain Management.

### <a name="consume-as-a-soft-reservation"></a><a name="consume-to-soft-reserved"></a>Потребление в качестве предварительного резервирования

API-интерфейс `Consume` может также потреблять распределенное количество в качестве предварительного резервирования. В этом случае операция `Consume` приведет к уменьшению распределенного количества, а затем выполнит предварительное резервирование для этого количества. Для использования этого подхода необходимо также использовать функцию [предварительное резервирование](inventory-visibility-reservations.md) видимости запасов.

Например, вы установили меру физического предварительного резервирования как `iv.softreserved`. Для рассчитанной меры "доступно для резервирования" используется следующая формула:

`iv.available_to_reserve` = `fno.onordered` + `pos.inbound` – `iv.softreserved`

Чтобы использовать эту настройку с функцией распределения, необходимо добавить `@iv.@allocated` в `iv.available_to_reserve`, чтобы создать следующую формулу:

`iv.available_to_reserve` = `fno.onordered` + `pos.inbound` – `iv.softreserved` – `@iv.@allocated`

Затем обновите `@iv.@available_to_allocate` до того же значения.

Если необходимо потребить количество 3 и непосредственно зарезервировать это количество, можно выполнить вызов со следующим текстом запроса.

```json
{
    "id": "???",
    "organizationId": "usmf",
    "productId": "Bike",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    },
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
    "quantity": 3,
    "physicalMeasures": {
        "iv": {
            "softreserved": "Addition"
        }
    }
}
```

Обратите внимание, что данном запросе `iv.softreserved` имеет значение `Addition`, а не `Subtraction`.

### <a name="query"></a>Запрос

Используйте API `Query` для получения сведений о распределении для некоторых продуктов. Можно использовать фильтры аналитик и фильтры групп распределения для сужения результатов. Аналитики должны точно соответствовать тому, что необходимо получить, например, \[сайт = 1, местоположение = 11\] будет иметь несвязанные результаты по сравнению с \[сайт = 1, местоположение = 11, цвет = красный\].

```json
{
    "productId": "string",
    "organizationId": "string",
    "dimensions": {
        "dimension1": "string",
        "dimension2": "string",
        "dimension3": "string"
    },
    "groups": {
        "additionalProp1": "string",
        "additionalProp2": "string",
        "additionalProp3": "string"
    },
}
```

Например, используйте \[сайт = 1, местоположение = 11, цвет = красный\] и пустые поля группы, чтобы получить все записи распределения:

```json
{
    "organizationId": "usmf",
    "productId": "Bike",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    },
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
}
```

Используйте \[сайт = 1, местоположение = 11, цвет = красный\] и группы \[каналы = Интернет, группа клиентов = VIP, регион = США\], чтобы получить записи распределения для этой группы:

```json
{
    "organizationId": "usmf",
    "productId": "Bike",
    "dimensions": {
        "siteId": "1",
        "locationId": "11",
        "colorId": "red"
    },
    "groups": {
        "channel": "Web",
        "customerGroup": "VIP",
        "region": "US"
    },
}
```

## <a name="use-the-allocation-user-interface"></a>Использование пользовательского интерфейса распределения

Можно вручную управлять распределением в интерфейсе пользователя, открыв приложение "Видимость запасов" и перейдя в раздел **Операционная видимость \> Распределение**. Оттуда можно выполнить любые действия, описанные в следующих подразделах.

### <a name="create-an-allocation"></a>Создание распределения

Выполните следующие действия, чтобы создать распределение на странице **Распределение** в приложении "Видимость запасов".

1. Выберите **Распределить**.
1. Установите базовые поля, аналитики и целевые значения групп распределения. (При выборе источника сбора данных в разделе **Аналитики** сначала воспользуйтесь раскрывающимся списком для задания аналитик (например, `siteId`). Затем введите значения аналитик в отображаемые поля.)
1. Выберите **отправить**.

### <a name="consume-an-allocation"></a>Потребление распределения

Выберите **Потребить**, чтобы использовать распределение. Чтобы убедиться в том, что используется правильная группа распределения и иерархия, введите те же наборы сведений об организации и измерении, которые были введены при создании распределения.

### <a name="reallocate-an-allocation"></a>Перераспределение распределения

Выберите **Перераспределить** для перемещения существующего распределенного количества из одного набора групп распределения в другой.

### <a name="query-existing-allocations"></a>Запрос существующих распределений

Выберите **Запрос**, затем введите значения для параметров "продукт", "организация", "аналитика" и "группа распределения", чтобы получить результаты запроса существующих распределений.
