---
title: Включение подстановки основных данных для конфигурации расчета налога
description: В этой статье объясняется, как настроить и включить функцию поиска в справочнике для расчета налогов.
author: kai-cloud
ms.date: 07/14/2022
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ''
audience: Application user
ms.reviewer: kfend
ms.custom: ''
ms.search.region: Global
ms.author: pashao
ms.search.validFrom: 2021-04-01
ms.dyn365.ops.version: 10.0.18
ms.openlocfilehash: 3642bb88d5b0570014513b64eef5fdab6d1ee9d3
ms.sourcegitcommit: 5b721f6fc1ba4350b5bd0eae457f71d80246db42
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2022
ms.locfileid: "9181135"
---
# <a name="enable-master-data-lookup-for-tax-calculation-configuration"></a>Включение подстановки основных данных для конфигурации расчета налога 

[!include [banner](../includes/banner.md)]

В этой статье объясняется, как настроить и включить функцию поиска в справочнике для расчета налогов. Раскрывающийся список доступен для выбора значений в конфигурации расчета налогов для таких полей , как **Юридическое лицо**, **Счет поставщика**, **Код номенклатуры** и **Условия поставки**. Эти значения берутся из связанной среды Microsoft Dynamics 365 Finance, использующей источник данных Microsoft Dataverse.

> [!NOTE] 
> Функция подстановки основных данных в расчете налога является дополнительной функциональностью. Можно пропустить следующие шаги, если отключить функцию **Поддержка источника данных налоговой службы Dataverse** в Regulatory Configuration Service (RCS). Однако в этом случае раскрывающийся список не будет доступен в конфигурации расчета налогов.

Чтобы включить раскрывающийся список в конфигурации версии функции расчета налога, выполните следующие действия.

1. [Включите интеграцию Microsoft Power Platform и откройте среду Dataverse.](#enable)
2. [Установите виртуальные сущности для управления финансами и операциями.](#install)
3. [Зарегистрируйте приложение Azure Active Directory (Azure AD).](#register)
4. [Предоставьте разрешения приложения в приложениях для управления финансами и операциями.](#grant)
5. [Настройте источник данных виртуальной сущности.](#configure)
6. [Включите виртуальные сущности Dataverse.](#virtual)
7. [Настройте подключенное приложение для расчета налогов.](#set-up)
8. [Импортируйте и настройте конфигурацию сопоставления модели Dataverse.](#import)

## <a name="enable-microsoft-power-platform-integration-and-open-the-dataverse-environment"></a><a name='enable'></a>Включение интеграции Microsoft Power Platform и открытие среды Dataverse

Интеграция приложений для управления финансами и операциями с Microsoft Power Platform может быть включена при создании новой среды приложений для управления финансами и операциями в службе Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в [Microsoft Power Platform интеграция — Обзор надстроек](../../fin-ops-core/dev-itpro/power-platform/add-ins-overview.md). После завершения появится название среды Microsoft Power Platform в разделе **Интеграция Power Platform**.

1. В LCS в среде для управления финансами и операциями в разделе **Интеграция Power Platform** найдите и запишите значение **Имя среды** для связанной среды.

    [![Значение имени среды.](./media/tcs-dataverse-master-data-lookup-1.png)](./media/tcs-dataverse-master-data-lookup-1.png)

2. В [центре администрирования Power Platform](https://admin.powerplatform.microsoft.com/environments) на вкладке **Среды** выберите среду, соответствующую значению **Имя среды**, которое вы записали.
3. На странице **Сведения** найдите значение **URL-адрес среды** для среды Dataverse. Запишите это значение, так как оно потребуется на [шаге 7. Настройка подключенного приложения для расчета налогов](#set-up).
4. Убедитесь, что вы можете открыть среду Dataverse в браузере, выбрав значение **URL-адрес среды**.

    [![Страница среды Dataverse.](./media/tcs-dataverse-master-data-lookup-2.png)](./media/tcs-dataverse-master-data-lookup-2.png)

    > [!NOTE]
    > Оставьте среду Dataverse открытой в браузере. Это потребуется на [шаге 5. Настройка источника данных для виртуальной сущности](#configure).

Дополнительные сведения см. в разделе [Включение интеграции Microsoft Power Platform](../../fin-ops-core/dev-itpro/power-platform/enable-power-platform-integration.md).

## <a name="install-finance-and-operations-virtual-entities"></a><a name='install'></a>Установка виртуальных сущностей для управления финансами и операциями

Решение Dataverse для виртуальных объектов для управления финансами и операциями должно быть установлено из решения виртуальных сущностей Microsoft AppSource.

1. В AppSource найдите [Виртуальная сущность для управления финансами и операциями](https://appsource.microsoft.com/product/dynamics-365/mscrm.finance_and_operations_virtual_entity).
2. Выберите **Получить**.
3. В поле **Выберите среду** введите значение **Имя среды**, которое было записано ранее.
4. Установите флажки, затем выберите **Установить**.

После завершения установки вы можете найти приложение **Виртуальная сущность для управления финансами и операциями** в [Центре администрирования Power Platform](https://admin.powerplatform.microsoft.com/) в разделе **Ресурсы** \> **Приложения Dynamics 365**.

Дополнительные сведения см. в разделе [Получение решения виртуальных сущностей](../../fin-ops-core/dev-itpro/power-platform/admin-reference.md#get-virtual-entity-solution).

## <a name="register-an-azure-ad-application"></a><a name='register'></a>Регистрация приложения Azure AD

Необходимо зарегистрировать приложение Azure AD в том же клиенте, что и приложения для управления финансами и операциями, чтобы они могли быть вызваны Dataverse.

1. На [портале Azure](https://portal.azure.com) перейдите к пункту **Azure Active Directory \> Регистрации приложений**.
2. Выберите **Создать регистрацию**, затем введите следующие сведения:

    - **Имя** – введите уникальное имя.
    - **Тип учетной записи** — введите **Любой каталог Azure AD** (с одним или несколькими клиентами).
    - **URI перенаправления** — оставьте это поле пустым.

3. Выберите **Регистр**.
4. Запишите значение **Код приложения (клиента)**, поскольку оно потребуется позже.

    [![Значение идентификатора приложения (клиента) Azure AD.](./media/tcs-dataverse-master-data-lookup-3.png)](./media/tcs-dataverse-master-data-lookup-3.png)

5. Создайте симметричный ключ для приложения.
6. В новом приложении выберите **Сертификаты и секреты**.
7. Выберите **Создать секрет клиента**.
8. Введите описание, выберите дату истечения срока действия, затем выберите **Сохранить**. Будет создан и показан ключ. Скопируйте значения для использования в дальнейшем.

Дополнительные сведения см. в разделе [Регистрация приложения Azure AD](../../fin-ops-core/dev-itpro/power-platform/admin-reference.md#register-the-app-in-the-azure-portal).

## <a name="grant-app-permissions-in-finance-and-operations-apps"></a><a name='grant'></a>Предоставление разрешений приложения в приложениях для управления финансами и операциями

Dataverse использует созданное вами приложение Azure AD для вызова приложений для управления финансами и операциями. Поэтому приложение должно быть доверенным для приложений для управления финансами и операциями и связано с учетной записью пользователя, обладающей соответствующими правами. В приложениях для управления финансами и операциями необходимо создать специального пользователя службы, у которого есть права **только** для функциональности виртуальных сущностей. Этот пользователь службы не должен иметь других прав. После выполнения этого шага любое приложение, которое имеет секрет приложения Azure AD, созданный вами, сможет вызвать среду приложений для управления финансами и операциями и получить доступ к функциям виртуальной сущности.

1. В вашей среде перейдите в раздел **Администрирование системы** \> **Пользователи** \> **Пользователи**.
2. Выберите **Создать**, чтобы добавить нового пользователя, и введите следующие сведения:

    - **Идентификатор пользователя** — введите **dataverseintegration** или другое значение.
    - **Имя пользователя** — введите **Интеграция Dataverse** или другое значение.
    - **Поставщик** — установите для этого поля значение **NonAAD**.
    - **Электронная почта** — введите **dataverseintegration** или другое значение. (Значение не обязательно должно быть действительной учетной записью электронной почты.)

3. Назначьте этому пользователю роль безопасности **Приложение виртуального объекта CDS**.
4. Удалите все остальные роли, включая **Системный пользователь**.
5. Перейдите в раздел **Администрирование системы** \> **Настройка** \> **Приложения Azure Active Directory**, чтобы зарегистрировать Dataverse. 
6. Добавьте строку, затем в поле **Код клиента** введите значение **Код приложения (клиента)**, который вы записали ранее.
7. В поле **Имя** введите имя. Например, введите **Интеграция Dataverse**.
8. В поле **ИД пользователя** введите ранее созданный ИД пользователя.

Дополнительные сведения см. в разделе [Предоставление разрешений приложения в приложениях для управления финансами и операциями](../../fin-ops-core/dev-itpro/power-platform/admin-reference.md#grant-app-permissions-in-finance-and-operations-apps).

## <a name="configure-the-virtual-entity-data-source"></a><a name='configure'></a>Настройка источника данных виртуальной сущности

Необходимо указать Dataverse экземпляр приложения для управления финансами и операциями, к которому требуется подключиться.

1. Ваша среда Dataverse должна все еще быть открыта в браузере после [шага 1. Включение интеграции Microsoft Power Platform и открытие среды Dataverse](#enable). Выберите кнопку параметров (символ шестеренки) в правом верхнем углу, затем выберите **Дополнительные параметры**.

    [![Открытие дополнительных параметров в среде Dataverse.](./media/tcs-dataverse-master-data-lookup-4.png)](./media/tcs-dataverse-master-data-lookup-4.png)

2. В раскрывающемся меню **Параметры** выберите **Администрирование**.

    [![Администрирование.](./media/tcs-dataverse-master-data-lookup-5.png)](./media/tcs-dataverse-master-data-lookup-5.png)

3. Выберите **Источники данных виртуальной сущности**.

    [![Источники данных виртуальной сущности.](./media/tcs-dataverse-master-data-lookup-6.png)](./media/tcs-dataverse-master-data-lookup-6.png)

4. Выберите источник данных, который называется **Финансы и операции**.

    [![Источник данных финансов и операций.](./media/tcs-dataverse-master-data-lookup-7.png)](./media/tcs-dataverse-master-data-lookup-7.png)

5. Введите следующие сведения из предыдущих шагов:

    - **Целевой URL-адрес** — введите URL-адрес, по которому можно получить доступ к приложениям для управления финансами и операциями.
    - **URL-адрес OAuth** — введите `https://login.windows.net/`.
    - **Код арендатора** — укажите клиент. Это значение может совпадать с именем домена электронной почты компании (например, contoso.com).
    - **Код приложения AAD** — введите значение **Код приложения (клиента)**, который был создан ранее.
    - **Секрет приложения AAD** — введите секрет, который был создан ранее.
    - **Ресурс AAD** — введите **00000015-0000-0000-c000-000000000000**. Это значение является приложением Azure AD, представляющим приложения для управления финансами и операциями. Это значение всегда должно быть одинаковым.

6. Сохраните изменения.
7. Закройте страницу, чтобы вернуться на страницу **Администрирование**, на которой вы начнете выполнение [шага 6. Включение виртуальных сущностей Dataverse](#virtual).

    [![Закрытие сущности для редактирования.](./media/tcs-dataverse-master-data-lookup-8.png)](./media/tcs-dataverse-master-data-lookup-8.png)

Дополнительные сведения см. в разделе [Настройка источника данных виртуальной сущности](../../fin-ops-core/dev-itpro/power-platform/admin-reference.md#configure-the-virtual-entity-data-source).

## <a name="enable-dataverse-virtual-entities"></a><a name='virtual'></a>Включение виртуальных сущностей Dataverse

Видимость виртуальных сущностей из приложений для управления финансами и операциями должна быть установлена на **Да**, прежде чем их можно будет использовать в конфигурации расчета налогов.

> [!NOTE]
> Этот шаг можно пропустить, разрешив виртуальные сущности, связанные с расчетом налогов, всего одним щелчком на [шаге 8. Настройка подключенного приложения для расчета налогов](#import). Однако рекомендуется вручную включить по крайней мере одну виртуальную сущность, чтобы указать, что подключение между приложениями для управления финансами и операциями и Dataverse хорошо установлено.

1. В вашей среде Dataverse на странице **Администрирование** выберите кнопку фильтра (символ воронки) в верхнем правом углу.

    [![Кнопка фильтра.](./media/tcs-dataverse-master-data-lookup-9.png)](./media/tcs-dataverse-master-data-lookup-9.png)

2. В окне **Расширенный поиск** в поле **Найти** выберите **Доступные сущности для управления финансами и операциями**.
3. Добавьте следующее правило: **Имя** — **содержит** — **CompanyInfoEntity**. Затем выберите **Результаты**.

    [![Окно расширенного поиска.](./media/tcs-dataverse-master-data-lookup-10.png)](./media/tcs-dataverse-master-data-lookup-10.png)

4. Выберите **CompanyInfoEntity** в результатах поиска, установите флажок **Видимый** и затем выберите **Сохранить**.

    [![Настройка видимости сущности.](./media/tcs-dataverse-master-data-lookup-11.png)](./media/tcs-dataverse-master-data-lookup-11.png)

5. Повторите предыдущие шаги для следующих сущностей, на которые ссылается конфигурация расчета налогов:

    - CompanyInfoEntity
    - CurrencyEntity
    - CustCustomerV3Entity
    - DeliveryTermsEntity
    - EcoResProductCategoryEntity
    - EcoResReleasedProductV2Entity
    - LogisticsAddressCountryRegionTranslationEntity
    - LogisticsAddressStateEntity
    - PurchProcurementChargeCDSEntity
    - SalesChargeCDSEntity
    - TaxGroupEntity
    - TaxItemGroupHeadingEntity
    - VendVendorV2Entity
    - InventOperationalSiteV2Entity
    - TaxExemptCodeEntity
    - InventWarehouseEntity

    > [!NOTE]
    > Только первые 5000 записей сущности могут быть извлечены Dataverse и сделаны доступными в раскрывающемся списке конфигурации расчета налогов.

Дополнительные сведения см. в разделе [Включение виртуальных объектов Microsoft Dataverse](../../fin-ops-core/dev-itpro/power-platform/enable-virtual-entities.md).

## <a name="set-up-the-connected-application-for-tax-calculation"></a><a name='set-up'></a>Настройка подключенного приложения для расчета налогов

1. В RCS откройте рабочую область **Управление функциями** и включите следующие функции:

    - Поддержка источников данных Dataverse электронной отчетности
    - Поддержка источников данных Dataverse налоговой службы
    - Функции глобализации

2. Перейдите в область **Электронная отчетность**, затем в разделе **Связанные ссылки** выберите **Подключенные приложения**.

    [![Подключенные приложения.](./media/tcs-dataverse-master-data-lookup-12.png)](./media/tcs-dataverse-master-data-lookup-12.png)

3. Выберите **Создать**, чтобы добавить запись, и введите следующие сведения.

    - **Имя** — введите имя.
    - **Тип** — выберите **Dataverse**.
    - **Приложение** — введите значение **URL-адрес среды** среды Dataverse, которой вы записали на [шаге 1. Включение интеграции Microsoft Power Platform и открытие среды Dataverse](#enable).
    - **Клиент** — введите свой клиент.
    - **Пользовательский URL-адрес** — введите ваш URL-адрес Dataverse и добавьте к нему **/api/data/v9.1**.

4. Выберите **Проверить подключение**, затем в появившемся диалоговом окне выберите **Щелкните здесь, чтобы подключиться к выбранному удаленному приложению**.

    [![Проверка подключения.](./media/tcs-dataverse-master-data-lookup-13.png)](./media/tcs-dataverse-master-data-lookup-13.png)
5. Убедитесь, что получено сообщение "Успех!", указывающее, что подключение успешно установлено.

    [![Сообщение об успешном выполнении.](./media/tcs-dataverse-master-data-lookup-14.png)](./media/tcs-dataverse-master-data-lookup-14.png)

## <a name="import-and-set-up-the-dataverse-model-mapping-configuration"></a><a name='import'></a>Импорт и настройка конфигурации сопоставления модели Dataverse

Microsoft предоставляет конфигурации сопоставления модели по умолчанию для сущностей из приложений для управления финансами и операциями для расчета налогов.

1. В RCS перейдите в раздел **Электронная отчетность**.
2. В разделе **Поставщики конфигурации** на плитке поставщика **Microsoft** выберите **Репозитории**.

    [![Репозитории.](./media/tcs-dataverse-master-data-lookup-15.png)](./media/tcs-dataverse-master-data-lookup-15.png)

3. Выберите запись **Глобальный репозиторий конфигураций**, затем выберите **Открыть**.
4. В разделе **Модель налоговых данных** \> **Модель данных для расчета налога** выберите конфигурацию **Сопоставление моделей Dataverse**.
5. На экспресс-вкладке **Версии** выберите версию, соответствующую версии приложений для управления финансами и операциями, затем выберите **Импорт**.

    [![Импорт конфигурации сопоставления модели Dataverse.](./media/tcs-dataverse-master-data-lookup-16.png)](./media/tcs-dataverse-master-data-lookup-16.png)

    > [!IMPORTANT]
    > Конфигурация **Сопоставление модели Dataverse** действует только в отношении наивысшей импортированной версии. Поэтому не следует импортировать версию конфигурации **Сопоставление модели Dataverse**, превышающую версию конфигурации расчета налогов, которую планируется реализовать. Например, если планируется реализовать версию 40.50.225 конфигурации расчета налогов, следует импортировать только версию 40.50.13 конфигурации **Сопоставление модели Dataverse**. Не следует импортировать версию 40.54.14. В противном случае в конфигурации будет несовпадение модели данных.

6. Вернитесь в раздел **Электронная отчетность** и выберите плитку **Конфигурации налогов**.
7. Выберите импортированную конфигурацию **Сопоставление моделей Dataverse**, затем выберите **Изменить**.
8. Установите для параметра **По умолчанию для сопоставления модели** значение **Да**.
9. В поле **Подключенное приложение** выберите подключенное приложение, настроенное на [шаге 7. Настройка подключенного приложения для расчета налогов](#set-up).
10. Установите для параметра **Задание видимости виртуальных таблиц** значение **Да**, чтобы задать видимость для всех виртуальных сущностей, соответствующие расчету налогов.

Вы завершили настройку функций подстановки основных данных. Раскрывающийся список для таких полей, как **Юридическое лицо**, **Счет поставщика**, **Код номенклатуры** и **Условия поставки**, из Dynamics 365 Finance будут включены в настройку **Версия функции расчета налога**.

[![Раскрывающийся список юридических лиц.](./media/tcs-dataverse-master-data-lookup-17.png)](./media/tcs-dataverse-master-data-lookup-17.png)

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
