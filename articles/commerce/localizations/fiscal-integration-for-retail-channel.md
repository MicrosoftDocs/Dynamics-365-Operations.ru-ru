---
title: Обзор финансовой интеграции для каналов Commerce
description: В этой статье представлен обзор возможностей финансовой интеграции, доступных в Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 10/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2017-06-20
ms.openlocfilehash: 1812405db3c1e58eaf7cd1df3896f786e7bf026f
ms.sourcegitcommit: 2bc6680dc6b12d20532d383a0edb84d180885b62
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2022
ms.locfileid: "9631249"
---
# <a name="fiscal-integration-overview-for-commerce-channels"></a>Обзор финансовой интеграции для каналов Commerce

[!include [banner](../includes/banner.md)]

В этой статье представлен обзор возможностей финансовой интеграции, доступных в Dynamics 365 Commerce. 

Финансовая интеграция включает интеграцию с различными финансовыми устройствами и службами, которые обеспечивают финансовую регистрации продаж в соответствии с местным финансовым законодательством, предназначенным для предотвращения налогового мошенничества в сфере розничной торговли. Вот некоторые типичные сценарии, которые могут охватываться с помощью финансовой интеграции:

- Регистрация продажи на финансовом устройстве, подключенном к POS-терминалу, такому как фискальный принтер, и печать фискального чека для клиента.
- Безопасная подача информации, которая относится к продажам и возвратам, выполняемым в Retail POS, во внешнюю веб-службу, которая принадлежит налоговым органам.
- Помощь в обеспечении невозможности изменения данных проводок продаж с помощью цифровых подписей.

Функция финансовой интеграции — это платформа, которая предоставляет общее решение для дальнейшей разработки и настройки интеграции между Retail POS и финансовыми устройствами и службами. Функциональные возможности также включают примеры финансовой интеграции, поддерживающие основные сценарии для конкретных стран или регионов, и работающие с конкретными финансовыми устройствами или службами. Образец финансовой интеграции состоит из нескольких расширений компонентов Commerce и включается в комплект средств разработки программного обеспечения (SDK). Дополнительные сведения о примерах финансовой интеграции см. в разделе [Примеры финансовой интеграции в пакете Commerce SDK](#fiscal-integration-samples-in-the-commerce-sdk). Сведения о том, как установить и использовать пакет Commerce SDK см. в разделе [Архитектура комплекта средств разработки программного обеспечения (SDK) для Retail](../dev-itpro/retail-sdk/retail-sdk-overview.md).

Для поддержки других сценариев, которые не поддерживаются примером финансовой интеграции, для интеграции Retail POS с другими финансовыми устройствами или службами или для покрытия потребностей в других странах или регионах необходимо расширить существующий пример финансовой интеграции или создать новый пример на основе существующего образца в качестве примера.

## <a name="fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services"></a>Примеры процесса финансовой регистрации и финансовой интеграции для финансовых устройств и служб

Процесс финансовой регистрации в Retail POS может состоять из одного или нескольких шагов. Каждый шаг включает финансовую регистрацию конкретных проводок или событий в одном финансовом устройстве или службе. Следующие компоненты решения участвуют в финансовой регистрации в финансовом устройстве или службе:

- **Поставщик фискальных документов** — этот компонент сериализует данные о проводке или событии в формат, который также используется для взаимодействия с финансовым устройством или службой, анализирует ответы от финансового устройства или службы и сохраняет ответы в базе данных канала. Расширения также определяет конкретные проводки и события, которые должны быть зарегистрированы.
- **Финансовый соединитель** — этот компонент инициализирует связь с финансовым устройством или службой, отправляя запросы и прямые команды на финансовое устройство или службу на основе данных проводки/события, которые извлекаются из финансового документа, и получает ответы от финансового устройства или службы.

Пример финансовой интеграции может содержать расширения Commerce Runtime (CRT), Hardware Station и POS для поставщика фискальных документов и финансового соединителя. Он также содержит следующие конфигурации компонентов:

- **Конфигурация поставщика фискальных документов** — эта конфигурация определяет метод вывода и формат финансовых документов. Он также содержит сопоставление данных для налогов и способов оплаты, чтобы сделать данные с Retail POS совместимыми со значениями, которые заранее определены во встроенном ПО финансового устройства или службе.
- **Конфигурация финансового соединителя** — эта конфигурация определяет физическую связь с конкретным финансовым устройством или службой.

Процесс финансовой регистрации для конкретной ККМ POS определяется соответствующим параметром в профиле функциональности POS. Дополнительные сведения о настройке процесса финансовой регистрации, отправки конфигураций поставщиков фискальных документов и финансовых соединителей и изменению параметров конфигурации см. в разделе [Настройка процесса финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

> [!NOTE]
> Если нужны устройства для операций, не связанных с финансами, таких как поиск в каталоге продуктов, поиск клиента или создание черновика проводки, их можно выбрать как терминалы с ограничениями финансовых процессов. Дополнительные сведения см. в разделе [Настройка терминалов с ограничениями финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-registers-with-fiscal-registration-restrictions).

Следующий типичный поток финансовой регистрации начинается с события в POS (например, завершение проводки по продажам) и реализует заранее определенную последовательность шагов, в которой участвуют другие компоненты Commerce (такие как CRT и Hardware Station).

1. POS запрашивает финансовый документ из структуры финансовой интеграции (FIF).
1. FIF определяет, требуется ли финансовая регистрация текущего события.
1. В зависимости от параметров процесса финансовой регистрации FIF определяет финансовый соединитель и соответствующий поставщик фискальных документов для использования для финансовой регистрации.
1. FIF запускается поставщик фискальных документов, который создает фискальный документ (например, документ XML), представляющий проводку или событие.
1. FIF возвращает созданный фискальный документ в POS.
1. POS запрашивает, чтобы FIF отправил финансовый документ в финансовое устройство или службу.
1. FIF запускает финансовый соединитель, который обрабатывает фискальный документ и передает его финансовому устройству или службе.
1. FIF возвращает финансовый ответ (то есть, отклик финансового устройства или службы) в POS.
1. POS анализирует финансовый ответ для определения того, была ли финансовая регистрация успешной. По мере необходимости, POS запрашивает, чтобы FIF обрабатывал все произошедшие ошибки. 
1. POS запрашивает процесс FIF и сохраняет финансовый ответ.
1. Поставщик финансовых документов обрабатывает финансовый ответ. В ходе этой обработки поставщик финансового документа анализирует ответ и извлекает из него расширенные данные.
1. FIF сохраняет ответ и расширенные данные в базе данных канала.
1. При необходимости в POS выполняется печать чека через стандартный принтер чеков, который подключен к Hardware Station. Чек может содержать необходимые данные из финансового ответа.
 
В следующих примерах показаны потоки выполнения финансовой регистрации для стандартных финансовых устройств или служб.
 
### <a name="fiscal-registration-is-done-via-a-device-connected-to-the-hardware-station"></a>Финансовая регистрация выполняется через устройство, подключенное к Hardware Station.

Эта конфигурация используется, когда физическое финансовое устройство, например, фискальный принтер, подсоединено к Hardware Station. Это также применяется, когда обмен данными с финансовым устройством или службой осуществляется через программное обеспечение, установленное на Hardware Station. В этом случае поставщик финансового документа находится в CRT, а финансовый соединитель находится на Hardware Station.

![Финансовая регистрация выполняется через устройство, подключенное к Hardware Station.](media/FIF-CRT-HWS.png)

### <a name="fiscal-registration-is-done-via-an-external-service"></a>Финансовая регистрация выполняется с помощью внешней службы

Эта конфигурация используется, когда финансовая регистрация выполняется через внешнюю службу, например, веб-службу, управляемую налоговыми органами. В этом случае и поставщик финансового документа и финансовый соединитель находятся в CRT.

![Финансовая регистрация выполняется с помощью внешней службы.](media/FIF-CRT-CRT.png)
 
### <a name="fiscal-registration-is-done-internally-in-the-crt"></a>Финансовая регистрация выполняется внутри CRT

Эта конфигурация используется, когда для финансовой регистрации не требуются внешние фискальные устройства или службы. Например, она используется, когда выполняется финансовая регистрация с использованием цифровых подписей проводок по продажам. В этом случае и поставщик финансового документа и финансовый соединитель находятся в CRT.

![Финансовая регистрация выполняется внутри CRT.](media/FIF-CRT-CRT-SGN.png)

### <a name="fiscal-registration-is-done-via-a-device-or-service-in-the-local-network"></a>Финансовая регистрация выполняется через устройство или службу в локальной сети

Эта конфигурация используется при наличии физического фискального устройства или фискальной службы в локальной сети магазина и обеспечивает API HTTPS. В этом случае поставщик финансового документа находится в CRT, а финансовый соединитель находится в POS.

![Финансовая регистрация выполняется через устройство или службу в локальной сети.](media/FIF-CRT-POS.png)

## <a name="error-handling"></a>Обработка ошибок

Платформа финансовой интеграции предоставляет следующие параметры для обработки ошибок во время финансовой регистрации:

- **Повторить** — оператор может использовать этот параметр, если сбой можно быстро устранить, и финансовую регистрацию можно перезапустить. Например, этот параметр используется, если финансовое устройство не подключено, в финансовом принтере нет бумаги или существует замятие бумаги в финансовом принтере.
- **Отмена** — этот параметр позволяет оператору отсрочить финансовую регистрацию текущей проводки или события в случае неудачи. После того как регистрация отложена, оператор можно продолжить работу с POS и выполнить любую операцию, для которой не требуется финансовая регистрация. При возникновении любого события, которое требует финансовой регистрации в POS (например, открывается новая проводка), автоматически отображается диалоговое окно обработки ошибок, чтобы уведомить оператора о том, что предыдущая проводка не была правильно зарегистрирована, и предоставить параметры обработки ошибок.
- **Пропустить** — оператор может использовать этот параметр, когда невозможно выполнить финансовую регистрацию текущей проводки или события, например, если финансовый принтер не работает **и** финансовую регистрацию можно пропустить при определенных условиях. Например, этот параметр может использоваться, когда проводка по продажам, для которой финансовая регистрация закончилась сбоем, может быть зарегистрирована в специальном бумажном журнале. После пропуска финансовой регистрации на POS-терминале могут быть продолжены обычные операции. 
- **Пометить как зарегистрированный** — оператор может использовать этот параметр, когда текущая проводка или событие фактически были зарегистрированы в финансовом устройстве (например, фискальный чек был распечатан), но произошел сбой при сохранении финансового ответа в базе данных канала. После пометки текущей проводки или события как зарегистрированного на POS-терминале могут быть продолжены обычные операции.
- **Отложить** — оператор может использовать этот параметр, если проводка не была зарегистрирована, так как устройство или служба регистрации недоступны **и** выполняется одно из следующих условий:
    - Имеется резервная возможность финансовой регистрации и можно продолжить процесс финансовой регистрации для текущей проводки. Например, локальное [финансовое устройство](./latam-bra-cf-e-sat.md#scenario-4-make-a-cash-and-carry-sale-of-goods-by-using-sat-as-contingency-mode) может быть таким вариантом для онлайн-службы финансовой регистрации, которая недоступна.
    - Финансовую регистрацию можно выполнить позже другими способами, отличными от платформы финансовой интеграции. Например, отложенные проводки могут позднее регистрироваться пакетно с помощью [отдельных функций](./latam-bra-nfce.md#scenario-3-make-a-cash-and-carry-sale-of-goods-in-offline-contingency-mode).
    
    После откладывания текущей проводки или события на POS-терминале могут быть продолжены обычные операции.

> [!WARNING]
> Параметры **Пропустить**, **Пометить как зарегистрированные** и **Отложить** должны рассматриваться как экстренные решения, которые используются только в исключительных случаях. Обсудите эти варианты обработки ошибок с юридическим или налоговым помощником и руководствуйтесь здравым смыслом, применяя их. Эти параметры нужно активировать в процессе финансовой регистрации перед их использованием. Чтобы операторы не использовали их регулярно, соответствующие разрешения должны быть предоставлены операторам.

[Финансовая проводка](#storing-fiscal-response-in-fiscal-transaction) создается тогда, когда выбраны параметры **Пропустить**, **Пометить как зарегистрированные** или **Отложить**, но финансовая проводка не содержит финансового ответа. Это позволяет регистрировать событие сбоя финансовой регистрации. Эти параметры также включают информационные коды для регистрации некоторых конкретных сведений о сбое, например причину ошибки или обоснование пропуска финансовой регистрации или пометки проводки как зарегистрированной. Дополнительные сведения о том, как настроить параметры обработки ошибок, см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

### <a name="optional-fiscal-registration"></a>Необязательная финансовая регистрация

Финансовая регистрация может быть обязательной для некоторых операций, но необязательной для других. Например, финансовая регистрация регулярных продаж и возвратов может быть обязательной, но финансовая регистрация операций, которые относятся к депозитам клиентов, может быть необязательной. В этом случае если финансовая регистрация продажи не завершена, следует блокировать дальнейшую продажу, но отсутствие финансовой регистрации депозита клиента не должно блокировать дальнейшие продажи. Чтобы различать обязательные и необязательные операции, рекомендуется обрабатывать их через разных поставщиков документов, а также настроить отдельные шаги в процессе финансовой регистрации для этих поставщиков. Параметр **Продолжать при ошибках** должен быть включен для любого шага, связанного с необязательной финансовой регистрацией. Дополнительные сведения о том, как настроить параметры обработки ошибок, см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

### <a name="manually-rerun-fiscal-registration"></a>Повторное выполнение финансовой регистрации вручную

Если финансовая регистрация проводки или события была отложена после сбоя (например, если оператор выбрал **Отменить** в диалоговом окне обработки ошибок), можно вручную повторно выполнить финансовую регистрацию путем вызова соответствующей операции. Дополнительные сведения см. в разделе [Включение выполнения вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-deferred-fiscal-registration).

### <a name="fiscal-registration-health-check"></a>Проверка состояния финансовой регистрации

Процедуру проверки состояния для финансовых регистраций проверяет доступность финансового устройства или службы при возникновении определенных событий. Если финансовая регистрация в настоящее время не может быть выполнена, оператор уведомляется заранее.

POS выполняет проверку состояния при возникновении следующих событий:

- Открыта новая проводка.
- Повторно вызвана приостановленная проводка.
- Проводка продажи или возврата завершена.

В случае сбоя проверки состояния POS открывает диалоговое окно проверки состояния. Это диалоговое окно содержит следующие кнопки:

- **ОК** — данная кнопка позволяет оператору пропустить ошибку проверки состояния и продолжить выполнение операции. Операторы могут выбрать эту кнопку только тогда, когда для них включено разрешение **Разрешить пропускать ошибки проверки состояния**.
- **Отмена** — если оператор выбирает эту кнопку, POS отменяет последнее действие (например, элемент не добавляется в новую проводку).

> [!NOTE]
> Проверка работоспособности выполняется только в том случае, если текущая операция требует финансовой регистрации, и если параметр **Продолжать при ошибках** отключен для текущего этапа процесса финансовой регистрации. Дополнительные сведения см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

## <a name="storing-fiscal-response-in-fiscal-transaction"></a>Сохранение финансового ответа в финансовой проводке

При успешной финансовой регистрации проводки или события финансовая проводка создается в базе данных канала и связывается с исходной проводки или событием. Аналогичным образом, если выбран параметр **Пропустить**, **Пометить как зарегистрированные** или **Отложить** для неудачной финансовой регистрации, эта информация сохраняется в финансовой проводке. Финансовая проводка содержит финансовый ответ финансового устройства или службы. Если процесс финансовой регистрации состоит из нескольких шагов, финансовая проводка создается для каждого шага процесса, который привел к успешной и неудачной регистрации.

Финансовые проводки переносятся в Headquarters с помощью *P-задания*, вместе с проводками. На экспресс-вкладке **Финансовые проводки** страницы **Проводки магазина** можно просмотреть финансовые проводки, которые связаны с проводкой розничной торговли.

В финансовой проводке хранятся следующие сведения:

- Сведения о процессе финансовой регистрации (процесс, группа соединителей, соединитель и т. д.). В них также хранятся серийный номер финансового устройства в поле **Номер регистратора**, если эти сведения включаются в финансовый ответ.
- Статус финансовой регистрации: **Завершено** для успешной регистрации, **Пропущено**, если оператор выбрал параметр **Пропустить** для сбойной регистрации, **Помечено как зарегистрированный**, если оператор выбрал параметр **Пометить как зарегистрированный** или **Отложить**, если оператор выбрал параметр **Отложить**.
- Проводки информационных кодов, связанных с выбранной финансовой проводкой. Для просмотра проводок информационных кодов на экспресс-вкладке **Финансовые проводки** выберите финансовую проводку, которая имеет статус **Пропущено**, **Помечено как зарегистрированный** или **Отложить**, затем выберите **Проводки с инфокодом**.

Выбрав **Расширенные данные**, можно также просмотреть некоторые свойства финансовой проводки. Список свойств, которые можно просмотреть, относится к функции финансовой регистрации, создавшей финансовую проводку. Например, можно просмотреть цифровую подпись, последовательный номер, отпечаток сертификата, идентификатор алгоритма хеширования, а также другие свойства финансовой проводки для функции цифровых подписей для Франции.

## <a name="fiscal-texts-for-discounts"></a>Финансовые тексты для скидок

В некоторых странах или регионах имеются особые требования к дополнительным текстам, который должен быть напечатан на финансовых чеках, когда применяются различные виды скидок. Функции финансовой интеграции позволяют настроить специальный текст для скидки, который будет печататься после строки скидки на фискальном чеке. Для ручных скидок можно настроить финансовый текст для информационного кода, который указан в качестве информационного кода **Скидка для продукта** в профиле функциональности POS. Дополнительную информацию о том, как настроить финансовые тексты для скидок, см. в разделе [Настройка финансовых текстов для скидок](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-texts-for-discounts).

## <a name="printing-fiscal-x-and-fiscal-z-reports"></a>Печать финансовых X- и Z-отчетов

Функциональные возможности финансовой интеграции поддерживают создание отчетов на конец дня, которые относятся к конкретному интегрированному финансовому устройству или службе:

- Новые кнопки, которые выполняют соответствующие операции, должны быть добавлены в макет экрана POS. Дополнительные сведения см. в разделе [Настройка финансовых X-/Z-отчетов с POS](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-xz-reports-from-the-pos).
- В примере финансовой интеграции этих операции должны соответствовать соответствующим операциям финансового устройства.

## <a name="fiscal-integration-samples-in-the-commerce-sdk"></a>Примеры финансовой интеграции в пакете Commerce SDK

Следующие примеры финансовой интеграции в настоящее время доступны в Commerce SDK:

- [Пример интеграции фискальных принтеров для Италии](./emea-ita-fpi-sample.md)
- [Пример интеграции фискальных принтеров для Польши](./emea-pol-fpi-sample.md)
- [Пример интеграции службы финансовой регистрации для Австрии](./emea-aut-fi-sample.md)
- [Пример интеграции службы финансовой регистрации для Чешской Республики](./emea-cze-fi-sample.md)
- [Пример интеграции с блоком управления для Швеции](./emea-swe-fi-sample.md)
- [Пример интеграции службы финансовой регистрации для Германии](./emea-deu-fi-sample.md)
- [Пример интеграции фискальных принтеров для России](./rus-fpi-sample.md)

Следующие функции финансовой интеграции также реализуются с помощью инфраструктуры финансовой интеграции, но она доступна в готовом виде и не включается в Commerce SDK:

- [Финансовая регистрация для Бразилии](./latam-bra-commerce-localization.md#fiscal-registration-for-brazil)
- [Цифровая подпись для Франции](./emea-fra-cash-registers.md)

Следующие функциональные возможности финансовой интеграции также доступны в пакете Commerce SDK, но в данный момент не используют преимущества платформы финансовой интеграции. Перенос этих финансовых возможностей в платформу финансовой интеграции планируется в последующих обновлениях.

- [Цифровая подпись для Норвегии](./emea-nor-cash-registers.md)

Следующие устаревшие функции финансовой интеграции, доступные в Commerce SDK, не используют структуру финансовой интеграции и будут удалены в последующих обновлениях:

- [Пример интеграции с блоком управления для Швеции (устар.)](./retail-sdk-control-unit-sample.md)
- [Цифровая подпись для Франции (устарело)](./emea-fra-deployment.md)

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
