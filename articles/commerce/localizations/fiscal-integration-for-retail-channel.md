---
title: Обзор финансовой интеграции для каналов Commerce
description: В этом разделе представлен обзор возможностей финансовой интеграции, доступных в Dynamics 365 Commerce.
author: josaw
manager: annbe
ms.date: 02/01/2019
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
ms.search.form: RetailFunctionalityProfile, RetailFormLayout, RetailParameters
audience: Application User
ms.reviewer: josaw
ms.search.region: Global
ms.search.industry: Retail
ms.author: epopov
ms.search.validFrom: 2019-1-16
ms.dyn365.ops.version: 10
ms.openlocfilehash: d766515d82e021f41e0cc0a9a877f25551817ad5
ms.sourcegitcommit: eaf330dbee1db96c20d5ac479f007747bea079eb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/15/2021
ms.locfileid: "5250838"
---
# <a name="overview-of-fiscal-integration-for-commerce-channels"></a>Обзор финансовой интеграции для каналов Commerce

[!include [banner](../includes/banner.md)]

## <a name="introduction"></a>Введение

В этом разделе представлен обзор возможностей финансовой интеграции, доступных в Dynamics 365 Commerce. Финансовая интеграция включает интеграцию с различными финансовыми устройствами и службами, которые обеспечивают финансовую регистрации продаж в соответствии с местным финансовым законодательством, предназначенным для предотвращения налогового мошенничества в сфере розничной торговли. Вот некоторые типичные сценарии, которые могут охватываться с помощью финансовой интеграции:

- Регистрация продажи на финансовом устройстве, подключенном к POS-терминалу, такому как фискальный принтер, и печать фискального чека для клиента.
- Безопасная подача информации, которая относится к продажам и возвратам, выполняемым в Retail POS, во внешнюю веб-службу, которая принадлежит налоговым органам.
- Помощь в обеспечении невозможности изменения данных проводок продаж с помощью цифровых подписей.

Функция финансовой интеграции — это платформа, которая предоставляет общее решение для дальнейшей разработки и настройки интеграции между Retail POS и финансовыми устройствами и службами. Функциональные возможности также включают примеры финансовой интеграции, поддерживающие основные сценарии для конкретных стран или регионов, и работающие с конкретными финансовыми устройствами или службами. Образец финансовой интеграции состоит из нескольких расширений компонентов Commerce и включается в комплект средств разработки программного обеспечения (SDK). Дополнительные сведения о примерах финансовой интеграции см. в разделе [Примеры финансовой интеграции в пакете Retail SDK](#fiscal-integration-samples-in-the-retail-sdk). Сведения о том, как установить и использовать пакет Retail SDK см. в разделе [Архитектура комплекта средств разработки программного обеспечения (SDK) для Retail](../dev-itpro/retail-sdk/retail-sdk-overview.md).

Для поддержки других сценариев, которые не поддерживаются примером финансовой интеграции, для интеграции Retail POS с другими финансовыми устройствами или службами или для покрытия потребностей в других странах или регионах необходимо расширить существующий пример финансовой интеграции или создать новый пример на основе существующего образца в качестве примера.

## <a name="fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices"></a>Примеры процесса финансовой регистрации и финансовой интеграции для финансовых устройств

Процесс финансовой регистрации в Retail POS может состоять из одного или нескольких шагов. Каждый шаг включает финансовую регистрацию конкретных проводок или событий в одном финансовом устройстве или службе. Следующие компоненты решения участвуют в финансовой регистрации в финансовом устройстве, подключенном к станции Hardware Station:

- **Расширение Commerce Runtime (CRT)** — этот компонент сериализует данные о проводке или событии в формат, который также используется для взаимодействия с финансовым устройством, анализирует ответы от финансового устройства и сохраняет ответы в базе данных канала. Расширения также определяет конкретные проводки и события, которые должны быть зарегистрированы. Данный компонент часто называется также *поставщиком фискальных документов*.
- **Расширение Hardware Station** — этот компонент инициализирует связь с финансовым устройством, отправляя запросы и прямые команды на финансовое устройство на основе данных проводки/события, которые извлекаются из финансового документа, и получает ответы от финансового устройства. Данный компонент часто называется *финансовым соединителем*.

Пример финансовой интеграции для финансового устройства содержит расширения CRT и Hardware Station для поставщика фискальных документов и финансового соединителя, соответственно. Он также содержит следующие конфигурации компонентов:

- **Конфигурация поставщика фискальных документов** — эта конфигурация определяет метод вывода и формат финансовых документов. Он также содержит сопоставление данных для налогов и способов оплаты, чтобы сделать данные с Retail POS совместимыми со значениями, которые заранее определены во встроенном ПО финансового устройства.
- **Конфигурация финансового соединителя** — эта конфигурация определяет физическую связь с конкретным финансовым устройством.

Процесс финансовой регистрации для конкретной ККМ POS определяется соответствующим параметром в профиле функциональности POS. Дополнительные сведения о настройке процесса финансовой регистрации, отправки конфигураций поставщиков фискальных документов и финансовых соединителей и изменению их параметров см. в разделе [Настройка процесса финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

В следующем примере показан типовой порядок выполнения финансовой регистрации для финансового устройства. Поток начинается с события в POS-терминале (например, завершение проводки продажи) и реализует следующую последовательность действий:

1. POS-терминал запрашивает финансовый документ из CRT.
2. CRT определяет, требуется ли финансовая регистрация текущего события.
3. В зависимости от параметров процесса финансовой регистрации CRT определяет финансовый соединитель и соответствующий поставщик фискальных документов для использования для финансовой регистрации.
4. CRT запускается поставщик фискальных документов, который создает фискальный документ (например, документ XML), представляющий проводку или событие.
5. POS-терминал отправляет фискальный документ, который подготовил CRT, в Hardware Station.
6. Hardware Station запускает финансовый соединитель, который обрабатывает фискальный документ и передает его финансовому устройству или службе.
7. POS-терминал анализирует ответ от финансового устройства или службы, чтобы определить, успешно ли выполнена финансовая регистрация.
8. CRT сохраняет ответ в базе данных канала.

![Схема решения](media/emea-fiscal-integration-solution.png "Схема решения")

## <a name="error-handling"></a>Обработка ошибок

Платформа финансовой интеграции предоставляет следующие параметры для обработки ошибок во время финансовой регистрации:

- **Повторить** — операторы могут использовать этот параметр, если сбой можно быстро устранить, и финансовую регистрации можно перезапустить. Например, этот параметр используется, если финансовое устройство не подключено, в финансовом принтере нет бумаги или существует замятие бумаги в финансовом принтере.
- **Отмена** — этот параметр позволяет оператору отсрочить финансовую регистрацию текущей проводки или события в случае неудачи. После того как регистрация отложена, оператор можно продолжить работу с POS и выполнить любую операцию, для которой не требуется финансовая регистрация. При возникновении любого события, которое требует финансовой регистрации в POS (например, открывается новая проводка), автоматически отображается диалоговое окно обработки ошибок, чтобы уведомить оператора о том, что предыдущая проводка не была правильно зарегистрирована, и предоставить параметры обработки ошибок.
- **Пропустить** — операторы могут использовать этот параметр, когда финансовая регистрация может быть пропущена при определенных условиях и обычные операции могут быть продолжены на POS-терминале. Например, этот параметр может использоваться, когда проводка по продажам, для которой финансовая регистрация закончилась сбоем, может быть зарегистрирована в специальном бумажном журнале.
- **Пометить как зарегистрированный** — операторы могут использовать этот параметр, когда проводка фактически была зарегистрирована в финансовом устройстве (например, фискальный чек был распечатан), но произошел сбой при сохранении финансового ответа в базе данных канала.

> [!NOTE]
> Параметры **Пропустить** и **Пометить как зарегистрированный** необходимо активировать в процессе финансовой регистрации перед их использованием. Кроме того, операторам должны быть присвоены соответствующие разрешения.

Параметры **Пропустить** и **Пометить как зарегистрированный** включают информационные коды для регистрации некоторых конкретных сведений о сбое, например причину ошибки или обоснование пропуска финансовой регистрации или пометки проводки как зарегистрированной. Дополнительные сведения о том, как настроить параметры обработки ошибок, см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

### <a name="optional-fiscal-registration"></a>Необязательная финансовая регистрация

Финансовая регистрация может быть обязательной для некоторых операций, но необязательной для других. Например, финансовая регистрация регулярных продаж и возвратов может быть обязательной, но финансовая регистрация операций, которые относятся к депозитам клиентов, может быть необязательной. В этом случае если финансовая регистрация продажи не завершена, следует блокировать дальнейшую продажу, но отсутствие финансовой регистрации депозита клиента не должно блокировать дальнейшие продажи. Чтобы различать обязательные и необязательные операции, рекомендуется обрабатывать их через разных поставщиков документов, а также настроить отдельные шаги в процессе финансовой регистрации для этих поставщиков. Параметр **Продолжать при ошибках** должен быть включен для любого шага, связанного с необязательной финансовой регистрацией. Дополнительные сведения о том, как настроить параметры обработки ошибок, см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

### <a name="manually-running-fiscal-registration"></a>Выполнение финансовой регистрации вручную

Если финансовая регистрация проводки или события была отсрочена после сбоя (например, если оператор выбрал **Отменить** в диалоговом окне обработки ошибок), можно вручную повторно выполнить финансовую регистрацию путем вызова соответствующей операции. Дополнительные сведения см. в разделе [Включение выполнения вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration).

### <a name="fiscal-registration-health-check"></a>Проверка состояния финансовой регистрации

Процедуру проверки состояния для финансовых регистраций проверяет доступность финансового устройства или службы при возникновении определенных событий. Если финансовая регистрация в настоящее время не может быть выполнена, оператор уведомляется заранее.

POS выполняет проверку состояния при возникновении следующих событий:

- Открыта новая проводка.
- Повторно вызвана приостановленная проводка.
- Проводка продажи или возврата завершена.

В случае сбоя проверки состояния POS открывает диалоговое окно проверки состояния. Это диалоговое окно содержит следующие кнопки:

- **ОК** — данная кнопка позволяет оператору пропустить ошибку проверки состояния и продолжить выполнение операции. Операторы могут выбрать эту кнопку только тогда, когда для них включено разрешение **Разрешить пропускать ошибки проверки состояния**.
- **Отмена** — если оператор выбирает эту кнопку, POS отменяет последнее действие (например, элемент не добавляется в новую проводку).

> [!NOTE]
> Проверка работоспособности выполняется только в том случае, если текущая операция требует финансовой регистрации, и если параметр **Продолжать при ошибках** отключен для текущего этапа процесса финансовой регистрации. Дополнительные сведения см. в разделе [Задание параметров обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

## <a name="storing-fiscal-response-in-fiscal-transaction"></a>Сохранение финансового ответа в финансовой проводке

При успешной финансовой регистрации проводки или события финансовая проводка создается в базе данных канала и связывается с исходной проводки или событием. Аналогичным образом, если выбран параметр **Пропустить** или **Пометить как зарегистрированный** для сбойной финансовой регистрации, эта информация сохраняется в финансовой проводке. Финансовая проводка содержит финансовый ответ финансового устройства или службы. Если процесс финансовой регистрации состоит из нескольких шагов, финансовая проводка создается для каждого шага процесса, который привел к успешной и неудачной регистрации.

Финансовые проводки переносятся в Headquarters с помощью *P-задания*, вместе с проводками. На экспресс-вкладке **Финансовые проводки** страницы **Проводки магазина** можно просмотреть финансовые проводки, которые связаны с проводкой розничной торговли.

В финансовой проводке хранятся следующие сведения:

- Сведения о процессе финансовой регистрации (процесс, группа соединителей, соединитель и т. д.). В них также хранятся серийный номер финансового устройства в поле **Номер регистратора**, если эти сведения включаются в финансовый ответ.
- Статус финансовой регистрации: **Завершено** для успешной регистрации, **Пропущено**, если оператор выбрал параметр **Пропустить** для сбойной регистрации, или **Помечено как зарегистрированный**, если оператор выбрал параметр **Пометить как зарегистрированный**.
- Проводки информационных кодов, связанных с выбранной финансовой проводкой. Для просмотра проводок информационных кодов на экспресс-вкладке **Финансовые проводки** выберите финансовую проводку, которая имеет статус **Пропущено** или **Помечено как зарегистрированный**, затем выберите **Проводки с инфокодом**.

## <a name="fiscal-texts-for-discounts"></a>Финансовые тексты для скидок

В некоторых странах или регионах имеются особые требования к дополнительным текстам, который должен быть напечатан на финансовых чеках, когда применяются различные виды скидок. Функции финансовой интеграции позволяют настроить специальный текст для скидки, который будет печататься после строки скидки на фискальном чеке. Для ручных скидок можно настроить финансовый текст для информационного кода, который указан в качестве информационного кода **Скидка для продукта** в профиле функциональности POS. Дополнительную информацию о том, как настроить финансовые тексты для скидок, см. в разделе [Настройка финансовых текстов для скидок](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-texts-for-discounts).

## <a name="printing-fiscal-x-and-fiscal-z-reports"></a>Печать финансовых X- и Z-отчетов

Функциональные возможности финансовой интеграции поддерживают создание отчетов на конец дня, которые относятся к конкретному интегрированному финансовому устройству или службе:

- Новые кнопки, которые выполняют соответствующие операции, должны быть добавлены в макет экрана POS. Дополнительные сведения см. в разделе [Настройка финансовых X-/Z-отчетов с POS](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-xz-reports-from-the-pos).
- В примере финансовой интеграции этих операции должны соответствовать соответствующим операциям финансового устройства.

## <a name="fiscal-integration-samples-in-the-retail-sdk"></a>Примеры финансовой интеграции в пакете Retail SDK

Следующие примеры финансовой интеграции в настоящее время доступны в Retail SDK:

- [Пример интеграции фискальных принтеров для Италии](emea-ita-fpi-sample.md)
- [Пример интеграции фискальных принтеров для Польши](emea-pol-fpi-sample.md)
- [Пример интеграции службы финансовой регистрации для Австрии](emea-aut-fi-sample.md)
- [Пример интеграции службы финансовой регистрации для Чешской Республики](emea-cze-fi-sample.md)
- [Пример интеграции с блоком управления для Швеции](./emea-swe-fi-sample.md)
- [Пример интеграции службы финансовой регистрации для Германии](./emea-deu-fi-sample.md)

Следующие функциональные возможности финансовой интеграции также доступны в пакете Retail SDK, но в данный момент не используют преимущества платформы финансовой интеграции. Перенос этих финансовых возможностей в платформу финансовой интеграции планируется в последующих обновлениях.


- [Цифровая подпись для Франции](emea-fra-cash-registers.md)
- [Цифровая подпись для Норвегии](emea-nor-cash-registers.md)

Следующие устаревшие функции финансовой интеграции, доступные в Retail SDK, не используют структуру финансовой интеграции и будут удалены в последующих обновлениях:

- [Пример интеграции с блоком управления для Швеции (устар.)](./retail-sdk-control-unit-sample.md)


[!INCLUDE[footer-include](../../includes/footer-banner.md)]