---
title: Определенные пользователем профили сертификатов для розничных магазинов
description: В этом разделе представлен обзор использования сертификатов в розничных магазинах.
author: josaw
manager: annbe
ms.date: 10/09/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
ms.search.form: RetailFormLayout, RetailParameters
audience: Application User
ms.reviewer: josaw
ms.search.region: Global
ms.search.industry: Retail
ms.author: epopov
ms.search.validFrom: 2020-10-09
ms.dyn365.ops.version: 10.0.15
ms.openlocfilehash: 81fa3770a137471e3d7f8cab3c7d7f37febe64fa
ms.sourcegitcommit: deac22ba5377a912d93fe408c5ae875706378c2d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "5018876"
---
# <a name="user-defined-certificate-profiles-for-retail-stores"></a>Определенные пользователем профили сертификатов для розничных магазинов

[!include [banner](../includes/banner.md)]


## <a name="overview"></a>Обзор

В этом разделе представлен обзор профилей сертификатов, доступных в Microsoft Dynamics 365 Commerce. Эта функция расширяет функцию [Управление секретами для розничных каналов](../dev-itpro/manage-secrets.md) путем добавления поддержки локальных сертификатов.

Когда POS-терминал работает в автономном режиме, он не может получить доступ к сертификатам, хранящимся в этом хранилище ключей. Вместо этого следует использовать локальный сертификат. Поддерживаются следующие возможности:

- Использование локальных сертификатов в сценариях резервного хранилища ключей
- Использование локальных сертификатов без хранилища ключей (например, в локальной установке)
- Постепенное обновление сертификатов, где некоторые магазины и терминалы используют новую версию сертификата, но другие магазины и терминалы продолжают использовать предыдущую версию

Функция профилей сертификатов позволяет указать сертификат по умолчанию и задать порядок поиска сертификатов в одном и том же профиле сертификатов. Эта функция также обеспечивает аналогичный подход к настройке для локальных сертификатов и сертификатов из хранилища ключей. Для сертификатов можно добавлять параметры, специфические для компании, но уникальный межфирменный идентификатор для каждого сертификата можно использовать в каналах Commerce.

### <a name="scenarios"></a>Сценарии

Функциональность профилей сертификатов поддерживает следующие сценарии в каналах Commerce:

- Использование локального сертификата в сценариях резервного хранилища ключей. Ниже приведены несколько примеров таких резервных сценариев:

    - Хранилище ключей недоступно.
    - Сертификат не найден в хранилище ключей.
    - POS-терминал работает в автономном режиме.

- Использование локальных сертификатов, но без хранения их в хранилище ключей (например, в локальной установке).
- Выполнение постепенного обновления сертификатов, когда новая версия сертификата используется только в магазинах или на терминалах, в которых уже доступна новая версия.
- Использование одного и того же сертификата в нескольких компаниях.

## <a name="set-up-certificate-profiles"></a>Настройка профилей сертификатов

В следующей процедуре описан порядок настройки профилей сертификатов. Прежде чем использовать профили сертификатов в каналах Commerce, выполните следующие шаги, чтобы настроить параметры.

1. В рабочей области **Управление функциями** включите функцию **Определяемые пользователем профили сертификатов для розничных магазинов**.
2. Перейдите в раздел **Администрирование системы \> Настройка \> Профили сертификатов**.
3. Создайте запись и задайте для нее поля **Профиль сертификата**, **Имя** и **Описание**.

    > [!NOTE]
    > Профиль сертификата является уникальным идентификатором сертификата во всех компаниях и компонентах Commerce.

3. На вкладке **Юридические лица** добавьте строку и выберите юридическое лицо (компанию), для которого должен использоваться текущий профиль сертификатов. Если профиль сертификатов должен использоваться для нескольких юридических лиц, повторите этот шаг, чтобы добавить строку для каждого дополнительного юридического лица.
4. Выберите **Параметры**, чтобы открыть страницу **Параметры профиля сертификатов**, на которой можно ввести параметры профиля сертификатов для конкретного компании.

### <a name="certificate-profile-settings"></a>Параметры профиля сертификата

При выборе пункта **Параметры** для строк профиля сертификатов отображается страница **Параметры профиля сертификатов**. Эта страница позволяет указать, какие сертификаты могут использоваться при вызове текущего профиля сертификатов в каналах Commerce. Можно также указать порядок, в котором должен выполняться поиск сертификатов.

> [!NOTE]
> Поле **Приоритет** устанавливается автоматически. Значение **1** соответствует наивысшему приоритету. При добавлении новой строки на странице **Параметры профиля сертификата** для ее приоритета устанавливается число, которое на единицу больше приоритета предыдущей строки. Чтобы изменить приоритет определенной строки, выберите строку, затем выберите либо **Переместить вверх**, чтобы увеличить приоритет, либо **Переместить вниз**, чтобы уменьшить приоритет.

При добавлении новой строки на страницу **Параметры профиля сертификатов** задайте следующие поля:

- **Тип местоположения** — выберите местоположение, в котором хранится сертификат. У этого поля есть два возможных значения: **Локальный сертификат** и **Хранилище ключей**.
- **Сертификат хранилища ключей** — это поле является обязательным, если в поле **Тип местоположения** указано значение **Хранилище ключей**. Используйте его для указания секрета сертификата хранилища ключей.

    > [!NOTE]
    > Прежде чем использовать сертификат хранилища ключей в профилях сертификатов, необходимо отправить сертификат в хранилище ключей и следовать инструкциям в разделе [Настройка клиента Azure Key Vault](https://docs.microsoft.com/dynamics365/finance/localizations/setting-up-azure-key-vault-client).

- **Имя хранилища** — это поле является необязательным и доступно только в том случае, если в поле **Тип местоположения** задано значение **Локальный сертификат**. Используйте его для указания имени хранилища по умолчанию, которое должно использоваться для поиска локальных сертификатов.
- **Местоположение хранилища** — это поле является необязательным и доступно только в том случае, если в поле **Тип местоположения** задано значение **Локальный сертификат**. Используйте его для указания местоположения хранилища по умолчанию, которое должно использоваться для поиска локальных сертификатов.

    > [!NOTE]
    > Для упрощения процесса поиска локальных сертификатов в Commerce Runtime добавлены имя хранилища и местоположение хранилища по умолчанию. X509StoreProvider содержит список папок, в которых хранятся сертификаты. Если не указано имя хранилища по умолчанию и местоположение хранилища по умолчанию, X509StoreProvider пытается найти сертификат в других папках в своем списке.

- **Отпечаток** — это поле является обязательным и доступно только в том случае, если в поле **Тип местоположения** задано значение **Локальный сертификат**. Используйте его для указания отпечатка сертификата.
- **Комментарии** — это поле является необязательным и позволяет пользователям вводить примечания.

### <a name="workflow-searching-certificates-in-the-commerce-runtime"></a>Рабочий процесс: поиск сертификатов в Commerce Runtime

Ниже приводится основной рабочий процесс, используемый для поиска сертификата при вызове профиля сертификата в среде Commerce Runtime.

1. Система определяет, имеет ли профиль сертификата специфические для компании параметры для текущего юридического лица.
1. Система пытается найти сертификат, используя значения на странице **Параметры профиля сертификатов** для строки, в поле **Приоритет** которого указано значение **1**.

    - Если для поля **Тип местоположения** задано значение **Key Vault**, значение в поле **Секрет сертификата хранилища ключей** используется для поиска сертификата на странице **Параметры хранилища ключей**. Затем выполняется поиск сертификата в хранилище ключей.
    - Если в поле **Тип местоположения** задано значение **Локальный сертификат**, X509StoreProvider сначала выполняет поиск сертификата, используя имя хранилища и местоположение хранилища по умолчанию, если эти параметры указаны. Затем он выполняет поиск во всех других папках в своем списке папок.

1. Если сертификат не найден, процесс повторяется для строки, в поле **Приоритет** которого установлено значение **2**, и т. д.

> [!NOTE]
> Если профиль сертификата не имеет параметров для текущего юридического лица или если поиск сертификата завершился неудачно для всех строк на странице **Параметры профиля сертификатов**, сертификат не найден.

#### <a name="caching-the-results-of-certificate-searches"></a>Кэширование результатов поиска сертификатов

Результаты поиска сертификатов кэшируются. По умолчанию для кэша используется срок действия один час. Однако это время можно настроить и задать максимальное значение в 24 часа.

### <a name="gradual-update"></a>Постепенное обновление

Если новая версия сертификата введена, но ее невозможно одновременно обновить во всех магазинах, функция профилей сертификатов позволяет постепенно обновлять сертификат.

1. Найдите профиль сертификатов и строку, которую необходимо обновить, затем выберите **Параметры**.
1. Добавьте строку и укажите параметры, которые относятся к последней версии сертификата.
1. Увеличьте значение **Приоритет** для новой строки. Используйте кнопку **Переместить вверх**, чтобы переместить строку так, чтобы она была над строкой предыдущей версии того же сертификата.

> [!NOTE]
> В среде Commerce Runtime новая версия сертификата будет называться первой. Если сертификат еще не был обновлен в конкретном магазине или на конкретном терминале, будет вызвана предыдущая версия.
