---
title: Пример интеграции фискальных принтеров для Польши
description: В этой статье представлен обзор примера финансовой интеграции для Польши в Microsoft Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 10/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2019-02-01.
ms.openlocfilehash: 2f27e5fdcd2b26a0a1651f21436cb4caad501cf8
ms.sourcegitcommit: 2bc6680dc6b12d20532d383a0edb84d180885b62
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2022
ms.locfileid: "9631380"
---
# <a name="fiscal-printer-integration-sample-for-poland"></a>Пример интеграции фискальных принтеров для Польши

[!include [banner](../includes/banner.md)]

В этой статье представлен обзор примера финансовой интеграции для Польши в Microsoft Dynamics 365 Commerce.

Функции Dynamics 365 Commerce для Польши включают в себя пример интеграции POS с финансовым принтером. Образец расширяет [возможности финансовой интеграции](fiscal-integration-for-retail-channel.md) и поддерживает протокол POSNET THERMAL HD 2.02 для финансовых принтеров от [Posnet Polska S.A.](https://www.posnet.com.pl) Пример обеспечивает связь с принтером финансовых данных, подключенным через COM-порт, с помощью собственного программного драйвера. Он было реализовано и проверен с помощью программного эмулятора, который Posnet предоставила для финансового принтера Posnet Thermal HD FV EJ. Пример представлен в форме исходного кода и является частью пакета Commerce SDK.

Корпорация Майкрософт не выпускает никакое оборудование, программное обеспечение или документацию от Posnet. Для получения сведений о получении и работе финансового принтера обратитесь в [Posnet Polska S.A.](https://www.posnet.com.pl)

## <a name="scenarios"></a>Сценарии

Пример интеграции финансового принтера для Польши покрывает следующие сценарии:

- Сценарии продаж:

    - Печать финансового чека для продаж и возвратов с кассовыми проводками.
    - Фиксация отклика от финансового принтера и хранение его в базе данных канала.
    - Налоги:

        - Сопоставление с кодами налога (подразделениями) финансового принтера.
        - Перенос сопоставленных налоговых данных в финансовый принтер.

    - Платежи:

        - Сопоставление с методами платежа для финансового принтера.
        - Печать платежей на финансовом чеке.
        - Печать сведений об изменениях.

    - Печать скидок по строке.
    - Подарочные сертификаты:

        - Исключение выданной или повторно начисленной строки подарочного сертификата из финансового чека для продажи.
        - Печать платежа, в котором используется подарочный сертификат в качестве регулярного метода платежа.

    - Печать финансовых чеков для операций с заказами клиентов:

        - Финансовый чек не печатается для депозита заказа клиента.
        - Печать финансового чека для строк самовывоза гибридного заказа клиента.
        - Печать финансового чека для операции получения для заказа клиента.
        - Печать финансового чека для заказа на возврат.

    - Печать [сведений о клиенте](emea-pol-customer-information.md), указанных для проводки по продажам на финансовом чеке. Примером такой информации является номер плательщика НДС клиента.

- Отчеты на конец дня (финансовые X- и финансовые Z-отчеты).
- Обработка ошибок, например, следующие параметры:

    - Повторите попытку выполнения финансовой регистрации, если это возможно, например, когда финансовый принтер не подключен, не готов или не отвечает, в принтере нет бумаги или в нем застряла бумага.
    - Отложить финансовую регистрацию.
    - Пропустите финансовую регистрацию или пометьте проводку как зарегистрированную и включите коды сведений для фиксации причины сбоя и дополнительной информации.
    - Проверка доступности финансового принтера до открытия новой проводки по продажам или завершения проводки по продажам.

### <a name="gift-cards"></a>Подарочные сертификаты

В образце интеграции финансового принтера реализованы следующие правила, которые относятся к подарочным сертификатам:

- Исключаются строки продаж, которые относятся к *выпуску подарочного сертификата* и *пополнения подарочного сертификата* из финансового чека.
- Не печатать финансовый чек, если он состоит только из строк подарочного сертификата.
- Вычесть общую сумму подарочных сертификатов, которые были выпущены или пополнены в проводке из строк платежа финансового чека.
- Сохранение рассчитанных корректировок строк платежа в базе данных канала со ссылкой на соответствующую финансовую проводку.
- Платеж по подарочным сертификатам считается обычным платежом.

### <a name="customer-deposits-and-customer-order-deposits"></a>Депозиты клиента и депозиты по заказу клиента

В образце интеграции финансового принтера реализованы следующие правила, которые относятся к депозитам клиентов и депозитам заказов клиентов:

- Не печатать финансовый чек, если проводка является депозитом клиента.
- Не печатать финансовый чек, если проводка содержит только депозит по заказу клиента или возврат депозита по заказу клиента.
- Печать суммы ранее оплаченного депозита в финансовом чеке для операции получения заказа клиента.
- Вычесть сумму депозита по заказу клиента из строк платежа, когда создается гибридный заказ клиента.
- Сохранение рассчитанных корректировок строк платежа в базе данных канала со ссылкой на финансовую проводку для гибридного заказа клиента.

### <a name="limitations-of-the-sample"></a>Ограничения примера

- Финансовый принтер поддерживает только ситуации, в которых налог включается в цену. Поэтому параметр **Цена включает налог** должен быть установлен в значение **Да** как для магазинов, так и для клиентов.
- Ежедневные отчеты (фискальные X и фискальные Z) печатаются с использованием внедренного формата *Отчет смены*.
- Печать штрих-кода в финансовых чеках считается потенциальной индивидуальной настройкой, поскольку эта функция не поддерживается во внедренных форматах и может быть реализована только с помощью настраиваемого отчета в **расширенном формате**.
- Фискальный принтер не поддерживает смешанные проводки. Параметр **Запретить смешивание продаж и возвратов в одной приходной накладной** должен иметь значение **Да** в профилях функциональности POS.

## <a name="set-up-fiscal-integration-for-poland"></a>Настройка финансовой интеграции для Польши

Образец интеграции финансового принтера для Польши базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Commerce SDK. Образец находится в папке **src\\FiscalIntegration\\Posnet** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). [Пример](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) состоит из поставщика финансового документа, который является расширением среды выполнения Commerce Runtime (CRT), и финансового соединителя, который является расширением Commerce Hardware Station. Дополнительные сведения об использовании Commerce SDK см. в разделе [Загрузка примеров Commerce SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!NOTE]
> Пример интеграции финансового принтера для Польши доступен в Commerce SDK в Commerce версии 10.0.29. В Commerce версии 10.0.28 и ранее необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Польши (устаревшая версия)](emea-pol-fpi-sample-sdk.md).

Выполните шаги настройки финансовой интеграции, как описано в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md).

1. [Настройте процесс финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Кроме того, запишите настройки для процесса финансовой регистрации, которые [относятся к данному образцу интеграции финансового принтера](#set-up-the-registration-process).
1. [Задайте параметры обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).
1. [Настройте финансовые отчеты X/Z на POS](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-xz-reports-from-the-pos).
1. [Включите выполнение вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-deferred-fiscal-registration).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="set-up-the-registration-process"></a>Настройка процесса регистрации

Чтобы включить процесс регистрации, выполните следующие действия для настройки Commerce Headquarters. Дополнительные сведения см. в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения.
    1. Откройте **src \> FiscalIntegration \> Posnet**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **CommerceRuntime \> DocumentProvider.PosnetSample \> Configuration \> DocumentProviderPosnetSample.xml**.
    1. Загрузите файл конфигурации финансового соединителя по пути **HardwareStation \> ThermalDeviceSample \> Configuration \> ConnectorPosnetThermalFVEJ.xml**.

    > [!NOTE]
    > В Commerce версии 10.0.28 и ранее необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в LCS. Файлы конфигурации для данного образца финансовой интеграции находятся в следующих папках пакета Retail SDK на виртуальной машине для разработчиков в LCS:
    >
    > - **Файл конфигурации поставщика финансовых документов:** RetailSdk\\SampleExtensions\\CommerceRuntime\\Extension.DocumentProvider.PosnetSample\\Configuration\\DocumentProviderPosnetSample.xml
    > - **Файл конфигурации финансового соединителя:** RetailSdk\\SampleExtensions\\HardwareStation\\Extension.Posnet.ThermalDeviceSample\\Configuration\\ConnectorPosnetThermalFVEJ.xml

1. Перейдите в раздел **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя. Выберите поставщика документов и соединитель, который был загружен ранее. При необходимости обновите [параметры сопоставления данных](#default-data-mapping).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите финансовый соединитель, который был загружен ранее. При необходимости обновите [параметры соединителя](#fiscal-connector-settings).
6. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**. Создайте новую группу финансовых соединителей для функционального профиля соединителя, созданного ранее.
7. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
8. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации.
9. Перейдите **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**. Выберите профиль оборудования, который связан с Hardware Station, с которой будет связан фискальный принтер. На экспресс-вкладке **Фискальная периферия** выберите ранее созданный технический профиль соединителя.
10. Откройте график распределения (**Retail и Commerce \> ИТ Retail и Commerce \> График распределения**) и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

#### <a name="default-data-mapping"></a>Сопоставление данных по умолчанию

Следующее сопоставление данных по умолчанию включено в конфигурацию поставщика фискальных документов, которая предоставляется в составе образца финансовой интеграции:

- **Сопоставление ставок налога на добавленную стоимость (НДС)** — сопоставление значений процентного налога, настроенных для налоговых кодов для ставок НДС, специфичных для финансовых принтеров. Вот сопоставление по умолчанию:

    ```
    0 : 23.00 ; 1 : 8.00 ; 2 : 5.00 ; 3 : 0.00
    ```

    Первый компонент в каждой паре представляет номер ставки НДС, настроенной в финансовом принтере. Второй компонент представляет соответствующую ставку НДС. Дополнительные сведения о настройке ставок НДС финансового принтера см. в документации по драйверу POSNET.

- **Сопоставление типов платежных средств** — сопоставление способов оплаты, настроенных для магазина в формах платежей, которые поддерживаются финансовым принтером. Вот сопоставление по умолчанию:

    ```
    0 : 0 ; 1 : 0 ; 2 : 2 ; 3 : 2 ; 4 : 0 ; 5 : 0 ; 6 : 0 ; 7 : 2 ; 8 : 0
    ```

    Первый компонент в каждой паре представляет метод платежа, настроенный для магазина. Второй компонент представляет соответствующую платежную форму, поддерживаемую финансовым принтером. Дополнительные сведения о формах платежей, которые поддерживает финансовый принтер, см. в документации по драйверу POSNET. Необходимо изменить сопоставление образца в соответствии с методами оплаты, настроенными в вашем приложении.

#### <a name="fiscal-connector-settings"></a>Параметры финансового соединителя

Следующие параметры включены в конфигурацию финансового соединителя, которая предоставляется в составе образца финансовой интеграции:

- **Строка подключения** — строка, описывающая сведения о соединении с устройством в формате, поддерживаемом драйвером. Дополнительные сведения см. в документации по драйверу POSNET.
- **Синхронизация даты и времени** — значение, указывающее, должны ли дата и время принтера быть синхронизированы с подключенной аппаратной станцией Hardware Station.
- **Время ожидания устройства** — период времени в миллисекундах, в течение которого драйвер будет ожидать отклика от устройства. Дополнительные сведения см. в документации по драйверу POSNET.

### <a name="configure-channel-components"></a>Настройка компонентов канала

> [!NOTE]
> - Пример интеграции финансового принтера для Польши доступен в Commerce SDK в Commerce версии 10.0.29. В Commerce версии 10.0.28 и ранее необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Польши (устаревшая версия)](emea-pol-fpi-sample-sdk.md).
> - Образцы Commerce, развернутые в вашей среде, не обновляются автоматически при применении сервисных обновлений или обновлений качества к компонентам Commerce. Необходимо вручную обновить требуемые примеры.

#### <a name="set-up-the-development-environment"></a>Настройка среды разработки

Чтобы настроить среду разработки для проверки и расширения образца, выполните следующие действия.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Commerce SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение интеграция фискальных принтеров по адресу **Dynamics365Commerce.Solutions\\FiscalIntegration\\Posnet\\Posnet.sln** и постройте его.
1. Установите расширения CRT:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **Posnet\\ScaleUnit\\ScaleUnit.Posnet.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.Posnet.Installer**.
        - **Локальный CRT на Modern POS:** в папке **Posnet\\ModernPOS\\ModernPOS.Posnet.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPOS.Posnet.Installer**.

    1. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.Posnet.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.Posnet.Installer.exe install --verbosity 0
            ```

1. Установите расширения Hardware Station:

    1. В папке **Posnet\\HardwareStation\\HardwareStation.PosnetThermalFVFiscalPrinter.Installer\\bin\\Debug\\net461** найдите программу установки **HardwareStation.PosnetThermalFVFiscalPrinter.Installer**.
    1. Запустите установщик расширений из командной строки:

        ```Console
        HardwareStation.PosnetThermalFVFiscalPrinter.Installer.exe install --verbosity 0
        ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **Posnet build-pipeline.yml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

## <a name="design-of-extensions"></a>Разработка расширений

Образец интеграции финансового принтера для Польши базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Commerce SDK. Образец находится в папке **src\\FiscalIntegration\\Posnet** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). [Пример](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) состоит из поставщика финансового документа, который является расширением CRT, и финансового соединителя, который является расширением Commerce Hardware Station. Дополнительные сведения об использовании Commerce SDK см. в разделе [Загрузка примеров Commerce SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!NOTE]
> Пример интеграции финансового принтера для Польши доступен в Commerce SDK в Commerce версии 10.0.29. В Commerce версии 10.0.28 и ранее необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Польши (устаревшая версия)](emea-pol-fpi-sample-sdk.md).

### <a name="commerce-runtime-extension-design"></a>Разработка расширения Commerce Runtime

Целью расширения, которое является поставщиком финансовых документов, является создание документов для конкретного принтера и обработка откликов от финансового принтера. Это расширение создает набор связанных с принтером команд в формате JavaScript Object Notation (JSON), который определяется спецификацией POSNET 19-3678.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **DocumentProviderPosnetProtocol** является точкой входа для запроса на создание документов с финансового принтера.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени поставщика документа соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **GetFiscalDocumentDocumentProviderRequest** — этот запрос содержит сведения о том, что должен создаваться документ. Он возвращает специфический для принтера документ, который должен быть зарегистрирован в финансовом принтере.
- **GetSupportedRegistrableEventsDocumentProviderRequest** — этот запрос возвращает список событий, на которые необходимо подписаться. В настоящее время поддерживаются следующие события: продажи, печать X-отчета и печать Z-отчета.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для поставщика фискального документа расположен по пути **src\\FiscalIntegration\\Posnet\\CommerceRuntime\\DocumentProvider.PosnetSample\\Configuration\\DocumentProviderPosnetSample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров поставщика фискального документа из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="hardware-station-extension-design"></a>Разработка расширения Hardware Station

Целью расширения, которое является финансовым соединителем, является обмен данными с финансовым принтером. Это расширение вызывает функции драйвера POSNET для отправки команд, которые расширение CRT создает на финансовом принтере. Оно также обрабатывает ошибки устройства.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **FiscalPrinterHandler** является точкой входа для обработки запроса к финансовому периферийному устройству.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **SubmitDocumentFiscalDeviceRequest** — этот запрос отправляет документы на принтеры и возвращает отклики из финансового принтера.
- **IsReadyFiscalDeviceRequest** — этот запрос используется для проверки работоспособности устройства.
- **InitializeFiscalDeviceRequest** — этот запрос используется для инициализации принтера.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для фискального соединителя расположен по пути **src\\FiscalIntegration\\Posnet\\HardwareStation\\ThermalDeviceSample\\Configuration\\ConnectorPosnetThermalFVEJ.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров финансового соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
