---
title: Пример интеграции фискальных принтеров для Италии
description: В этой статье представлен обзор примера финансовой интеграции для Италии в Microsoft Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 12/20/2021
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: epopov
ms.search.validFrom: 2018-11-1
ms.openlocfilehash: 2aa1851fe5fe447ba2dd4640be9881b37e54216e
ms.sourcegitcommit: 52b7225350daa29b1263d8e29c54ac9e20bcca70
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/03/2022
ms.locfileid: "8909398"
---
# <a name="fiscal-printer-integration-sample-for-italy"></a>Пример интеграции фискальных принтеров для Италии

[!include[banner](../includes/banner.md)]

В этой статье представлен обзор примера финансовой интеграции для Италии в Microsoft Dynamics 365 Commerce.

Функции Commerce для Италии включают в себя пример интеграции POS с финансовым принтером. Пример расширяет [возможности финансовой интеграции](fiscal-integration-for-retail-channel.md), чтобы они работали с принтерами [Epson FP-90III Series](https://www.epson.it/products/sd/pos-printer/epson-fp-90iii-series) компании Epson, и обеспечивает связь с финансовым принтером в режиме веб-сервера через веб-службу EpsonFPMate с помощью API-интерфейса Fiscal ePOS-Print. Пример поддерживает только режим Registratore Telematico (RT). Пример представлен в форме исходного кода и является частью пакета SDK Retail.

Корпорация Майкрософт не выпускает никакое оборудование, программное обеспечение или документацию от Epson. Для получения сведений о получении и работе финансового принтера обратитесь в [Epson Italia S.p.A](https://www.epson.it).

## <a name="scenarios"></a>Сценарии

Пример интеграции финансового принтера для Италии покрывает следующие сценарии.

- Сценарии продаж:

    - Печать финансового чека для продаж и возвратов с кассовыми проводками.
    - Фиксация отклика от финансового принтера и хранение его в базе данных канала.
    - Налоги:

        - Сопоставление с кодами налога (подразделениями) финансового принтера.
        - Перенос сопоставленных налоговых данных в финансовый принтер.
        - Печать налогов на финансовом чеке.

    - Платежи:

        - Сопоставление с методами платежа для финансового принтера.
        - Печать платежей на финансовом чеке.
        - Печать сведений об изменениях.

    - Печать скидок по строке.
    - Подарочные сертификаты:

        - Исключение выданной или повторно начисленной строки подарочного сертификата из финансового чека для продажи.
        - Печать платежа, в котором используется подарочный сертификат в качестве регулярного метода платежа.

    - Печать финансовых чеков для операций с заказами клиентов:

        - Финансовый чек не печатается для депозита заказа клиента.
        - Печать финансового чека для строк самовывоза гибридного заказа клиента.
        - Печать финансового чека для операции получения для заказа клиента.
        - Печать финансового чека для заказа на возврат.

    - Печать штрих-кода для номера чека в финансовом чеке.
    - Печать [сведений о клиенте](emea-ita-customer-information.md), указанных для проводки по продажам на финансовом чеке. Примером такой информации является код лотереи клиента. 

- Отчеты на конец дня (финансовые X- и финансовые Z-отчеты).
- Обработка ошибок, например, следующие параметры:

    - Повторите попытку выполнения финансовой регистрации, если это возможно, например, когда финансовый принтер не подключен, не готов или не отвечает, в принтере нет бумаги или в нем застряла бумага.
    - Откладывание финансовой регистрации.
    - Пропустите финансовую регистрацию или пометьте проводку как зарегистрированную и включите коды сведений для фиксации причины сбоя и дополнительной информации.
    - Проверка доступности финансового принтера до открытия новой проводки по продажам или завершения проводки по продажам.

### <a name="gift-cards"></a>Подарочные сертификаты

В образце интеграции финансового принтера реализованы следующие правила, которые относятся к подарочным сертификатам:

- Исключаются строки продаж, которые относятся к *выпуску подарочного сертификата* и *пополнения подарочного сертификата* из финансового чека.
- Не печатать финансовый чек, если он состоит только из строк подарочного сертификата.
- Вычесть общую сумму подарочных сертификатов, которые были выпущены или пополнены в проводке из строк платежа финансового чека.
- Сохранение рассчитанных корректировок строк платежа в базе данных канала со ссылкой на соответствующую финансовую проводку.
- Платеж по подарочным сертификатам считается обычным платежом.

### <a name="customer-deposits-and-customer-order-deposits"></a>Депозиты клиента и депозиты по заказу клиента

В образце интеграции финансового принтера реализованы следующие правила, которые относятся к депозитам клиентов и депозитам заказов клиентов:

- Не печатать финансовый чек, если проводка является депозитом клиента.
- Не печатать финансовый чек, если проводка содержит только депозит по заказу клиента или возврат депозита по заказу клиента.
- Печать суммы ранее оплаченного депозита в финансовом чеке для операции получения заказа клиента.
- Вычесть сумму депозита по заказу клиента из строк платежа, когда создается гибридный заказ клиента.
- Сохранение рассчитанных корректировок строк платежа в базе данных канала со ссылкой на финансовую проводку для гибридного заказа клиента.

### <a name="limitations-of-the-sample"></a>Ограничения примера

- Финансовый принтер поддерживает только ситуации, в которых налог включается в цену. Поэтому параметр **Цена включает налог** должен быть установлен в значение **Да** как для магазинов, так и для клиентов.
- Ежедневные отчеты (фискальные X и фискальные Z) печатаются с использованием формата, внедренного во встроенное ПО фискального принтера.
- Фискальный принтер не поддерживает смешанные проводки. Параметр **Запретить смешивание продаж и возвратов в одной приходной накладной** должен иметь значение **Да** в профилях функциональности POS.
- Пример поддерживает интеграцию только с финансовым принтером, работающим в режиме Registratore Telematico (RT).

## <a name="set-up-fiscal-integration-for-italy"></a>Настройка финансовой интеграции для Италии

Образец интеграции финансового принтера для Италии базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\EpsonFP90IIISample** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/EpsonFP90IIISample)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением среды выполнения Commerce Runtime (CRT), и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Италии (устаревшая версия)](emea-ita-fpi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

Выполните шаги настройки финансовой интеграции, как описано в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md).

1. [Настройте процесс финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Кроме того, запишите настройки для процесса финансовой регистрации, которые [относятся к данному образцу интеграции финансового принтера](#set-up-the-registration-process).
1. [Настройка финансовых текстов для скидок](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-texts-for-discounts).
1. [Задайте параметры обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).
1. [Настройте финансовые отчеты X/Z на POS](setting-up-fiscal-integration-for-retail-channel.md#set-up-fiscal-xz-reports-from-the-pos).
1. [Включите выполнение вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration).
1. [Настройте функции для управления сведениями о клиентах в POS-терминале](emea-ita-customer-information.md#setup).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="set-up-the-registration-process"></a>Настройка процесса регистрации

Чтобы включить процесс регистрации, выполните следующие действия для настройки Commerce Headquarters. Дополнительные сведения см. в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения (например, **[release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33)**).
    1. Откройте **src \> FiscalIntegration \> EpsonFP90IIISample**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **CommerceRuntime \> DocumentProvider.EpsonFP90IIISample \> Configuration \> DocumentProviderEpsonFP90IIISample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/EpsonFP90IIISample/CommerceRuntime/DocumentProvider.EpsonFP90IIISample/Configuration/DocumentProviderEpsonFP90IIISample.xml)).
    1. Загрузите файл конфигурации финансового соединителя по пути **HardwareStation \> EpsonFP90IIIFiscalDeviceSample \> Configuration \> ConnectorEpsonFP90IIISample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/EpsonFP90IIISample/HardwareStation/EpsonFP90IIIFiscalDeviceSample/Configuration/ConnectorEpsonFP90IIISample.xml).

    > [!WARNING]
    > Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Файлы конфигурации для данного образца финансовой интеграции находятся в следующих папках пакета Retail SDK на виртуальной машине для разработчиков в LCS:
    >
    > - **Файл конфигурации поставщика финансовых документов:** RetailSdk\\SampleExtensions\\CommerceRuntime\\Extension.DocumentProvider.EpsonFP90IIISample\\Configuration\\DocumentProviderEpsonFP90IIISample.xml
    > - **Файл конфигурации финансового соединителя:** RetailSdk\\SampleExtensions\\HardwareStation\\Extension.EpsonFP90IIIFiscalDeviceSample\\Configuration\\ConnectorEpsonFP90IIISample.xml
    > 
    > Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

1. Перейдите в раздел **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя. Выберите поставщика документов и соединитель, который был загружен ранее. При необходимости обновите [параметры сопоставления данных](#default-data-mapping).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите финансовый соединитель, который был загружен ранее. При необходимости обновите [параметры соединителя](#fiscal-connector-settings).
6. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**. Создайте новую группу финансовых соединителей для функционального профиля соединителя, созданного ранее.
7. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
8. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации.
9. Перейдите **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**. Выберите профиль оборудования, который связан с Hardware Station, с которой будет связан фискальный принтер. На экспресс-вкладке **Фискальная периферия** выберите ранее созданный технический профиль соединителя.
10. Откройте график распределения (**Retail и Commerce \> ИТ Retail и Commerce \> График распределения**) и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

#### <a name="default-data-mapping"></a>Сопоставление данных по умолчанию

Следующее сопоставление данных по умолчанию включено в конфигурацию поставщика фискальных документов, которая предоставляется в составе образца финансовой интеграции:

- **Сопоставление типов платежных средств** — сопоставление способов оплаты, настроенных для магазина для типов платежей, которые поддерживает финансовый принтер. В следующем примере показано сопоставление по умолчанию.

    ```JSON
    {"PaymentMethods": [
        {"StorePaymentMethod":"1", "PrinterPaymentType":"0", "PrinterPaymentIndex":"00"},
        {"StorePaymentMethod":"3", "PrinterPaymentType":"2", "PrinterPaymentIndex":"00"},
        {"StorePaymentMethod":"4", "PrinterPaymentType":"2", "PrinterPaymentIndex":"01"},
        {"StorePaymentMethod":"6", "PrinterPaymentType":"0", "PrinterPaymentIndex":"01"},
        {"StorePaymentMethod":"8", "PrinterPaymentType":"6", "PrinterPaymentIndex":"01"}
        ],
        "DepositPaymentMethod": {"PrinterPaymentType":"2", "PrinterPaymentIndex":"00"}}
    ```

    Вот объяснение атрибутов в этом сопоставлении:

    - **StorePaymentMethod** является способом платежа, настроенным для магазина в **Retail и Commerce \> Настройка канала \> Способы оплаты \> Способы оплаты**.
    - **PrinterPaymentType** и **PrinterPaymentIndex** — это соответствующие типы платежей и индексы, которые определены в документации по финансовому принтеру Epson.
    - **DepositPaymentMethod** используется для указания типа платежа принтера и индекса для части суммы получения заказа клиента, которая сопоставляется с депозитом по заказу клиента.

    В следующей таблице показано, как пример сопоставления способов оплаты соответствует способам оплаты магазина, которые настроены в стандартных демонстрационных данных.

    | Способ оплаты | Имя способа оплаты |
    |----------------|---------------------|
    | 1              | Касса                |
    | 3              | Карта                |
    | 4              | Счет клиента    |
    | 6              | Валюта            |
    | 8              | Подарочный сертификат           |

    Необходимо изменить сопоставление образца в соответствии с методами оплаты, настроенными в вашем приложении.

- **Тип штрихкода для номера чека** — тип штрих-кода, используемый для отображения номера чека в финансовом чеке. Сопоставление по умолчанию — **CODE128**.
- **Печать финансовых данных в заголовке чека** — если этот параметр включен, информация о магазине будет печататься в финансовом чеке. Эти сведения включают название, адрес и налоговый код магазина, а также имя кассира.
- **Сопоставление отделов финансовых принтеров** — сопоставление подразделений финансового принтера со ставками налога на добавленную стоимость (НДС), природами исключений НДС и типами продуктов. В следующем примере показано сопоставление по умолчанию.

    ```JSON
    {"Departments": [
        {"VATRate":"2200", "VATExemptNature":"", "ProductType":"0", "DepartmentNumber":"01"},
        {"VATRate":"2200", "VATExemptNature":"", "ProductType":"1", "DepartmentNumber":"02"},
        {"VATRate":"1000", "VATExemptNature":"", "ProductType":"0", "DepartmentNumber":"03"},
        {"VATRate":"1000", "VATExemptNature":"", "ProductType":"1", "DepartmentNumber":"04"},
        {"VATRate":"0500", "VATExemptNature":"", "ProductType":"0", "DepartmentNumber":"05"},
        {"VATRate":"0500", "VATExemptNature":"", "ProductType":"1", "DepartmentNumber":"06"},
        {"VATRate":"0400", "VATExemptNature":"", "ProductType":"0", "DepartmentNumber":"07"},
        {"VATRate":"0400", "VATExemptNature":"", "ProductType":"1", "DepartmentNumber":"08"},
        {"VATRate":"0000", "VATExemptNature":"", "ProductType":"0", "DepartmentNumber":"09"},
        {"VATRate":"0000", "VATExemptNature":"", "ProductType":"1", "DepartmentNumber":"10"},
        {"VATRate":"0000", "VATExemptNature":"NS", "ProductType":"0", "DepartmentNumber":"99"}]}
    ```

    Вот объяснение атрибутов в этом сопоставлении:

    - **VATRate** является поддерживаемой ставкой НДС, настроенной в качестве налогового кода. Значение в сопоставлении имеет два знака после запятой, но разделитель дробной части отсутствует. Например, **2200** соответствует 22 процентам, а **1000** — 10 процентам.
    - **VATExemptNature** применяется только в тех случаях, когда ставка НДС равна 0 (нулю), включая случаи, когда налог отсутствует. В настоящее время **VATExemptNature** поддерживается только для подарочных сертификатов, и значение в сопоставлении должно соответствовать значению свойства **VATExemptNatureForGiftCard** в XML-файле конфигурации.
    - **ProductType** является типом продукта. Значение **0** означает товары, а значение **1** — услуги.
    - **DepartmentNumber** — это номер подразделения, настроенного в принтере и соответствующего трем предыдущим атрибутам.

    Необходимо изменить сопоставление образца в соответствии со ставками НДС, настроенными в приложении, и соответствующими подразделениями, настроенными в финансовом принтере.

- **Характер освобождения от НДС для подарочного сертификата** — это природа освобождения от НДС, которая должна применяться при выдаче или пополнении подарочного сертификата. Значение должно соответствовать некоторой записи в сопоставлении подразделений для финансового принтера. Сопоставление по умолчанию — **NS**.
- **Включить бесплатные номенклатуры** — если этот параметр включен, используется специальный тип корректировки скидки *omaggio* для номенклатур, для которой включена скидка в 100 процентов.
- **Информационный код для источника возврата** — информационный код, используемый для фиксации источника проводки возврата, если исходный чек на продажу не указан. Этот параметр используется вместе с параметрами **Информационный код для исходной даты продаж** и **Сопоставление источника возврата** для создания правильного сообщения в финансовом чеке относительно происхождения проводки по возврату, если исходная проводка продаж не существует. 

    Этот информационный код должен быть настроен таким образом, чтобы позволить пользователю выбрать или ввести одно из возможных происхождений возврата в магазинах. Например, оно может быть настроено как список дополнительных кодов (таких, как **Возврат с сайта** или **Возврат из киоска**). Затем параметр **Сопоставление источника возврата** используется для перевода значения информационного кода в команду для финансового принтера.

    Информационный код, выбранный для параметра **Информационный код для источника возврата**, должен быть настроен как обязательный информационный код, который создается один раз для каждой проводки продажи. Он должен быть назначен в качестве информационного кода **Возврат продукта** в профиле функциональности POS-терминала, чтобы он был запущен при выполнении операции **Возврат продукта**.

    Для этого сопоставления значение по умолчанию не указано. Необходимо выбрать информационный код, настроенный в приложении.

- **Информационный код для исходной даты продаж** — информационный код, используемый для фиксации даты исходной продажи, если исходный чек на продажу не указан. Этот параметр используется вместе с параметрами **Информационный код для источника возврата** и **Сопоставление источника возврата** для создания правильного сообщения в финансовом чеке относительно происхождения проводки по возврату, если исходная проводка продаж не существует.

    Информационный код должен быть настроен таким образом, чтобы в поле **Тип ввода** было указано значение **Дата**. Он должен быть настроен как обязательный информационный код, который запускается один раз для каждой проводки продаж. Он также должен быть назначен как **Связанный информационный код** для информационного кода, выбранного для параметра **Информационный код для источника возврата**, чтобы эти два информационных кода запускались один за другим.

    Для этого сопоставления значение по умолчанию не указано. Необходимо выбрать информационный код, настроенный в приложении.

- **Сопоставление источника возврата** — сопоставление источников возврата, которые используются для печати источника проводки возврата, если исходный чек на продажу не указан. Этот параметр используется вместе с параметрами **Информационный код для источника возврата** и **Информационный код для исходной даты продаж** для создания правильного сообщения в финансовом чеке относительно происхождения проводки по возврату, если исходная проводка продаж не существует. В следующем примере показано сопоставление по умолчанию.

    ```JSON
    {"ReturnOrigins": [
        {"ReturnOrigin":"1", "PrinterReturnOrigin":"POS"},
        {"ReturnOrigin":"2", "PrinterReturnOrigin":"ND"}
        ],
        "PrinterReturnOriginWithoutFiscalData":"POS"}
    ```

    Вот объяснение атрибутов в этом сопоставлении:

    - **ReturnOrigin** — это один из возможных источников возвратов в магазинах. Значение должно соответствовать значению параметра **Информационный кода для источника возврата**.
    - **PrinterReturnOrigin** — один из источников возврата, принимаемых финансовым принтером (**POS**, **VR** или **ND**).
    - **PrinterReturnOriginWithoutFiscalData** является источником возврата, который принимается финансовым принтером и который соответствует проводке возврата, связанной с исходной проводкой по продажам, которая не имеет связанных финансовых данных, поскольку она не была зарегистрирована через финансовый принтер. В этом случае исходная дата продажи определяется как дата исходной проводки по продажам.

Следующие сопоставления данных по умолчанию устарели и поддерживаются только для обратной совместимости:

- Сопоставление кодов налога на добавленную стоимость (НДС)
- Типа платежа депозита

#### <a name="fiscal-connector-settings"></a>Параметры финансового соединителя

Следующие параметры включены в конфигурацию финансового соединителя, которая предоставляется в составе образца финансовой интеграции:

- **Адрес конечной точки** — URL-адрес принтера.
- **Синхронизация даты и времени** — значение, указывающее, должны ли дата и время принтера быть синхронизированы с подключенной аппаратной станцией Hardware Station.

### <a name="configure-channel-components"></a>Настройка компонентов канала

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Италии (устаревшая версия)](emea-ita-fpi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

#### <a name="set-up-the-development-environment"></a>Настройка среды разработки

Чтобы настроить среду разработки для проверки и расширения образца, выполните следующие действия.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Retail SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение интеграция фискальных принтеров по адресу **Dynamics365Commerce.Solutions\\FiscalIntegration\\EpsonFP90IIISample\\EpsonFP90IIISample.sln** и постройте его.
1. Установите расширения CRT:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **EpsonFP90IIISample\\ScaleUnit\\ScaleUnit.EpsonFP90III.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.EpsonFP90III.Installer**.
        - **Локальный CRT на Modern POS:** в папке **EpsonFP90IIISample\\ModernPOS\\ModernPOS.EpsonFP90III.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPOS.EpsonFP90III.Installer**.

    1. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.EpsonFP90III.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.EpsonFP90III.Installer.exe install --verbosity 0
            ```

1. Установите расширения Hardware Station:

    1. В папке **EpsonFP90IIISample\\HardwareStation\\HardwareStation.EpsonFP90III.Installer\\bin\\Debug\\net461** найдите программу установки **HardwareStation.EpsonFP90III.Installer**.
    1. Запустите установщик расширений из командной строки:

        ```Console
        HardwareStation.EpsonFP90III.Installer.exe install --verbosity 0
        ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **EpsonFP90III build-pipeline.yml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

## <a name="design-of-extensions"></a>Разработка расширений

Образец интеграции финансового принтера для Италии базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\EpsonFP90IIISample** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/EpsonFP90IIISample)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением CRT, и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Италии (устаревшая версия)](emea-ita-fpi-sample-sdk.md). Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

### <a name="commerce-runtime-extension-design"></a>Разработка расширения Commerce Runtime

Целью расширения, которое является поставщиком финансовых документов, является создание документов для конкретного принтера и обработка откликов от финансового принтера.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **DocumentProviderEpsonFP90III** является точкой входа для запроса на создание документов с финансового принтера.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени поставщика документа соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **GetFiscalDocumentDocumentProviderRequest** — этот запрос содержит сведения о том, что должен создаваться документ. Он возвращает специфический для принтера документ, который должен быть зарегистрирован в финансовом принтере.
- **GetSupportedRegistrableEventsDocumentProviderRequest** — этот запрос возвращает список событий, на которые необходимо подписаться. В настоящее время поддерживаются следующие события: продажи, печать X-отчета и печать Z-отчета.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для поставщика фискального документа расположен по пути **src\\FiscalIntegration\\EpsonFP90IIISample\\CommerceRuntime\\DocumentProvider.EpsonFP90IIISample\\Configuration\\DocumentProviderEpsonFP90IIISample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью этого файла является разрешение настройки для параметров поставщика фискального документа из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="hardware-station-extension-design"></a>Разработка расширения Hardware Station

Целью расширения, которое является финансовым соединителем, является обмен данными с финансовым принтером. Это расширение использует протокол HTTP для отправки документов, создаваемых расширением CRT, на финансовый принтер. Оно также обрабатывает отклики, полученные от финансового принтера.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **EpsonFP90IIISample** является точкой входа для обработки запроса к финансовому периферийному устройству.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **SubmitDocumentFiscalDeviceRequest** — этот запрос отправляет документы на принтеры и возвращает отклики из финансового принтера.
- **IsReadyFiscalDeviceRequest** — этот запрос используется для проверки работоспособности устройства.
- **InitializeFiscalDeviceRequest** — этот запрос используется для инициализации принтера.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для фискального соединителя расположен по пути **src\\FiscalIntegration\\EpsonFP90IIISample\\HardwareStation\\EpsonFP90IIIFiscalDeviceSample\\Configuration\\ConnectorEpsonFP90IIISample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки для параметров соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
