---
title: Пример интеграции с блоком управления для Швеции
description: В этой статье представлен обзор примера финансовой интеграции для Швеции в Microsoft Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 12/20/2021
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2019-10-08
ms.openlocfilehash: 3376e6a901b692371a44b5c74c1e6b4afd0cd573
ms.sourcegitcommit: 87e727005399c82cbb6509f5ce9fb33d18928d30
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/12/2022
ms.locfileid: "9275075"
---
# <a name="control-unit-integration-sample-for-sweden"></a>Пример интеграции с блоком управления для Швеции

[!include [banner](../includes/banner.md)]

В этой статье представлен обзор примера финансовой интеграции для Швеции в Microsoft Dynamics 365 Commerce.

> [!NOTE]
> Этот пример функциональности финансовой интеграции заменяет более ранний [пример интеграции POS с блоками управления для Швеции](retail-sdk-control-unit-sample.md). Более ранний пример не использует преимущества [платформы финансовой интеграции](./fiscal-integration-for-retail-channel.md) и станет устаревшим в последующих обновлениях. Сведения о миграции из предыдущего примера на этот пример, соответствующий Dynamics 365 Commerce версии **10.0.22 и более ранним**, см. в разделе [Миграция из предыдущего примера интеграции](emea-swe-fi-sample-sdk.md#migrating-from-the-earlier-integration-sample).

Функция Commerce для Швеции включает образец интеграции POS-терминалов с финансовыми устройствами, специфичными для Швеции, которые называются *блоками управления*. Этот пример расширяет [функциональность финансовой интеграции](fiscal-integration-for-retail-channel.md). Предполагается, что блок управления физически подключен к станции Hardware Station, с которой связан POS-терминал. В качестве примера в этом примере используется интерфейс прикладного программирования (API) блока управления [CleanCash Type A](https://www.retailinnovation.se/produkter) от компании Retail Innovation HTT AB. Используется версия 1.1.4 интерфейса API CleanCash.

Пример представлен в форме исходного кода и является частью пакета SDK Retail.

Корпорация Майкрософт не выпускает никакое оборудование, программное обеспечение или документацию от компании Retail Innovation HTT AB. Для получения сведений о том, как получить блок управления и управлять им, свяжитесь с компанией [Retail Innovation HTT AB](https://www.retailinnovation.se/).

## <a name="scenarios"></a>Сценарии

Пример интеграции блоков управления для Швеции включает следующие возможности:

- Продажи, возвраты и копии чеков автоматически регистрируются в блоке управления, подключенному к станции Hardware Station, связанной с POS-терминалом.
- Код управления и номер производства блока управления для зарегистрированной проводки фиксируются в блоке управления и сохраняются в проводке. Эти данные также называются *финансовым откликом*. Финансовый ответ можно просмотреть на странице **Проводки магазина**.
- Настраиваемые поля для кода управления и номера производства для блока управления могут быть добавлены в макет чека. Таким образом можно напечатать финансовый ответ для проводки на чеке.
- Финансовый ответ для проводки отображается в отчете канала **Электронный журнал (Швеция)**.
- Имеется несколько вариантов обработки ошибок. Далее приводятся некоторые примеры.

    - Повторите попытку выполнения финансовой регистрации, если возможна повторная попытка. Можно повторить попытку выполнения финансовой регистрации, например, если блок управления не подключен, не готов или не отвечает.
    - Откладывание финансовой регистрации.
    - Пропустите финансовую регистрацию или пометьте проводку как зарегистрированную и включите коды сведений для фиксации причины сбоя и дополнительной информации.
    - Проверьте доступность блока управления до открытия новой проводки по продажам или завершения проводки по продажам.

### <a name="limitations-of-the-sample"></a>Ограничения примера

Пример интеграции блока управления для Швеции в настоящее время не поддерживает сценарии заказов клиентов.

## <a name="setting-up-the-integration-with-control-units"></a>Настройка интеграции c блоками управления

Дополнительные сведения о настройке, необходимой для Швеции, см. в разделе [Настройка Commerce для Швеции](./emea-swe-cash-registers.md#setting-up-commerce-for-sweden).

### <a name="configuring-swedenspecific-receipts"></a>Настройка чеков для Швеции

#### <a name="configure-custom-fields-so-that-they-can-be-used-in-receipt-formats-for-sales-receipts"></a>Настройка настраиваемых полей таким образом, чтобы их можно было использовать в форматах чеков для чеков на продажу

Можно настроить текст языка и настраиваемые поля, используемые в форматах чеков POS-терминала. Компанией по умолчанию для пользователя, который создает настройку чека, должна быть то же юридическое лицо, в котором создана текстовая настройка языка. В качестве альтернативы необходимо создать те же тексты на языке компании пользователя по умолчанию и на языке юридического лица магазина, для которого создается настройка.

На странице **Текст языка** добавьте следующие записи для меток настраиваемых полей для макетов чеков. Обратите внимание на то, что значения **Код языка**, **Код текста** и **Текст**, показанные в таблице, являются просто примерами. Их можно изменить в зависимости от требований. Однако используемые вами значения **Код текста** должны быть уникальными и должны больше или равны 900001.

Добавьте следующие ярлыки POS в раздел **POS** страницы **Текст языка**:

| Код языка | Код текста | Текст                  |
|-------------|---------|-----------------------|
| en-US       | 900001  | Код управления регистрацией |
| en-US       | 900002  | Устройство регистрации       |

На странице **Настраиваемые поля** добавьте следующие записи для настраиваемых полей для макетов чеков. Обратите внимание, что значения **Код текста подписи** должны соответствовать значениям **Код текста**, указанным на странице **Текст языка**.

| Имя                         | Тип    | ИД текста заголовка |
|------------------------------|---------|-----------------|
| SE_FISCALREGISTERCONTROLCODE | Чек | 900001          |
| SE_FISCALREGISTERID          | Чек | 900002          |

> [!NOTE]
> Важно указать правильные имена настраиваемых полей, как перечислено в таблице выше. Неправильное имя настраиваемого поля приведет к пропущенным данным в чеках.

#### <a name="configure-receipt-formats"></a>Настройка форматов чеков

Для каждого требуемого формата чека измените значение в поле **Поведение печати** на **Всегда печатать**.

В конструкторе формата чеков добавьте следующие настраиваемые поля в разделе **Нижний колонтитул**. Обратите внимание, что имена полей соответствуют текстам языка, определенным в предыдущем разделе этой статьи.

- **Регистрация контрольного кода** — в этом поле распечатывается контрольный код.
- **Устройство регистрации** — в этом поле распечатывается производственный номер управляющего блока.

Дополнительные сведения о порядке работы с форматами чеков см. в разделе [Шаблоны и печать чеков](../receipt-templates-printing.md).

### <a name="set-up-fiscal-integration-for-sweden"></a>Настройка финансовой интеграции для Швеции

Образец интеграции блока управления для Швеции базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\CleanCash** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/CleanCash)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением среды выполнения Commerce Runtime (CRT), и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции блока управления для Швеции (устаревшая версия)](emea-swe-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

Выполните шаги настройки финансовой интеграции, как описано в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md).

1. [Настройте процесс финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Кроме того, запишите настройки для процесса финансовой регистрации, которые [относятся к данному образцу интеграции блока управления](#set-up-the-registration-process).
1. [Задайте параметры обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).
1. [Включите выполнение вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="set-up-the-registration-process"></a>Настройка процесса регистрации

Чтобы включить процесс регистрации, выполните следующие действия для настройки Commerce Headquarters. Дополнительные сведения см. в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения (например, **[release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33)**).
    1. Откройте **src \> FiscalIntegration \> CleanCash**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **CommerceRuntime \> DocumentProvider.CleanCashSample \> Configuration \> DocumentProviderFiscalCleanCashSample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/CleanCash/CommerceRuntime/DocumentProvider.CleanCashSample/Configuration/DocumentProviderFiscalCleanCashSample.xml)).
    1. Загрузите файл конфигурации финансового соединителя по пути **HardwareStation \> Connector.CleanCashSample \> Configuration \> ConnectorCleanCashSample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/CleanCash/HardwareStation/Connector.CleanCashSample/Configuration/ConnectorCleanCashSample.xml)).

    > [!WARNING]
    > Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Файлы конфигурации для данного образца финансовой интеграции находятся в следующих папках пакета Retail SDK на виртуальной машине для разработчиков в LCS:
    >
    > - **Файл конфигурации поставщика финансовых документов:** RetailSdk\\SampleExtensions\\CommerceRuntime\\Extensions.DocumentProvider.CleanCashSample\\Configuration\\DocumentProviderFiscalCleanCashSample.xml
    > - **Файл конфигурации финансового соединителя:** RetailSdk\\SampleExtensions\\HardwareStation\\Extension.CleanCashSample\\Configuration\\ConnectorCleanCashSample.xml
    > 
    > Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

1. Перейдите в раздел **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя. Выберите поставщика документов и соединитель, который был загружен ранее. При необходимости обновите [параметры сопоставления данных](#default-data-mapping).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите финансовый соединитель, который был загружен ранее. При необходимости обновите [параметры соединителя](#fiscal-connector-settings).
6. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**. Создайте новую группу финансовых соединителей для функционального профиля соединителя, созданного ранее.
7. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
8. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации.
9. Перейдите **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**. Выберите профиль оборудования, который связан с Hardware Station, с которой будет связан фискальный принтер. На экспресс-вкладке **Фискальная периферия** выберите ранее созданный технический профиль соединителя.
10. Откройте график распределения (**Retail и Commerce \> ИТ Retail и Commerce \> График распределения**) и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

#### <a name="default-data-mapping"></a>Сопоставление данных по умолчанию

Следующее сопоставление данных по умолчанию включено в конфигурацию поставщика фискальных документов, которая предоставляется в составе образца финансовой интеграции:

- **Сопоставление кодов налога на добавленную стоимость (НДС)** — это сопоставление устанавливает коды налога на добавленную стоимость (НДС) для конкретного устройства на соответствующие налоговые коды. Сопоставление кода НДС должно иметь следующий формат:

    ```
    1 : code1 ; 2 : code2
    ```

    Вот объяснение этого формата:

    - *1* и *2* являются кодами НДС для конкретного устройства.
    - Точка с запятой (;) используется в качестве разделителя.
    - *code1* и *code2* являются налоговыми кодами, настроенными в Commerce Headquarters. Необходимо изменить сопоставление образца в соответствии с кодами налога, настроенными в вашем приложении.

    Блоки управления поддерживают до четырех других кодов НДС. Таким образом, сопоставление кода НДС можно настроить следующим образом:

    ```
    1 : code1 ; 2 : code2 ; 3 : code3 ; 4 : code4
    ```

    > [!NOTE]
    > Несколько налоговых кодов могут быть сопоставлены с одним и тем же кодом НДС для конкретного устройства.

#### <a name="fiscal-connector-settings"></a>Параметры финансового соединителя

Следующие параметры включены в конфигурацию финансового соединителя, которая предоставляется в составе образца финансовой интеграции:

- **Строка подключений** — параметры подключения блока управления.
- **Время ожидания** — период времени в миллисекундах, в течение которого драйвер будет ожидать отклика от блока управления.

### <a name="configure-channel-components"></a>Настройка компонентов канала

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции блока управления для Швеции (устаревшая версия)](emea-swe-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

#### <a name="set-up-the-development-environment"></a>Настройка среды разработки

Чтобы настроить среду разработки для проверки и расширения образца, выполните следующие действия.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Retail SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение интеграция блока управления по адресу **Dynamics365Commerce.Solutions\\FiscalIntegration\\CleanCash\\CleanCash.sln** и постройте его.
1. Установите расширения CRT:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **CleanCash\\ScaleUnit\\ScaleUnit.CleanCash.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.CleanCash.Installer**.
        - **Локальный CRT на Modern POS:** в папке **CleanCash\\ModernPOS\\ModernPOS.CleanCash.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPOS.CleanCash.Installer**.

    2. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.CleanCash.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.CleanCash.Installer.exe install --verbosity 0
            ```

1. Установите расширения Hardware Station:

    1. В папке **CleanCash\\HardwareStation\\HardwareStation.CleanCash.Installer\\bin\\Debug\\net461** найдите программу установки **HardwareStation.CleanCash.Installer**.
    1. Запустите установщик расширений из командной строки:

        ```Console
        HardwareStation.CleanCash.Installer.exe install --verbosity 0
        ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **CleanCash build-pipeline.yml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

## <a name="design-of-the-extensions"></a>Разработка расширений

Образец интеграции блока управления для Швеции базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\CleanCash** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/CleanCash)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением CRT, и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции блока управления для Швеции (устаревшая версия)](emea-swe-fi-sample-sdk.md). Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

### <a name="crt-extension-design"></a>Разработка расширения CRT

Целью расширения, которое является поставщиком финансовых документов, является создание документов для конкретной службы и обработка откликов от блока управления.

#### <a name="request-handler"></a>Обработчик запросов

Имеется один обработчик запросов **DocumentProviderCleanCash** для поставщика документов. Этот обработчик используется для создания финансовых документов для блока управления.

Этот обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени поставщика документа соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **GetFiscalDocumentDocumentProviderRequest** — этот запрос содержит сведения о том, что должен создаваться документ. Он возвращает специфический для службы документ, который должен быть зарегистрирован в блоке управления.
- **GetSupportedRegistrableEventsDocumentProviderRequest** — этот запрос возвращает список событий, на которые необходимо подписаться. В настоящее время поддерживаются события продаж и аудита.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для поставщика фискального документа расположен по пути **src\\FiscalIntegration\\CleanCash\\CommerceRuntime\\DocumentProvider.CleanCashSample\\Configuration\\DocumentProviderFiscalCleanCashSample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью этого файла является разрешение настройки для параметров поставщика фискального документа из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="hardware-station-extension-design"></a>Разработка расширения Hardware Station

Целью расширения, которое является финансовым соединителем, является обмен данными с блоком управления. Оно использует протокол HTTP для отправки документов, создаваемых расширением CRT в блоке управления. Оно также обрабатывает отклики, полученные от блока управления.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **CleanCashHandler** является точкой входа для обработки запросов к блоку управления.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **SubmitDocumentFiscalDeviceRequest** — этот запрос отправляет документы в блок управления и возвращает из него отклики.
- **IsReadyFiscalDeviceRequest** — этот запрос используется для проверки работоспособности блока управления.
- **InitializeFiscalDeviceRequest** — этот запрос используется для инициализации блока управления.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для фискального соединителя расположен по пути **src\\FiscalIntegration\\CleanCash\\HardwareStation\\Connector.CleanCashSample\\Configuration\\ConnectorCleanCashSample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки для параметров финансового соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
