---
title: Рекомендации по развертыванию контрольно-кассовых машин для Норвегии
description: В этой статье представлено руководство по включению функциональности контрольно-кассовой машины для локализации Microsoft Dynamics 365 Commerce для Норвегии.
author: EvgenyPopovMBS
ms.date: 10/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2019-03-01
ms.openlocfilehash: 0e66ef93e65fecaca23f0434c386507a0672d251
ms.sourcegitcommit: 2bc6680dc6b12d20532d383a0edb84d180885b62
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/06/2022
ms.locfileid: "9631324"
---
# <a name="deployment-guidelines-for-cash-registers-for-norway"></a>Рекомендации по развертыванию контрольно-кассовых машин для Норвегии

[!include[banner](../includes/banner.md)]

> [!IMPORTANT]
> Шаги, описанные в этой статье, следует использовать только в том случае, если используется Microsoft Dynamics 365 Commerce версии 10.0.29 или более поздней. В Commerce версии 10.0.28 и ранее необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [Инструкции по развертыванию контрольно-кассовых машин для Норвегии (устарело)](./emea-nor-loc-deployment-guidelines.md). Если используется Commerce версии 10.0.28 или более ранней и выполняется миграция в Commerce версии 10.0.29 или более поздней, необходимо выполнить шаги из раздела [Переход со старой функциональности Commerce для Норвегии](./emea-nor-fi-migration.md).

В этой статье представлено руководство по включению функциональности контрольно-кассовой машины для локализации Commerce для Норвегии. Локализация состоит из нескольких расширений компонентов, которые позволяют выполнять такие действия, как печать настраиваемых полей в чеках, регистрация дополнительных событий аудита, проводок по продажам и платежных проводок в POS-терминале, использование цифровой подписи для проводок по продажам и печать X и Z отчетов в локальных форматах. Дополнительные сведения о локализации для Норвегии см. в разделе [Функциональность контрольно-кассовой машины для Норвегии](./emea-nor-cash-registers.md). Дополнительные сведения о порядке настройки Commerce для Норвегии см. в разделе [Настройка Commerce для Норвегии](./emea-nor-cash-registers.md#setting-up-commerce-for-norway).

## <a name="set-up-fiscal-registration-for-norway"></a>Настройка финансовой регистрации для Норвегии

Образец финансовой регистрации для Норвегии базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Commerce SDK. Образец находится в папке **src\\FiscalIntegration\\SequentialSignatureNorway** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). [Пример](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) состоит из поставщика финансового документа и финансового соединителя, которые являются расширениями среды выполнения Commerce Runtime (CRT). Дополнительные сведения об использовании Commerce SDK см. в разделе [Загрузка примеров Commerce SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

Выполните шаги настройки финансовой регистрации, которые описаны в разделе [Настройка финансовой интеграции для каналов Commerce](./setting-up-fiscal-integration-for-retail-channel.md):

1. [Настройте процесс финансовой регистрации](./setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Обязательно запишите настройки процесса финансовой регистрации, которые [относятся к Норвегии](#configure-the-fiscal-registration-process).
1. [Задайте параметры обработки ошибок](./setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).
1. [Включите выполнение вручную отложенной финансовой регистрации](./setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-deferred-fiscal-registration).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="configure-the-fiscal-registration-process"></a>Настройка процесса финансовой регистрации

Выполните эти шаги, чтобы включить процесс финансовой регистрации для Норвегии в Commerce Headquarters.

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя из пакета Commerce SDK:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Откройте последнюю доступную ветвь выпуска.
    1. Откройте **src \> FiscalIntegration \> SequentialSignatureNorway \> CommerceRuntime**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **DocumentProvider.SequentialSignNorway \> Configuration \> DocumentProviderSequentialSignatureNorwaySample.xml**.
    1. Загрузите файл конфигурации финансового соединителя по пути **Connector.SequentialSignNorway \> Configuration \> ConnectorSequentialSignatureNorwaySample.xml**.

1. Перейдите в раздел **Retail и Commerce \> Настройка центрального офиса \> Параметры \> Общие параметры**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя и выберите поставщика документов и соединитель, которые были загружены ранее.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите соединитель, который был загружен ранее. Задайте тип соединителя **Внутренний**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей** и создайте новую группу фискальных соединителей для функционального профиля соединителя, который был создан ранее.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации. На экспресс-вкладке **Финансовые службы** выберите ранее созданный технический профиль соединителя. 
1. Перейдите в раздел **Retail и Commerce \> ИТ Retail и Commerce \> График распределения**. Откройте график распределения и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

### <a name="configure-the-digital-signature-parameters"></a>Настройка параметров цифровых подписей

Необходимо настроить сертификаты, которые будут использоваться для цифровых подписей проводок по продажам в магазине. Для подписания используется цифровой сертификат, хранящийся в Azure Key Vault. Для автономного режима Modern POS можно также выполнить подписание с помощью цифрового сертификата, хранящегося в локальном хранилище компьютера, на котором установлено приложение Modern POS.

Прежде чем можно будет использовать цифровой сертификат, хранящийся в хранилище ключей Key Vault, необходимо выполнить следующие действия.

1. Необходимо создать хранилище ключей Key Vault. Рекомендуется разворачивать хранилище в той же географической области, что и Commerce Scale Unit.
1. Сертификат должен быть отправлен в хранилище ключей Key Vault в виде секретной строки в формате Base64.
1. Приложение Application Object Server (AOS) должно быть авторизовано для чтения секретов из хранилища ключей Key Vault.

Дополнительные сведения о работе с хранилищем ключей Key Vault см. в разделе [Приступая к работе с Azure Key Vault](/azure/key-vault/key-vault-get-started).

Далее на странице **Параметры Key Vault** необходимо указать параметры для доступа к хранилищу ключей Key Vault:

- **Имя** и **Описание** — имя и описание хранилища ключей Key Vault.
- **URL-адрес Key Vault** — URL-адрес хранилища ключей Key Vault.
- **Клиент Key Vault** — код интерактивного клиента приложения Azure Active Directory (Azure AD), связанного с хранилищем ключей Key Vault для целей проверки подлинности. Этот клиент должен иметь доступ для чтения секретов из хранилища.
- **Секретный ключ хранилища ключей** — секретный ключ, который связан с приложением Azure AD, используемым для проверки подлинности в хранилище ключей Key Vault.
- **Имя**, **Описание** и **Секретная ссылка** — имя, описание и секретная ссылка сертификата.

Затем необходимо настроить соединитель для сертификатов, которые хранятся в хранилище ключей Key Vault или в локальном хранилище сертификатов. Этот соединитель используется для входа на стороне канала.

1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**.
1. На экспресс-вкладке **Параметры** укажите следующие параметры для цифровых подписей:

    - **Имя секрета** — выберите имя секрета, настроенное ранее на странице **Параметры хранилища ключей**.
    - **Отпечаток локального сертификата** — предоставляет отпечаток для сертификата, который хранится локально.
    - **Алгоритм хеширования** — укажите один из криптографических хэш-алгоритмов, поддерживаемых Microsoft .NET, например **SHA1**.
    - **Имя хранилища сертификатов** — это поле является необязательным. Используйте его для указания имени хранилища по умолчанию, которое должно использоваться для поиска локальных сертификатов.
    - **Расположение хранилища сертификатов** — это поле является необязательным. Используйте его для указания местоположения хранилища по умолчанию, которое должно использоваться для поиска локальных сертификатов.
    - **Сначала попробовать локальный сертификат** — выберите этот параметр, чтобы использовать для подписывания данных сертификат из локального хранилища по умолчанию вместо сертификата из хранилища Key Vault.
    - **Активировать проверку работоспособности** — дополнительные сведения о функции проверки работоспособности см. в разделе [Проверка работоспособности финансовой регистрации](./fiscal-integration-for-retail-channel.md#fiscal-registration-health-check).

> [!NOTE]
> - В настоящее время для Норвегии допускается только алгоритм хэширования **SHA1**.
> - Для упрощения процесса поиска локальных сертификатов в CRT добавлены имя хранилища и местоположение хранилища по умолчанию. X509StoreProvider содержит список папок, в которых хранятся сертификаты. Если не указано имя хранилища по умолчанию и местоположение хранилища по умолчанию, X509StoreProvider пытается найти сертификат во всех других папках в своем списке.

### <a name="configure-channel-components"></a>Настройка компонентов канала

#### <a name="development-environment"></a>Среда разработки

Выполните эти шаги для настройки среды разработки, чтобы можно было проверить и расширить пример.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Commerce SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение **SequentialSignatureNorway.sln** по пути **Dynamics365Commerce.Solutions\\FiscalIntegration\\SequentialSignatureNorway** и постройте его.
1. Установите расширения CRT:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **SequentialSignatureNorway\\ScaleUnit\\ScaleUnit.SequentialSignNorway.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.SequentialSignNorway.Installer**.
        - **Локальный CRT на Modern POS:** в папке **SequentialSignatureNorway\\ModernPOS\\ModernPos.SequentialSignNorway.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPos.SequentialSignNorway.Installer**.

    1. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.SequentialSignNorway.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.SequentialSignNorway.Installer.exe install --verbosity 0
            ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **SequentialSignatureNorway build-pipeline.yaml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

### <a name="enable-the-digital-signature-in-offline-mode-for-modern-pos"></a>Включение цифровой подписи в автономном режиме для Modern POS

Чтобы включить цифровую подпись в автономном режиме для Modern POS, необходимо выполнить следующие действия после активации Modern POS на новом устройстве.

1. Войдите в POS.
1. На странице **Состояние подключения к базе данных** убедитесь, что автономная база данных полностью синхронизирована. Когда значение поля **Ожидающие загрузки** равно **0** (нулю), база данных полностью синхронизирована.
1. Выйдите из приложения POS.
1. Подождите, пока база данных в автономном режиме не будет полностью синхронизирована.
1. Войдите в POS.
1. На странице **Состояние подключения к базе данных** убедитесь, что автономная база данных полностью синхронизирована. Когда значение поля **Ожидающие проводки в автономной базе данных** равно **0** (нулю), база данных полностью синхронизирована.
1. Снова откройте Modern POS.
