---
title: Пример интеграции службы финансовой регистрации для Чешской Республики
description: В этой статье представлен обзор примера финансовой интеграции для Чешской Республики в Microsoft Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 03/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: epopov
ms.search.validFrom: 2019-4-1
ms.dyn365.ops.version: 10.0.2
ms.openlocfilehash: d255b03242a4cb7a72cef1e8e6fab901ecf953e6
ms.sourcegitcommit: 52b7225350daa29b1263d8e29c54ac9e20bcca70
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/03/2022
ms.locfileid: "8910506"
---
# <a name="fiscal-registration-service-integration-sample-for-the-czech-republic"></a>Пример интеграции службы финансовой регистрации для Чешской Республики

[!include[banner](../includes/banner.md)]

В этой статье представлен обзор примера финансовой интеграции для Чешской Республики в Microsoft Dynamics 365 Commerce.

Для соблюдения локальных финансовых требований для кассовых ККМ в Чешской Республике функции Dynamics 365 Commerce для Чешской Республики включают образец интеграции POS-терминалов с внешней службой финансовой регистрации. Образец расширяет [функциональность финансовой интеграции](fiscal-integration-for-retail-channel.md). Он основан на решении [EFR (Electronic Fiscal Register)](https://efsta.org/sicherheitsloesungen/) от [EFSTA](https://efsta.org/) и обеспечивает связь с службой EFR через протокол HTTPS. Служба EFR обеспечивает электронную регистрацию продаж (EET - Elektronická evidence tržeb), то есть, передачу через Интернет данных продаж в финансовую веб-службу налоговых органов.

Служба EFR должна располагаться на станции Commerce Hardware Station или на отдельном компьютере, к которому можно подключиться с помощью Hardware Station. Пример представлен в форме исходного кода и является частью пакета SDK Retail.

Корпорация Майкрософт не выпускает никакое оборудование, программное обеспечение или документацию из EFSTA. Для получения сведений о получении решения EFR и работе с ним обратитесь в [EFSTA](https://efsta.org/kontakt/).

## <a name="scenarios"></a>Сценарии

Пример интеграции службы финансовой интеграции для Чешской Республики покрывает следующие сценарии.

- Регистрация кассовых проводок в службе финансовой регистрации.

    - Отправка подробной информации о проводках в службу финансовой регистрации. Эти данные включают сведения о строке продаж и сведения о скидках, платежах и налогах. Служба финансовой регистрации далее отправляет данные в веб-службу налоговых органов и получает подтверждение от нее, которое включает финансовый идентификационный код проводки.
    - Сбор отклика от службы финансовой регистрации. Этот ответ содержит финансовые данные, такие как финансовый код идентификации и код безопасности проводки и т. д.
    - Печать финансовых данных для зарегистрированной проводки на чеке.

- Регистрация операций с подарочными сертификатами и депозитами клиентов в службе финансовой регистрации.

    - Расход или добавление средств на счету подарочного сертификата.
    - Регистрация депозита на счету клиента.
    - Создание заказа клиента и регистрация депозита для заказа.
    - Изменение заказа клиента и переопределение депозита для заказа.
    - Отмена заказа клиента и возврат денежных средств депозита для заказа.

- Обработка ошибок, например, следующие параметры.

    - Повторите попытку выполнения финансовой регистрации, если возможна повторная попытка, например в том случае, если служба финансовой регистрации недоступна, не готова или не отвечает.
    - Откладывание финансовой регистрации.
    - Пропустите финансовую регистрацию или пометьте проводку как зарегистрированную и включите коды сведений для фиксации причины сбоя и дополнительной информации.
    - Проверка доступности службы финансовой регистрации до открытия новой проводки по продажам или завершения проводки по продажам.

### <a name="gift-cards"></a>Подарочные сертификаты

В образце интеграции со службой финансовой регистрации реализованы следующие правила, которые относятся к подарочным сертификатам.

- Строки продаж, которые относятся к операциям *выпуска подарочного сертификата* или *добавления на подарочный сертификат* в проводках по продажам помечаются специальным атрибутом, когда проводка регистрируется в службе финансовой регистрации.
- Платеж по подарочному сертификату рассматривается как обычный платеж и помечается специальным атрибутом, когда проводка регистрируется в службе финансовой регистрации.

### <a name="customer-account-deposits-and-customer-order-deposits"></a>Депозиты по счету клиента и депозиты по заказу клиента

В образце интеграции со службой финансовой регистрации реализованы следующие правила, которые относятся к депозитам счетов клиентов и депозитам заказов клиентов.

- Проводка, имеющая отношение к депозиту счета клиента или депозиту по заказу клиента, регистрируется в службе финансовой регистрации как проводка по одной строке и помечается специальным атрибутом. В этой строке указывается группа НДС депозита.
- Когда создается гибридный заказ клиента, то есть заказ клиента, в котором содержатся продукты, которые могут быть получены клиентом в магазине, а также продукты, которые будут получены или отгружены позже, проводка, зарегистрированная в службе финансовой регистрации, содержит строки для продуктов, которые были получены, а также строку для депозита заказа.
- Платеж со счета клиента рассматривается как обычный платеж и помечается специальным атрибутом, когда проводка регистрируется в службе финансовой регистрации.
- Сумма депозита по заказу клиента, которая применяется к операции самовывоза заказа клиента, считается обычным платежом и отмечается специальным атрибутом, когда проводка регистрируется в службе финансовой регистрации.

### <a name="offline-registration"></a>Автономная регистрация

Если служба финансовой регистрации не может передать данные проводок в финансовую веб-службу налоговых органов (например, из-за таймаута отклика) и получить подтверждение от веб-службы (то есть, финансовый код проводки), она создает локальную подпись для проводки и включает ее и особый код ошибки в ответ. Служба финансовой регистрации повторно отправляет проводки в исходном порядке в фоновом режиме, как только будет восстановлено сетевое подключение.

### <a name="limitations-of-the-sample"></a>Ограничения примера

Служба финансовой регистрации поддерживает только ситуации, в которых налог включается в цену. Поэтому параметр **Цена включает налог** должен быть установлен в значение **Да** как для магазинов, так и для клиентов.

## <a name="set-up-commerce-for-the-czech-republic"></a>Настройка Commerce для Чешской Республики

В этом разделе описываются параметры Commerce, которые относятся к Чешской Республики и рекомендованы для нее. Дополнительные сведения см. в разделе [Домашняя страница Commerce](../index.md).

Чтобы использовать функциональность, относящуюся к Чешской Республике, вы должны указать следующие параметры.

- В основном адресе юридического лица задайте для поля **Страна/регион** значение **CZE** (Чешская Республика).
- В профиле функциональности POS каждого магазина, расположенного в Чешской Республике, установите для поля **Код ISO** значение **CZ** (Чешская Республика).

Также необходимо указать следующие параметры для Чешской Республики. Обратите внимание, что после завершения настройки необходимо выполнить соответствующие задания распределения.

### <a name="set-up-vat-per-czech-republic-requirements"></a>Настройка НДС в соответствии с требованиями Чешской Республики


Необходимо создать коды налога, налоговые группы и налоговые группы номенклатур. Необходимо также настроить сведения о налогах для продуктов и услуг. Дополнительные сведения о настройке кодов и использовании функций налогов см. в разделе [Обзор налогов](../../finance/general-ledger/indirect-taxes-overview.md).

### <a name="set-up-stores"></a>Настройка магазинов

На странице **Все магазины** обновите сведения о магазинах. Конкретно, задайте следующие параметры.

- В поле **Налоговая группа** укажите налоговую группу, которая должна использоваться для продажи клиенту по умолчанию.
- Установите для параметра **Цены включают налог** значение **Да**.
- Задайте в поле **Имя** название компании. Это изменение помогает гарантировать, что название компании появится в чеке по продажам. Кроме того, можно добавить название компании в макет чека по продажам в качестве текста произвольной формы.
- В поле **Идентификационный номер налогоплательщика (ИНН)** укажите идентификационный номер компании. Это изменение помогает гарантировать, что идентификационный номер компании появится в чеке по продажам. Кроме того, можно добавить идентификационный номер компании в макет чека по продажам в качестве текста произвольной формы.

### <a name="set-up-functionality-profiles"></a>Настройка профилей функциональности

Настройте профили функциональности POS.

- На экспресс-вкладке **Нумерация чеков** настройте нумерацию чеков путем создания или обновления записей для типов проводок **Продажа**, **Заказ на продажу** и **Возврат**.

### <a name="set-up-registration-numbers"></a>Настройка регистрационных номеров

1. Откройте **Администрирование организации \> Глобальная адресная книга \> Типы регистрации \> Типы регистрации**. Создайте новый тип регистрации. Укажите в поле **Страна/регион** значение **CZE** (Чешская Республика) и убедитесь, что оно ограничено организацией.
2. Откройте **Администрирование организации \> Глобальная адресная книга \> Типы регистрации \> Категории регистрации**. Создайте новую категорию регистрации. Выберите тип регистрации на предыдущем шаге и задайте для параметра **Категория регистрации** значение **Код корпоративного помещения**.
3. Перейдите в раздел **Управление организацией \> Организации \> Операционные единицы**. Для каждого магазина, расположенного в Чешской Республике, выберите единицу, соответствующую магазину. На экспресс-вкладке **Адрес** разверните раскрывающийся список **Дополнительные параметры** и выберите **Дополнительно**. 
4. На открытой странице **Управление адресами** необходимо указать следующий параметр.

    - На экспресс- вкладке **Адрес** в поле **Страна/регион** задайте значение **CZE**.
    - На экспресс-вкладке **Регистрационный номер** создайте новую запись. Выберите созданный ранее тип регистрации и задайте номер регистрации.

### <a name="configure-custom-fields-so-that-they-can-be-used-in-receipt-formats-for-sales-receipts"></a>Настройка настраиваемых полей таким образом, чтобы их можно было использовать в форматах чеков для чеков на продажу

Можно настроить текст языка и настраиваемые поля, используемые в форматах чеков POS-терминала. Компанией по умолчанию для пользователя, который создает настройку чека, должна быть то же юридическое лицо, в котором создана текстовая настройка языка. В качестве альтернативы необходимо создать те же тексты на языке компании пользователя по умолчанию и на языке юридического лица магазина, для которого создается настройка.

На странице **Текст языка** добавьте следующие записи для меток настраиваемых полей для макетов чеков. Обратите внимание на то, что значения **Код языка**, **Код текста** и **Текст**, показанные в таблице, являются просто примерами. Их можно изменить в зависимости от требований. Однако используемые вами значения **Код текста** должны быть уникальными и должны быть больше или равны 900001.

Добавьте следующие ярлыки POS в раздел **POS** поля **Текст языка** из таблицы:

| Код языка | Код текста | Текст                   |
|-------------|---------|------------------------|
| en-US       | 900001  | ID provozovny/pokladny |
| en-US       | 900002  | BKP                    |
| en-US       | 900003  | PKP                    |
| en-US       | 900004  | FIK                    |
| en-US       | 900005  | Информация                   |
| en-US       | 900006  | Порядковый номер        |

На странице **Настраиваемые поля** добавьте следующие записи для настраиваемых полей для макетов чеков. Обратите внимание, что значения **Код текста подписи** должны соответствовать значениям **Код текста**, указанным на странице **Текст языка**:

| Имя                 | Тип    | ИД текста заголовка |
|----------------------|---------|-----------------|
| TLT                  | Чек | 900001          |
| SEC                  | Чек | 900002          |
| SIGN                 | Чек | 900003          |
| FISCAL               | Чек | 900004          |
| INFO                 | Чек | 900005          |
| CONTINUOUSNUMBER     | Чек | 900006          |

> [!NOTE]
> Важно указать правильные имена настраиваемых полей, как перечислено в предыдущей таблице. Неправильное имя настраиваемого поля приведет к пропущенным данным в чеках.

### <a name="configure-receipt-formats"></a>Настройка форматов чеков

Для каждого требуемого формата чека измените значение в поле **Поведение печати** на **Всегда печатать**.

В конструкторе формата чеков добавьте следующие настраиваемые поля в соответствующие разделы чека. Обратите внимание, что имена полей соответствуют текстам языка, определенным в предыдущем разделе.

- **Заголовок:** добавьте следующие поля.

    - **Название магазина** и **Идентификационный номер налогоплательщика**: эти поля используются для печати названия компании и идентификационного номера на чеках. Кроме того, можно добавить название компании и идентификационный номер в макет чека по продажам в качестве текста произвольной формы.
    - **Адрес магазина**, **Дата**, **Время в формате 24H**, **Номер чека** и **Номер ККМ**.
    - **Порядковый номер**: в этом поле указывается номер кассовой проводки в службе финансовой регистрации.

- **Строки:** добавьте следующие поля.

    - **Наименование номенклатуры**
    - **Кол-во**
    - **Общая цена с учетом налога**

- **Нижний колонтитул:** добавьте следующие поля.

    - Поля оплаты, чтобы печатались суммы платежа для каждого метода платежа. Например, добавьте поля **Название платежного средства** и **Сумма платежного средства** в одну строку макета.
    - **ID provozovny/pokladny**: в этом поле печатаются идентификаторы делового помещения и ККМ.
    - **BKP** : в этом поле распечатывается код безопасности налогоплательщика, назначенный службой финансовой регистрации.
    - **FIK**: в этом поле распечатывается код финансового идентификатора проводки, который назначается веб-службой налоговых органов в случае успеха интерактивной регистрации.
    - **PKP** : в этом поле распечатывается код подписи налогоплательщика, созданный службой финансовой регистрации в случае автономной регистрации.
    - **Информация**: в этом поле печатаются дополнительные сведения из службы финансовой регистрации.

Дополнительные сведения о работе с форматами чеков см. в разделе [Настройка и конструирование форматов чеков](../receipt-templates-printing.md).

## <a name="set-up-fiscal-integration-for-the-czech-republic"></a>Настройка финансовой интеграции для Чешской Республики

Образец интеграции службы финансовой регистрации для Чешской Республики базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\Efr** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/Efr)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением среды выполнения Commerce Runtime (CRT), и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [рекомендации по развертыванию образца финансовой интеграции для Чешской Республики (устаревшая версия)](emea-cze-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

Выполните шаги настройки финансовой интеграции, как описано в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md):

1. [Настройте процесс финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Кроме того, запишите настройки для процесса финансовой регистрации, которые [относятся к данному образцу интеграции со службой финансовой регистрации](#set-up-the-registration-process).
1. [Задайте параметры обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).
1. [Включите выполнение вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="set-up-the-registration-process"></a>Настройка процесса регистрации

Чтобы включить процесс регистрации, выполните следующие действия для настройки Commerce Headquarters. Дополнительные сведения см. в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения (например, **[release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33)**).
    1. Откройте **src \> FiscalIntegration \> Efr**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **Конфигурации \> DocumentProviders \> DocumentProviderFiscalEFRSampleCzech.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/Efr/Configurations/DocumentProviders/DocumentProviderFiscalEFRSampleCzech.xml)).
    1. Загрузите файл конфигурации финансового соединителя по пути **Конфигурации \> Соединители \> ConnectorEFRSample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/Efr/Configurations/Connectors/ConnectorEFRSample.xml)).

    > [!WARNING]
    > Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Файлы конфигурации для данного образца финансовой интеграции находятся в следующих папках пакета Retail SDK на виртуальной машине для разработчиков в LCS:
    >
    > - **Файл конфигурации поставщика финансовых документов:** RetailSdk\\SampleExtensions\\CommerceRuntime\\Extensions.DocumentProvider.EFRSample\\Configuration\\DocumentProviderFiscalEFRSampleCzech.xml
    > - **Файл конфигурации финансового соединителя:** RetailSdk\\SampleExtensions\\HardwareStation\\Extension.EFRSample\\Configuration\\ConnectorEFRSample.xml
    > 
    > Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

1. Перейдите в раздел **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя. Выберите поставщика документов и соединитель, который был загружен ранее. При необходимости обновите [параметры сопоставления данных](#default-data-mapping).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите финансовый соединитель, который был загружен ранее. При необходимости обновите [параметры соединителя](#fiscal-connector-settings).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**. Создайте новую группу финансовых соединителей для функционального профиля соединителя, созданного ранее.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации.
1. Перейдите **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**. Выберите профиль оборудования, который связан с Hardware Station, с которой будет связан фискальный принтер. На экспресс-вкладке **Фискальная периферия** выберите ранее созданный технический профиль соединителя.
1. Откройте график распределения (**Retail и Commerce \> ИТ Retail и Commerce \> График распределения**) и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

#### <a name="default-data-mapping"></a>Сопоставление данных по умолчанию

Следующее сопоставление данных по умолчанию включено в конфигурацию поставщика фискальных документов, которая предоставляется в составе образца финансовой интеграции:

- **Сопоставление ставок налога на добавленную стоимость (НДС)** — сопоставление значений процента налога, которые настроены для налоговых кодов для значений атрибута **TaxG** (налоговая группа) в запросах, отправляемых в финансовую службу. Вот сопоставление по умолчанию:

    ```
    A: 21.00; B: 15.00; C: 10.00; Z: 0.00
    ```

    Первый компонент в каждой паре представляет налоговую группу НДС, которая поддерживается службой финансовой регистрации EFR. Второй компонент представляет соответствующую ставку НДС. Дополнительные сведения о налоговых группах НДС, поддерживаемых EFR для Чешской Республики, см. в разделе [Справочник по EFR](https://public.efsta.net/efr/).

- **Сопоставление группы НДС по умолчанию** — любые суммы НДС, которые не могут быть сопоставлены с одной из предопределенных групп НДС, будут добавлены к группе НДС по умолчанию (базовой группе). Вот сопоставление по умолчанию:

    ```
    A
    ```

- **Сопоставление группы НДС по депозитам** – суммы депозитов клиентов и суммы депозитов по заказам клиентов будут назначены группе НДС по депозитам. Вот сопоставление по умолчанию:

    ```
    Z
    ```

#### <a name="fiscal-connector-settings"></a>Параметры финансового соединителя

Следующие параметры включены в конфигурацию финансового соединителя, которая предоставляется в составе образца финансовой интеграции:

- **Адрес конечной точки** — URL-адрес службы финансовой регистрации.
- **Время ожидания** — период времени в миллисекундах, в течение которого финансовый соединитель будет ожидать отклика от службы финансовой регистрации.

### <a name="configure-channel-components"></a>Настройка компонентов канала

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца финансовой интеграции для Чешской Республики (устаревшая версия)](emea-cze-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

#### <a name="set-up-the-development-environment"></a>Настройка среды разработки

Чтобы настроить среду разработки для проверки и расширения образца, выполните следующие действия.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Retail SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение EFR в **Dynamics365Commerce.Solutions\\FiscalIntegration\\Efr\\EFR.sln** и создайте его.
1. Установите расширения CRT:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **Efr\\ScaleUnit\\ScaleUnit.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.EFR.Installer**.
        - **Локальный CRT на Modern POS:** в папке **Efr\\ModernPOS\\ModernPOS.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPOS.EFR.Installer**.

    1. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.EFR.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.EFR.Installer.exe install --verbosity 0
            ```

1. Установка расширений финансового соединителя:

    Можно установить расширения финансовых соединителей на [станцию оборудования](fiscal-integration-for-retail-channel.md#fiscal-registration-is-done-via-a-device-connected-to-the-hardware-station) или [POS-терминал](fiscal-integration-for-retail-channel.md#fiscal-registration-is-done-via-a-device-or-service-in-the-local-network).

    1. Установите расширения Hardware Station:

        1. В папке **Efr\\HardwareStation\\HardwareStation.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **HardwareStation.EFR.Installer**.
        1. Запустите установщик расширений из командной строки, выполнив следующую команду.

            ```Console
            HardwareStation.EFR.Installer.exe install --verbosity 0
            ```

    1. Установите расширения POS:

        1. Откройте образец решения финансового соединителя POS по пути **Dynamics365Commerce.Solutions\\FiscalIntegration\\PosFiscalConnectorSample\\Contoso.PosFiscalConnectorSample.sln** и выполните его сборку.
        1. В папке **PosFiscalConnectorSample\\StoreCommerce.Installer\\bin\\Debug\\net461** найдите установщик **Contoso.PosFiscalConnectorSample.StoreCommerce.Installer**.
        1. Запустите установщик расширений из командной строки, выполнив следующую команду.

            ```Console
            Contoso.PosFiscalConnectorSample.StoreCommerce.Installer.exe install --verbosity 0
            ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **EFR build-pipeline.yml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

## <a name="design-of-extensions"></a>Разработка расширений

Образец интеграции службы финансовой регистрации для Чешской Республики базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\Efr** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/Efr)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services) из поставщика финансового документа, который является расширением CRT, и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца финансовой интеграции для Чешской Республики (устаревшая версия)](emea-cze-fi-sample-sdk.md). Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

### <a name="commerce-runtime-extension-design"></a>Разработка расширения Commerce Runtime

Целью расширения, которое является поставщиком финансовых документов, является создание документов для конкретной службы и обработка откликов от службы финансовой регистрации.

#### <a name="request-handler"></a>Обработчик запросов

Для поставщика документов имеется единый обработчик запросов **DocumentProviderEFRFiscalCZE**, который используется для создания финансовых документов для службы финансовой регистрации.

Этот обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени поставщика документа соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы.

- **GetFiscalDocumentDocumentProviderRequest** — этот запрос содержит сведения о том, что должен создаваться документ. Он возвращает специфический для службы документ, который должен быть зарегистрирован в службе финансовой регистрации.
- **GetSupportedRegistrableEventsDocumentProviderRequest** — этот запрос возвращает список событий, на которые необходимо подписаться. В настоящее время поддерживаются следующие события: продажи, депозиты счетов клиентов и депозиты заказов клиентов.
- **GetFiscalRegisterResponseToSaveDocumentProviderRequest** — этот запрос возвращает ответ от службы финансовой регистрации. Этот ответ сериализуется для формирования строки, чтобы ее можно было сохранить.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для поставщика фискального документа расположен по пути **src\\FiscalIntegration\\Efr\\Configurations\\DocumentProviders\\DocumentProviderFiscalEFRSampleCzech.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров поставщика фискального документа из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="hardware-station-extension-design"></a>Разработка расширения Hardware Station

Целью расширения, которое является финансовым соединителем, является обмен данными со службой финансовой регистрации. Расширение аппаратной станции использует протокол HTTP для отправки документов, создаваемых расширением CRT в службе финансовой регистрации. Оно также обрабатывает отклики, полученные от службы финансовой регистрации.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **EFRHandler** является точкой входа для обработки запросов к службе финансовой регистрации.

Обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы.

- **SubmitDocumentFiscalDeviceRequest** — этот запрос отправляет документы в службу финансовой регистрации и возвращает из него отклики.
- **IsReadyFiscalDeviceRequest** — этот запрос используется для проверки работоспособности службы финансовой регистрации.
- **InitializeFiscalDeviceRequest** — этот запрос используется для инициализации службы финансовой регистрации.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для фискального соединителя расположен по пути **src\\FiscalIntegration\\Efr\\Configurations\\Connectors\\ConnectorEFRSample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров финансового соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="pos-fiscal-connector-extension-design"></a>Дизайн расширения финансового соединителя POS-терминала

Целью расширения финансового соединителя POS-терминала является обмен данными со службой финансовой регистрации из POS-терминала. Он использует протокол HTTPS для связи.

#### <a name="fiscal-connector-factory"></a>Фабрика финансовых соединителей

Фабрика финансовых соединителей сопоставляет имя соединителя с реализацией финансового соединителя и находится в файле **Pos.Extension\\Connectors\\FiscalConnectorFactory.ts**. Имя соединителя должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

#### <a name="efr-fiscal-connector"></a>Финансовый соединитель EFR

Финансовый соединитель EFR находится в файле **Pos.Extension\\Connectors\\Efr\\EfrFiscalConnector.ts**. Он реализует интерфейс **IFiscalConnector**, который поддерживает следующие запросы:

- **FiscalRegisterSubmitDocumentClientRequest** — этот запрос отправляет документы в службу финансовой регистрации и возвращает из него отклики.
- **FiscalRegisterIsReadyClientRequest** — этот запрос используется для проверки работоспособности службы финансовой регистрации.
- **FiscalRegisterInitializeClientRequest** — этот запрос используется для инициализации службы финансовой регистрации.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации находится в папке **src\\FiscalIntegration\\Efr\\Configurations\\Connectors** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки для параметров финансового соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции. Добавлены следующие параметры:

- **Адрес конечной точки** — URL-адрес службы финансовой регистрации.
- **Время ожидания** — период времени в миллисекундах, в течение которого соединитель будет ожидать отклика от службы финансовой регистрации.

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
