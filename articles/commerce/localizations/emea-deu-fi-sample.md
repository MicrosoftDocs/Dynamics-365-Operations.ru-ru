---
title: Пример интеграции службы финансовой регистрации для Германии
description: В этой теме представлен обзор примера финансовой интеграции для Германии в Microsoft Dynamics 365 Commerce.
author: EvgenyPopovMBS
ms.date: 12/20/2021
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: epopov
ms.search.validFrom: 2020-5-29
ms.openlocfilehash: ca747215a8dfb85237365880ad5bdd49e57ec949
ms.sourcegitcommit: 0d2de52e12fdb9928556d37a4813a67b303695dc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2021
ms.locfileid: "7944696"
---
# <a name="fiscal-registration-service-integration-sample-for-germany"></a>Пример интеграции службы финансовой регистрации для Германии

[!include[banner](../includes/banner.md)]

В этой теме представлен обзор примера финансовой интеграции для Германии в Microsoft Dynamics 365 Commerce.

Для соблюдения локальных финансовых требований для кассовых ККМ в Германии функции Microsoft Dynamics 365 Commerce для Германии включают образец интеграции POS-терминалов с внешней службой финансовой регистрации. Образец расширяет [функциональность финансовой интеграции](fiscal-integration-for-retail-channel.md). Он основан на решении [EFR (Electronic Fiscal Register)](https://www.efsta.eu/de/fiskalloesungen/deutschland) от [EFSTA](https://www.efsta.eu/de/) и обеспечивает связь с службой EFR через протокол HTTPS. Служба EFR должна располагаться на станции Retail Hardware Station или на отдельном компьютере, к которому можно подключиться с помощью Hardware Station. Пример представлен в форме исходного кода и является частью пакета SDK Retail.

Корпорация Майкрософт не выпускает никакое оборудование, программное обеспечение или документацию из EFSTA. Для получения сведений о получении решения EFR и работе с ним обратитесь в [EFSTA](https://www.efsta.eu/de/kontakt/kontakt).

## <a name="scenarios"></a>Сценарии

Пример интеграции службы финансовой интеграции для Германии покрывает следующие сценарии.

### <a name="sales-operations"></a>Операции продажи

- **Регистрация продаж и возвратов с кассовыми проводками в службе финансовой регистрации:**

    Регистрация операций продажи включает в себя следующие шаги:

    1. Регистрация начала проводки

        Начало каждой проводки регистрируется в элементе технического контроля безопасности (TSE), подключенном к службе EFR. В результате регистрации TSE назначает код проводки (TID).

    2. Регистрация окончания проводки

        При завершении проводки на POS-терминале она регистрируется с использованием того же ключа TID, который был назначен во время регистрации начала проводки. В этот момент подробная информация о проводках отправляется в службу финансовой регистрации. Эти данные включают сведения о строке продаж и сведения о скидках, платежах и налогах.

    3. Сбор отклика от службы финансовой регистрации

        Данные безопасности поступают от TSE в качестве части отклика и сохраняются в транзакции в базе данных канала. Данные безопасности состоят из следующих данных:

        - TID
        - Дата и время начала проводки
        - Дата и время завершения проводки
        - Счетчик подписей
        - Проверочное значение
        - Серийный номер TSE

- **Регистрация заказов клиентов в службе финансовой регистрации:** процесс регистрации такой же, как и для продаж и возврата с кассовыми проводками.
- **Регистрация операций с подарочными сертификатами и депозитами:** процесс регистрации такой же, как и для продаж и возврата с кассовыми проводками.

#### <a name="notifying-users-about-fiscal-registration-failures"></a>Уведомление пользователей о сбоях финансовой регистрации

Служба финансовой регистрации может уведомлять пользователей о сбоях, произошедших в ходе финансовой регистрации, двумя способами:

- Печать дополнительной информации из отклика в поле **Информационное сообщение** в чеках.
- Отображение уведомлений от финансовой службы в виде пользовательских сообщений на POS-терминале.

    > [!NOTE]
    > Этот механизм уведомлений требует, чтобы параметр **Отображать уведомления о финансовой регистрации** на странице **Технические профили соединителя** был включен.

#### <a name="printing-receipts"></a>Печать чеков

Печать чеков обязательна в Германии. Все чеки должны содержать по крайней мере следующую информацию:

- Имя и адрес компании
- Сведения о товарах, включая их цены и количества
- Сведения о полученных платежах
- Сведения о налогах, включая итоговые суммы на ставку налогов
- Данные о безопасности:

    - TID
    - Дата и время начала проводки
    - Дата и время завершения проводки
    - Счетчик подписей
    - Проверочное значение
    - Серийный номер TSE

- Информационное сообщение

> [!NOTE]
> QR-код может также быть распечатан на чеках. Хотя QR-код не является обязательным, он настоятельно рекомендуется. Дополнительные сведения о порядке получения QR-кода в качестве части ответа от службы финансовой регистрации см. в документе "Руководство по EFR \[DE\]", который опубликован на веб-сайте [документации EFSTA](https://public.efsta.net/efr/).
>
> Поле **Информационное сообщение** в чеках отображает уведомление от службы финансовой регистрации. Например, если устройство подписи сломано, в чеке можно напечатать специальный текст.

#### <a name="voided-suspended-and-recalled-transactions"></a>Аннулированные, приостановленные или отозванные проводки

- Аннулированная проводка регистрируется в качестве запроса на прерывания проводки в службе финансовой регистрации.
- Приостановленная проводка регистрируется в качестве запроса на прерывания проводки в службе финансовой регистрации.
- Отозванная проводка регистрируется в качестве запроса на начало новой проводки в службе финансовой регистрации.

### <a name="non-sales-transactions-and-shift-closing"></a>Проводки, не связанные с продажами, и закрытие смен

Следующие проводки, не связанные с продажами, регистрируются как нефинансовые операции в службе финансовой регистрации с помощью тега **NFS**:

- Объявить начальную сумму
- Внесение денежных средств
- Удаление платежного средства
- Сдача наличных средств в сейф
- Инкассация
- Приходные счета
- Расходные счета

Операция **Закрыть смену** также регистрируются как нефинансовая операция в службе финансовой регистрации с помощью тега **NFS**.

### <a name="data-export-and-audit"></a>Экспорт и аудит данных

Все проводки должны быть подписаны с помощью TSE, чтобы гарантировать их целостность, подлинность и полноту, и чтобы помочь предотвратить манипуляцию записанными данными.

> [!WARNING]
> Может использоваться только сертифицированный TSE. Сведения о типах и моделях TSE, поддерживаемых в решении EFR, см. в документе "Руководство по EFR \[DE\]", который опубликован на веб-сайте [документации EFSTA](https://public.efsta.net/efr/). Для получения сведений о выборе и получении TSE обратитесь в [EFSTA](https://www.efsta.eu/at/kontakt).

Законодательство в Германии требует поддержки экспорта DSFinV-K. Экспорт DSFinV-K может быть запущен в решении EFR. Дополнительные сведения об экспорте DSFinV-K см. в документе "Руководство по EFR \[DE\]", который опубликован на веб-сайте [документации EFSTA](https://public.efsta.net/efr/).

### <a name="limitations-of-the-sample"></a>Ограничения примера

Служба финансовой регистрации поддерживает только ситуации, в которых налог включается в цены. Поэтому параметр **Цены включают налог** должен быть установлен в значение **Да** как для магазинов, так и для клиентов.

Финансовая служба не поддерживает ситуации, когда для одной и той же строки проводки применяется несколько налоговых кодов.

Платформа финансовой интеграции не поддерживает предложения с расценками по продажам. Таким образом, эти операции не регистрируются в финансовой службе.

## <a name="set-up-commerce-for-germany"></a>Настройка Commerce для Германии

В этом разделе описываются параметры Commerce, которые относятся к Германии и рекомендованы для нее. Дополнительные сведения о настройке см. в разделе [Домашняя страница Commerce](../index.md).

Чтобы использовать функциональность, относящуюся к Германии, вы должны указать следующие параметры.

- В основном адресе юридического лица задайте для поля **Страна/регион** значение **DEU** (Германия).
- В профиле функциональности POS каждого магазина, расположенного в Германии, установите для поля **Код ISO** значение **DE** (Германия).

Также необходимо указать следующие параметры для Германии. После завершения настройки необходимо выполнить соответствующие задания распределения.

### <a name="set-up-vat-per-german-requirements"></a>Настройка НДС по требованиям Германии

Необходимо создать коды налога, налоговые группы и налоговые группы номенклатур. Необходимо также настроить сведения о налогах для продуктов и услуг. Дополнительные сведения о настройке кодов и использовании функций налогов см. в разделе [Обзор налогов](../../finance/general-ledger/indirect-taxes-overview.md).

В чеке на продажу можно напечатать сокращенный код для налогового кода (например, "A" или "B"). Чтобы сделать эту функциональность доступной, установите поле **Код для печати** на странице **Налоговые коды**.

### <a name="set-up-stores"></a>Настройка магазинов

На странице **Все магазины** обновите сведения о магазинах. Конкретно, задайте следующие параметры:

- В поле **Налоговая группа** укажите налоговую группу, которая должна использоваться для продажи клиенту по умолчанию.
- Установите для параметра **Цены включают налог** значение **Да**.
- Задайте в поле **Имя** название компании. Это изменение помогает обеспечить, что название компании появится в чеке по продажам. Кроме того, можно добавить название компании в макет чека по продажам в качестве текста произвольной формы.
- В поле **Идентификационный номер налогоплательщика (ИНН)** укажите идентификационный номер компании. Это изменение помогает обеспечить, что идентификационный номер компании появится в чеке по продажам. Кроме того, можно добавить идентификационный номер компании в макет чека по продажам в качестве текста произвольной формы.

### <a name="set-up-functionality-profiles"></a>Настройка профилей функциональности

Настройте профили функциональности POS. На экспресс-вкладке **Нумерация чеков** настройте нумерацию чеков путем создания или обновления записей для типов проводок **Продажа**, **Заказ на продажу** и **Возврат**.

### <a name="configure-custom-fields-so-that-they-can-be-used-in-receipt-formats-for-sales-receipts"></a>Настройка настраиваемых полей таким образом, чтобы их можно было использовать в форматах чеков для чеков на продажу

Можно настроить текст языка и настраиваемые поля, используемые в форматах чеков POS-терминала. Компанией по умолчанию для пользователя, который создает настройку чека, должна быть то же юридическое лицо, в котором создана текстовая настройка языка. В качестве альтернативы необходимо создать те же тексты на языке компании пользователя по умолчанию и на языке юридического лица магазина, для которого создается настройка.

На странице **Текст языка** добавьте следующие записи для меток настраиваемых полей для макетов чеков. Обратите внимание на то, что значения **Код языка**, **Код текста** и **Текст**, показанные в таблице, являются просто примерами. Их можно изменить в зависимости от требований. Однако используемые вами значения **Код текста** должны быть уникальными и должны быть больше или равны 900001.

Добавьте следующие ярлыки POS в раздел **POS** страницы **Текст языка**:

| Код языка | Код текста | Текст                                  |
|-------------|---------|---------------------------------------|
| en-US       | 900001  | QR-код                               |
| en-US       | 900002  | Код проводки                        |
| en-US       | 900003  | Код печати налога на розницу                 |
| en-US       | 900004  | Сумма налога (продажи)                    |
| en-US       | 900005  | Налоговая база (продажи)                     |
| en-US       | 900006  | Начальные дата и время проводки           |
| en-US       | 900007  | Конечные дата и время проводки             |
| en-US       | 900008  | Серийный номер элемента безопасности |
| en-US       | 900009  | Счетчик подписей                     |
| en-US       | 900010  | Проверочное значение                           |
| en-US       | 900011  | Информационное сообщение                          |

На странице **Настраиваемые поля** добавьте следующие записи для настраиваемых полей для макетов чеков. Обратите внимание, что значения **Код текста подписи** должны соответствовать значениям **Код текста**, указанным на странице **Текст языка**.

| Имя                            | Тип    | ИД текста заголовка |
|---------------------------------|---------|-----------------|
| QRCODE\_DE                      | Чек | 900001          |
| TRANSACTIONID\_DE               | Чек | 900002          |
| RETAILPRINTCODE\_DE             | Чек | 900003          |
| SALESTAXAMOUNT\_DE              | Чек | 900004          |
| SALESTAXBASIS\_DE               | Чек | 900005          |
| TRANSACTIONSTARTDATETIME\_DE    | Чек | 900006          |
| TRANSACTIONENDDATETIME\_DE      | Чек | 900007          |
| SECURITYELEMENTSERIALNUMBER\_DE | Чек | 900008          |
| SIGNCOUNTER\_DE                 | Чек | 900009          |
| SIGN\_DE                        | Чек | 900010          |
| INFOMESSAGE\_DE                 | Чек | 900011          |

> [!NOTE]
> Важно указать правильные имена настраиваемых полей, как перечислено в предыдущей таблице. Неправильное имя настраиваемого поля приведет к пропущенным данным в чеках.

### <a name="configure-receipt-formats"></a>Настройка форматов чеков

Для каждого требуемого формата чека измените значение в поле **Поведение печати** на **Всегда печатать**.

В конструкторе формата чеков добавьте следующие настраиваемые поля в соответствующие разделы чека. Обратите внимание, что имена полей соответствуют текстам языка, определенным в предыдущем разделе.

- **Заголовок:** добавьте следующие поля:

    - **Название магазина** и **Идентификационный номер налогоплательщика**, которые используются для печати названия компании и идентификационного номера на чеках. Кроме того, можно добавить название компании и идентификационный номер в макет чека по продажам в качестве текста произвольной формы.
    - Поля **Адрес магазина**, **Дата**, **Время в формате 24H**, **Номер чека** и **Номер ККМ**.

- **Строки:** добавьте следующие поля:

    - Поле **Наименование номенклатуры**
    - Поле **Кол-во**
    - Поле **Общая цена с учетом налога**
    - Поле **Код печати налога на розницу**, которое используется для печати сокращенного кода, соответствующего налоговому коду, который применяется к номенклатуре

- **Нижний колонтитул:** добавьте следующие поля:

    - Поля оплаты, чтобы печатались суммы платежа для каждого метода платежа. Например, добавьте поля **Название платежного средства** и **Сумма платежного средства** в одну строку макета.
    - Поля в группе полей **Разбивка налога**. Все поля в этой группе полей должны печататься на одной отдельной строке.

        - Поле **Налоговый код**, представляющее собой стандартное поле, позволяющее печатать сводку налогов для каждого налогового кода. Это поле должно быть добавлено на новую строку.
        - Поле **Процент налога** — это стандартное поле, используемое для печати эффективной налоговой ставки для налогового кода.
        - Поле **Налоговая база (продажи)**, используемое для печати общей суммы чека продажи за денежные средства для налогового кода. Операции с предоплатой и подарочными картами исключаются.
        - Поле **Сумма налога (продажи)**, используемое для печати суммы налога по чеку для продаж за денежные средства для налогового кода.
        - Поле **Код печати налога на розницу**, которое используется для печати сокращенного кода, соответствующего налоговому коду.

    - Поля, которые содержат защищенные данные проводок, возвращенные службой финансовой регистрации:

        - Поле **Код проводки**, в котором указывается номер кассовой проводки в службе финансовой регистрации
        - Поле **Дата и время начала проводки**
        - Поле **Дата и время завершения проводки**
        - Поле **Серийный номер элемента безопасности**
        - Поле **Счетчик подписей**
        - Поле **Контрольное значение**
        - Поле **QR-код**, которое используется для печати ссылки на зарегистрированную кассовую проводку в форме QR-кода

        > [!NOTE]
        > Значение **QR-код** извлекается из ответа финансового регистра. EFR возвращает QR-код в своем ответе, только если значение поля **Атрибуты** в конфигурации EFR описано в документации EFSTA. Формат QR-кода в поле **Атрибуты** конфигурации EFR должен быть установлено на значение **BMP**.

    - Поле **Информационное сообщение**, чтобы уведомления от службы финансовой регистрации могли отображаться на чеке. Например, если устройство подписи сломано, в чеке можно напечатать специальный текст.

Дополнительные сведения о работе с форматами чеков см. в разделе [Настройка и конструирование форматов чеков](../receipt-templates-printing.md).

## <a name="set-up-fiscal-integration-for-germany"></a>Настройка финансовой интеграции для Германии

Образец интеграции службы финансовой регистрации для Германии базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\Efr** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/Efr)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices) из поставщика финансового документа, который является расширением среды выполнения Commerce Runtime (CRT), и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине (ВМ) разработчика в Microsoft Dynamics Lifecycle Services (LCS). Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Германии (устаревшая версия)](emea-deu-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

Выполните шаги настройки финансовой интеграции, как описано в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md):

1. [Настройте процесс финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process). Кроме того, запишите настройки для процесса финансовой регистрации, которые [относятся к данному образцу интеграции со службой финансовой регистрации](#set-up-the-registration-process).
1. [Задайте параметры обработки ошибок](setting-up-fiscal-integration-for-retail-channel.md#set-error-handling-settings).

    > [!WARNING]
    > Возможности обработки ошибок платформы финансовой интеграции могут неполностью соответствовать местному финансовому законодательству.
    >
    > - Рекомендуется оставить параметр **Продолжить при ошибке** на странице **Процесс финансовой регистрации** отключенным, так как все проводки должны быть правильно зарегистрированы, даже если первая попытка в финансовой регистрации не удалась.
    > - Перед включением параметра **Пропустить** или **Пометить как зарегистрированный** на странице **Процесс финансовой регистрации** следует обсудить эти изменения в процессе финансовой регистрации с налоговым консультантом или в местном отделении налоговой службы.

1. [Включите выполнение вручную отложенной финансовой регистрации](setting-up-fiscal-integration-for-retail-channel.md#enable-manual-execution-of-postponed-fiscal-registration).
1. [Настройте компоненты каналов](#configure-channel-components).

### <a name="set-up-the-registration-process"></a>Настройка процесса регистрации

Чтобы включить процесс регистрации, выполните следующие действия для настройки Commerce Headquarters. Дополнительные сведения см. в разделе [Настройка финансовой интеграции для каналов Commerce](setting-up-fiscal-integration-for-retail-channel.md#set-up-a-fiscal-registration-process).

1. Загрузите файлы конфигурации для поставщика фискальных документов и финансового соединителя:

    1. Откройте репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/).
    1. Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения (например, **[release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33)**).
    1. Откройте **src \> FiscalIntegration \> Efr**.
    1. Загрузите файл конфигурации поставщика финансовых документов по пути **Конфигурации \> DocumentProviders \> DocumentProviderFiscalEFRSampleGermany.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/Efr/Configurations/DocumentProviders/DocumentProviderFiscalEFRSampleGermany.xml)).
    1. Загрузите файл конфигурации финансового соединителя по пути **Конфигурации \> Соединители \> ConnectorEFRSample.xml** (например, [файл для release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/blob/release/9.33/src/FiscalIntegration/Efr/Configurations/Connectors/ConnectorEFRSample.xml)).

    > [!WARNING]
    > Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Файлы конфигурации для данного образца финансовой интеграции находятся в следующих папках пакета Retail SDK на виртуальной машине для разработчиков в LCS:
    >
    > - **Файл конфигурации поставщика финансовых документов:** RetailSdk\\SampleExtensions\\CommerceRuntime\\Extensions.DocumentProvider.EFRSample\\Configuration\\DocumentProviderFiscalEFRSampleGermany.xml
    > - **Файл конфигурации финансового соединителя:** RetailSdk\\SampleExtensions\\HardwareStation\\Extension.EFRSample\\Configuration\\ConnectorEFRSample.xml
    > 
    > Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

1. Перейдите в раздел **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. На вкладке **Общие** задайте для параметра **Включить финансовую интеграцию** значение **Да**.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов** и загрузите ранее скаченный файл конфигурации поставщика финансовых документов.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Финансовые соединители** и загрузите ранее скаченный файл конфигурации финансового соединителя.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**. Создайте новый функциональный профиль соединителя. Выберите поставщика документов и соединитель, который был загружен ранее. При необходимости обновите [параметры сопоставления данных](#default-data-mapping).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**. Создайте новый технический профиль соединителя и выберите финансовый соединитель, который был загружен ранее. При необходимости обновите [параметры соединителя](#fiscal-connector-settings).
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**. Создайте новую группу финансовых соединителей для функционального профиля соединителя, созданного ранее.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**. Создайте новый процесс финансовой регистрации и шаг процесса финансовой регистрации и выберите созданную ранее группу финансовых соединителей.
1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**. Выберите профиль функциональности, связанный с магазином, в котором должен быть активирован процесс регистрации. На экспресс-вкладке **Процесс финансовой регистрации** выберите ранее созданный процесс финансовой регистрации.
1. Перейдите **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**. Выберите профиль оборудования, который связан с Hardware Station, с которой будет связан фискальный принтер. На экспресс-вкладке **Фискальная периферия** выберите ранее созданный технический профиль соединителя.
1. Откройте график распределения (**Retail и Commerce \> ИТ Retail и Commerce \> График распределения**) и выберите задания **1070** и **1090** для передачи данных в базу данных канала.

#### <a name="default-data-mapping"></a>Сопоставление данных по умолчанию

Следующее сопоставление данных по умолчанию включено в конфигурацию поставщика фискальных документов, которая предоставляется в составе образца финансовой интеграции:

- **Сопоставление типов платежных средств** — сопоставление методов оплаты со значениями атрибута **PayG** (платежная группа) в запросах, отправляемых в финансовую службу. Вот сопоставление по умолчанию:

    ```
    1: 0; 2: 1; 3: 3; 4: 8; 5: 2; 6: 0; 7: 7; 8: 6; 9: 0; 10: 8; 11: 1
    ```

    Первый компонент в каждой паре представляет метод платежа, настроенный для магазина. Второй компонент представляет соответствующую платежную группу, поддерживаемую службой финансовой регистрации EFR. Дополнительные сведения о группах платежей, поддерживаемых EFR для Германии, см. в разделе [Справочник по EFR](https://public.efsta.net/efr/).

    Пример сопоставления способов оплаты соответствует способам оплаты магазина, которые настроены в стандартных демонстрационных данных.

    | Способ оплаты | Имя способа оплаты |
    |----------------|---------------------|
    | 1              | Касса                |
    | 2              | Проверка               |
    | 3              | Карта                |
    | 4              | Счет клиента    |
    | 5              | Другая               |
    | 6              | Валюта            |
    | 7              | Ваучер             |
    | 8              | Подарочный сертификат           |
    | 9              | Внесение/изъятие наличности |
    | 10             | Карты лояльности       |
    | 11             | Чеки, отличные от локальных    |

    Таким образом, необходимо изменить сопоставление образца в соответствии с методами оплаты, настроенными в вашем приложении.

- **Включить данные клиента** — если этот параметр включен, запросы к финансовой службе будут содержать сведения о клиенте, такие как имена и адреса, в случаях, когда клиент добавляется в проводку.
- **Сопоставление ставок налога на добавленную стоимость (НДС)** — сопоставление значений процента налога, которые настроены для налоговых кодов для значений атрибута **TaxG** (налоговая группа) в запросах, отправляемых в финансовую службу. Вот сопоставление по умолчанию:

    ```
    A: 19.00; B: 7.00; C: 10.70; D: 5.50; E: 0.00
    ```

    Первый компонент в каждой паре представляет налоговую группу НДС, которая поддерживается службой финансовой регистрации EFR. Второй компонент представляет соответствующую ставку НДС. Дополнительные сведения о налоговых группах НДС, поддерживаемых EFR для Германии, см. в разделе [Справочник по EFR](https://public.efsta.net/efr/).

- **Налоговая группа для подарочных сертификатов и депозитов** — значение атрибута **TaxG** в запросах, отправляемых в финансовую службу, на основе операций, включающих подарочные сертификаты или депозиты. Вот сопоставление по умолчанию:

    ```
    G
    ```

- **Налоговая группа для освобождения от НДС** — значение атрибута **TaxG** в запросах, отправляемых в финансовую службу на основе операций, освобожденных от налоговых обязательств. Вот сопоставление по умолчанию:

    ```
    F
    ```

> [!NOTE]
> Настройки налогов в сопоставлении данных по умолчанию отвечают за сопоставление настроек налогов в системных и налоговых группах в службе EFR. Налоговые группы могут быть распечатаны в чеках только в том случае, если поле **Код для печати** задано на странице **Налоговые коды**.

#### <a name="fiscal-connector-settings"></a>Параметры финансового соединителя

Следующие параметры включены в конфигурацию финансового соединителя, которая предоставляется в составе образца финансовой интеграции:

- **Адрес конечной точки** — URL-адрес службы финансовой регистрации.
- **Время ожидания** — период времени в миллисекундах, в течение которого финансовый соединитель будет ожидать отклика от службы финансовой регистрации.
- **Показывать уведомления о финансовой регистрации** — этот флаг определяет, должны ли отображаться оператору уведомления, возвращаемые службой финансовой регистрации.

### <a name="configure-channel-components"></a>Настройка компонентов канала

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Германии (устаревшая версия)](emea-deu-fi-sample-sdk.md).
>
> Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

#### <a name="set-up-the-development-environment"></a>Настройка среды разработки

Чтобы настроить среду разработки для проверки и расширения образца, выполните следующие действия.

1. Создайте точную копию или загрузите репозиторий [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions). Выберите правильную версию ветви выпуска в соответствии с версией пакета SDK/приложения. Дополнительные сведения см. в разделе [Загрузка примеров Retail SDK и справочных пакетов из GitHub и NuGet](../dev-itpro/retail-sdk/sdk-github.md).
1. Откройте решение EFR в **Dynamics365Commerce.Solutions\\FiscalIntegration\\Efr\\EFR.sln** и создайте его.
1. Установка расширений Commerce Runtime:

    1. Найдите установщик расширений CRT:

        - **Commerce Scale Unit:** в папке **Efr\\ScaleUnit\\ScaleUnit.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **ScaleUnit.EFR.Installer**.
        - **Локальный CRT на Modern POS:** в папке **Efr\\ModernPOS\\ModernPOS.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **ModernPOS.EFR.Installer**.

    1. Запустите установщик расширений CRT из командной строки:

        - **Commerce Scale Unit:**

            ```Console
            ScaleUnit.EFR.Installer.exe install --verbosity 0
            ```

        - **Локальный CRT на Modern POS:**

            ```Console
            ModernPOS.EFR.Installer.exe install --verbosity 0
            ```

1. Установите расширения Hardware Station:

    - В папке **Efr\\HardwareStation\\HardwareStation.EFR.Installer\\bin\\Debug\\net461** найдите программу установки **HardwareStation.EFR.Installer**.
    - Запустите установщик расширений из командной строки:

        ```Console
        HardwareStation.EFR.Installer.exe install --verbosity 0
        ```

#### <a name="production-environment"></a>Рабочая среда

Выполните шаги, описанные в разделе [Настройка конвейера построения для образца финансовой интеграции](fiscal-integration-sample-build-pipeline.md), чтобы создать и выпустить облачную единицу масштабирования и развертываемые пакеты самообслуживания для образца финансовой интеграции. Файл шаблона YAML **EFR build-pipeline.yml** можно найти в папке **Pipeline\\YAML_Files** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions).

## <a name="design-of-extensions"></a>Разработка расширений

Образец интеграции службы финансовой регистрации для Германии базируется на [функции финансовой интеграции](fiscal-integration-for-retail-channel.md) и входит в состав пакета Retail SDK. Пример находится в папке **src\\FiscalIntegration\\Efr** репозитория [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/) (например, [пример в выпуске release/9.33](https://github.com/microsoft/Dynamics365Commerce.Solutions/tree/release/9.33/src/FiscalIntegration/Efr)). Пример [состоит](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices) из поставщика финансового документа, который является расширением CRT, и финансового соединителя, который является расширением Commerce Hardware Station. Для получения дополнительных сведений о способах использования пакета Retail SDK см. разделы [Архитектура пакета Retail SDK](../dev-itpro/retail-sdk/retail-sdk-overview.md) и [Настройка конвейера сборки для пакета SDK независимой упаковки](../dev-itpro/build-pipeline.md).

> [!WARNING]
> Вследствие ограничений [новой модели независимой упаковки и расширения](../dev-itpro/build-pipeline.md), она не может использоваться для этого образца финансовой интеграции. Необходимо использовать предыдущую версию пакета Retail SDK на виртуальной машине разработчика в LCS. Дополнительные сведения см. в разделе [рекомендации по развертыванию образца интеграции финансового принтера для Германии (устаревшая версия)](emea-deu-fi-sample-sdk.md). Поддержка новой независимой модели упаковки и расширения для образцов финансовой интеграции запланирована для последующих версий.

### <a name="crt-extension-design"></a>Разработка расширения CRT

Целью расширения, которое является поставщиком финансовых документов, является создание документов для конкретной службы и обработка откликов от службы финансовой регистрации.

#### <a name="request-handler"></a>Обработчик запросов

Имеется один обработчик запросов для поставщика документов, **DocumentProviderEFRFiscalDEU**. Этот обработчик используется для создания финансовых документов для службы финансовой регистрации. Он наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени поставщика документа соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **GetFiscalDocumentDocumentProviderRequest** — этот запрос содержит сведения о том, что должен создаваться документ. Он возвращает специфический для службы документ, который должен быть зарегистрирован в службе финансовой регистрации.
- **GetFiscalTransactionExtendedDataDocumentProviderRequest** — этот запрос возвращает ответ вместе с расширенными данными.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для поставщика фискального документа расположен по пути **src\\FiscalIntegration\\Efr\\Configurations\\DocumentProviders\\DocumentProviderFiscalEFRSampleGermany.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров поставщика фискального документа из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

### <a name="hardware-station-extension-design"></a>Разработка расширения Hardware Station

Целью расширения, которое является финансовым соединителем, является обмен данными со службой финансовой регистрации.

Расширение Hardware Station — это **HardwareStation.Extension.EFRSample**. Оно использует протокол HTTP для отправки документов, создаваемых расширением CRT в службе финансовой регистрации. Оно также обрабатывает отклики, полученные от службы финансовой регистрации.

#### <a name="request-handler"></a>Обработчик запросов

Обработчик запросов **EFRHandler** является точкой входа для обработки запросов к службе финансовой регистрации. Этот обработчик наследуется из интерфейса **INamedRequestHandler**. Метод **HandlerName** отвечает за возврат имени обработчика. Имя обработчика должно соответствовать имени финансового соединителя, указанного в Commerce Headquarters.

Соединитель поддерживает следующие запросы:

- **SubmitDocumentFiscalDeviceRequest** — этот запрос отправляет документы в службу финансовой регистрации и возвращает из него отклики.
- **IsReadyFiscalDeviceRequest** — этот запрос используется для проверки работоспособности службы финансовой регистрации.
- **InitializeFiscalDeviceRequest** — этот запрос используется для инициализации службы финансовой регистрации.

#### <a name="configuration"></a>Конфигурация

Файл конфигурации для фискального соединителя расположен по пути **src\\FiscalIntegration\\Efr\\Configurations\\Connectors\\ConnectorEFRSample.xml** в репозитории [Решения Dynamics 365 Commerce](https://github.com/microsoft/Dynamics365Commerce.Solutions/). Целью файла является разрешение настройки параметров финансового соединителя из Commerce Headquarters. Формат файла сопоставляется с требованиями к настройке финансовой интеграции.

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
