---
title: Расчет наличия запасов для розничных каналов
description: В этой теме описывается, как компания может использовать Microsoft Dynamics 365 Commerce для просмотра оценки доступности продуктов в наличии в интерактивном режиме и в каналах магазина.
author: hhainesms
ms.date: 09/01/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application User
ms.reviewer: v-chgri
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: hhaines
ms.search.validFrom: 2020-02-11
ms.dyn365.ops.version: Release 10.0.10
ms.openlocfilehash: 1b1e0ea264dd74f6583d3b7fd3ecce551c73fbae
ms.sourcegitcommit: 1707cf45217db6801df260ff60f4648bd9a4bb68
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2021
ms.locfileid: "7674683"
---
# <a name="calculate-inventory-availability-for-retail-channels"></a>Расчет наличия запасов для розничных каналов

[!include [banner](../includes/banner.md)]

В этой теме описывается, как компания может использовать Microsoft Dynamics 365 Commerce для просмотра оценки доступности продуктов в наличии в интерактивном режиме и в каналах магазина.

## <a name="accuracy-of-inventory-availability"></a>Точность наличия запасов

Для обеспечения масштабируемости и производительности Commerce использует несколько серверов и баз данных. Таким образом, важно понимать, что доступные значения запасов, предоставляемые в приложении POS, интерфейсе прикладного программирования (API) доступности запасов электронной коммерции и на страницах запасов в наличии в Commerce Headquarters могут не быть точным на 100 процентов в реальном времени. Если транзакции, созданные для продуктов в интерактивном режиме или в канале магазина, еще не были синхронизованы с центральным офисом, то страницы запасов в наличии в центральном офисе могут не содержать точных значений запасов этих продуктов в реальном времени. И наоборот, если ваша компания настроена таким образом, что пользователи в центральном офисе или другие интегрированные приложения смогут продавать, получать, возвращать или иным образом корректировать складской запас из магазина или интерактивного склада, на POS-терминале или в интерактивном канале могут отсутствовать все сведения, необходимые для отображения точных значений для номенклатур в реальном времени.

Важно понимать, что все данные о доступности в наличии, предоставляемые в ходе рабочего дня, считаются оцененным значением. Таким образом, при попытке сравнить сведения о запасах в наличии, предоставляемые приложением, с фактическими физическими запасами на полках, или при попытке сравнить значения в наличии, которые отображаются в POS, с данными о запасах в наличии, которые вы нашли для того же склада в центральном офисе, значения могут отличаться. Эта разница в ходе рабочего дня является ожидаемой и не должна рассматриваться проблемой. Если требуется проводить аудит данных и гарантировать, что значения, указанные в POS, интерфейсах API и центральном офисе, соответствуют реальным физическим единицам, находящимся на полках в магазинах или складах, то лучше всего сделать это после того, как операции канала будут остановлены в течение дня, и все транзакции были правильно синхронизированы между центральным офисом и каналами.

## <a name="channel-side-inventory-calculation"></a>Расчет запасов на стороне канала

Расчет запасов на стороне канала — это механизм, который принимает последние известные данные о запасах по каналам в Commerce Headquarters в качестве базового прогноза, а затем факторы в дополнительных изменениях запасов, произошедших на стороне канала, которые не включены в этот базовый прогноз для расчета оцененных запасов в наличии практически в реальном времени. 

Следующие изменения запасов в настоящее время учтены в логике расчета запасов на стороне канала:

- Запасы, проданные через кассовые проводки в магазине
- Запасы, проданные через заказы клиентов в магазине или через интерактивный канал
- Запасы, возвращенные в магазин
- Выполненные запасы (комплектация, упаковка, отгрузка) со склада магазина

Для использования расчета запасов на стороне канала необходимо включить функцию **оптимизированный расчет доступности продукта**.

Если у вас Commerce Environment версии **с 10.0.8 по 10.0.11**, выполните следующие действия.

1. В Commerce headquarters перейдите в раздел **Retail и Commerce** Настройка Headquarters \> **Общие параметры Commerce**.
1. На вкладке **Запасы** в поле **Задание Доступность продукта** выберите **использовать оптимизированный процесс для задания Доступность продукта**.

Если у вас Commerce Environment версии **с 10.0.12 или более поздней**, выполните следующие действия.

1. В Commerce headquarters перейдите в раздел **Рабочие области \> Управление функциями** и включите функцию **оптимизированный расчет доступности продукта**.
1. Если в интерактивном режиме и в каналах магазина используются одни и те же склады пополнения, необходимо также включить функцию **Расширенная логика расчета запасов на стороне канала в электронной коммерции**. Таким образом, логика расчета на стороне канала будет считать неразнесенные проводки, созданные в канале магазина. (Эти проводки могут быть кассовыми проводками, заказами клиентов и возвратами.)
1. Выполните задание **1070** (**конфигурация канала**).

Если Commerce Environment был обновлен с выпуска более ранней версии, чем Commerce, 10.0.8, после включения функции **оптимизированный расчет доступности продукта** необходимо также запустить функцию **Инициализация планировщика Commerce**, чтобы эта функция вступила в силу. Чтобы запустить инициализацию, перейдите к **Retail и Commerce** \> **Настройка Headquarters** \> **Планировщик Commerce**.

Чтобы использовать расчет запасов на стороне канала, в качестве необходимого компонента периодический моментальный снимок данных о запасах из центрального офиса, созданный заданием **Доступность продукта**, должен быть отправлен в базы данных канала. Моментальный снимок представляет сведения, которыми центральный офис обладает о доступности запасов для определенной комбинации продукта или варианта продукта и склада. Он включает только проводки по запасам, которые были обработаны и разнесены в центральном офисе в момент создания моментального снимка, и в реальном времени может быть не на 100% точным из-за постоянной обработки продаж, которая происходит на распределенных серверах.

- Если запасы были проданы для продукта в магазине с помощью кассовой или асинхронной продажи по заказу клиента в приложении POS, в центральном офисе сразу не появятся сведения о соответствующей проводке отпуска запасов для данной продажи. Центральный офис будет содержать информацию о запасе, который продается для этих типов продаж магазина только после того, как P-задание загружает связанную проводку из базы данных канала магазина в центральный офис, а соответствующие заказы на продажу создаются с помощью разноски журнала операций или процессов поточной разноски. Процесс создания заказа в центральном офисе создает соответствующие проводки по запасам. 
- Для заказов каналов электронной коммерции центральный офис содержит сведения о проводках по запасам только после того, как проводки отправлены в центральный офис через P-задание и процесс синхронизации заказов завершен.

Чтобы создать моментальный снимок запасов в центральном офисе, выполните следующие действия.

1. Перейдите в **Retail и Commerce \> ИТ Retail и Commerce \> Продукты и запасы \> Доступность продукта**.
1. Нажмите кнопку **ОК**, чтобы выполнить задание **Доступность продукта**. Можно также запланировать выполнение этого задания в пакетном режиме.

После завершения выполнения задания **Доступность продукта** собранные данные должны быть отправлены в базы данных канала, чтобы при расчете оцененных запасов в наличии со стороны канала учитывался последний моментальный снимок запасов центрального офиса.

Чтобы синхронизировать данные моментального снимка из центрального офиса с базами данных канала, выполните следующие действия.

1. Перейдите в раздел **Retail и Commerce \> ИТ Retail и Commerce \> График распределения**.
1. Выполните задание **1130** (**Доступность продукта**) для синхронизации данных моментального снимка, которые задание **Доступность продукта** создало из центрального офиса в базах данных канала.

## <a name="inventory-availability-apis-for-e-commerce"></a>API доступности запасов для электронной коммерции

Commerce предоставляет следующие интерфейсы API для сценариев электронной коммерции для запроса доступности продукта в запасах:

- **GetEstimatedAvailability** — этот API используется для запроса запасов для продукта или варианта продукта на складе или складах интернет-канала, связанных с группой выполнения интернет-канала.
- **GetEstimatedProductWarehouseAvailability** — этот API используется для запроса запасов для продукта или варианта продукта с конкретного склада.

> [!NOTE]
> Эти API-интерфейсы заменяют API-интерфейсы **GetProductAvailabilities** и **GetAvailableInventoryNearby** в Commerce версии 10.0.7 и более ранних версиях.

Оба интерфейса API служат для внутреннего использования логики вычисления на стороне канала и возвращают расчетное **физически доступное** количество, **общее доступное** количество, **единицу измерения** и **уровень запасов** для запрошенного продукта и склада. Возвращенные значения могут отображаться на сайте электронной коммерции, если это необходимо, или они могут использоваться для запуска другой бизнес-логики на сайте электронной коммерции. Например, можно отменить покупку продуктов на уровне запасов "нет в наличии".

Хотя другие API-интерфейсы, доступные в Commerce, могут переходить непосредственно в центральный офис для извлечения количества в наличии для продуктов, мы не рекомендуем использовать их в среде электронной коммерции, поскольку имеются потенциальные проблемы с производительностью и связанного с этим влияния, которое эти частые запросы могут оказывать на ваши серверы центрального офиса. Кроме того, при расчете на стороне канала два упомянутых выше интерфейса API могут обеспечить более точную оценку доступности продукта, принимая во внимание проводки, созданные в каналах, которые еще не были известны в центральном офисе.

Чтобы определить, как должно возвращаться количество продукции в выходных данных API, выполните следующие действия.

1. Перейдите в раздел **Retail и Commerce \> Настройка центрального офиса \> Параметры \> Параметры Commerce**.
1. Выберите вкладку **Запасы**, а затем на экспресс-вкладке **API доступности запасов для электронной торговли** настройте значение в параметрах **Количество в выходных данных API**.
1. Запустите задание **1070** (**Конфигурация канала**) для синхронизации последнего параметра с каналами.

Параметр **Количество в выходных данных API** имеет три варианта:

- **Возврат количества запасов** — физически доступное и общее доступное количество запрошенного продукта, возвращаемые в выходных данных API.
- **Возврат количества запасов минус буфер запасов** — количество, возвращенное в выходных данных API, корректируется путем вычитания значения буфера запасов. Дополнительные сведения о буфере запасов см. в разделе [Настройка буферов запасов и уровней запасов](inventory-buffers-levels.md).
- **Не возвращать количество запасов** — в выходных данных API возвращается только уровень запасов. Дополнительные сведения об уровнях запасов см. в разделе [Настройка буферов запасов и уровней запасов](inventory-buffers-levels.md).

Можно использовать параметр API `QuantityUnitTypeValue` для указания типа единицы, в которой API должны вернуть количество. Этот параметр поддерживает значения **единица измерения складского учета** (по умолчанию), **единица покупки** и **единица продажи**. Возвращенное количество округляется до определенной точности соответствующей единицы измерения в центральном офисе.

API **GetEstimatedAvailability** предлагает следующие входные параметры для поддержки других сценариев запросов:

- `DefaultWarehouseOnly` — этот параметр используется для запроса запасов для продукта на складе по умолчанию для интернет-канала. 
- `FilterByChannelFulfillmentGroup` и `SearchArea` — эти два параметра используются для запроса запасов для продукта из всех местоположений отправки в определенной области поиска на основе `longitude`, `latitude` и `radius`. 
- `FilterByChannelFulfillmentGroup` и `DeliveryModeTypeFilterValue` — эти два параметра используются для запроса запасов продукта с определенных складов, связанных с группой выполнения интернет-канала, и настроены на поддержку определенных режимов доставки. Параметр `DeliveryModeTypeFilterValue` поддерживает значения **все** (по умолчанию), **отгрузка** и **отправка**. Например, в ситуации, когда интернет-заказ может быть выполнен из нескольких складов отгрузки, можно использовать эти два параметра для запроса доступности продукта на всех складах отгрузки. В этом случае в интерфейсе API возвращается количество продукта в наличии и уровень запасов в наличии для каждого склада отгрузки, а также агрегированное количество и суммарный уровень запасов со всех складов отгрузки в области запроса.
 
Модули Commerce поля покупки, выбора магазина, списка желаемого, корзины и значка корзины используют API и параметры, упомянутые выше, для отображения сообщений об уровне запасов на сайте электронной коммерции. Конструктор сайтов Commerce предоставляет различные параметры запасов для управления сбытом и покупками. Для получения дополнительной информации о см. раздел [Применение настроек запасов](inventory-settings.md).

## <a name="pos-inventory-lookup-with-channel-side-calculation"></a>Поиск запасов POS с расчетом на стороне канала

В Commerce версии 10.0.9 и более ранних, операция **Поиск запасов** в POS использовала вызов службы в реальном времени в центральном офисе для получения сведений о запасах для выбранного продукта, для текущего магазина пользователя и других магазинов, настроенных для группы выполнения в рамках конфигурации канала магазина. В Commerce версии 10.0.10 и более поздних версиях можно выключить вызовы службы в реальном времени для центрального офиса и вместо этого использовать расчет на стороне каналов на сервере Commerce, чтобы определить запасы в наличии, которые физически доступны для магазина и всех остальных местоположений, которые заданы в группе выполнения. Эта конфигурация запасов, рассчитанная по каналам, также полезна для тех местоположений, в которых подключение к Интернету ненадежно, так как нет необходимости в интерактивном режиме получать поиск запасов из центрального офиса.

Когда расчет на стороне канала правильно настроен и управляется, он может обеспечить более надежную оценку текущих запасов магазина, так как в нем используются данные о проводках, которые находятся в базе данных канала Commerce, но в центральном офисе еще могут отсутствовать сведения об этом. Например, если вы используете существующий вызов службы в реальном времени для поиска запасов в POS, центральный офис, вероятно, не будет содержать сведений о кассовых продажах, которые были только что выполнены для продукта. Таким образом, стоимость запасов в наличии, которую центральный офисе возвращает для этого продукта, скорее всего превысит фактические запасы в наличии для магазина на одну единицу. Однако при использовании расчета на стороне канала, кассовая продажа может быть учтена в расчете и вычтена из отображаемого значения в наличии. Несмотря на то что значения, которые предоставляют как вычисления на стороне канала, так и вызов службы в реальном времени, являются только оценками запасов в наличии, значение, предоставляемое при вычислении на стороне канала, с большей вероятностью будет точным для текущего магазина.

Чтобы настроить операцию POS **Поиск запасов** в центральном офисе Commerce для использования логики расчета на стороне канала и отключить вызов службы в реальном времени, необходимо сначала включить функцию **Оптимизированный расчет доступности продукта** в рабочей области **Управление функциями** в центральном офисе Commerce и выполнить следующие действия.

1. Перейдите в раздел **Retail и Commerce \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**.
1. Выберите профиль функциональности.
1. На экспресс-вкладке **функции** в разделе **Расчет наличия запасов** измените значение поля **Режим расчета наличия запасов** с **Служба реального времени** на **Канал**. По умолчанию все профили функциональности используют вызовы службы в реальном времени. Необходимо изменить значение этого поля, если необходимо использовать логику расчета на стороне канала. Данное изменение повлияет на все розничные магазины, связанные с выбранным профилем функциональности.

Затем необходимо синхронизировать изменения в каналах в рамках процесса графика распределения в центральном офисе, выполнив следующие шаги.

1. Перейдите в раздел **Retail и Commerce \> ИТ Retail и Commerce \> График распределения**.
1. Выполните задание **1070** (**конфигурация канала**).

После завершения настройки сведения, предоставляемые о физически доступных запасах, больше не используют вызов службы в реальном времени, когда пользователь в приложении POS использует операцию **Поиск запасов** (стандартное и матричное представление). Вместо этого данные о физически доступных запасах для текущего магазина и всех магазинов в группе выполнения рассчитываются на основе последнего известного снимка, который был доставлен в базу данных канала из Commerce Headquarters. Значение моментального снимка в дальнейшем будет уточнено с помощью расчета на стороне канала для корректировки физически доступного значения на основе дополнительных проводок по продажам или возвратам, которые существуют для выбранного продукта в базе данных канала, которые не были включены в последний синхронизированный моментальный снимок из задания 1130. Если база данных канала не содержит транзакционных данных для каких-либо складов или магазинов в группе выполнения, она не содержит дополнительных транзакций, которые могут быть учтены в пересчете значения. Таким образом, наилучшей оценкой запасов в наличии, которые могут быть показаны для складов или магазинов, являются данные из последнего моментального снимка Commerce Headquarters.

Экраны **Выполнение заказов** в POS также используют расчет на стороне канала для отображения запасов в наличии для номенклатур, когда выбрана строка выполнения заказа, и пользователь просматривает панель **Подробно** для запасов в наличии для выбранной номенклатуры.

## <a name="optimize-your-inventory-data"></a>Оптимизируйте данные по запасам

Для обеспечения наилучшей оценки запасов важно использовать следующие пакетные задания Commerce и выполнять их часто:

- **P-задание** — P-задание находится на странице **Планы распределения** и должно запускаться часто. В этом задании отображаются заказы электронной коммерции, асинхронные заказы клиентов, созданные POS, а также кассовые заказы, которые были созданы POS из баз данных канала в Commerce Headquarters, чтобы их можно было обработать в дальнейшем. До тех пор, пока эти данные не будут синхронизированы из канала в Commerce Headquarters, в Commerce Headquarters нет сведений о корректировках запасов для продуктов на складах, которые являются результатом этих транзакций.
- **Синхронизация заказов** — это задание обрабатывает необработанные транзакционные данные в Commerce Headquarters о том, которые обеспечивает P-задание и конвертирует проводки заказов электронной коммерции и асинхронных заказов клиентов в заказы на продажу в Commerce Headquarters. Пока это задание не будет обработано, а заказы на продажу созданы, проводки по запасам создаваться не будут. Таким образом, запасы в наличии в Commerce Headquarters не будут учитывать проводки.
- **Пакетный расчет журналов проводок** — для кассовых проводок, созданных в магазине, процесс поточной разноски обеспечивает эффективное обновление запасов, относящихся к продажам. Чтобы наиболее эффективно обрабатывать проводки по запасам для кассовых заказов, убедитесь, что ваша система настроена на использование [потоковой разноски](./trickle-feed.md).
- **Пакетная разноска журналов проводок** — это задание также необходимо для пакетной разноски. Далее следует задание **Пакетный расчет журналов проводок**. Это задание систематически разносит рассчитанные выписки, так что заказы на продажу для кассовых продаж создаются в Commerce Headquarters, а Commerce Headquarters более точно отражает запасы магазина.
- **Доступность продукта** — это задание создает моментальный снимок запасов из Commerce Headquarters.
- **1130 (Доступность продукта)** — это задание находится на странице **Планы распределения** и должно запускаться сразу после задания **Доступность продукта**. Это задание позволяет переносить данные моментального снимка запасов из Commerce Headquarters в базы данных канала.

> [!NOTE]
> - Рекомендуется выполнять задания **Доступность продукта** и **1130** каждый час, а также планировать P-задания, синхронизировать заказы и задания потоковой разноски, с такой же или более высокой частотой.
> - Для повышения производительности при использовании расчета наличия запасов на стороне канала для создания запроса доступности запасов с помощью API-интерфейса электронной коммерции или логики запасов канала POS в расчете используется кэш, чтобы определить, прошло ли достаточно времени, чтобы оправдать повторное выполнение логики расчета. В качестве значения кэша по умолчанию задано 60. Например, вы включили расчет на стороне канала для магазина и просмотрели запасы в наличии для продукта на странице **Поиск запасов**. Если одна единица продукта будет продана, на странице **Поиск запасов** не будет отображаться сокращенный запас до тех пор, пока не будет очищен кэш. После разноски проводок пользователями в POS, они должны подождать 60 секунд, прежде чем убедиться в том, что запасы в наличии были сокращены.

Если бизнес-сценарий требует меньшее время кэширования, обратитесь за помощью к представителю службы поддержки продукта.

[!INCLUDE[footer-include](../includes/footer-banner.md)]
