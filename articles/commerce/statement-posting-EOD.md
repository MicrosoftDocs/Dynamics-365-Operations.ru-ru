---
title: Усовершенствования функции разноски журнала операций
description: В этом разделе описываются усовершенствования, которые были внесены в функцию разноски журналов операций.
author: analpert
ms.date: 04/27/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: josaw
ms.search.region: Global
ms.author: analpert
ms.search.validFrom: 2018-04-30
ms.openlocfilehash: be9aa68aec1fd7deff315234a6dbf41edc3d6819
ms.sourcegitcommit: 9e1129d30fc4491b82942a3243e6d580f3af0a29
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/27/2022
ms.locfileid: "8649027"
---
# <a name="improvements-to-statement-posting-functionality"></a>Усовершенствования функции разноски журнала операций

[!include [banner](includes/banner.md)]

В этом разделе описывается первый набор усовершенствований, которые были внесены в функцию разноски журналов операций. Эти усовершенствования доступны в Microsoft Dynamics 365 for Finance and Operations 7.3.2.

## <a name="activation"></a>Активация

По умолчанию во время развертывания Finance and Operations 7.3.2 программа настроена для использования устаревшей функции разноски журналов операций. Чтобы включить усовершенствованную функцию разноски журналов операций, необходимо включить конфигурационный ключ для нее.

- Перейдите в раздел **Администрирование системы** \> **Настройка** \> **Конфигурация лицензии**, затем в узле **Retail и Commerce** снимите флажок **Журналы операций (устар.)** и установите флажок **Журналы операций розничной торговли**.

После включения нового конфигурационного ключа **Журналы операций** станет доступен новый пункт меню с именем **Журналы операций**. Этот пункт меню позволяет вручную создать, рассчитать и разнести журналы операций. Любой журнал операций, который приводит к ошибке в процессе пакетной обработки, также будет доступен в этом пункте меню. (Если включен конфигурационный ключ **Журналы операций (устар.)**, пункт меню называется **Открытые журналы операций**.)

Commerce включает следующие проверки, связанные с этими конфигурационными ключами:

- Оба конфигурационных ключа не могут быть включены одновременно.
- Необходимо использовать одинаковые конфигурационные ключи для всех операций, которые выполняются в данном журнале операций во время его жизненного цикла (создание, расчет, очистка, разноска и так далее). Например, невозможно создать и рассчитать журнал операций, если включен конфигурационный ключ **Журналы операций (устар.)**, а затем разнести тот же журнал операций, если включен конфигурационный ключ **Журнал операций**.

> [!NOTE]
> Рекомендуется использовать конфигурационный ключ **Журналы операций** для усовершенствованной функции разноски журналов операций, если нет особой причины использовать конфигурационный ключ **Журналы операций (устар.)**. Корпорация Майкрософт будет продолжать развивать новую и усовершенствованную функцию разноски журналов операций, и важно, чтобы вы перешли на нее при первой возможности для повышения эффективности работы. Устаревшая функция разноски журналов операций будет объявлена устаревшей в выпуске 8.0.

## <a name="setup"></a>Настройка

В рамках улучшения функции разноски журналов операций введены три новых параметра на экспресс-вкладке **Журнал операций** вкладки **Разноска** на странице **Параметры Commerce**:

- **Отключить удаление строк журнала операций** — данный параметр применяется только для устаревшей функции разноски журналов операций. Рекомендуется установить для этого параметра значение **Нет**, чтобы пользователи не могли очистить журналы операций, имеющие состояние частичной разноски. Если очистить журналы операций, которые находятся в состоянии частичной разноски, данные будут повреждены. Задавать для этого параметра значение **Да** следует только в исключительных случаях.
- **Резервировать запасы во время расчета** — рекомендуется использовать пакетное задание **Разнести запасы** для резервирования запасов и установить для этого параметра значение **Нет**. Если для этого параметра задать значение **Нет**, улучшенная функция разноски журналов операций не пытается создать записи резервирования запасов во время расчета (если записи еще не были созданы с помощью пакетного задания **Разнести запасы**). Вместо этого функция создает записи резервирования запасов только во время разноски. Эта реализация была проектным решением и основана на том факте, что интервал времени между процессом расчета и процессом разноски обычно небольшой. Тем не менее, если требуется зарезервировать запасы во время расчета, можно установить для этого параметра значение **Да**.

    Устаревшая функция разноски журналов операций всегда резервирует запасы во время процесса расчета журнала операций (если резервирование уже не было сделано с помощью пакетного задания **Разнести запасы**), независимо от значения данного параметра.

- **Отключить требование пересчета** — если для этого параметра задать значение **Да**, процесс разноски журнала операций продолжается, даже если расхождение между подсчитанной суммой и суммой проводки в журнале операций выходит за пределы порогового значения, определенного на экспресс-вкладке **Журнал операций** для магазинов.

> [!NOTE]
> С Commerce версии 10.0.14, когда включена функция **Журналы операций розничной торговли — поточная разноска** пакетное задание **Разнести запасы** больше не используется и не может быть выполнено.

## <a name="processing"></a>Обработка

Журналы операций можно рассчитать и разнести в пакетном режиме с помощью пунктов меню **Пакетный расчет журналов операций** и **Пакетная разноска журналов операций**. Кроме того, журналы операций можно рассчитать и разнести вручную с помощью пункта меню **Журналы операций**, который предоставляет улучшенная функция разноски журналов операций.

Процесс и шаги расчета и разноски журналов операций в пакетном режиме аналогичны тем, что были в устаревшей функции разноски журналов операций. Тем не менее, значительные улучшения были внесены в базовую внутреннюю обработку журналов операций. Эти улучшения делают процесс более устойчивым и обеспечивают улучшенную видимость состояний и сведений об ошибках. Таким образом, пользователи могут устранить корневую причину ошибок и продолжить процесс разноски без повреждения данных, и не требуя исправлений данных.

В следующих разделах описаны некоторые основные улучшения функции разноски журналов операций, отображаемые в пользовательском интерфейсе для журналов операций и разнесенных журналов операций.

### <a name="status-details"></a>Сведения о статусе

Новая модель состояния введена в процесс разноски журналов операций для расчета и разноски.

В следующей таблице описаны различные состояния и их порядок в процессе расчета.

| Порядок состояния | Область, край      | описание |
|-------------|------------|-------------|
| 1           | Начато    | Журнал операций создан и готов к расчету. |
| 2           | Отмечено     | Проводки, которые входят в журнал операций, определяются на основе параметров журнала операций и помечены идентификатором журнала операций. |
| 3           | Расcчитана | Строки журнала операций рассчитываются и отображаются. |

В следующей таблице описаны различные состояния и их порядок в процессе разноски.

| Порядок состояния | Область, край                   | описание |
|-------------|-------------------------|-------------|
| 1           | Проверено                 | Выполняется несколько проверок, которые относятся к параметрам (например, накладные расходы расстановки) и к журналу операций и строкам журнала операций (например, расхождение между рассчитанной суммой и суммой проводки). |
| 2           | Агрегированн.              | Проводки по продажам для именованных и неименованных клиентов агрегируются на основании конфигурации. Каждая агрегированная проводка в конечном итоге преобразуется в заказ на продажу. |
| 3           | Заказ клиента создан  | На основании агрегированной проводки в системе создаются заказы на продажу. |
| 4           | По заказу клиента выставлена накладная | По заказам на продажу выставлены накладные. |
| 5           | Разнесенные скидки        | Журналы розничной скидки разносятся на основании конфигурации. |
| 6           | Разнесенный доход/расход   | Проводки по доходам/расходам разносятся как ваучеры. |
| 7           | Связанные ваучеры         | Журналы платежей создаются и связываются с соответствующей накладной. |
| 8           | Разнесенные платежи         | Журналы платежей разносятся. |
| 9           | Разнесенные подарочные сертификаты       | Проводки по подарочным сертификатам разносятся как ваучеры. |
| 10          | Опубликовано                  | Журнал операций помечается как разнесенный. |

Каждое состояние в таблицах выше по существу независимо, и между состояниям создается иерархическая зависимость. Эта зависимость направлена сверху вниз. Если в системе возникают ошибки при обработке состояния, статус журнала операций возвращается в предыдущее состояние. Все последующие повторные попытки выполнить процесс начинаются с состояния, в котором возникла ошибка, и продолжаются вперед. Этот подход имеет следующие преимущества:

- Пользователь имеет полную видимость состояния, в котором возникла ошибка.
- Можно избежать повреждения данных. Например, в устаревшей функции разноски журналов операций были случаи, когда по некоторым заказам на продажу выставлялись накладные, а другие оставались открытыми. Также были случаи, когда некоторые журналы платежей не имели соответствующей накладной для сопоставления из-за ошибки разноски накладной.
- Пользователи могут просмотреть текущее состояние журнала операций с помощью кнопки **Сведения о статусе** в группе **Сведения о выполнении** журнала операций. Страница сведений о состоянии имеет три раздела:

    - В первом разделе показано текущее состояние журнала операций вместе с кодом ошибки и подробным сообщением об ошибке, если произошла ошибка.
    - Во втором разделе показаны различные состояния процесса расчета. Визуальные подсказки указывают состояния, которые были успешно выполнены, состояния, которые не удалось выполнить из-за ошибок, и состояния, которые еще не выполнялись.
    - В третьем разделе показаны различные состояния процесса разноски. Визуальные подсказки указывают состояния, которые были успешно выполнены, состояния, которые не удалось выполнить из-за ошибок, и состояния, которые еще не выполнялись.

Кроме того, заголовок второго и третьего разделов показывает общее состояние соответствующего процесса.

### <a name="event-logs"></a>Журналы событий

Журнал операций проходит через различные операции (например, "Создать", "Рассчитать", "Очистить" и "Разнести"), и во время жизненного цикла журнала операций могут вызываться несколько экземпляров одной операции. Например, после создания и расчета журнала операций пользователь может очистить журнал операций и снова рассчитать его. Кнопка **Журналы событий** в группе **Сведения о выполнении** журнала операций позволяет выполнить аудиторский след различных операций, которые были вызваны в журнале операций, а также сведения о том, когда были вызваны эти операции.

### <a name="aggregated-transactions"></a>Агрегированные проводки

В процессе разноски транзакции с кассовыми проводками суммируются по клиентам и продуктам. Таким образом, количество созданных заказов на продажу и строк уменьшается. Агрегированные проводки хранятся в системе и используются для создания заказов на продажу. Каждая агрегированная проводка создает один соответствующий заказ на продажу в системе. 

Если журнал операций разносится не полностью, можно просмотреть агрегированные проводки в журнале операций. В области действий на вкладке **Журнал операций** в группе **Сведения о выполнении** выберите **Агрегированные проводки**.

![Кнопка агрегированных проводок для журнала операций, который не был полностью разнесен.](media/aggregated-transactions.png)

Для разнесенных журналов операций можно просмотреть агрегированные проводки на странице **Разнесенные журналы операций**. В области действий выберите **Запросы**, затем выберите **Агрегированные проводки**.

![Команда агрегированных проводок для разнесенных журналов операций.](media/aggregated-transactions-posted-statements.png)

На экспресс-вкладке **Сведения о заказе на продажу** агрегированной проводки отображаются следующие сведения:

- **Код записи** — код агрегированной проводки.
- **Номер журнала операций** — журнал операций, к которому принадлежит агрегированная проводка.
- **Дата** — дата создания агрегированной проводки.
- **Код продаж** — код заказа на продажу при создании заказа на продажу из агрегированной проводки. Если это поле не заполнено, соответствующий заказ на продажу не создан.
- **Число агрегированных строк** — общее число строк для агрегированной проводки и заказа на продажу.
- **Статус** — последний статус агрегированной проводки.
- **Код накладной** — код заказа на продажу, когда по заказу на продажу для агрегированной проводки выставляется накладная. Если это поле не заполнено, накладная для заказа на продажу не создана.
- **Код ошибки** — это поле задается, если агрегирование находится в состоянии ошибки.
- **Сообщение об ошибке** — это поле задается, если агрегирование находится в состоянии ошибки. В нем отображаются подробные сведения о причине сбоя процесса. Можно использовать информацию в коде ошибки для устранения проблемы, а затем вручную перезапустить процесс. В зависимости от типа разрешения, суммарные продажи могут быть удалены и обработаны в новом журнале операций.

![Поля на экспресс-вкладке сведений заказа на продажу для агрегированной проводки.](media/aggregated-transactions-error-message-view.png)

На экспресс-вкладке **Сведения о проводках** агрегированной проводки отображаются все проводки, которые были включены в агрегированную проводку. В агрегированных строках агрегированной проводки отображают все агрегированные записи из проводок. В агрегированных строках также отображаются такие сведения, как номенклатура, вариант, количество, цена, чистая сумма, единица измерения и склад. По существу, каждая агрегированная строка соответствует одной строке заказа на продажу.

![Экспресс-вкладка сведений о проводке для агрегированной проводки.](media/aggregated-transactions-sales-details.png)

В некоторых случаях в агрегированных проводках могут возникнуть сбои при разноске консолидированного заказа на продажу. В этих случаях код ошибки будет связан со статусом журнала операций. Чтобы просмотреть только агрегированные проводки с ошибками, можно включить фильтр **Показывать только сбои** в представлении агрегированных проводок, установив флажок. При включении этого фильтра результаты будут ограничены агрегированными проводками, которые имеют ошибки, требующие решения. Сведения о том, как устранять эти ошибки, см. в разделе [Изменение и аудит интернет-заказов и асинхронных проводок заказов клиентов](edit-order-trans.md).

![Флажок для фильтра «Показывать только сбои» в представлении агрегированных проводок.](media/aggregated-transactions-failure-view.png)

На странице **Агрегированные проводки** можно загрузить XML для конкретной агрегированной проводки, выбрав **Экспорт агрегированных данных**. Можно просмотреть XML в любом XML-средстве форматирования, чтобы просмотреть фактические данные, связанные с созданием и разноской заказов на продажу. Функциональные возможности загрузки XML для агрегированных проводок недоступны для журналов операций, которые были разнесены.

![Кнопка экспорта агрегированных данных на странице агрегированных проводок.](media/aggregated-transactions-export.png)

В случае невозможности исправления ошибки путем исправления данных в заказе на продажу или данных, которые поддерживают заказ на продажу, доступна кнопка **Удалить заказ клиента**. Чтобы удалить заказ, выберите сбойную агрегированную проводку, затем выберите **Удалить заказ клиента**. Агрегированная проводка и соответствующий заказ на продажу будут удалены. Теперь можно просмотреть проводки с помощью функций редактирования и аудита. Кроме того, они могут быть повторно обработаны с помощью нового журнала операций. После устранения всех неисправностей можно возобновить разноску журнала операций, запустив функцию разноски для соответствующего журнала операций.

![Кнопка удаления заказа клиента в представлении агрегированных проводок.](media/aggregated-transactions-delete-cust-order.png)

Представление агрегированных проводок предоставляет следующие преимущества:

- Пользователь имеет видимость агрегированных проводок, которые завершились с ошибкой во время создания заказа на продажу, и заказов на продажу, которые завершились с ошибкой во время выставления накладных.
- Пользователь имеет видимость способа агрегирования проводок.
- Пользователь имеет полный аудиторский след от проводок до заказов на продажу и накладных по продаже. Этот аудиторский след не был доступен в устаревшей функции разноски журналов операций.
- С помощью агрегированного XML-файла легче выявить проблемы во время создания заказа на продажу и выставления накладных по нему.

### <a name="journal-vouchers"></a>Операции журнала

Кнопка **Ваучеры журнала** в группе **Сведения о выполнении** журнала операций показывает все различные проводки по ваучеру, созданные для журнала операций и связанные со скидками, приходным/расходным счетами, подарочными сертификатами и т. д.

В настоящее время программа отображает эти данные только для разнесенных журналов операций.

### <a name="payment-journals"></a>Журналы платежей

Кнопка **Журналы платежей** в группе **Сведения о выполнении** журнала операций показывает все различные журналы платежей, созданные для журнала операций.

В настоящее время программа отображает эти данные только для разнесенных журналов операций.

## <a name="other-improvements"></a>Другие улучшения

Другие внутренние усовершенствования, которые может видеть пользователь, были внесены в функцию разноски журналов операций. Далее приводятся некоторые примеры.

- При агрегировании не учитываются записи персонала, терминала и смен. Поскольку имеется меньшее число параметров агрегирования, необходимо обрабатывать меньшее количество строк заказа на продажу.
- Случаи возникновения взаимоблокировки в таблицах проводок сокращены за счет дополнительных таблиц расширений и выполнения операций вставки вместо операций обновления в таблицах проводок.
- Количество выполняемых пакетных задач параметризировано и ограничено. Таким образом, это число можно точно настроить специально для среды клиента. В устаревшей функции разноски журналов операций одновременно создавалось неограниченное количество пакетных задач. Это приводило к неуправляемым нагрузкам, накладным расходам и узким местам на сервере обработки пакетных заданий.
- Журналы операций эффективно помещаются в очередь для обработки, отдавая приоритет журналам операций с максимальным количеством проводок.
- Процессы пакетной обработки, например **Пакетный расчет журналов операций** и **Пакетная разноска журналов операций**, выполняются только в пакетном режиме. В устаревшей функции разноски журналов операций пользователи выбирали запуск этих процессов пакетной обработки в интерактивном режиме, который представляет собой однопоточную операцию в отличие от процессов пакетной обработки, которые являются многопоточными.
- В устаревшей функции разноски журналов операций любой сбой пакетной задачи приводил к тому, что все пакетное задание переходило в состояние ошибки. В улучшенной функции сбои пакетных задач не помещают пакетное задание в состояние ошибки, если другие пакетные задачи успешно выполнены. Следует оценить статус разноски для пакетного выполнения с помощью страницы **Журналы операций**, на которой можно просматривать любые журналы операций, которые не были разнесены из-за ошибки.
- В устаревшей функции разноски журналов операций первый случай возникновения сбоя журнала операций приводит к сбою всего пакета. Остальные журналы операций не обрабатываются. В улучшенной функции процесс пакетной обработки продолжается для обработки всех журналов операций даже в случае соя некоторых журналов операций. Одним из преимуществ является то, что пользователи получают видимость точного количества журналов операций с ошибками. Поэтому пользователям не нужно постоянно исправлять ошибки и выполнять процесс разноски журналов операций, пока не будут разнесены все журналы операций.

## <a name="general-guidance-about-the-statement-posting-process"></a>Общие рекомендации по процессу разноски журналов операций

- Рекомендуется выполнять процесс разноски журналов операций в пакетном режиме, поскольку при этом используются преимущества структуры пакетной обработки в отношении многопоточности. Многопоточность необходима для обработки больших объемов проводок, которые обычно имеются в разносках журналов операций.
- Рекомендуется включить отрицательные физические запасы в группе номенклатурных моделей, чтобы обеспечить плавную разноску. В некоторых сценариях отрицательные журналы операций могут не разноситься при отсутствии отрицательных физических запасов. Например, в теории, если существует только одна единица номенклатуры на складе и были проводка по продаже и проводка возврата для данной номенклатуры, проводку можно будет разнести, даже если отрицательный запас отключен. Тем не менее, поскольку процесс разноски журналов операций объединяет проводку по продаже и проводку возврата в один заказ клиента, нет никакой гарантии, что строки продажи будут разноситься первыми, а затем строки возврата. Таким образом, могут возникать ошибки. Если отрицательный запас включен в этом сценарии, разноска проводок не затрагивается, и система будет правильно отражать запасов.
- Рекомендуется использовать агрегирование при расчете и разноске журналов операций. Таким образом, для некоторых агрегированных параметров рекомендуются следующие настройки:

    - Перейдите в раздел **Retail и Commerce** \> **Настройка Headquarters** \> **Параметры** \> **Параметры Commerce**. Затем на вкладке **Разноска** на экспресс-вкладке **Обновление запасов** в поле **Обновить запасы** выберите **Сводка**.
    - Перейдите в раздел **Retail и Commerce** \> **Настройка Headquarters** \> **Параметры** \> **Параметры Commerce**. Затем на вкладке **Разноска** на экспресс-вкладке **Агрегирование** задайте для параметра **Проводки по ваучеру** значение **Да**.


[!INCLUDE[footer-include](../includes/footer-banner.md)]
