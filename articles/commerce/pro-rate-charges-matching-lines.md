---
title: Пропорциональное распределение расходов из заголовка по соответствующим строкам продаж
description: В этом разделе описываются дополнительные возможности для расчета и применения автоматических расходов по заказам канала Commerce с помощью функции расширенных автоматических накладных расходов.
author: hhaines
manager: annbe
ms.date: 03/30/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
ms.search.form: ''
audience: Application User
ms.reviewer: josaw
ms.search.scope: Core, Operations, Retail
ms.custom: ''
ms.assetid: ''
ms.search.region: global
ms.search.industry: Retail
ms.author: hhaines
ms.search.validFrom: ''
ms.dyn365.ops.version: 10.0.1
ms.openlocfilehash: 048885cac7a316e144b2df072da405d74096203f
ms.sourcegitcommit: 199848e78df5cb7c439b001bdbe1ece963593cdb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "4415112"
---
# <a name="prorate-header-charges-to-matching-sales-lines"></a>Пропорциональное распределение расходов из заголовка по соответствующим строкам продаж


[!include [banner](includes/banner.md)]

В этом разделе описывается возможность для группировки автоматических накладных расходов на уровне заголовка и пропорционального распределения их по строкам продажи для Commerce. Эта функция доступна для проводок, которые были созданы в POS в Retail версии 10.0.1 и продаж, которые создаются в центре обработки вызовов в Retail версии 10.0.2.

Эта функция доступна только тогда, когда функция [расширенных автоматических расходов](https://docs.microsoft.com/dynamics365/unified-operations/retail/omni-auto-charges) включена с помощью параметра на странице **Параметры Commerce**. Кроме того, улучшенный метод расчета автоматических начислений расходов может применяться только к заказам на продажу Commerce, созданные по каналам (POS, центр обработки вызовов и платформа электронной коммерции Dynamics).

Эта новая функциональность дает большую гибкость организациям в способе расчета и применения к проводкам по продажам автоматических расходов на уровне заголовка.

В версиях приложения до версии 10.0.1 автоматические расходы уровня заголовка, которые имеют определенный способ отношений поставки, вычисляются только в том случае, если имеется соответствие со способом поставки, который определяется в заголовке заказа на продажу.

Например, автоматические расходы на уровне заголовка определены для режима поставки **99** и режима поставки **11**. Создается заказ на продажу и режим поставки **99** определяется в заголовке заказа. Однако некоторые из строк продажи настраиваются таким образом, чтобы они отгружались с помощью режима доставки **11**. В этом случае только расходы уровня заголовка, связанные со способом поставки **99**, учитываются и применяются к заказу на продажу.

В Commerce накладные расходы уровня заголовка имеют дополнительную функцию, которая позволяет определить [многоуровневую конфигурацию расходов](https://docs.microsoft.com/dynamics365/unified-operations/retail/configure-call-center-delivery), основанную на сумме заказа. Например, если сумма заказа между $50,00 и $200,00, организация может захотеть начислять расходы на фрахт в $5,00. Однако если сумма заказа между $200,01 и $500,00, расходы на транспортировку могут быть $4,00.

Некоторым организациям требуются преимущества многоуровневых расчетов расходов, которые входят в состав расходов на уровне заголовка. Тем не менее в сценариях, включающих смешанные режимы доставки, они также хотят убедиться в том, что расходы, которые рассчитываются, основаны на совпадении со способом поставки, который определен в каждой строке продажи.

Теперь можно настроить автоматические расходы на уровне заголовка таким образом, чтобы при расчете расходов учитывались все способы поставки по заказу. Эта функция требует более сложную логику расчета для расчета расходов уровня заголовка. Логика группирует вместе все номенклатуры, которые отгружаются с использованием одного режима поставки, и эта группа учитывается как группа расчета для номенклатур при расчете автоматических расходов на уровне заголовка. Для номенклатур, которые имеют тот же режим поставки, автоматические затраты рассчитываются на основе комбинированной суммы продажи номенклатур. Таким образом определяется соответствующий уровень автоматических накладных расходов.

После получения соответствующих расходов на уровне заголовка для строк продаж, отгружаемых с использованием одного режима поставки, рассчитанные расходы пропорционально переносятся на уровень строк продаж. Поскольку эти расходы находятся на уровне строки и не сохраняются на уровне заголовка, создается более конкретная связь между номенклатурой и суммой расходов, вычисленной для нее. Это может быть полезно в сценариях частичного возврата, где организация хочет возмещать только часть расходов, а не все расходы, при возврате только некоторых номенклатур.

## <a name="scenarios"></a>Сценарии

Следующие два примера сценария показывают, как эти расходы вычисляются как при использовании новой функциональной возможности, так и когда она не используется.

### <a name="scenario-1"></a>Сценарий 1

Этот сценарий описывает поведение, когда для параметра **Пропорциональное распределение по соответствующим строкам продаж** задано значение **Нет** в настройках автоматического расхода. (Поведение эквивалентно поведению расходов на уровне заголовка в версиях приложения, выпущенных до версии 10.0.1.)

В этом случае организация определила расходы на уровне заголовка для связи режима поставки **99** и связи режима поставки **11**. Автоматические затраты для режима поставки **21** не заданы.

![Автоматические накладные расходы для способа поставки 99 при отключенном пропорциональном распределении по соответствующим строкам](media/99_disabled.png)

![Автоматические накладные расходы для способа поставки 11 при отключенном пропорциональном распределении по соответствующим строкам](media/11_disabled.png)

Заказ на продажу создан в центре обработки вызовов и задан режим поставки **99**. Этот заказ содержит пять номенклатур. Две строки заказа были настроены на использование режима поставки **99**, две строки были настроены на использование режима поставки **11**, и одна строка была настроена на использование режима поставки **21**, как показано в следующей таблице.

| Раздел  | Количество по строке | Способ поставки | Цена за единицу измерения |
|-------|---------------|---------------|----------------|
| 81331 | 1             | 11            | $10            |
| 81332 | 1             | 99            | $50            |
| 81333 | 2             | 11            | $30            |
| 81334 | 3             | 99            | $10            |
| 81334 | 3             | 21            | $5             |

В этом случае весь заказ оценивается по таблицы автоматических расходов для способа поставки **99**. Полная сумма всех строк продажи используется для определения соответствующего уровня в конфигурации автоматического расхода, и эти издержки применяется на уровне заголовка заказа. В этом примере общая сумма по заказу равна $165,00 и $15,00 расходов на фрахт применяются к заголовку заказа. Автоматические расходы, настроенные для режима поставки **11**, никогда не используются и не применяются.

В этом случае, если клиент возвращает несколько номенклатур в заказе и если [код накладных расходов настроен таким образом, что они подлежат возмещению](https://docs.microsoft.com/dynamics365/unified-operations/retail/omni-auto-charges#setup-and-configuration-2), общие накладные расходы уровня заголовка систематически применяются для возмещения, даже если только некоторые номенклатуры возвращены.

### <a name="scenario-2"></a>Сценарий 2

В этом случае расходы на уровне заголовка определены для связи режима поставки **99** и связи режима поставки **11**. Однако для параметра **Пропорциональное распределение по соответствующим строкам продаж** задано значение **Да** для этих таблиц автоматического расхода.

![Автоматические накладные расходы для способа поставки 99 при включенном пропорциональном распределении по соответствующим строкам](media/99_enabled.png)

![Автоматические накладные расходы для способа поставки 11 при включенном пропорциональном распределении по соответствующим строкам](media/11_enabled.png)

В этом сценарии используется этот же заказ на продажу, содержащий пять строк. Способ поставки в заголовке заказа имеет значение **99**, но способ поставки для каждой номенклатуры в заказе на продажу настроен, как показано в следующей таблице.

| Раздел  | Количество по строке | Способ поставки | Цена за единицу измерения |
|-------|---------------|---------------|----------------|
| 81331 | 1             | 11            | $10            |
| 81332 | 1             | 99            | $50            |
| 81333 | 2             | 11            | $30            |
| 81334 | 3             | 99            | $10            |
| 81334 | 3             | 21            | $5             |

Поскольку конфигурация автоматического расхода задана для пропорционального распределения по соответствующим строкам продаж, система выполняет следующие шаги расчета.

1. Все номенклатуры, которые имеют тот же режим доставки, группируются вместе, и система рассчитывает общую сумму продукции для номенклатур в группе.

    **Способ поставки 11**

    - Номенклатура 81331, количество 1 = $10
    - Номенклатура 81333, количество 2 = $60 нетто ($30 за единицу)
    - **Общая стоимость продукции для способа поставки 11 = $70**

    **Способ поставки 99**

    - Номенклатура 81332, количество 1 = $50
    - Номенклатура 81334, количество 3 = $30 нетто
    - **Общая стоимость продукции для способа поставки 99 = $80**

    **Способ поставки 21**

    - Номенклатура 81334, количество 3 = $15 нетто
    - **Общая стоимость продукции для способа поставки 21 = $15**

2. Система выполняет поиск конфигурации для автоматических расходов на уровне заголовка, соответствующей настройкам клиента и режима доставки для каждой группы номенклатур. Если конфигурация найдена, система просматривает многоуровневую конфигурацию для поиска накладных расходов, которые должны быть применены, на основе общем стоимости продуктов номенклатур в группе режима поставки.

    **Способ поставки 11**

    - Общая стоимость продуктов = $70
    - **Значение расходов = $7**

    **Способ поставки 99**

    - Общая стоимость продуктов = $80
    - **Значение расходов = $15**

    **Способ поставки 21**

    - Общая стоимость продуктов = $15
    - **Значение расходов = $0** (автоматические расходы не были настроены для этой комбинации клиента и способа поставки.)

    ![Расходы с режимом поставки 11 попадают в выделенный уровень](media/step2mode11.png)

    ![Расходы с режимом поставки 99 попадают в выделенный уровень](media/step2mode99.png)

3. Система вычисляет значение расходов, которое должно быть применено для каждой строки, на основе логики пропорционального распределения, которая учитывает пропорциональную стоимость строки по отношению к общей стоимости продуктов для данной группы.

    **Способ поставки 11**

    - Значение расходов = $7
    - Сумма группы продуктов = $70
    - Сумма строки 1 = $10 (= 14,2857 процента от стоимости группы)
    - Сумма строки 3 = $60 (= 85,7143 процента от стоимости группы)
    - **Расходы строки для строки 1 = $1**
    - **Расходы строки для строки 3 = $6**

    **Способ поставки 99**

    - Значение расходов = $15
    - Сумма группы продуктов = $80
    - Сумма строки 2 = $50 (= 62,5 процента от стоимости группы)
    - Сумма строки 4 = $30 (= 37,5 процента от стоимости группы)
    - **Расходы строки для строки 2 = $9,38**
    - **Расходы строки для строки 4 = $5,62**

    **Способ поставки 21**

    - Значение расходов = $0
    - Сумма группы продуктов = $15
    - Сумма строки 5 = $15 (= 100 процентов от стоимости группы)
    - **Расходы строки для строки 5 = $0**

Таким образом, в этом примере номенклатуре 81334 будут назначены накладные расходы на фрахт $5,62. Можно просмотреть эти расходы на странице **Ведение накладных расходов** для строки продажи. На следующем рисунке показано, как выглядит эта страница для номенклатуры 81334.

![Пропорциональные накладные расходы в строке продаж для номенклатуры 81334](media/proratedlinecharge.png)

Когда этот метод расчета используется в случае частичного возврата, если код накладных расходов предусматривает возмещение, только часть накладных расходов, назначенная для этой строки, будет возмещена при возврате номенклатуры.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Омниканальные расширенные автоматические накладные расходы](omni-auto-charges.md)

[Включение и настройка автоматических накладных расходов по каналам](auto-charges-by-channel.md)


[!INCLUDE[footer-include](../includes/footer-banner.md)]