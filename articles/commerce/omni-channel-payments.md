---
title: Обзор омниканальных платежей
description: В этой теме представлен обзор омниканальных платежей в Dynamics 365 Commerce.
author: rubendel
ms.date: 09/17/2020
ms.topic: article
ms.prod: ''
ms.technology: ''
audience: Application user
ms.reviewer: josaw
ms.custom:
- "141393"
- intro-internal
ms.assetid: ''
ms.search.region: Global
ms.search.industry: Retail
ms.author: rubendel
ms.search.validFrom: 2019-01-01
ms.dyn365.ops.version: AX 8.1.3
ms.openlocfilehash: adab650451a4ff22fcba82b0aa053c923f5dc5ef
ms.sourcegitcommit: 92ff867a06ed977268ffaa6cc5e58b9dc95306bd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2021
ms.locfileid: "6339439"
---
# <a name="omni-channel-payments-overview"></a>Обзор омниканальных платежей

[!include [banner](../includes/banner.md)]

В этой теме представлен обзор омниканальных платежей в Dynamics 365 Commerce. Она содержит полный список поддерживаемых сценариев, информацию о функциях, настройке и устранении неполадок, а также описания типичных проблем.

## <a name="key-terms"></a>Ключевые термины

| Срок | Описание |
|---|---|
| Маркер | Строка данных, которую процессор платежей предоставляет в качестве ссылки. Маркеры могут представлять номера платежных карт, авторизации платежей и предыдущие записи платежей. Маркеры важны, потому что они помогают хранить конфиденциальные данные вне системы POS-терминалов. Иногда они также называются *ссылками*. |
| Маркер карты | Маркер, предоставляемый процессором платежей для хранения в системе POS. Маркер карты может использоваться только продавцом, который его получает. Маркеры карт они называются *ссылками карт*. |
| Маркер авторизации (auth) | Уникальный код, который процесс платежа представляет как часть отклика, который он отправляет в систему POS после того, как система POS-терминалов выполнит запрос авторизации. Маркер авторизации может использоваться позднее, если процессор вызван для выполнения таких действий, как реверсирование или аннулирование авторизации. Однако чаще всего он используется для регистрации фондов при выполнении заказа или при завершении проводки. Маркеры авторизации иногда называются *ссылками авторизации*. |
| Маркер подтверждения | Ссылка, которую процессор платежей предоставляет системе POS при завершении или подтверждении платежа. Маркер подтверждения можно затем использовать для ссылки на подтверждение платежа в последующих операциях, таких как запросы на возврат средств. | 
| Карта отсутствует | Термин, который относится к платежным проводкам, в которых физическая карта не представлена. Например, эти проводки могут выполняться в сценариях электронной коммерции или в центре обработки вызовов. Для этих проводок информация, связанная с платежом, вручную вводится на веб-сайте электронной коммерции, в потоке центра обработки вызовов или на POS-терминале или платежном терминале. |
| Карта присутствует | Термин, который относится к проводкам платежа, в которых физическая карта представлена и используется на платежном терминале, подключенном к системе POS-терминалов Microsoft Dynamics 365. |

## <a name="overview"></a>Обзор

В общем случае термин *омниканальные платежи* описывает возможность создания заказа в одном канале и выполнения его в другом канале. Ключом к поддержке омниканальных платежей является сохранение сведений об оплате вместе с остальными сведениями о заказе, а затем использование этих сведений об оплате при вызове или обработке заказа в другом канале. Классическим примером является сценарий "купить в Интернете, забрать в магазине". В этом сценарии сведения об оплате добавляются, когда заказ создается в Интернете. Затем они вызываются в POS-терминале, чтобы снять средства с платежной карты клиента в момент выдачи. 

Все сценарии, описанные в этом разделе, могут быть реализованы с помощью стандартного пакета средств разработки программного обеспечения (SDK) платежей, поставляемого вместе с Commerce. [Соединитель платежей Dynamics 365 для Adyen](/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3) предоставляет готовую реализацию каждого сценария, описанного здесь. 

### <a name="prerequisites"></a>Необходимые условия

Для каждого сценария, описанного в этом разделе, требуется соединитель платежей, поддерживающий омниканальные платежи. Готовый соединитель Adyen также можно использовать, поскольку он поддерживает сценарии, доступные через пакет SDK для платежей. Для получения дополнительных сведений о том, как реализовать соединители платежей, и о пакете SDK Retail в целом см. на [домашней странице Retail для ИТ-специалистов и разработчиков](/dynamics365/unified-operations/retail/dev-itpro/dev-retail-home-page#payment-connectors).

#### <a name="supported-versions"></a>Поддерживаемые версии

Возможности омниканальных платежей, описанные в этом разделе, были выпущены как часть Microsoft Dynamics 365 for Retail версии 8.1.3. 

#### <a name="card-present-and-card-not-present-connectors"></a>Соединители "карта присутствует" и "карта отсутствует"

В пакете SDK "Платежи" для платежей используются два набора интерфейсов прикладного программирования (API). Первый набор интерфейсов API называется **iPaymentProcessor**. Он используется для реализации соединителей платежа "карты нет", которые могут использоваться в центрах обработки вызовов и в платформе электронной коммерции Microsoft Dynamics. Дополнительные сведения об интерфейсе **iPaymentProcessor** см. в техническом документе [Реализация соединителя платежей и платежного устройства](https://download.microsoft.com/download/e/2/7/e2735c65-1e66-4b8d-8a3c-e6ef3a319137/The%20Guide%20to%20Implementing%20Payment%20Connector%20and%20Payment%20Device_update.pdf), который охватывает платежи. 

Второй набор интерфейсов API называется **iNamedRequestHandler**. Он поддерживает реализацию случаев интеграции платежей "карта присутствует", использующих платежный терминал. Дополнительные сведения об интерфейсе **iNamedRequestHandler** см. в разделе [Создание интеграции платежей для платежного терминала](/dynamics365/unified-operations/retail/dev-itpro/end-to-end-payment-extension). 

### <a name="setup-and-configuration"></a>Настройка и конфигурация

Следующие компоненты и шаги настройки являются обязательными:

- **Интеграция электронной коммерции:** интеграция с модулем Commerce необходима для поддержки сценариев, когда заказ исходит из Интернет-магазина. Для получения дополнительных сведений о пакете SDK для электронной коммерции Retail см. в разделе [Пакет разработки программного обеспечения для платформы электронной коммерции (SDK)](/dynamics365/unified-operations/retail/dev-itpro/ecommerce-platform-sdk). В демонстрационной среде указанный магазин поддерживает сценарии омниканальных платежей. 
- **Конфигурация интернет-платежей:** настройка интернет-канала должна включать в себя соединитель платежей, который был обновлен для поддержки многоканальных платежей. В качестве альтернативы можно использовать готовый соединитель платежей. Сведения о настройке соединителя платежей Adyen для интернет-магазинов см. в разделе [Соединитель платежей Adyen](/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3#e-commerce). В дополнение к шагам настройки электронной коммерции, описанным в этом разделе, необходимо установить для параметра **Разрешить сохранение информации о платеже в электронной коммерции** значение **True** в настройках соединителя Adyen. 
- **Конфигурация омниканальных платежей:** в бэк-офисе выберите **Retail и Commerce \> Настройка Headquarters \> Параметры \> Общие параметры Commerce**. Затем на вкладке **Омниканальные платежи** выберите значение для параметра **Использовать омниканальные платежи** значение **Да**. В Commerce версии 10.0.12 и выше этот параметр находится в рабочей области **Управление функциями**. Выберите функцию **Многоканальные платежи** и щелкните **Включить**. 
- **Службы платежей:** центр обработки звонков использует соединитель платежей по умолчанию на странице **Службы платежей** для обработки платежей. Для поддержки таких сценариев, как "Купить в центре обработки вызовов, забрать в магазине", этот платежный соединитель по умолчанию должен быть платежным соединителем Adyen или платежным соединителем, который удовлетворяет требованиям к реализации для омниканальных платежей.
- **Услуга электронного платежа:** платежи через платежный терминал должны быть настроены на экспресс-вкладке **Услуга электронного платежа** в профиле оборудования. Соединитель Adyen включает готовую поддержку сценариев омниканальных платежей. Другие соединители платежей, поддерживающие интерфейс **iNamedRequestHandler**, также могут использоваться, если они поддерживают омниканальные платежи.
- **Доступность платежного соединителя:** при повторном вызове заказа строки платежного средства, которые вызываются вместе с заказом, включают имя соединителя платежа, который использовался для создания авторизаций, связанных с этим заказом. Когда заказ будет выполнен, SDK платежей предпринимает попытку использования того же соединителя, который использовался для создания исходной авторизации. Таким образом, платежный соединитель с теми же свойствами получателя платежа должен быть доступен для фиксации. 
- **Типы карт:** для правильной работы омниканальных сценариев каждый канал должен иметь одинаковую настройку типов платежных средств, которые могут быть использованы для омниканальной работы. Эта настройка включает коды методов оплаты и коды типов карт. Например, если тип платежного средства **Карты** имеет идентификатор **2** в настройке интернет-магазина, он должен иметь такой же код в настройке розничного магазина. Эти же требования относятся к кодам типов карт. Если в интернет-магазине для номера карт **12** установлено значение **VISA**, для розничного магазина необходимо настроить этот же код. 
- Retail Modern POS для Windows или Android со станцией оборудования или
- Modern POS для iOS или Cloud POS с подключенной общей станцией оборудования. 

### <a name="basic-principle-supporting-omni-channel-payments"></a>Основной принцип поддержки омниканальных платежей

Соединители платежей и процессоры платежей используют маркеры, или ссылки, для ссылки на взаимодействия, которые относятся к платежам картой. Например, при запросе авторизации платежа предоставляется ссылка на эту авторизацию. Таким образом, в дальнейшем можно использовать ссылку на авторизацию, когда средства фиксируются во время выполнения. Эта авторизация является уникальной для продавца, платежного соединителя и процессора. 

Если заказ, созданный в Интернете, забирается в магазине, необходимо вызвать и использовать те же сведения об оплате для этого заказа. Когда исходные сведения предоставляются в рамках запроса на фиксацию платежа относительно исходной авторизации, процессор платежа сможет обработать запрос и зафиксировать платеж. 

Чтобы правильно ссылаться на интернет-заказ, также должен быть доступен соединитель платежей "карта отсутствует", поддерживающий этот же процессор. Таким образом, система POS может иметь один процессор для платежей "карта присутствует", но она также может иметь доступ к другим соединителям платежей, чтобы выполнять заказы, созданные в других каналах, используя различные процессоры оплаты. 

## <a name="supported-scenarios"></a>Поддерживаемые сценарии

Поддерживаются следующие сценарии омниканальных платежей:

- Покупка в сети, получение в магазине
- Покупка в центре обработки вызовов, получение в магазине
- Покупка в магазине A, получение в магазине B
- Покупка в магазине A, отгрузка клиенту

    > [!NOTE]
    > Платежи, сделанные в центре обработки вызовов, которые сопоставляются с "нормальными" функциями платежа, должны быть помечены как **Предоплата** = **Да**, чтобы быть отраженными в сумме, подлежащей оплате, при отзыве заказа в POS-терминале. Неоплачиваемые платежи типа "Нормальный" не опознаются при отзыве заказа в POS-терминале. 

Также поддерживаются вариации этих сценариев. Например, заказ в Интернете может включать как строки, которые будут отгружены клиенту, так и строки, которые будут получены в магазине. Все варианты выполнения заказа поддерживаются через омниканальные платежи. 

В следующих разделах описываются шаги для каждого сценария и показано, как запустить сценарий, используя демонстрационные данные. 

### <a name="buy-online-pick-up-in-store"></a>Покупка в сети, получение в магазине

Перед началом убедитесь, что выполнены следующие предварительные условия:

- Имеется пример магазина, в котором настроен соединитель Adyen.
- Параметр **Омниканальные платежи** на странице **Общие параметры Commerce** имеет значение **True**. В более поздних версиях этот параметр перенесен в рабочую область **управления функциями**, в которой можно выбрать функцию **Многоканальные платежи** и нажать **Включить**. 
- Соединитель платежей Adyen настроен для POS-ККМ Houston.
- Retail Modern POS для Windows или Android со станцией оборудования или
- Modern POS для iOS или Cloud POS с подключенной общей станцией оборудования. 

Для выполнения этого сценария выполните следующие действия.

1. В примере магазине создайте заказ для получения в магазине. Не забудьте выбрать магазин **Houston**. 
2. Выполните действия для оформления заказа и оплатите, используя номер тестовой кредитной карты. Номера тестовых кредитных карт можно найти на [странице номеров тестовых карт Adyen](https://docs.adyen.com/development-resources/test-cards/test-card-numbers/#description).
3. В модуле Commerce используйте пакетное задание **Синхронизация заказов** и график распределения **P-001**, чтобы создать заказы в бэк-офисе.
4. В POS-терминале на странице приветствия выберите операцию **Заказы для отправки**, чтобы просмотреть заказы, которые должны быть получены в магазине. 
5. Выберите одну или несколько строк из заказа, который был создан в примере магазина, затем выберите **Вывоз**.

    Заказ извлекается из бэк-офиса. 

6. Когда сведения о строке заказа извлекаются из бэк-офиса и платеж по карте, который может использоваться для омниканального сценария обнаружен, вы получаете сведения о том, что доступен метод оплаты.
7. Выберите **Использовать доступный метод оплаты**, чтобы выполнить проводку, используя сведения о карте, которые были введены в примере магазина.

    Строки заказа загружаются на страницу проводки, а задолженность равна 0 (нулю). 

8. Перейдите на вкладку **Платежи**, чтобы просмотреть строку платежного средства, которая была извлечена из заказа в Интернете. 
9. Выберите любой метод оплаты, чтобы выполнить проводку. 

### <a name="buy-in-call-center-pick-up-in-store"></a>Покупка в центре обработки вызовов, получение в магазине

1. В модуле Commerce на странице **Обслуживание клиентов** введите **Карен Берг** на панели поиска, затем выберите **Поиск**. 
3. Выберите **Карен Берг** в результатах поиска.
4. После загрузки Карен на страницу **Обслуживание клиентов** выберите **Новый заказ на продажу**.
5. На странице нового заказа на продажу выберите **Заголовок** для просмотра заголовка заказа. 
6. На странице **Заголовок заказа** задайте сайт **Центральный** и склад **Хьюстон**.
7. На вкладке **Доставка** задайте в поле **Способ поставки** значение **60** для отправки клиенту.
8. Выберите **Строки**, затем добавьте одну или несколько строк в заказ. 
9. Выберите **Завершить**, чтобы перейти в поток завершения заказа.
10. Перейдите вниз в раздел платежей, выберите команду **Добавить**, затем выберите строку, для которой установлен тип метода платежа **Карты**. 
11. Выберите знак "плюс" (**+**), чтобы добавить платеж по карте. 
12. Введите сведения для номера пробной кредитной карты, который вы нашли на [странице номеров тестовых карт Adyen](https://docs.adyen.com/development-resources/test-cards/test-card-numbers/#description), затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Если бренд карты для введенного номера отличается от бренда, который был выбрана при запуске платежа, платеж все равно пройдет. Однако он будет разнесен на счета, сопоставленные с брендом карт, выбранным на шаге 10.

12. Снова нажмите **ОК**, чтобы закрыть диалоговое окно **Завершение оплаты заказа**.
13. На странице **Сводка заказа на продажу** выберите **Отправить**.
14. В POS-терминале на странице приветствия выберите операцию **Заказы для отправки**, чтобы просмотреть заказы, которые должны быть получены в магазине. 
15. Выберите одну или несколько строк из заказа, который был создан в примере магазина, затем выберите **Вывоз**.

    Заказ извлекается из бэк-офиса. 

16. Когда сведения о строке заказа извлекаются из бэк-офиса и платеж по карте, который может использоваться для омниканального сценария обнаружен, вы получаете сведения о том, что доступен метод оплаты.
17. Выберите **Использовать доступный метод оплаты**, чтобы выполнить проводку, используя сведения о карте, которые были введены в примере магазина.

    Строки заказа загружаются на страницу проводки, а задолженность равна 0 (нулю).

18. Перейдите на вкладку **Платежи**, чтобы просмотреть строку платежного средства, которая была извлечена из заказа в Интернете. 
19. Выберите любой метод оплаты, чтобы выполнить проводку. 

### <a name="buy-in-store-a-pick-up-in-store-b"></a>Покупка в магазине A, получение в магазине B

1. Запустите POS-терминал для магазина Хьюстон.
2. На странице **Проводка** добавьте Карен Берг в проводку, используя цифровую клавиатуру для ввода **2001**.
3. Добавить одну или несколько строк в проводку.
4. Выберите **Заказы**, чтобы просмотреть параметры заказа.
5. Выберите **Скомплектовать все**, затем, когда появится запрос, выберите **Заказ клиента**.
6. В строке поиска введите **Сиэтл**, затем выберите магазин **Сиэтл** для получения. 
7. Выберите кнопку **ОК**, чтобы принять текущую дату в качестве даты получения.
9. Выберите **Платежная карта**, чтобы начать платеж.
10. Выставите в платеже по карте сумму, подлежащую оплате на депозит. 
11. Выполните платеж на депозит на платежном терминале. 
12. После выплаты депозита выберите параметр для использования той же карты для выполнения и дождитесь завершения заказа. 
13. Запустите POS-терминал для магазина Сиэтла.
14. В POS-терминале на странице приветствия выберите операцию **Заказы для отправки**, чтобы просмотреть заказы, которые должны быть получены в магазине. 
15. Выберите одну или несколько строк из заказа, который был создан в примере магазина, затем выберите **Вывоз**.

    Заказ извлекается из бэк-офиса. 

16. Когда сведения о строке заказа извлекаются из бэк-офиса и платеж по карте, который может использоваться для омниканального сценария обнаружен, вы получаете сведения о том, что доступен метод оплаты.
17. Выберите **Использовать доступный метод оплаты**, чтобы выполнить проводку, используя сведения о карте, которые были введены в примере магазина.

    Строки заказа загружаются на страницу проводки, а задолженность равна 0 (нулю).

18. Перейдите на вкладку **Платежи**, чтобы просмотреть строку платежного средства, которая была извлечена из заказа в Интернете. 
19. Выберите любой метод оплаты, чтобы выполнить проводку. 

### <a name="buy-in-store-a-ship-to-customer"></a>Покупка в магазине A, отгрузка клиенту

1. Запустите POS-терминал для магазина Хьюстон.
2. На странице **Проводка** добавьте Карен Берг в проводку, используя цифровую клавиатуру для ввода **2001**.
3. Добавить одну или несколько строк в проводку.
4. Выберите **Заказы**, чтобы просмотреть параметры заказа.
5. Выберите **Отгрузить все**, затем, когда появится запрос, выберите **Заказ клиента**.
6. На странице метода отгрузки выберите вариант **Стандартный на следующий рабочий день**, затем выберите **ОК**, чтобы принять сегодняшнюю дату в качестве даты отгрузки. 
7. Выберите кнопку **ОК**, чтобы принять текущую дату в качестве даты получения.
8. Выберите **Платежная карта**, чтобы начать платеж.
9. Выставите в платеже по карте сумму, подлежащую оплате на депозит. 
10. Выполните платеж на депозит на платежном терминале. 
11. После выплаты депозита выберите параметр для использования той же карты для выполнения и дождитесь завершения заказа.

Когда заказ скомплектован, упакован и за него выставлен счет в бэк-офисе, сведения об оплате, предоставленные в POS, будут использоваться для фиксации средств за товары, отправляемые клиенту. 

## <a name="scenario-details"></a>Подробности сценария

В дополнение к базовым сценариям, которые только что были описаны, в пакет SDK для модуля "Платежи" были внесены некоторые усовершенствования, поддерживающие омниканальные платежи. 

### <a name="pos"></a>POS

#### <a name="single-swipedip-for-customer-orders"></a>Однократное использование карты для заказов клиента

До реализации функции омниканальных платежей при создании в POS-терминале заказов клиента, которые включают депозиты, клиентам было необходимо два раза предъявить карту: один раз для оплаты депозита и один раз для токенизации карты для последующего выполнения заказа. Когда функция создания омниканальных маркеров включена, клиенты должны предъявить карту только один раз, чтобы оплатить депозит и авторизовать сумму, которая должна быть выплачена за товары, которые будут поставлены позже. Во время выполнения авторизированные средства списываются. До реализации функции омниканальной маркировки для последующего выполнения заказа создавался только повторяющийся маркер карты. Таким образом, средства для ожидающего выполнения не были авторизованы, и поскольку эти средства не были заблокированы для данной покупки, было менее вероятно, что они могут быть списаны позднее.

> [!NOTE]
> Одно считывание не поддерживается в Retail версии 8.1.3. Заказы клиентов в версии 8.1.3 используют тот же поток, который использовался до реализации функции омниканальной токенизации. 

### <a name="cards-that-cant-issue-recurring-card-tokens"></a>Карты, которые не могут выдавать повторяющиеся маркеры карт

Некоторые карты не могут использоваться для омниканальных платежей, так как они не поддерживают выдачу повторяющихся маркеров карты. Когда заказ создается на POS-терминале, если депозит оплачивается с помощью карты, которая не поддерживает повторяющиеся маркеры карт, используется предыдущий процесс токенизации карты. Поэтому клиент, который хочет предоставить платеж, который будет использоваться для последующего выполнения заказа, должен предоставить вторую карту. Если вторая карта не поддерживает повторяющиеся маркеры карт, действие токенизации будет отклонено, и кассиру будет предложено попросить клиента предоставить другую карту. 

### <a name="using-a-different-card"></a>Использование другой карты

Клиент, который пришел в магазин, чтобы забрать заказ, имеет возможность использовать другую карту. Когда кассир получает запрос **Использование доступного способа платежа** при получении заказа, кассир может спросить, хочет ли клиент использовать ту же карту. Если клиент потерял карту, которая использовалась для создания заказа, и хочет заплатить за заказ с помощью другой карты, кассир может выбрать разрешается **Использовать другой способ платежа**. Если позже клиент придет, чтобы забрать дополнительные номенклатуры из того же заказа, если исходная авторизация карты все еще действительна, кассир может снова спросить, хочет ли клиент использовать эту карту.

### <a name="invalid-authorizations"></a>Недействительные авторизации

Если карта, которая использовалась для создания заказа, больше не действительна, то при выборе продуктов для получения запрос на списание платежа будет неудачным. После этого соединитель платежей POS попытается создать новую авторизацию и выполнить списание с использованием тех же сведений карты. Если произойдет сбой новой авторизации или списания, кассиру будет сообщено, что платеж не может быть обработан. Затем кассир должен получить новый платеж от клиента. 

### <a name="multiple-available-payments"></a>Несколько доступных платежей

При получении заказа, в котором имеется несколько платежных средств и несколько строк, кассир сначала получает запрос **Использование доступного способа платежа**. Если есть несколько карт, когда кассир выбирает вариант **Использование доступного способа платежа**, существующие строки карточного платежного средства списываются до тех пор, пока сальдо не будет достигнуто для текущих забираемых товаров. У кассира нет возможности выбора карты, которая должна использоваться для забираемых товаров. 

## <a name="related-topics"></a>Связанные разделы

- [Вопросы и ответы по платежам](/dynamics365/unified-operations/retail/dev-itpro/payments-retail)
- [Соединитель платежей Dynamics 365 для Adyen](/dynamics365/unified-operations/retail/dev-itpro/adyen-connector?tabs=8-1-3)
- [Настройка BOPIS в ознакомительной среде Dynamics 365 Commerce](./cpe-bopis.md)



[!INCLUDE[footer-include](../includes/footer-banner.md)]