---
title: API ценообразования для Commerce
description: В этой статье описываются различные API ценообразования, предоставляемые механизма ценообразования Microsoft Dynamics 365 Commerce.
author: boycez
ms.date: 08/10/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: global
ms.author: boycez
ms.search.validFrom: 2022-07-15
ms.openlocfilehash: d694c44f6987fbf2a360869d2fb2a2fbaf0d2e4d
ms.sourcegitcommit: 924dbcdc6b03f6a7ae3a07378ec405fd15c7e359
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2022
ms.locfileid: "9294123"
---
# <a name="commerce-pricing-apis"></a>API ценообразования для Commerce

[!include [banner](../includes/banner.md)]

В этой статье описываются различные API ценообразования, предоставляемые механизма ценообразования Microsoft Dynamics 365 Commerce.

Механизм ценообразования Dynamics 365 Commerce предоставляет следующие API серверной службы Retail Server, которые могут использоваться внешними приложениями для обеспечения поддержки различных сценариев ценообразования:

- **GetActivePrices** — этот API получает расчетную цену продукта, включая простые скидки.
- **CalculateSalesDocument** — этот API вычисляет цены и скидки для продуктов в заданных количествах, если они куплены вместе.
- **GetAvailablePromotions** — этот API получает применимые скидки для продуктов в корзине. 
- **AddCoupons** — этот API добавляет купоны в корзину.
- **RemoveCoupons** — этот API удаляет купоны из корзины.

Дополнительные сведения об использовании интерфейсов API серверной службы Retail Server во внешних приложениях см. в разделе [Использование интерфейсов API Retail Server во внешних приложениях](dev-itpro/consume-retail-server-api.md).

## <a name="getactiveprices"></a>GetActivePrices

API-интерфейс *GetActivePrices* был представлен в версии Commerce 10.0.4. Этот API получает расчетную цену продукта, включая простые скидки. Он не вычисляет многострочные скидки, и предполагается, что каждый продукт в запросе API имеет количество 1. Этот API также может принимать список продуктов в качестве входных данных и запрашивать цены отдельных продуктов в пакетном режиме.

API-интерфейс *GetActivePrices* поддерживает роли **Сотрудник**, **Клиент**, **Анонимный** и **Приложение** в Commerce.

Основным вариантом использования API-интерфейса *GetActivePrices* является страница со сведениями о продукте (PDP), на которой розничные продавцы хотят продемонстрировать лучшую цену на продукт, включая действующие скидки.

В следующей таблице показаны входные параметры для API-интерфейса *GetActivePrices*.

| Имя                                    | Вложенное имя | Тип | Требуется/Необязательно | Описание |
|-----------------------------------------|----------|------|-------------------|-------------|
| projectDomain                           | | ProjectionDomain | Обязательное поле | |
|                                         | ChannelId | длинный | Обязательное поле | |
|                                         | CatalogId | длинный | Обязательное поле | |
| productIds                              | | IEnumerable\<long\> | Обязательное поле | Список продуктов, для которых требуется рассчитать цены. |
| activeDate                              | | DateTimeOffset | Обязательное поле | Дата, в которую рассчитываются цены. |
| customerId                              | | строка | Необязательно | Номер счета клиента. |
| affiliationLoyaltyTiers                 | | IEnumerable\<AffiliationLoyaltyTier\> | Необязательно | Уровни назначения и лояльности. |
|                                         | AffiliationId | длинный | Обязательное поле | Код назначения. |
|                                         | LoyaltyTierId | длинный | Необязательно | Код уровня лояльности. |
| includeSimpleDiscountsInContextualPrice | | логический | Необязательно | Установите для этого параметра значение **true**, чтобы добавить простые скидки в расчет ценообразования. Значение по умолчанию равно **false**. |
| includeVariantPriceRange                | | логический | Необязательно | Установите для этого параметра значение **true**, чтобы получить минимальные и максимальные цены из всех вариантов для основного продукта. Значение по умолчанию равно **false**. |
| includeAttainablePricesAndDiscounts     | | логический | Необязательно | Установите для этого параметра значение **true**, чтобы получить достижимые цены и скидки. Значение по умолчанию равно **false**. |

**Образец текста запроса**

```json
{
    "projectDomain": 
    {
        "ChannelId": 5637144592,
        "CatalogId": 0
    },
    "productIds": 
    [
        68719489871
    ],
    "activeDate": "2022-06-20T14:40:05.873+08:00",
    "includeSimpleDiscountsInContextualPrice": true,
    "includeVariantPriceRange": false
}
```

**Образец текста ответа**

```json
{
    "value": 
    [
        {
            "ProductId": 68719489871,
            "ListingId": 68719489871,
            "BasePrice": 0,
            "TradeAgreementPrice": 0,
            "AdjustedPrice": 0,
            "MaxVariantPrice": 0,
            "MinVariantPrice": 0,
            "CustomerContextualPrice": 0,
            "DiscountAmount": 0,
            "CurrencyCode": "USD",
            "ItemId": "82000",
            "InventoryDimensionId": null,
            "UnitOfMeasure": "ea",
            "ValidFrom": "2022-06-20T01:40:05.873-05:00",
            "ProductLookupId": 0,
            "ChannelId": 5637144592,
            "CatalogId": 0,
            "SalesAgreementPrice": 0,
            "PriceSourceTypeValue": 1,
            "DiscountLines": [],
            "AttainablePriceLines": [],
        }
    ]
}
```

## <a name="calculatesalesdocument"></a>CalculateSalesDocument

API-интерфейс *CalculateSalesDocument* был представлен в версии Commerce 10.0.25. Этот API вычисляет цены и скидки для продуктов в заданных количествах, если они куплены вместе в заказе. При расчете ценообразования в API-интерфейсе *CalculateSalesDocument* учитываются однострочные скидки и скидки по нескольким строкам.

Основным вариантом использования API-интерфейса *CalculateSalesDocument* является расчет ценообразования в сценариях, когда контекст полной корзины не сохраняется (например, для предложений по продажам). Сценарии в POS и в электронной коммерции Commerce могут также использовать преимущества этого случая использования. Более низкая общая цена, когда номенклатуры корзины рассчитываются как набор (например, для дискретных наборов, связанных или рекомендуемых продуктов или продуктов, которые уже добавлены в корзину), может склонить клиентов к добавлению продуктов в корзину.

Модель данных для запроса и ответа API-интерфейса *CalculateSalesDocument* — **Корзина**. Однако в контексте этого API модель данных называется **SalesDocument**. Так как большинство свойств являются необязательными, и только некоторые из них влияют на расчет ценообразования, в следующей таблице показаны только поля, связанные с ценообразованием. Не рекомендуется добавлять в запрос API какие-либо другие поля.

Область API-интерфейса *CalculateSalesDocument* представляет собой просто расчет цен и скидок. Налоги и расходы не учитываются.

В следующей таблице показаны входные параметры внутри объекта с именем **salesDocument**.

| Имя             | Вложенное имя | Тип | Требуется/Необязательно | Описание |
|------------------|----------|------|-------------------|-------------|
| ИД               | | строка | Обязательное поле | Код документа продажи. |
| CartLines        | | IList\<CartLine\> | Необязательно | Список строк, для которых требуется рассчитать цены и скидки. |
|                  | ИД продукта | длинный | Необходимо указать в области CartLine | Код записи продукта. |
|                  | ItemId | строка | Необязательно | Идентификатор номенклатуры. Если указано значение, оно должно соответствовать значению параметра **ProductId**. |
|                  | InventoryDimensionId | строка | Необязательно | Код складской аналитики. Если указано значение, сочетание значений **ItemId** и **InventoryDimensionId** должно соответствовать значению параметра **ProductId**. |
|                  | Количество | десятичное | Необходимо указать в области CartLine | Количество продукта. |
|                  | UnitOfMeasureSymbol | строка | Необязательно | Единица измерения продукта. По умолчанию, если значение не указано, в API используется единица измерения продажи продукта. |
| CustomerId       | | строка | Необязательно | Номер счета клиента. |
| LoyaltyCardId    | | строка | Необязательно | Код карточки лояльности. Любой счет клиента, связанный со карточкой лояльности, должен соответствовать значению параметра **CustomerId** (если оно указано). Карточка лояльности не будет учитываться, если она не найдена или ее статус **Заблокировано**. |
| AffiliationLines | | IList\<AffiliationLoyaltyTier\> | Необязательно | Строки уровня лояльности назначения. Если заданы значения **CustomerId** и/или **LoyaltyCardId**, соответствующие строки уровня лояльности назначения будут объединены со строками, указанными в значении **AffiliationLines**. |
|                  | AffiliationId | длинный | Необходимо указать в области AffiliationLoyaltyTier | Код записи назначения. |
|                  | LoyaltyTierId | длинный | Необходимо указать в области AffiliationLoyaltyTier | Код записи уровня лояльности. |
|                  | AffiliationTypeValue | int | Необходимо указать в области AffiliationLoyaltyTier | Значение, указывающее тип строки назначения **Общий** (**0**) или **Лояльность** (**1**). Если этот параметр имеет значение **0**, API принимает в качестве идентификатора значение **AffiliationId** и игнорирует значение **LoyaltyTierId**. Если этот параметр имеет значение **1**, API принимает в качестве идентификатора значение **LoyaltyTierId** и игнорирует значение **AffiliationId**. |
|                  | ReasonCodeLines | Сбор\<ReasonCodeLine\> | Необходимо указать в области AffiliationLoyaltyTier | Строки кода причины. Этот параметр не влияет на расчет ценообразования, но является обязательным как часть объекта **AffiliationLoyaltyTier**. |
|                  | CustomerId | строка | Необходимо указать в области AffiliationLoyaltyTier | Номер счета клиента. |
| Купоны          | | IList\<Coupon\> | Необязательно | Купоны, которые не применимы (неактивные, просроченные или не найденные), не учитываются в расчете ценообразования. |
|                  | Код | строка | Необходимо указать в области Coupon | Код купона. |
|                  | CodeId | строка | Необязательно | Идентификатор кода купона. Если указано значение, оно должно соответствовать значению параметра **Code**. |
|                  | DiscountOfferId | строка | Необязательно | Код скидки. Если указано значение, оно должно соответствовать значению параметра **Code**. |

**Образец текста запроса**

```json
{
    "salesDocument": 
    {
        "Id": "CalculateSalesDocument",
        "CartLines": 
        [
            {
                "ProductId": 68719491408,
                "ItemId": "91003",
                "InventoryDimensionId": "",
                "Quantity": 1,
                "UnitOfMeasureSymbol": "ea"
            },
            {
                "ProductId": 68719493014,
                "Quantity": 2,
                "UnitOfMeasureSymbol": "ea"
            }
        ],
        "CustomerId": "3003",
        "AffiliationLines": 
        [
            {
                "AffiliationId": 68719476742,
                "LoyaltyTierId": 0,
                "AffiliationTypeValue": 0,
                "ReasonCodeLines": [],
                "CustomerId": null
            }
        ],
        "LoyaltyCardId": "55103",
        "Coupons": 
        [
            {
                "CodeId": "CODE-0005",
                "Code": "CPN0004",
                "DiscountOfferId": "ST100077"
            }
        ]
    }
}
```

Весь объект корзины возвращается в качестве текста ответа. Для проверки цен и скидок следует сосредоточиться на полях в следующей таблице.

| Имя           | Вложенное имя | Тип | Описание |
|----------------|----------|------|--------------|
| NetPrice       | | десятичное | Чистая цена всего документа продажи до применения скидок. |
| DiscountAmount | | десятичное | Общая сумма скидки всего документа продажи. |
| TotalAmount    | | десятичное | Общая сумма всего документа продажи. |
| CartLines      | | IList\<CartLine\> | Рассчитанные строки, содержащие сведения о ценах и скидках. |
|                | Цена | десятичное | Цена за единицу продукта. |
|                | NetPrice | десятичное | Чистая цена строки до применения скидок (= *Цена* &times; *Количество*). |
|                | DiscountAmount | десятичное | Сумма скидки. |
|                | TotalAmount | десятичное | Окончательный итоговый результат ценообразования для строки. |
|                | PriceLines | IList\<PriceLine\> | Сведения о цене, включая источник цены (базовая цена, корректировка цены или коммерческое соглашение) и сумму. |
|                | DiscountLines | IList\<DiscountLine\> | Сведения о скидке. |

## <a name="getavailablepromotions"></a>GetAvailablePromotions 

При наличии корзины, имеющей несколько строк, API-интерфейс *GetAvailablePromotions* возвращает все применимые скидки для строк корзины. 

Основным вариантом использования API-интерфейса *GetAvailablePromotions* является страница «Корзина», на которой розничные продавцы хотят продемонстрировать примененные скидки или доступные купоны для текущей корзины.

В следующей таблице показаны входные параметры для API-интерфейса *GetAvailablePromotions*.

| Имя        | Тип | Требуется/Необязательно | Описание |
|-------------|------|-------------------|-------------|
| ключ         | строка | Обязательное поле | Код корзины. |
| cartLineIds | IEnumerable\<string\> | Необязательно | Настройте это параметр на возврат скидок только для выбранных строк корзины. |

**Образец текста ответа**

```json
{
    "value": 
    [
        {
            "LineId": "f495ffa507bc4f63a47a409cd8713dd7",
            "Promotion": {
                "OfferId": "ST100012",
                "OfferName": "Loyalty 5% off over $100",
                "PeriodicDiscountTypeValue": 4,
                "IsDiscountCodeRequired": false,
                "ValidationPeriodId": null,
                "AdditionalRestrictions": null,
                "Description": "All loyalty members get 5% with transaction total above $10 unless some exclusive or best price discounts are already applied on the transaction",
                "ValidFromDate": "2022-06-20T06:52:56.2460219Z",
                "ValidToDate": "2022-06-20T06:52:56.2460224Z",
                "CouponCodes": [],
                "ValidationPeriod": null
            }
        }
    ]
}
```

## <a name="addcoupons"></a>AddCoupons

API-интерфейс *AddCoupons* поддерживает добавление списка купонов в корзину. Он возвращает объект корзины после добавления купонов.

В следующей таблице показаны входные параметры для API-интерфейса *AddCoupons*.

| Имя                 | Тип | Требуется/Необязательно | Описание |
|----------------------|------|-------------------|-------------|
| ключ                  | строка | Обязательное поле | Код корзины. |
| couponCodes          | IEnumerable\<string\> | Обязательное поле | Коды купонов для добавления в корзину. |
| isLegacyDiscountCode | логический | Необязательно | Установите для этого параметра значение **true**, чтобы указать, что купон является устаревшим кодом скидки. Значение по умолчанию равно **false**. |

## <a name="removecoupons"></a>RemoveCoupons

Api-интерфейс *RemoveCoupons* поддерживает удаление списка купонов из корзины. Он возвращает объект корзины после удаления купонов.

В следующей таблице показаны входные параметры для API-интерфейса *RemoveCoupons*.

| Имя        | Тип | Требуется/Необязательно | Описание |
|-------------|------|-------------------|-------------|
| ключ         | строка | Обязательное поле | Код корзины. |
| couponCodes | IEnumerable\<string\> | Обязательное поле | Коды купонов для удаления из корзины. |

[!INCLUDE[footer-include](../includes/footer-banner.md)]
