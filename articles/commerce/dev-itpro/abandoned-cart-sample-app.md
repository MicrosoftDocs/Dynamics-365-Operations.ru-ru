---
title: Обнаружение брошенных корзин и отправка уведомлений клиентам
description: В этой теме описывается, как настроить приложение примера соединителя брошенных корзин Microsoft Dynamics 365 Commerce, чтобы выявлять брошенные корзины и отправлять уведомления клиентам по электронной почте.
author: bicyclingfool
ms.date: 02/25/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: stuharg
ms.search.validFrom: 2017-06-20
ms.openlocfilehash: 82848f1ff068cea0adfc6ec1b33fc4bb035f78dc
ms.sourcegitcommit: 374bbdde90fc9a68c0799158a50409bfbe8ca64e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/25/2022
ms.locfileid: "8353366"
---
# <a name="detect-abandoned-carts-and-send-notifications-to-customers"></a>Обнаружение брошенных корзин и отправка уведомлений клиентам

[!include [banner](../includes/banner.md)]

В этой теме описывается, как настроить приложение примера соединителя брошенных корзин Microsoft Dynamics 365 Commerce, чтобы выявлять брошенные корзины и отправлять уведомления клиентам по электронной почте.

Возможность восстановления выручки и сохранения клиентов через уведомления о брошенных корзинах является важной возможностью, поддерживаемой Dynamics 365 Commerce. Путем настройки образца приложения соединителя отброшенных корзин Commerce розничные продавцы могут получить доступ к корзинам для покупок на сервере розничной торговли Retail Server, которая не была изменена в течение промежутка времени, определяемого продавцом. Эти корзины затем могут быть извлечены вместе с данными о продуктах и клиентах и переданы стороннему поставщику маркетинговой программы электронной почты, который может генерировать уведомления по электронной почте и отправлять их клиентам.

Уведомление электронной почты о брошенной корзине, которое получают клиенты, может содержать следующую информацию:

- Имя клиента.
- Фамилия клиента.
- Адрес электронной почты клиента.
- URL-адрес, который возвращает клиента в корзину.
- Валюта транзакции.
- Список продуктов в корзине клиента. Для каждого продукта включены следующие сведения:

    - Отображаемое имя продукта
    - Код продукта (используется для сборки URL-адреса страницы описания продукта)
    - Изображение продукта, размер которого может быть автоматически изменен в соответствии с различными размерами окна просмотра
    - Альтернативный текст для изображения продукта
    - Цена за единицу продукта

## <a name="abandoned-cart-connector-sample"></a>Пример соединителя брошенной корзины

Модель соединителя, предоставляемая корпорацией Майкрософт с помощью пакета SDK Retail, позволяет получать сведения о брошенных корзинах и отправлять их сторонним поставщикам маркетинговых услуг электронной почты. Этот соединитель обрабатывает связь с сервером Retail Server, использует для безопасности Azure Key Vault, обрабатывает планирование извлечения корзины для указанного временного окна и извлекает данные о заказах и продуктах. Он также предоставляет пример реализации для интеграции со сторонним поставщиком маркетинга по электронной почте. Соединитель в готовом виде создан для связи с [Emarsys](https://emarsys.com). Однако его можно легко настроить для интеграции с другими решениями, например с Constant Contact, Mailchimp и SendGrid.

На следующем рисунке показаны компоненты образца приложения соединителя брошенной корзины.

![Компоненты образца приложения соединителя брошенной корзины](media/AbandonedCartConnector.png)

> [!IMPORTANT]
> Некоторые регионы требуют, чтобы клиенты могли отказаться от того, что данные корзины передавались поставщику услуг электронной почты, или потребовать, чтобы их данные были удалены. Однако корпорация Майкрософт не предоставляет эти возможности пользователям. Таким образом, если планируется вести бизнес в регионах, которые выдвигают такие требования, необходимо предоставить необходимую инфраструктуру и настройки для отслеживания предпочтений клиентов и, на основе их предотвратить передачу данных клиента на вашу платформу электронной почты. Кроме того, необходимо определить процесс удаления данных клиента из поставщика маркетинга по электронной почте по запросу клиента.

## <a name="obtain-the-code-sample"></a>Получение примера кода

Образец приложения соединителя брошенной корзины включен в пакет SDK Retail версии 10.0.16. Код можно найти по пути **\\RetailSDK\\Code\\SampleExtensions\\RetailServer\\Extensions.AbandonedCartSample**. Дополнительные сведения о пакете Retail SDK и о том, где его получить, см. в разделе [Комплект средств разработки программного обеспечения (SDK) для Retail](retail-sdk/retail-sdk-overview.md).

> [!NOTE]
> Хотя образец кода впервые был доступен в сборках версии 10.0.16, он совместим с версиями 10.0.13 и более поздними версиями сервера Retail Server.

## <a name="prerequisites-and-dependencies"></a>Необходимые условия и зависимости

Перед развертыванием и настройкой образца кода соединителя брошенной корзины должны быть выполнены следующие условия.

### <a name="access-to-commerce-resources"></a>Доступ к ресурсам Commerce

Для настройки и развертывания приложения соединителя брошенной корзины необходимо иметь доступ к следующим ресурсам Commerce:

- Доступ администратора к Commerce headquarters для вашей среды
- Доступ к проекту Microsoft Dynamics Lifecycle Services (LCS) для вашей среды

### <a name="azure-cosmos-db"></a>Azure Cosmos DB

Приложение соединителя брошенной корзины использует Azure Cosmos DB для отслеживания кодов и отметок времени ранее извлеченных корзин. Можно использовать Azure Cosmos DB для хранения этих данных или можно настроить пример кода для интеграции с другим параметром хранения данных. Дополнительные сведения об Azure Cosmos DB см. в разделе [Добро пожаловать в Azure Cosmos DB](/azure/cosmos-db/introduction).

Если вы используете Azure Cosmos DB ,прежде чем вы сможете запустить образец, необходимо выполнить следующие предварительные требования:

- Необходимо иметь активную учетную запись Azure Cosmos DB. Если у вас нет учетной записи, см. раздел [Создание учетной записи базы данных](/azure/cosmos-db/create-sql-api-dotnet#create-a-database-account).
- Необходимо извлечь значения **URI** и **ПЕРВИЧНЫЙ КЛЮЧ** (или **ВТОРИЧНЫЙ КЛЮЧ**) из вертикальной вкладки **Ключи** учетной записи Azure Cosmos DB на портале Azure. Дополнительные сведения о получении конечной точки и информации о ключе для учетной записи Azure Cosmos DB см. в разделе [Просмотр, копирование и регенерация ключей доступа и паролей](/azure/cosmos-db/manage-account#keys).

### <a name="azure-key-vault"></a>Azure Key Vault

В приложении соединителя брошенных корзин используется Key Vault для хранения имен и секретов других компонентов, требующих безопасного доступа.

Чтобы настроить хранилище ключей, сделайте следующее.

1. Следуйте указаниям в разделе [Управление Key Vault в Azure Stack Hub с помощью портала](/azure-stack/user/azure-stack-key-vault-manage-portal?view=azs-2002&preserve-view=true).
2. Создайте секреты для следующей информации:

    - Имя пользователя и секрет API интерфейса прикладного программирования (API) Emarsys
    - Код и секрет приложения брошенных корзин

Пример кода соединителя брошенной корзины использует учетные данные Azure по умолчанию для доступа к Key Vault. Необходимо предоставить разрешения **Список** и **Чтение** для удостоверения, которое планируется использовать для доступа к Key Vault.

Дополнительные сведения об учетных данных Azure по умолчанию см. в разделе [Класс DefaultAzureCredential](/dotnet/api/azure.identity.defaultazurecredential?view=azure-dotnet&preserve-view=true).

## <a name="create-an-abandoned-cart-connector-sample-app-application-id-for-the-azure-ad-tenant"></a>Создание кода примера приложения соединителя брошенной корзины для клиента Azure AD

Вы должны создать код примера приложения соединителя брошенной корзины для клиента Azure Active Directory (AD). Информация о том, как создать код приложения, см. в разделе [Использование портала для создания приложения Azure AD и субъекта-службы, которые имеют доступ к ресурсам](/azure/active-directory/develop/howto-create-service-principal-portal).

## <a name="add-the-abandoned-cart-connector-sample-app-application-id-to-the-allow-list-for-the-retail-server-api"></a>Добавление кода образца приложения соединителя брошенной корзины в список разрешений для API розничного сервера Retail Server

Далее вы должны добавить код образца приложения соединителя брошенной корзины в список разрешений для API розничного сервера Retail Server. Сведения о добавлении идентификатора приложения в список разрешений в Azure см. в разделе [Поддержка аутентификации между службами в Retail Server](https://community.dynamics.com/ax/b/axforretail/posts/support-for-service-to-service-authentication-in-retail-server).

## <a name="configure-the-abandoned-cart-connector-sample-app"></a>Настройка образца приложения соединителя брошенной корзины

Для настройки образца приложения соединителя брошенной корзины измените файл конфигурации **appSettings.json**, расположенный в корне каталога **AbandonedCartDetectionSample**. В следующих таблицах описываются свойства файла конфигурации.

### <a name="keyvaultoptions"></a>KeyVaultOptions

| Свойство    | Описание |
| ----------- | ----------- |
| KeyVaultURI | Имя службы DNS хранилища ключей, которое используется на портале Azure. |

### <a name="retailserverclientoptions"></a>RetailServerClientOptions

| Свойство                                      | Описание |
| --------------------------------------------- | ----------- |
| TenantId                                      | Код клиента Azure AD для вашего клиента Azure. |
| RetailServerAudienceId                        | Идентификатор аудитории сервера розничной торговли Retail Server. Вы можете оставить значение по умолчанию. |
| AppIdKeyVaultSecretName                       | Имя секрета, созданного для кода примера приложения соединителя брошенной корзины. |
| AppSecretKeyVaultSecretName                   | Имя секрета, хранящего секрет приложения для кода примера приложения соединителя брошенной корзины. |
| RetailServerUrl                               | URL-адрес экземпляра сервера розничной торговли Retail Server. Это значение можно найти в LCS. |
| OperatingUnitNumber                           | Номер операционной единицы (OUN). Это значение можно найти в Commerce headquarters. |
| IncludeAbandonedCartsModifiedSinceLastMinutes | Начало временного окна для брошенных корзин, которые необходимо извлечь. Значение выражается как число минут до текущего времени. Например, установите для этого свойства значение **120**, чтобы извлечь все корзины, которые были изменены между последними 120 минутами назад и концом временного окна, определенного свойством **ExcludeAbandonedCartsModifiedSinceLastMinutes**. |
| ExcludeAbandonedCartsModifiedSinceLastMinutes | Конец временного окна для брошенных корзин, которые необходимо извлечь. Значение выражается как число минут до текущего времени. Например, если свойство **IncludeAbandonedCartsModifiedSinceLastMinutes** имеет значение **120**, установите для этого свойства значение **30**, чтобы извлечь все корзины, которые были изменены между 120 минутами назад и 30 минутами назад. На практике это свойство определяет период времени, в течение которого необходимо ожидать, пока корзина не будет объявлена как брошенная. |
| ReturnToCartUrl                               | URL-адрес корзины на веб-сайте электронной коммерции в формате, который используется в файле **app.config**. |

### <a name="azurecosmosoptions"></a>AzureCosmosOptions

Статус задания получения брошенной корзины, идентификаторы корзины и измененные временные метки хранятся в Azure Cosmos DB. По умолчанию настройки в файле конфигурации указывают на локальный экземпляр эмулятора Azure Cosmos DB. При развертывании соединителя в производстве необходимо обновить эти параметры, чтобы они указывали на экземпляр Azure Cosmos DB в вашей подписке Azure. Для локального тестирования или тестирования в песочнице можно использовать [эмулятор Azure Cosmos](/azure/cosmos-db/local-emulator).

| Свойство    | Описание |
| ----------- | ----------- |
| EndPointUri | URI конечной точки, предоставляемый Azure или эмулятором. |
| PrimaryKey  | Первичный ключ, предоставляемый Azure или эмулятором. |
| DatabaseId  | Идентификатор базы данных. Можно оставить значение по умолчанию или предоставить собственное. |
| ContainerId | Код контейнера. Можно оставить значение по умолчанию или предоставить собственное. |

### <a name="emarsysclientoptions"></a>EmarsysClientOptions

> [!NOTE]
> При интеграции с поставщиком маркетинга по электронной почте, отличному от Emarsys, необходимо расширить интерфейс **IEmailProvider** для связи с этим поставщиком.

| Свойство                      | Описание |
| ----------------------------- | ----------- |
| ApiUrl                        | `https://api.emarsys.net/api/v2/event/{0}/trigger` |
| ExternalEventId               | Код внешней записи события, созданной в Emarsys. Можно найти значение в разделе **Параметры триггера** в кампании, созданной для отправки по электронной почте уведомлений о брошенной корзине. |
| ApiUserNameKeyVaultSecretName | Имя ключа, в котором хранится имя пользователя API Emarsys. |
| ApiSecretKeyVaultSecretName   | Имя ключа, в котором хранится секрет API Emarsys. |
| EmarsysContactKeyId           | Идентификатор столбца электронной почты в базе данных контактов Emarsys. Значение по умолчанию равно **3** и не должно изменяться. |

### <a name="mediaoptions"></a>MediaOptions

Если вы используете возможности электронной коммерции в модуле Commerce, вы можете использовать управление цифровыми активами Commerce для получения изображений продуктов. Дополнительные сведения о функциях изменения размеров изображений в управлении цифровыми средствами см. в разделе [Конфигурация окна просмотра ImageSettings](../e-commerce-extensibility/image-component.md#imagesettings-viewport-configuration).

| Свойство                             | Описание |
| ------------------------------------ | ----------- |
| ImageServerUrl                       | Корневой URL-адрес диспетчера цифровых ресурсов сайта. Вы можете найти значение в ключе свойства **Базовый URL-адрес сервера мультимедиа** по пути **Retail и Commerce \> Настройка каналов \> Профили каналов** в Commerce headquarters. |
| ImageViewPorts                       | Узел контейнера для отдельных конфигураций окна просмотра. |
| ImageViewPorts/viewport              | Определение окна просмотра. Используйте это свойство для указания диапазона ширины для окна просмотра в пикселях. Пример, который показывает использование этого свойства, см. в файле конфигурации **appSettings.json**. |
| ImageViewPorts/imageWidth            | Ширина изображения в окне просмотра, в пикселах. |
| imageViewPorts/imageHeight           | Высота изображения в окне просмотра, в пикселах. |
| imageViewPorts/useForDefaultImageTag | Значение **true**/**false**, указывающее, следует ли использовать аналитики изображения, определенные в окне просмотра, если HTML-тег `<picture>` не поддерживается для веб-браузера или почтового клиента. |

[!INCLUDE[footer-include](../../includes/footer-banner.md)]
