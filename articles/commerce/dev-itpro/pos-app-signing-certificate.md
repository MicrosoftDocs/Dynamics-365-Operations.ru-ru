---
title: Подписание файла MPOS .appx с помощью сертификата подписи кода
description: В этой статье объясняется, как подписать MPOS с помощью сертификата подписи кода.
author: josaw1
ms.date: 05/27/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: josaw
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2019-09-2019
ms.custom: 28021
ms.openlocfilehash: bcf558b4b375078ed24777417e92b1c852f4c0eb
ms.sourcegitcommit: 87e727005399c82cbb6509f5ce9fb33d18928d30
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/12/2022
ms.locfileid: "9282815"
---
# <a name="sign-the-mpos-appx-file-with-a-code-signing-certificate"></a>Подписание файла MPOS .appx с помощью сертификата подписи кода

[!include [banner](../includes/banner.md)]

Чтобы установить Modern POS (MPOS), необходимо подписать приложение MPOS с помощью сертификата подписи кода от доверенного поставщика и установить один и тот же сертификат на всех компьютерах, где MPOS установлен в доверенную корневую папку для текущего пользователя.

Чтобы подписать приложение MPOS с помощью сертификата, воспользуйтесь одним из следующих вариантов в файле **Retail SDK\\Build tool\\Customization.settings**:

- Добавьте часть задачи защитного файла в шаги создания Azure DevOps и загрузите сертификат, чтобы защитить задачу файла. Используйте переменную выходного пути к защитному файлу в качестве параметра в файле Customization.settings.

    > [!NOTE]
    > Задача защитного файла не поддерживает сертификат, защищенный паролем. Перед отправкой этой задачи необходимо удалить пароль. Поскольку сертификат отправляется в системную задачу защитного файла в Azure, можно удалить пароль только для этого шага. Однако следует обсудить удаление пароля с экспертами по безопасности, чтобы определить, является ли это действие правильным для вашего проекта. Не удаляйте пароль сертификата для других сценариев.
- Используйте сертификат, который находится в файловой системе. Для этого загрузите или создайте сертификат и поместите его в файловую систему, в которой запущена данная сборка. Размещенный агент Microsoft или пользователь сборки должен иметь доступ к этому пути и файлу.
- Используйте отпечаток для поиска в сертификате в магазине и войдите в систему с помощью этого сертификата.

## <a name="use-a-secure-file-task-for-universal-windows-platform-app-signing"></a>Используйте задачу защитного файла для подписи приложения универсальной платформы Windows

> [!NOTE]
> Можно также использовать Azure Key Vault для хранения сертификата и использовать инструмент подписи Azure для подписывания файла Modern POS . appx и установщиков дистанционного обслуживания. Образцы сценариев конвейера и дополнительные сведения см. в разделе [Настройка конвейера сборки в Azure DevOps для создания пакетов дистанционного обслуживания Retail](build-pipeline.md#set-up-a-build-pipeline-in-azure-devops-to-generate-retail-self-service-packages).

Использование задачи защитного файла является рекомендуемым подходом к подписанию приложений универсальной платформы Windows (UWP). Дополнительные сведения о подписывании пакетов см. в разделе [Настройка подписи пакетов](/windows/uwp/packaging/auto-build-package-uwp-apps#configure-package-signing). Этот процесс показан на следующем изображении.

![Поток подписи приложения MPOS.](media/POSSigningFlow.png)

> [!NOTE]
> В настоящее время упаковка OOB поддерживает подпись только для файла appx, разные установщики дистанционного обслуживания, например MPOIS, RSSU и HWS, не подписываются этим процессом. Необходимо подписать его вручную с помощью инструмента SignTool или других инструментов подписи. Сертификат, используемый для подписывания файла appx, должен быть установлен на компьютере, на котором установлен Modern POS.

## <a name="steps-to-configure-the-certificate-for-signing-in-azure-pipelines"></a>Шаги настройки сертификата для подписывания в Azure Pipelines

### <a name="certificate-in-the-file-systemsecure-location"></a>Сертификат в файловой системе/безопасном расположении

Загрузите [задачу DownloadFile](/visualstudio/msbuild/downloadfile-task) и добавьте ее в качестве первого шага процесса создания. Преимуществом использования задачи защитного файла является то, что файл шифруется и помещается на диск во время сборки независимо от того, выполняется ли конвейер сборки успешно, завершается с ошибкой или отменяется. Файл удаляется из расположения загрузки после завершения процесса выполнения сборки.

1. Загрузите и добавьте задачу защитного файла в качестве первого шага в конвейере сборки Azure. Можно загрузить задачу защитного файла из [DownloadFile](https://marketplace.visualstudio.com/items?itemName=automagically.DownloadFile).
1. Загрузите сертификат в задачу защитного файла и задайте имя ссылки в поле "Выходные переменные", как показано на следующем изображении.
    > [!div class="mx-imgBorder"]
    > ![Задача защитного файла](media/SecureFile.png)
1. Создайте новую переменную в Azure Pipelines, выбрав элемент **Новая переменная** на вкладке **Переменные**.
1. Введите имя переменной в поле значения, например **MySigningCert**.
1. Сохраните переменную.
1. Откройте файл **Customization.settings** из **RetailSDK\\BuildTools** и обновите **ModernPOSPackageCertificateKeyFile**, используя имя переменной, созданное в конвейере (шаг 3). Пример:

    ```Xml
    <ModernPOSPackageCertificateKeyFile Condition="'$(ModernPOSPackageCertificateKeyFile)' ==''">$(MySigningCert)</ModernPOSPackageCertificateKeyFile>
    ```
    Этот шаг необходим, если сертификат не защищен паролем. Если сертификат защищен паролем, выполните следующие действия.
    
1. Если требуется отметка времени файла MPOS .appx при подписывании его с помощью сертификата, откройте файл **Retail SDK\\Build tool\\Customization.settings** и обновите переменную **ModernPOSPackageCertificateTimestamp** поставщиком метки времени (например, `http://timestamp.digicert.com`).
1. На вкладке конвейера **Переменные** добавьте новую переменную защищенного текста. Задайте для имени значение **MySigningCert.secret** и установите значение пароля для сертификата. Щелкните значок блокировки для защиты переменной.
1. Добавьте задачу **сценария PowerShell** в конвейер (после загрузки защитного файла и перед этапом выполнения сборки). Укажите имя **Дисплея** и задайте тип как **Встроенный**. Скопируйте и вставьте следующий текст в раздел сценария.

    ```powershell
    Write-Host "Start adding the PFX file to the certificate store."
    $pfxpath = '$(MySigningCert.secureFilePath)'
    $secureString = ConvertTo-SecureString "$(MySigningCert.secret)" -AsPlainText -Force
    Import-PfxCertificate -FilePath $pfxpath -CertStoreLocation Cert:\CurrentUser\My -Password $secureString
    ```

1. Откройте файл **Customization.settings** из **RetailSDK\\BuildTools** и обновите **ModernPOSPackageCertificateThumbprint**, используя значение отпечатка сертификата.

    ```Xml
       <ModernPOSPackageCertificateThumbprint Condition="'$(ModernPOSPackageCertificateThumbprint)' == ''"></ModernPOSPackageCertificateThumbprint>
    ```
 
Сведения о том, как получить отпечаток сертификата, см. в разделе [Получение отпечатка сертификата](/dotnet/framework/wcf/feature-details/how-to-retrieve-the-thumbprint-of-a-certificate#to-retrieve-a-certificates-thumbprint). 

## <a name="download-or-generate-a-certificate-to-sign-the-mpos-app-manually-using-msbuild-in-sdk"></a>Загрузите или создайте сертификат для подписания приложения MPOS вручную с помощью msbuild в SDK

Если загруженный или созданный сертификат используется для подписи приложения MPOS, обновите узел **ModernPOSPackageCertificateKeyFile** в файле **BuildTools\\Customization.settings**, чтобы указать расположение файла PFX (**$(SdkReferencesPath)\\appxsignkey.pfx**). Пример:

```xml
<ModernPOSPackageCertificateKeyFile Condition="'$(ModernPOSPackageCertificateKeyFile)' ==''">$(SdkReferencesPath)\appxsignkey.pfx</ModernPOSPackageCertificateKeyFile>
```

В этом случае именем файла сертификата является **appxsignkey.pfx**. Он расположен в папке **Retail SDK\\Reference**.

## <a name="use-thumbprint-to-sign-the-mpos-app"></a>Использование отпечатка для подписи приложения MPOS

Если для подписи приложения MPOS используется отпечаток, установите сертификат локально. Обновите значение отпечатка в узле **ModernPOSPackageCertificateThumbprint** в файле **BuildTools\\Customization.settings**.

Этот параметр будет работать, если пользователь сборки является локальным пользователем. Однако если вы используете агенты Azure DevOps для создания сборки, то у агента могут отсутствовать разрешения на доступ к хранилищу сертификатов для использования сертификата для подписания, или на компьютере сборки не будет установлен сертификат. В этом случае для решения проблемы необходимо изменить пользователя сборки на локального пользователя и установить сертификат в поле. Однако этот параметр не будет работать, если у пользователя нет административного доступ к полю.

> [!NOTE]
> Если для подписи приложения используется PFX-файл или параметр задачи защитного файла, оставьте узел **ModernPOSPackageCertificateThumbprint** в **Customization.settings** пустым. Если используется параметр отпечатка, оставьте **ModernPOSPackageCertificateKeyFile** пустым. Если обновляются оба значения, то выполнение сборки завершится с ошибкой.

### <a name="certification-renewal"></a>Возобновление действия сертификата

### <a name="renew-a-certificate-from-trusted-ca"></a>Возобновление действия сертификата из доверенного ЦС

Чтобы выполнить процедуру возобновления действия сертификатов, обратитесь в свой центр сертификации (ЦС). Для доверенного сертификата никаких действий на стороне MPOS не требуется.

### <a name="renew-a-self-signed-certificate"></a>Возобновление действия самозаверяющего сертификата

Не используйте образец сертификата, доступный в Retail SDK, для производства. Она может использоваться только для целей разработки. Действие образца сертификата Contoso не может быть возобновлено, а образец сертификата, включенный в пакет Retail SDK версии 10.0.16 или более ранней, истечет 31 декабря 2020. Если этот сертификат или самозаверяющий сертификат использовался для подписания настроенного Modern POS, существует серьезная вероятность того, что Modern POS будет работать неправильно после этой даты.
 
### <a name="impact"></a>Влияние
 
Если это верно для вас, проблема, с которой вы столкнетесь, заключается в том, что установщик не сможет работать после 31 декабря 2020. В зависимости от используемых корпоративных ИТ-политик компании Modern POS может не работать. Крайне важно проверить это, изменив дату временно на будущую дату, чтобы определить влияние на организацию.
 
### <a name="steps-to-determine-the-issue"></a>Шаги по определению проблемы
 
1.  Используйте настройки Windows для изменения времени компьютерных часов на дату и время в 2021 году.
2.  Убедитесь, что Modern POS могут быть открыты, возможен вход в систему и выполнение проводки может быть завершено.
3.  Убедитесь, что установщиков дистанционного обслуживания Modern POS можно запустить. Если это так, что установка будет завершена успешно.
4.  Установите на часах Windows правильную дату и время.
 
Если все эти шаги можно выполнить без каких-либо ошибок, вы сможете работать с текущим сертификатом после 31 декабря 2020.  
 
### <a name="steps-going-forward"></a>Дальнейшие действия 

Настоятельно рекомендуется возобновить действие ранее использовавшегося сертификата. Настоятельно рекомендуется получить новый сертификат. Для этого необходимо выполнить одно из следующих действий:
 
- **Предпочтительный** — получите сертификат для подписи кода от доверенного центра сертификации.

- **Не предпочтительный** — создайте самозаверяющий сертификат для подписи кода для использования. Обычно это используется только для целей разработки в рамках домена и не рекомендуется использовать для производства. 

- **Доступно в качестве временного решения** — используйте сертификат для подписи кода Contoso, срок действия которого возобновлен. Обычно это используется для целей тестирования, поэтому не рекомендуется развертывать в производстве.
 
Затем создайте новый настроенный пакет Modern POS, который был подписан с помощью этого сертификата, полученного в результате одного из действий, описанных выше. В зависимости от сертификата, необходимо выполнить один из описанных ниже шагов.
 
- При использовании нового доверенного сертификата (или нового самозаверяющего сертификата) потребуется установить новый сертификат на каждое устройство. После этого необходимо взять недавно созданный пакет Modern POS (установщик), удалить существующее приложение, а затем переустановить новый пакет Modern POS. Вам потребуется выполнить активацию устройств Modern POS на каждом устройстве.

- При использовании обновленного сертификата Contoso потребуется установить новый сертификат на каждом устройстве и установить пакет Modern POS (установщик). Удаление не требуется, однако необходимо переустановить его на устройстве. Обратите внимание, что активация Modern POS не потребуется. Этот параметр является временным решением. Этот параметр следует использовать, только чтобы избежать повторной активации и устранить проблему перед получением нового доверенного сертификата.


[!INCLUDE[footer-include](../../includes/footer-banner.md)]
