---
title: Настройка CPOS для использования пользовательского приложения Azure AD
description: В этой статье объясняется, как настроить Cloud POS (CPOS) для использования пользовательского приложения Azure Active Directory (Azure AD).
author: boycez
ms.date: 11/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: josaw
ms.search.region: global
ms.author: boycez
ms.search.validFrom: 2017-06-20
ms.openlocfilehash: 5e4ff797410e1e94869cc37684e7622ec0d97842
ms.sourcegitcommit: 9e2e54ff7d15aa51e58309da3eb52366328e199d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2022
ms.locfileid: "9746269"
---
# <a name="configure-cpos-to-use-a-custom-azure-ad-app"></a>Настройка CPOS для использования пользовательского приложения Azure AD

[!include [banner](includes/banner.md)]

По умолчанию Cloud POS (CPOS) Microsoft Dynamics 365 Commerce указывает на зарегистрированное основное приложение Microsoft в Azure Active Directory (Azure AD). Таким образом, можно использовать CPOS без внесения каких-либо изменений в Azure AD. Однако может потребоваться указать, что ваш экземпляр CPOS является пользовательским приложением Azure AD, которым вы управляете. В этой статье объясняется, как настроить Cloud POS (CPOS) для использования пользовательского приложения Azure AD.

## <a name="set-up-a-custom-retail-server-app-in-azure-ad"></a>Настройка пользовательского приложения Retail Server в Azure AD

Чтобы создать и настроить пользовательское приложение Retail Server в Azure AD, выполните следующие действия.

1. Войдите в [Центр администрирования Azure Active Directory](https://aad.portal.azure.com), используя любую учетную запись пользователя Azure AD. У учетной записи пользователя нет прав администратора.
1. Выберите **Azure Active Directory**.
1. Выберите пункт **Регистрация приложений**, затем выберите пункт **Новая регистрация**, чтобы открыть диалоговое окно **Регистрация приложения**.
1. Задайте значения в следующих полях:

    - **Имя** — введите оригинальное имя приложения. Например, можно ввести имя **Пользовательский сервер розничной торговли**.
    - **Поддерживаемые типы учетных записей** — выберите параметр по умолчанию — **Учетные записи только в данном каталоге организации (только Microsoft, один клиент)**.
    - **URI перенаправления** — это поле является необязательным. Оставьте его пустым.
    - **Идентификатор дерева службы** — это поле является необязательным. Оставьте его пустым.
    
1. Выберите **Регистр**. Откроется страница настройки нового зарегистрированного приложения.
1. В разделе **Обзор \> Essentials** выберите пункт **Добавить URI идентификатора приложения**, а затем нажмите кнопку **Задать** рядом с полем **URI идентификатора приложения**. Запишите предлагаемое значение, а затем нажмите кнопку **Сохранить**, чтобы принять это значение. 
1. Выберите пункт **Добавить область**, затем заполните следующие поля:

    - **Имя области** — введите имя для области. Например, введите **Устаревшая.Полный.Доступ**.
    - **Кому разрешено согласие** — укажите, могут ли давать согласие и администраторы, и пользователи или только администраторы (с учетом политик безопасности вашей организации).
    - **Отображаемое имя согласия администратора** — введите отображаемое имя. Например, можно ввести имя **Доступ к серверу розничной торговли**.
    - **Описание согласия администратора** — введите описание. Например, можно ввести **Предоставляет доступ к API сервера розничной торговли**.

1. Выберите команду **Добавить область**, чтобы завершить процесс создания области.

## <a name="set-up-a-custom-cpos-app-in-azure-ad"></a>Настройка пользовательского приложения CPOS в Azure AD

> [!IMPORTANT]
> При обновлении существующего настраиваемого приложения CPOS Azure AD, которое было создано до Commerce версии 10.0.21, выполните шаги по [обновлению существующего пользовательского приложения CPOS Azure AD, созданного до Commerce версии 10.0.21](#upgrade-an-existing-custom-cpos-azure-ad-app-created-before-commerce-version-10021).

Чтобы создать и настроить пользовательское приложение CPOS в Azure AD, выполните следующие действия.

1. Войдите в [Центр администрирования Azure Active Directory](https://aad.portal.azure.com), используя любую учетную запись пользователя Azure AD. У учетной записи пользователя нет прав администратора.
1. Выберите **Azure Active Directory**.
1. Выберите пункт **Регистрация приложений**, затем выберите пункт **Новая регистрация**, чтобы открыть диалоговое окно **Регистрация приложения**.
1. Задайте значения в следующих полях:

    - **Имя** — введите имя для приложения. Например, введите **Пользовательский Cloud POS**.
    - **Поддерживаемые типы учетных записей** — выберите параметр по умолчанию — **Учетные записи только в данном каталоге организации (только Microsoft, один клиент)**.
    - **URI перенаправления** — выберите пункт **Одностраничное приложение (SPA)** в раскрывающемся списке, а затем введите URI своего CPOS.
    - **Идентификатор дерева службы** — это поле является необязательным. Оставьте его пустым.

1. Выберите **Регистр**. Откроется страница настройки нового зарегистрированного приложения.
1. В разделе **Манифест** установите для параметров **oauth2AllowIdTokenImplicitFlow** и **oauth2AllowImplicitFlow** значение **true**, а затем нажмите кнопку **Сохранить**.
1. В разделе **Конфигурация токенов** выполните следующие действия, чтобы добавить два утверждения.

    1. Выберите пункт **Добавить необязательное утверждение**. Установите для поля **Тип токена** значение **ИД**, а затем выберите утверждение **SID**. Выберите **Добавить**.
    1. Выберите пункт **Добавить необязательное утверждение**. Установите для поля **Тип токена** значение **Доступ**, а затем выберите утверждение **SID**. Выберите **Добавить**.

1. В разделе **Разрешения API** выберите пункт **Добавить разрешение**.
1. На вкладке **Интерфейсы API, используемые моей организацией** выполните поиск приложения Retail Server, созданного в разделе [Настройка пользовательского приложения Retail Server в Azure AD](#set-up-a-custom-retail-server-app-in-azure-ad). Затем выберите пункт **Добавить разрешения**.
1. В разделе **Обзор** запишите значение в поле **Идентификатор приложения (клиент)**.

### <a name="upgrade-an-existing-custom-cpos-azure-ad-app-created-before-commerce-version-10021"></a>Обновление существующего настраиваемого приложения CPOS Azure AD, созданного до Commerce версии 10.0.21

Чтобы обновить существующее настраиваемое приложение CPOS Azure AD, созданное до Commerce версии 10.0.21, выполните следующие шаги. 

1. Откройте пользовательское приложение CPOS Azure AD на портале Azure.
1. Выберите вкладку **Аутентификация**.
1. Скопируйте и сохраните исходный URI-адрес перенаправления из типа **Веб** для использования в дальнейшем, затем удалите его.
1. Выберите **Добавить платформу**, затем выберите **Одностраничное приложение (SPA)**.
1. Добавьте исходный URI-адрес перенаправления веб, скопированный выше, в платформу SPA.
1. В разделе **Конфигурация токенов** выполните следующие действия, чтобы добавить два утверждения.
    1. Выберите пункт **Добавить необязательное утверждение**. Установите для поля **Тип токена** значение **ИД**, а затем выберите утверждение **SID**. Выберите **Добавить**.
    1. Выберите пункт **Добавить необязательное утверждение**. Установите для поля **Тип токена** значение **Доступ**, а затем выберите утверждение **SID**. Выберите **Добавить**.

## <a name="update-the-cpos-configuration-file"></a>Обновление файла конфигурации CPOS

Откройте файл config.json соответствующего CPOS и выполните в нем указанные ниже обновления.

1. Замените значение ключа **AADClientId** значением **Идентификатор приложения (клиент)** для пользовательского приложения CPOS, созданного в разделе [Настройка пользовательского приложения CPOS в Azure AD](#set-up-a-custom-cpos-app-in-azure-ad).
1. Замените значение ключа **AADRetailServerResourceId** значением **URI идентификатора приложения** для пользовательского приложения CPOS, созданного в разделе [Настройка пользовательского приложения Retail Server в Azure AD](#set-up-a-custom-retail-server-app-in-azure-ad).

CPOS будет использовать оба параметра при отправке запросов в Azure AD на получение токена безопасности.

## <a name="update-identity-providers-settings-in-commerce-headquarters"></a>Обновление настроек поставщиков удостоверений в Commerce headquarters

Далее необходимо обновить настройки поставщиков удостоверений в Commerce headquarters.

1. В Commerce headquarters откройте страницу **Общие параметры Commerce**.
1. На вкладке **Поставщики удостоверений** в разделе **Поставщики удостоверений** выберите строку, в которой для поля **Тип** установлено значение **Azure Active Directory**, а поле **Издатель** указывает на вашего клиента Azure AD. Этот параметр объявляет, что вы будете работать с дочерними сетками, содержащими данные, относящиеся к поставщику удостоверений, который соответствует вашему клиенту Azure AD.
1. В разделе **Проверяющие стороны** выберите команду **Добавить**, чтобы добавить строку.
1. Задайте значения в следующих полях:

    - **ClientId** — введите значение **Код клиента приложения** пользовательского приложения CPOS, созданного в разделе [Настройка пользовательского приложения CPOS в Azure AD](#set-up-a-custom-cpos-app-in-azure-ad).
    - **Тип** — выберите **Общий**.
    - **UserType** — выберите **Работник**.

1. Выберите только что добавленную строку. В разделе **Коды ресурсов сервера** под разделом **Проверяющие стороны** отображаются идентификаторы приложений Retail Server, к которым может получать доступ приложение, выбранное вами в сетке **Проверяющие стороны**.
1. В разделе **Коды ресурсов сервера** выберите команду **Добавить**, чтобы добавить строку.
1. В поле **Код серверного ресурса** введите значение **URI идентификатора приложения** пользовательского приложения CPOS, созданного в разделе [Настройка пользовательского приложения Retail Server в Azure AD](#set-up-a-custom-retail-server-app-in-azure-ad).

    > [!IMPORTANT]
    > Все поля, упоминаемые в предыдущих действиях, учитывают регистр. Введенные значения должны точно соответствовать значениям, настроенным в Центре администрирования Azure AD.

1. Перейдите в раздел **ИТ розничной торговли и коммерции \> График распределения** и выполните задание **1110** (**Глобальная конфигурация**).

Теперь можно активировать устройства CPOS, используя ваше собственное приложение Azure AD.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Активация POS-устройства](dev-itpro/retail-device-activation.md)

[Управление учетными записями активации и проверка устройств](set-up-activation-accounts-validate-devices-hq.md)

[!INCLUDE[footer-include](../includes/footer-banner.md)]
