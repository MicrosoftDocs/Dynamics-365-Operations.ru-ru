---
title: Настройка форматов электронной отчетности для использования параметров, указанных для юридического лица
description: В этой статье объясняется, как можно настроить форматы электронной отчетности (ER) для использования параметров, которые указаны для юридического лица.
author: NickSelin
ms.date: 04/02/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ERSolutionTable, EROperationDesigner, ERLookupDesigner, ERComponentLookupStructureEditing
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: 2019-01-01
ms.dyn365.ops.version: Release 8.1.3
ms.openlocfilehash: eb44422c4cdcc87989cdfb28dcd7d5cfea9002eb
ms.sourcegitcommit: 52b7225350daa29b1263d8e29c54ac9e20bcca70
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/03/2022
ms.locfileid: "8858838"
---
# <a name="configure-er-formats-to-use-parameters-that-are-specified-per-legal-entity"></a>Настройка форматов ER для использования параметров, указанных для юридического лица

[!include[banner](../includes/banner.md)]

## <a name="overview"></a>Обзор

Во многих форматах электронной отчетности (ER), которые будут создаваться, необходимо фильтровать данные с помощью набора значений, которые относятся к каждому юридическому лицу вашего экземпляра (например, набору налоговых кодов для фильтрации проводок по налогу). В настоящее время, когда фильтрация этого типа настроена в формате ER, значения, зависящие от юридического лица (например, налоговые коды), используются в выражениях в формате ER для указания правил фильтрации данных. Таким образом, используется формат ER для компании, а для создания необходимых отчетов необходимо создать производные копии оригинального формата ER для каждого юридического лица, для которого нужен формат ER. Каждый производный формат ER должен быть изменен для того, чтобы передать в него значения, зависящие от юридического лица, изменяя основу при обновлении исходной (базовой) версии, которая экспортируется из тестовой среды и импортируется в производственную среду, когда она должна быть развернута для практического использования и т. д. Таким образом, обслуживание этого типа настроенного решения ER является сложным и требует много времени по нескольким причинам:

-   Чем больше юридических лиц, тем большее количество конфигураций формата ER необходимо поддерживать.
-   Для поддержки конфигураций ER требуется, чтобы у бизнес-пользователей были сведения об ER.

Параметры, зависящие от приложения ER, позволяют опытным пользователям настраивать фильтрацию данных в формате ER, чтобы они основывались на наборе абстрактных правил. Этот набор правил может быть настроен таким образом, чтобы использовать источники данных, доступные в формате ER. Бизнес-пользователи могут затем указать реальные правила за пределами среды ER, используя пользовательский интерфейс, который автоматически создается на основе настроек соответствующего формата ER и текущих данных юридического лица, к которым будут иметь доступ источники данных в формате ER. Набор правил, указанный для формата ER, может быть экспортирован из текущего юридического лица экземпляра Dynamics 365 Finance (Finance). Затем он может быть импортирован в другое юридическое лицо того же или другого экземпляра в качестве набора правил для того же формата ER.

## <a name="prerequisites"></a>Необходимые условия

Чтобы выполнить примеры в этой статье, необходимо иметь доступ к экземпляру служб Regulatory Configuration Services (RCS), который был подготовлен для того же клиента, что и Finance, для одной из следующих ролей:

- Разработчик электронной отчетности
- Консультант по функциональным возможностям электронной отчетности
- Системный администратор

Рекомендуется выполнить шаги, указанные в статье [Поддержка параметризованных вызовов источников данных электронной отчетности для типа ВЫЧИСЛЯЕМОЕ ПОЛЕ](er-calculated-field-type.md). После выполнения этих шагов можно пропустить шаги в разделе **Импорт конфигураций ER в RCS**.

## <a name="import-er-configurations-into-rcs"></a>Импорт конфигураций ER в RCS

Загрузите и локально сохраните следующие конфигурации электронной отчетности.

| **Описание содержания**                        | **Имя файла**                                        |
|------------------------------------------------|------------------------------------------------------|
| Пример файла конфигурации **Модель данных ER**    | [Model to learn parameterized calls.version.1.xml](https://download.microsoft.com/download/2/d/b/2db913a0-3622-494e-91a2-97fc494af9b9/Modeltolearnparameterizedcalls.version.1.xml)     |
| Пример файла конфигурации **Метаданные ER**      | [Metadata to learn parameterized calls.version.1.xml](https://download.microsoft.com/download/1/b/3/1b343968-5a47-4000-b5a8-6487698ef4c0/Metadatatolearnparameterizedcalls.version.1.xml)  |
| Пример файла конфигурации **Сопоставления модели ER** | [Mapping to learn parameterized calls.version.1.1.xml](https://download.microsoft.com/download/8/6/6/866e0ab6-2e05-4d98-9d52-d2da2038f6e4/Mappingtolearnparameterizedcalls.version.1.1.xml) |
| Пример конфигурации **Формат ER**             | [Format to learn parameterized calls.version.1.1.xml](https://download.microsoft.com/download/e/3/9/e392eadc-b9b4-4834-95c3-b8066dd00b9c/Formattolearnparameterizedcalls.version.1.1.xml)  |

Затем войдите в экземпляр RCS.

В этом примере вам предстоит создать конфигурацию для компании-образца Litware, Inc. Перед выполнением этой процедуры необходимо выполнить шаги в статье [Создание поставщика конфигурации и пометка его как активного](tasks/er-configuration-provider-mark-it-active-2016-11.md) в RCS.

1.  В панели мониторинга по умолчанию выберите **Электронная отчетность**.
2.  Выберите **Конфигурации отчетности**.
3.  Импортируйте конфигурации ER, загруженные ранее в RCS, в следующей последовательности: модель данных, метаданные, сопоставление модели и формат. Для каждой конфигурации ER выполните следующие действия.

    1.  Выберите **Обменять**.
    2.  Выберите **Загрузить из XML-файла**.
    3.  Выберите **Обзор**, чтобы выбрать файл для требуемой конфигурации ER в формате XML.
    4.  Нажмите **ОК**.

## <a name="review-the-er-solution-that-is-provided"></a>Предварительный просмотр предоставленного решения ER

1.  В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2.  Выберите элемент **Формат для изучения параметризованных вызовов**.
3.  Выберите **Конструктор**.
4.  Выберите **Развернуть/Свернуть**.

    Формат ER **Формат для изучения параметризованных вызовов** предназначен для создания налоговой выписки в формате XML, представляющей несколько уровней налогообложения (обычный, сокращенный и отсутствует). На каждом уровне разное число деталей.

    ![Несколько уровней формата электронной отчетности, Формат для изучения параметризованных вызовов.](./media/RCS-AppSpecParms-ReviewFormat.PNG)

5.  На вкладке **Сопоставление** раскройте элементы **Модель**, **Данные** и **Сводка**.

    В качестве источника данных **Model.Data.Summary** возвращается список налоговых проводок. Такие проводки упорядочиваются по налоговому коду. Для этого источника данных вычисляемое поле **Model.Data.Summary.Level** настроено для возврата кода уровня налогообложения для каждой записи сводки. Для любого кода налога, получаемого из источника данных **Model.Data.Summary** во время выполнения, вычисляемое поле возвращает код уровня налогообложения (**обычный**, **пониженный**, **отсутствует** или **другой**) в виде текстового значения. Вычисляемое поле **Model.Data.Summary.Level** используется для фильтрации записей источника данных **Model.Data.Summary** и ввода отфильтрованных данных в каждый элемент XML, представляющий уровень налогообложения, с помощью полей **Model.Data2.Level1**, **Model.Data2.Level2** и **Model.Data2.Level3**.

    ![Источник данных Model.Data.Summary содержит список налоговых проводок.](./media/RCS-AppSpecParms-ReviewFormat-Data2Fld.PNG)

    Вычисляемое поле **Model.Data.Summary.Level** было настроено, чтобы оно содержало выражение ER. Налоговые коды (**VAT19**, **InVAT19**, **VAT7**, **InVAT7**, **THIRD** и **InVAT0**) жестко запрограммированы в этой конфигурации. Поэтому этот формат ER зависит от юридических лиц, в которых настроены эти налоговые коды.

    ![Вычисляемое поле Model.Data.Summary.Level с налоговыми кодами, запрограммированными в коде.](./media/RCS-AppSpecParms-ReviewFormat-LevelFld.PNG)

    Для поддержки различных наборов налоговых кодов для каждого юридического лица необходимо выполнить следующие действия:

    - Создайте производную версию формата ER для каждого юридического лица.
    - Обновите налоговые коды в вычисляемом поле **Model.Data.Summary.Level** на основе параметра юридического лица.

6.  Закройте страницу **Конструктор форматов**.

## <a name="create-a-derived-format"></a>Создание производного формата

Затем будут использованы параметры, зависящие от приложения ER, для поддержки различных наборов налоговых кодов для каждого юридического лица в одном формате ER.

1.  В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2.  Выберите элемент **Формат для изучения параметризованных вызовов**.
3.  Выберите **Создать конфигурацию**.
4.  Выберите **Производное от имени: формат для изучения параметризованных вызовов, Microsoft**.
5.  В поле **Имя** введите **Формат для изучения поиска данных LE**.
6.  Выберите **Создать конфигурацию**.

## <a name="configure-a-derived-format"></a>Настройка производного формата

### <a name="add-a-format-enumeration"></a>Добавление перечисления форматов

Далее необходимо добавить новое перечисление формата ER. Значения этого перечисления форматов будут представлены для бизнес-пользователей, которые будут определять зависимые от компании наборы налоговых кодов для различных уровней налогообложения, используемых в формате ER.

1.  Выберите **Конструктор**.
2.  Выберите **Перечисление форматов**.
3.  Выберите **Добавить**.
4.  В поле **Имя** введите **Список уровней налогообложения**.
5.  Нажмите **Сохранить**.
6.  На вкладке **Значения перечисления форматов** выберите **Добавить**.
7.  В поле **Имя** введите **Обычное налогообложение**.
8.  Снова выберите **Добавить**.
9.  В поле **Имя** введите **Сокращенное налогообложение**.
10. Снова выберите **Добавить**.
11. В поле **Имя** введите **Нет налогообложения**.
12. Снова выберите **Добавить**.
13. В поле **Имя** введите **Другое**.

    ![Новая запись на странице перечислений форматов.](./media/RCS-AppSpecParms-ConfigureFormat-Enum.PNG)

    Так как бизнес-пользователи могут использовать другие языки для указания зависящих от компании наборов налоговых кодов, рекомендуется перевести значения этого перечисления в языки, настроенные в качестве предпочтительных языков для пользователей в Finance.

14. Выберите запись **Нет налогообложения**.
15. Щелкните поле **Метка**.
16. Выберите **Перевести**.
17. В области **Перевод текста** в поле **Код метки** введите **LBL_LEVELENUM_NO**.
18. В поле **Текст на языке по умолчанию** введите **Нет налогообложения**.
19. В поле **Язык** выберите **DE**.
20. В поле **Переведенный текст** введите **keine Besteuerung**.
21. Выберите **Перевести**.

    ![Раскрывающийся список перевода текста.](./media/RCS-AppSpecParms-ConfigureFormat-EnumTranslate.PNG)

22. Нажмите **Сохранить**.
23. Закройте страницу **Перечисления форматов**.

### <a name="add-a-new-lookup-data-source"></a>Добавление нового источника данных поиска

Далее необходимо добавить новый источник данных, чтобы указать, как бизнес-пользователи будут задавать правила, зависящие от компании, чтобы определить правильный уровень налогообложения для каждой суммарной записи проводки.

1.  На вкладке **Сопоставление** выберите **Добавить**.
2.  Выберите **Перечисление/поиск форматов**.

    Только что было определено, что каждое правило, указанное бизнес-пользователями для распознавания на уровне налогообложения, возвратит значение перечисления формата ER. Обратите внимание на то, что тип источника данных **Поиск** может быть доступен в **модели данных** и блоках **Dynamics 365 for Operations** в дополнение к блоку **Перечисление форматов**. Таким образом, перечисления модели данных ER и перечисления приложений могут использоваться для указания типа значений, которые возвращаются для источников данных этого типа. Дополнительные сведения об источниках данных **поиска** см. в [Настройка источников данных поиска для использования функции параметров для приложения электронной отчетности](er-lookup-data-sources.md).
    
3.  В поле **Имя** введите **Выбор**.
4.  В поле **Перечисление форматов** выберите **Список уровней налогообложения**.

    Вы указали, что для каждого правила, указанного в этом источнике данных, бизнес-пользователь должен выбрать одно из значений перечисления форматов **Список уровней налогообложения** в качестве возвращенного значения.
    
5.  Выберите **Изменить поиск**.
6.  Выберите **Столбцы**.
7.  Разверните элемент **Model**.
8.  Разверните элемент **Данные**.
9.  Разверните элемент **Налог**.
10. Выберите элемент **Model.Data.Tax.Code**.
11. Нажмите кнопку **Добавить** (стрелка вправо).

    ![Раскрывающийся список столбцов.](./media/RCS-AppSpecParms-ConfigureFormat-Lookup1.PNG)

    Вы только что указали, что для каждого правила, указанного в этом источнике данных для распознавания уровня налогообложения, бизнес-пользователь должен выбрать один из кодов налога в качестве условия. Список налоговых кодов, которые может выбрать пользователь, будет возвращен в источнике данных **Model.Data.Tax**. Поскольку этот источник данных содержит поле **Имя**, имя налогового кода будет отображаться для каждого значения налогового кода в поиске, представляемом для бизнес-пользователя.
    
12. Нажмите **ОК**.

    ![Страница конструктора подстановок.](./media/RCS-AppSpecParms-ConfigureFormat-Lookup2.PNG)

    Бизнес-пользователи могут добавить несколько правил в виде записей этого источника данных. Каждая запись будет пронумерована с помощью кода строки. Правила будут оценены в порядке возрастания номера строки.

    Так как в качестве условия для правил в источнике данных поиска выбрано поле **Налоговый код**, и поскольку **Налоговый код** задан как поле типа данных **Строка**, каждое правило будет оцениваться во время выполнения путем сравнения налогового кода, который передается в источник данных, с налоговым кодом, который указан в этой записи источника данных.

    При обнаружении правила, удовлетворяющего настроенному условию, этот источник данных возвращает значение поиска для правила, которое определено в поле **Результат поиска**. Если правило не найдено, выдается исключение, уведомляющее пользователя о том, что текущий источник данных не может вернуть правильное значение.

13. Нажмите **Сохранить**.
14. Закройте страницу **Конструктор поиска**.
15. Нажмите **ОК**.

    Обратите внимание, что был добавлен новый источник данных, который будет возвращать уровень налогообложения в виде значения перечисления форматоров **Список уровней налогообложения** для любого налогового кода, который передается в источник данных в качестве аргумента параметра **Код** с типом данных **Строка**.
    
    ![Страница конструктора форматов с новым источником данных.](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFld.PNG)

    Оценка настроенных правил зависит от типа данных полей, которые были выбраны для определения условий этих правил. При выборе поля, настроенного в качестве поля типа **Числовой** или **Данные**, критерии будут отличаться от критериев, описанных выше, для типа данных **Строка**. Для полей **Числовой** и **Данные** правило должно быть определено как диапазон значений. Затем условие правила будет считаться удовлетворенным, когда значение, передаваемое в источник данных, попадает в настроенный диапазон.
    
    На следующем рисунке приведен пример этого типа настройки. В дополнение к полю **Model.Data.Tax.Code** типа данных **Строка** поле **Model.Tax.Summary.Base** типа данных **Вещественный** используется для определения условий для источника данных поиска.
    
    ![Страница конструктора подстановок с дополнительными столбцами.](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFld2.PNG)

    Так как для этого источника данных поиска выбраны поля **Model.Data.Tax.Code** и **Model.Tax.Summary.Base**, каждое правило этого источника данных будет настроено следующим образом:
    
    -   В представленном списке значение перечисления форматов **Список уровней налогообложения** должно быть выбрано как возвращаемое значение.
    -   Налоговый код должен быть введен как условие этого правила. Применимы только налоговые коды, предоставляемые в источнике данных **Model.Data.Tax**.
    -   Минимальное и максимальное значения базовой суммы налога должны вводиться в качестве условий этого правила.

    Ниже показано, как каждое правило этого источника данных будет оцениваться во время выполнения:
    -   Совпадает ли код типа данных **Строка**, переданного в этот источник данных, с кодом налога правила?
    -   Попадает ли значение типа данных **Вещественный**, переданное в этот источник данных, в интервал между указанными минимальным и максимальным значениями?

    Правило будет учитываться как применимое, если удовлетворяются оба условия.

### <a name="translate-the-label-of-the-lookup-data-source-that-was-added"></a>Перевод метки добавленного источника данных поиска

Так как бизнес-пользователи могут использовать другие языки для указания зависящих от компании наборов налоговых кодов, рекомендуется перевести этикетку добавляемого источника данных поиска, чтобы она отображалась на предпочитаемом языке пользователя на соответствующей странице.

1.  Выберите источник данных **Model.Data.Selector**.
2.  Выберите **Правка**.
3.  Щелкните поле **Метка**.
4.  Выберите **Перевести**.
5.  В области **Перевод текста** в поле **Код метки** введите **LBL_SELECTOR_DS**.
6.  В поле **Текст на языке по умолчанию** введите **Выбрать уровень налогообложения по коду налога**.
7.  В поле **Язык** выберите **DE**.
8.  В поле **Переведенный текст** введите **Steuerebene für Steuerkennzeichen auswählen**.
9.  Выберите **Перевести**.
10. Нажмите **ОК**.

    ![Раскрывающийся список свойств источника данных.](./media/RCS-AppSpecParms-ConfigureFormat-SelectorFldTranslate.PNG)

### <a name="add-a-new-field-to-consume-the-configured-lookup"></a>Добавление нового поля для использования настроенного поиска

1.  Разверните элемент **Model.Data**.
2.  Выберите элемент **Model.Data.Summary**.
3.  Выберите **Добавить**.
4.  Выберите **Функции/Вычисляемое поле**.
5.  В поле **Имя** введите **LevelByLookup**.
6.  Выберите **Изменить формулу**.
7.  В поле **Формула** введите **Model.Selector(Model.Data.Summary.Code)**.
8.  Нажмите **Сохранить**.

    ![Добавление Model.Selector(Model.Data.Summary.Code) на страницу конструктора формул.](./media/RCS-AppSpecParms-ConfigureFormat-AddLevelByLookupFld.PNG)

9.  Закройте страницу **Редактор формул**.
10. Нажмите **ОК**.

    ![Страница конструктора форматов с добавленной новой формулой.](./media/RCS-AppSpecParms-ConfigureFormat-AddLevelByLookupFld2.PNG)

    Обратите внимание, что добавленное вычисляемое поле **LevelByLookup** будет возвращать уровень налогообложения как значение перечисления форматов **Список уровней налогообложения** для каждой сводной записи налоговых проводок. Налоговый код записи будет передан в источник данных поиска **Model.Selector**, и набор правил для этого источника данных будет использоваться для выбора правильного уровня налогообложения.

### <a name="add-a-new-format-enumeration-based-data-source"></a>Добавление нового источника данных на основе перечисления форматов

Далее будет добавлен новый источник данных, относящийся к перечислению форматов, добавленному ранее. Значения этого источника данных будут использоваться в выражении формата ER позднее.

1.  Выберите **Добавить корень**.
2.  Выберите **Перечисление форматов/перечисление**.
3.  В поле **Имя** введите **TaxationLevel**.
4.  В поле **Перечисление форматов** выберите **Список уровней налогообложения**.
5.  Нажмите **Сохранить**.

### <a name="modify-an-existing-field-to-start-to-use-the-lookup"></a>Измените существующее поле, чтобы начать использовать поиск

Далее будет изменено существующее вычисляемое поле, чтобы оно использовало настроенный источник данных поиска для возврата значения налогообложения в зависимости от налогового кода.

1.  Выберите элемент **Model.Data.Summary.Level**.
2.  Выберите **Правка**.
3.  Выберите **Изменить формулу**.

    Обратите внимание, что текущее выражение поля **Model.Data.Summary.Level** включает следующие жестко запрограммированные налоговые коды:
    
    CASE (@.Code, "VAT19", "Обычный", "InVAT19", "Обычный", "VAT7", "Сокращенный", "InVAT7", "Сокращенный", "THIRD", "Нет", "InVAT0", "Нет", "Другой")

4.  В поле **Формула** введите **CASE(@.LevelByLookup, TaxationLevel.'Regular taxation', "Regular", TaxationLevel.'Reduced taxation', "Reduced", TaxationLevel.'No taxation', "None", "Other")**.

    ![Страница конструктора операций ER.](./media/RCS-AppSpecParms-ConfigureFormat-ChangeLookupFld.PNG)
    
    Обратите внимание, что выражение в поле **Model.Data.Summary.Level** теперь возвращает уровень налогообложения на основе налогового кода текущей записи и набора правил, которые бизнес-пользователь настраивает в источнике данных поиска **Model.Data.Selector**.
    
5.  Нажмите **Сохранить**.
6.  Закройте страницу **Конструктор формул**.
7.  Нажмите **ОК**.
8.  Нажмите **Сохранить**.
9.  Закройте страницу **Конструктор форматов**.

## <a name="complete-the-draft-version-of-a-derived-format"></a>Завершение черновой версии производного формата

1.  На экспресс-вкладке **Версии** выберите **Изменить статус**.
2.  Выберите **Завершено**.
3.  Нажмите **ОК**.

## <a name="export-completed-version-of-modified-format"></a>Экспорт завершенной версии измененного формата

1.  В дереве конфигурации выберите элемент **Формат для изучения поиска данных LE**.
2.  На экспресс-вкладке **Версии** выберите запись со статусом **Завершено**.
3.  Выберите **Обменять**.
4.  Выберите **Экспорт в виде XML-файла**.
5.  Нажмите **ОК**.
6.  Веб-браузер загружает файл **Format to learn how to look up LE data.xml**. Сохраните этот файл локально.

Повторите шаги в этом разделе для родительских элементов формата **Формат для изучения поиска данных LE** и сохраните следующие файлы локально:

-   Формат для изучения параметризованных вызовов.xml
-   Сопоставление для изучения параметризованных вызовов.xml
-   Модели для изучения параметризованных вызовов.xml

Чтобы узнать, как использовать настроенный формат ER **Формат для изучения поиска данных LE** для настройки наборов налоговых кодов, зависящих от юридического лица, для фильтрации налоговых проводок по разным уровням налогообложения, выполните шаги в статье [Настройка параметров формата электронной отчетности для юридического лица](er-app-specific-parameters-set-up.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

[Конструктор формул в электронной отчетности](general-electronic-reporting-formula-designer.md)

[Настройка параметров формата электронной отчетности для юридического лица](er-app-specific-parameters-set-up.md)

[Настройка источников данных поиска для использования функции параметров для приложения электронной отчетности](er-lookup-data-sources.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
