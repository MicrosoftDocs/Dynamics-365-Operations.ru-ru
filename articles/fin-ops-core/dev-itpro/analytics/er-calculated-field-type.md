---
title: Поддержка параметризованных вызовов источников данных электронной отчетности для типа вычисляемого поля
description: В этом разделе приводятся сведения об использовании типов вычисляемых полей для источников данных электронной отчетности.
author: NickSelin
manager: AnnBe
ms.date: 08/06/2020
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: ''
ms.dyn365.ops.version: 10.0.5
ms.openlocfilehash: 3f21b323ddbf653bf8ca8dd1f879a6bdbddcdefc
ms.sourcegitcommit: 659375c4cc7f5524cbf91cf6160f6a410960ac16
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2020
ms.locfileid: "4681264"
---
# <a name="support-parameterized-calls-of-er-data-sources-of-the-calculated-field-type"></a>Поддержка параметризованных вызовов источников данных электронной отчетности для типа вычисляемого поля

[!include [banner](../includes/banner.md)]

В этой теме объясняется, как создать источник данных для электронной отчетности (ER) с помощью типа **Вычисляемое поле**. Этот источник данных может содержать выражение электронной отчетности, которое при исполнении может управляться значениями аргументов параметров, которые настроены в привязке, вызывающей этот источник данных. Настраивая параметризованные вызовы такого источника данных, можно повторно использовать один источник данных во многих привязках, что позволяет сократить общее число источников данных, которые должны быть настроены в сопоставлениях модели ER или в форматах ER. Это также упрощает настроенный компонент ER, что снижает затраты на обслуживание и затраты на их использование другими потребителями.

## <a name="prerequisites"></a>Необходимые условия
Чтобы завершить примеры из этой темы необходимы следующие возможности доступа:

- Доступ к одной из следующих ролей:

    - Разработчик электронной отчетности
    - Консультант по функциональным возможностям электронной отчетности
    - Системный администратор

- Доступ к службам Regulatory Configuration Services (RCS), которые были настроены для того же клиента, что и Finance and Operations, для одной из следующих ролей:

    - Разработчик электронной отчетности
    - Консультант по функциональным возможностям электронной отчетности
    - Системный администратор

Кроме того, необходимо загрузить следующие файлы и сохранить их локально.

| **Содержание**                           | **Имя файла**                                        |
|---------------------------------------|------------------------------------------------------|
| Пример конфигурации модели данных электронной отчетности    | [Model to learn parameterized calls.version.1.xml](https://mbs.microsoft.com/customersource/global/AX/downloads/hot-fixes/365optelecrepeg)     |
| Пример конфигурации метаданных электронной отчетности      | [Metadata to learn parameterized calls.version.1.xml](https://mbs.microsoft.com/customersource/global/AX/downloads/hot-fixes/365optelecrepeg)  |
| Пример конфигурации сопоставления модели электронной отчетности | [Mapping to learn parameterized calls.version.1.1.xml](https://mbs.microsoft.com/customersource/global/AX/downloads/hot-fixes/365optelecrepeg) |
| Пример конфигурации формата электронной отчетности        | [Format to learn parameterized calls.version.1.1.xml](https://mbs.microsoft.com/customersource/global/AX/downloads/hot-fixes/365optelecrepeg)  |

## <a name="sign-in-to-your-rcs-instance"></a>Вход в экземпляр RCS
В этой примере вам предстоит создать конфигурацию для демонстрационной компании Litware, Inc. Сначала в RCS необходимо выполнить шаги в процедуре [Создание поставщиков конфигураций и пометка их как активных](tasks/er-configuration-provider-mark-it-active-2016-11.md).

1. В панели мониторинга по умолчанию выберите **Электронная отчетность**.
2. Выберите **Конфигурации отчетности**.
3. Импортируйте загруженные конфигурации в RCS в следующей последовательности: модель данных, метаданные, сопоставление модели, формат. Выполните следующие шаги для каждой конфигурации ER:

    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Выберите **Обзор**, затем выберите требуемую конфигурацию ER в формате XML.
    4. Выберите **ОК**.

## <a name="review-the-provided-er-solution"></a>Предварительный просмотр предоставленного решения ER

### <a name="review-model-mapping"></a>Предварительный просмотр сопоставления модели

1. В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2. Выберите **Сопоставление для изучения параметризованных вызовов**.
3. Выберите **Конструктор**.
4. Выберите **Конструктор**.  
   
    Это сопоставление модели ER предназначено для выполнения следующих действий:

    - Извлечение списка налоговых кодов (источник данных **Tax**), расположенных в таблице **TaxTable**.
    - Извлечение списка налоговых проводок (источник данных **Trans**), расположенных в таблице **TaxTrans**:
    
        - Группировка списка извлеченных проводок (источник данных **Gr**) по налоговому коду.
        - Расчет для сгруппированных проводок следующих агрегированных значений для налогового кода:

            - Сумма значений налоговой базы.
            - Сумма значений налога.
            - Минимальное значение примененной налоговой ставки.

    Сопоставление модели в этой конфигурации реализует базовую модель данных для любого из форматов ER, созданных для этой модели и выполняемых в Finance and Operations. В результате содержимое источников данных **Tax** и **Gr** предоставляется для форматов ER, таких как абстрактные источники данных.

    ![Страница конструктора сопоставления модели, на которой отображаются источники данных Tax и Gr](media/er-calculated-field-type-01.png)

5.  Закройте страницу **Конструктор сопоставления модели**.
6.  Закройте страницу **Сопоставление модели**.

### <a name="review-format"></a>Предварительный просмотр формата

1. В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2. Выберите **Формат для изучения параметризованных вызовов**.
3. Выберите **Конструктор**. Этот формат ER предназначен для выполнения следующих действий:

    - Создание налоговой декларации в формате XML.
    - Представление следующих уровней налогообложения в налоговой декларации: обычный, уменьшенный и нет.
    - Представление нескольких сведений на каждом уровне налогообложения, имеющем различное количество сведений на каждом уровне.

    ![Страница конструктора форматов](media/er-calculated-field-type-02.png)

4. Выберите **Сопоставление**.
5. Разверните элементы **Модель**, **Данные** и **Сводка**. 

    Вычисляемое поле **Model.Data.Summary.Level** содержит выражение, которое возвращает код уровня налогообложения (**Обычный**, **Пониженный**, **Нет** или **Другой**) в виде текстового значения для любого налогового кода, которое может быть извлечено из источника данных **Model.Data.Summary** во время выполнения.

    ![Страница конструктора форматов, в которой показаны подробные сведения о модели данных для изучения параметризованных вызовов](media/er-calculated-field-type-03.png)

6. Разверните элемент **Model**.**Data2**.
7. Разверните элемент **Model**.**Data2.Summary2**.
   
    Источник данных **Model**.**Data2.Summary2** настроен для группирования сведений проводок источника данных **Model.Data.Summary** по уровню налогообложения (возвращается вычисляемым полем **Model.Data.Summary.Level**) и вычисления агрегированных значений.

    ![Страница конструктора форматов, в которой показаны подробные сведения об источнике данных Model.Data2.Summary2](media/er-calculated-field-type-04.png)

8. Просмотрите вычисляемые поля **Model**.**Data2.Level1**, **Model**.**Data2.Level2** и **Model**.**Data2.Level3.** Эти вычисляемые поля используются для фильтрации списка записей **Model**.**Data2.Summary2** и возврата только тех записей, которые представляют конкретный уровень налогообложения.
9. Закройте страницу **Конструктор форматов**.

## <a name="create-a-derived-format"></a>Создание производного формата
Можно улучшить предоставленный формат, добавив одно вычисляемое поле для фильтрации необходимого уровня налогообложения вместо использования существующих трех полей: **Model**.**Data2.Level1**, **Model**.**Data2.Level2** и **Model**.**Data2.Level3**. Требуемый уровень налогообложения можно указать в месте, где будет вызвано это новое вычисляемое поле.

1. В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2. Выберите **Формат для изучения параметризованных вызовов**.
3. Выберите **Создать конфигурацию**.
4. Выберите **Производное от имени: формат для изучения параметризованных вызовов, Microsoft**.
5. В поле **Имя** введите **Формат для изучения параметризованных вызовов (настраиваемый)**.
6. Выберите **Создать конфигурацию**.

## <a name="configure-a-parameterized-calculated-field-that-returns-a-list-of-records"></a>Настройка параметризованного вычисляемого поля, которое возвращает список записей

### <a name="start-adding-a-new-calculated-field"></a>Начало добавления нового вычисляемого поля

1. Выберите **Конструктор**.
2. Чтобы развернуть все элементы форматирования, выберите **Развернуть/свернуть**/
3. Выберите **Сопоставление**.
4. Разверните элемент **Model**.
5. Выберите элемент **Model.Data2**.
6. Выберите **Добавить**.
7. Выберите **Функции\\Вычисляемое поле**.
8. В поле **Имя** введите **Уровни**.
9. Выберите **Изменить формулу**.

### <a name="define-a-parameter-for-adding-a-calculated-field"></a>Определение параметра для добавления вычисляемого поля

1. Выберите **Параметры**.
2. Выберите **Создать**.
3. В поле **Имя** введите **Уровень налогообложения**.
4. В поле **Тип** выберите **String**.

    Для указания типа аргумента параметра могут использоваться только примитивные типы данных. Таким образом, для этой цели нельзя использовать типы **Список записей**, **Запись** и **Перечисление**.

    Максимальное число параметров, которые могут быть указаны для одного вычисляемого поля, равно 8.

    ![Список источников данных параметров](media/er-calculated-field-type-05.png)

5. Нажмите **ОК**.

При добавлении этого параметра указывается условие, которое должно выполняться для вызова этого вычисляемого поля. При вызове этого вычисляемого поля необходимо указать аргумент параметра **Уровень налогообложения** как значение в формате **String**.

   Убедитесь, что параметры определены только для тех вычисляемых полей, которые находятся в контейнере (**Список записей**, **Запись** или **Контейнер**).

   Настроенный параметр доступен в списке источников данных для этого вычисляемого поля. Можно добавить параметр в настроенное выражение, выбрав **Добавить источник данных**.

   ![Поле источника данных](media/er-calculated-field-type-06.png)

### <a name="define-an-expression-for-adding-a-calculated-field"></a>Определение выражения для добавления вычисляемого поля

1. В поле **Формула** введите: 

    **WHERE(\@.Summary2, \@.Summary2.grouped.Level =**
    
2. Выберите параметр **Уровень налогообложения** в списке источников данных.
3. Выберите **Добавить источник данных**.
4. В поле **Формула** завершите выражение следующим образом:  

    **WHERE(\@.Summary2, \@.Summary2.grouped.Level = 'Уровень налогообложения')**

5. Нажмите **Сохранить**.

    ![Сведения о поле источника данных](media/er-calculated-field-type-07.png)

6. Закройте страницу **Конструктор формул**.

### <a name="finish-adding-a-new-calculated-field"></a>Завершение добавления нового вычисляемого поля

- Нажмите **ОК**.

На странице **Конструктор форматов** настроенное параметризованное вычисляемое поле **Уровни** требует наличия аргумента типа **String**.

![Развернутый список уровней вычисляемых полей](media/er-calculated-field-type-08.png)

### <a name="use-the-configured-calculated-field-for-binding-format-elements"></a>Использование настроенного вычисляемого поля для привязки элементов форматирования

1. Выберите **Model.Data2.Levels**, чтобы выбрать настроенное вычисляемое поле.
2. Выберите элемент форматирования **Statement.Taxation.Regular**.
3. Выберите **Связать**.
4. Выберите **Да**, чтобы подтвердить замену текущего источника данных, **Level1**, новым источником данных, **Levels**, во всех вложенных элементах форматирования выбранного элемента форматирования.

    Примененная привязка была создана в виде вызова параметризованного вычисляемого поля. По умолчанию имя связанного элемента форматирования используется в качестве аргумента для параметризованного вычисляемого поля при следующих условиях:

      - В вычисляемом поле настроено использование одного параметра.
      - Тип данных этого параметра определен как **String**.

    Если имя связанного элемента форматирования не заполнено, в применяемой привязке используется имя источника данных этого элемента.

5. Выберите элемент форматирования **Statement.Taxation.Reduced**.
6. Выберите **Связать**.
7. Выберите **Да**, чтобы подтвердить замену текущего источника данных, **Level2**, новым источником данных, **Levels**, во всех вложенных элементах форматирования в выбранном элементе форматирования.
8. Выберите элемент форматирования **Statement.Taxation.None**.
9. Выберите **Связать**.
10. Выберите **Да**, чтобы подтвердить замену текущего источника данных, **Level3**, новым источником данных, **Levels**, во всех вложенных элементах форматирования в выбранном элементе форматирования.

   При указании аргумента параметризованного вычисляемого поля для элемента XML, представляющего уровень налогообложения ( например, **Model.Data2.Levels("Пониженный")** как текстовое значение), нет необходимости выполнять те же действия для вложенных XML-атрибутов — их привязки автоматически наследуют значение аргумента, определенного на родительском уровне (**Model.Data2.Levels.aggregated.Base**, а не **Model.Data2.Levels("Пониженный").aggregated.Base**).

Рекуррентные вызовы любого параметризованного вычисляемого поля не поддерживаются.

Можно выбрать **Изменить формулу** и изменить применяемый по умолчанию аргумент параметризованного вычисляемого поля в выбранной привязке. Если этот аргумент отсутствует, он может вызвать ошибки во время выполнения — пользователи получают уведомление о такой ситуации, когда проверяется текущий формат.

![Уведомление о предупреждении проверки](media/er-calculated-field-type-10.png)

## <a name="configure-a-parameterized-calculated-field-to-return-a-record"></a>Настройка параметризованного вычисляемого поля для возвращения записи
Когда параметризованное вычисляемое поле возвращает запись, необходимо обеспечить привязку отдельных полей данной записи к элементам форматирования. В таких случаях родительская привязка, содержащая значение аргумента для вызова параметризованного вычисляемого поля, не будет представлена — это значение должно быть определено в привязке одного поля записи.

### <a name="start-adding-a-new-calculated-field"></a>Начало добавления нового вычисляемого поля

1. Выберите элемент **Model.Data2**.
2. Выберите **Добавить**.
3. Выберите **Функции\\Вычисляемое поле**.
4. В поле **Имя** введите **LevelRecord**.
5. Выберите **Изменить формулу**.

### <a name="define-a-parameter-for-adding-a-calculated-field"></a>Определение параметра для добавления вычисляемого поля

1. Выберите **Параметры**.
2. Выберите **Создать**.
3. В поле **Имя** введите **Уровень налогообложения**.
4. В поле **Тип** выберите **String**.
5. Нажмите **ОК**.

### <a name="define-an-expression-for-adding-a-calculated-field"></a>Определение выражения для добавления вычисляемого поля

1. В поле **Формула** введите следующее:  
    
    **FIRSTORNULL(\@.Levels(**

2. Выберите параметр **Уровень налогообложения**.
3. Выберите **Добавить источник данных**.
4. В поле **Формула** добавьте **'Уровень налогообложения'))** к тому, что было введено на шаге 1, чтобы завершить выражение следующим образом:  
    
    **FIRSTORNULL(\@.Levels('Уровень налогообложения'))**

5. Нажмите **Сохранить**.
6. Закройте страницу **Конструктор формул**.

### <a name="finish-adding-a-new-calculated-field"></a>Завершение добавления нового вычисляемого поля

-   Нажмите **ОК**.

### <a name="use-the-configured-calculated-field-to-bind-format-elements"></a>Использование настроенного вычисляемого поля для привязки элементов форматирования

1. Разверните **Model.Data2.LevelRecord**, чтобы выбрать настроенное вычисляемое поле.
2. Разверните контейнер **Model.Data2.LevelRecord.aggregated** настроенного вычисляемого поля.
3. Выберите поле **Model.Data2.LevelRecord.aggregated.Base**.
4. Выберите элемент форматирования **Statement.Taxation.None**.
5. Выберите **Отменить связь**.
6. Выберите элемент форматирования **Statement.Taxation.None.Base**.
7. Выберите **Связать**.
8. Выберите **Изменить формулу**.
9. Измените выражение на **Model.Data2.LevelRecord("Нет").aggregated.Base**.

![Обновленное выражение](media/er-calculated-field-type-11.png)

## <a name="remove-calculated-fields-that-are-not-used"></a>Удаление вычисляемых полей, которые не используются

1. Выберите **Model.Data2.Level1**.
2. Выберите **Удалить**.
3. Выберите **Model.Data2.Level2**.
4. Выберите **Удалить**.
5. Выберите **Model.Data2.Level3**.
6. Выберите **Удалить**.
7. Нажмите **Сохранить**.

  > [!NOTE]
  > Вы повторно использовали одно и то же вычисляемое поле **Model.Data2.Levels** несколько раз в привязках формата. Гораздо проще использовать и сопровождать одно вычисляемое поле вместо того, чтобы делать это для нескольких аналогичных полей.

8. Закройте страницу **Конструктор форматов**.

## <a name="complete-adjusted-version-of-a-derived-format"></a>Завершение измененной версии производного формата

1. На экспресс-вкладке **Версии** выберите **Изменить статус**.
2. Выберите **Завершено**.

## <a name="export-completed-version-of-a-derived-format"></a>Экспорт завершенной версии производного формата

1. Выберите формат **Формат для изучения параметризованных вызовов (настраиваемый)** в дереве конфигураций.
2. На экспресс-вкладке **Версии** выберите завершенную версию 1.1.1.
3. Выберите **Обменять**.
4. Выберите **Экспорт в виде XML-файла**.
5. Сохраните загруженную конфигурацию локально, в формате XML.

## <a name="test-er-formats"></a>Проверка форматов ER 
Можно выполнить исходный и улучшенный форматы электронной отчетности, чтобы убедиться, что настроенные параметризованные вычисляемые поля работают правильно.

### <a name="import-er-configurations"></a>Импорт конфигураций электронной отчетности
Можно импортировать проверенные конфигурации из RCS, используя репозиторий ER типа **RCS**. Если вы уже выполнили эти шаги в разделе [Импорт конфигураций электронной отчетности (ER) из служб нормативных конфигураций (RCS)](rcs-download-configurations.md), используйте настроенный репозиторий ER, чтобы импортировать конфигурации, описанные ранее в этом разделе, в вашу среду. В противном случае выполните следующие действия.

1. Выберите компанию **DEMF** и на панели мониторинга по умолчанию выберите **Электронная отчетность**.
2. Выберите **Конфигурации отчетности**.
3. Импортируйте конфигурации из центра загрузки Майкрософт в следующей последовательности: модель данных, сопоставление модели, формат. Выполните следующие шаги для каждой конфигурации ER:

    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Выберите **Обзор**, чтобы выбрать требуемую конфигурацию ER в формате XML.
    4. Нажмите **ОК**.

4. Импортируйте экспортированную из RCS завершенную версию 1.1.1 формата **Формат для изучения параметризованных вызовов (настраиваемый)**:

    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Выберите **Обзор**, чтобы выбрать локально сохраненный файл **Формат для изучения параметризованных вызовов (настраиваемый)** в формате XML.
    4. Нажмите **ОК**.

### <a name="run-er-formats"></a>Выполнение форматов ER

1. В дереве конфигурации разверните содержимое пункта **Модели для изучения параметризованных вызовов**.
2. Выберите **Формат для изучения параметризованных вызовов**.
3. Выберите **Выполнить** на самой верхней ленте.
4. Сохраните локально созданные выходные данные.
5. Выберите элемент **Формат для изучения параметризованных вызовов (настраиваемый)**.
6. Выберите **Выполнить** на самой верхней ленте.
7. Сохраните созданные выходные данные локально. 
8. Сравните содержимое созданных выходных данных.

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Конструктор формул в электронной отчетности (ER)](general-electronic-reporting-formula-designer.md)
- [Повышение производительности решений электронной отчетности за счет добавления параметризованных источников данных ВЫЧИСЛЯЕМЫЕ ПОЛЯ](er-calculated-field-ds-performance.md)

