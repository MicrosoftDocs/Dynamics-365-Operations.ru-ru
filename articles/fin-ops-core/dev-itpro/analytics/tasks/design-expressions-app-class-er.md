---
title: Разработка выражений электронной отчетности для вызова методов классов приложений
description: В этой теме описывается повторное использование существующей логики в конфигурациях электронной отчетности путем вызова требуемых методов классов приложения.
author: NickSelin
ms.date: 11/02/2021
ms.topic: business-process
ms.prod: ''
ms.technology: ''
audience: Application User
ms.reviewer: kfend
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: 2016-06-30
ms.dyn365.ops.version: Version 7.0.0
ms.openlocfilehash: 81fae8d3603677afd7dd4b09b9073805f73582b4
ms.sourcegitcommit: e6b4844a71fbb9faa826852196197c65c5a0396f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2021
ms.locfileid: "7751714"
---
# <a name="design-er-expressions-to-call-application-class-methods"></a>Разработка выражений электронной отчетности для вызова методов классов приложений

[!include [banner](../../includes/banner.md)]

В этой теме описывается повторное использование существующей логики приложения в конфигурациях [электронной отчетности (ER)](../general-electronic-reporting.md) путем вызова требуемых методов классов приложения в выражениях ER. Значения аргументов для вызывающих классов могут быть динамически определены во время выполнения. Например, значения могут быть основаны на данных в анализируемом документе для обеспечения их правильности.

Для примера в этой теме мы разработаем процесс, который анализирует входящие банковские выписки для обновления данных приложения. Входящие банковские выписки будут приходить в виде текстовых файлов (. txt), содержащих коды международного номера банковского счета (IBAN). В рамках процесса импорта банковских выписок необходимо проверить правильность кода IBAN с помощью логики, которая уже доступна.

## <a name="prerequisites"></a>Необходимые условия

Процедуры в этой теме предназначены для пользователей, которым назначена роль **Системный администратор** или **Разработчик электронной отчетности**.

Процедуры можно выполнить с использованием любого набора данных.

Чтобы выполнить их, необходимо загрузить и сохранить следующий файл: [SampleIncomingMessage.txt](https://download.microsoft.com/download/8/0/a/80adbc89-f23c-46d9-9241-e0f19125c04b/SampleIncomingMessage.txt).

В этой теме вам предстоит создать необходимые конфигурации ER для демонстрационной компании Litware, Inc. Поэтому перед окончанием выполнения процедур данной темы необходимо выполнить следующие шаги.

1. Перейдите в раздел **Управление организацией** \> **Рабочие области** \> **Электронная отчетность**.
2. На странице **Конфигурации локализации** убедитесь, что поставщик конфигурации для демонстрационной компании **Litware, Inc.** доступен и помечен как активный. Если вы не видите этого поставщика конфигурации, необходимо сначала выполнить шаги в процедуре [Создание поставщиков конфигурации и пометка их как активных](er-configuration-provider-mark-it-active-2016-11.md).

## <a name="import-a-new-er-model-configuration"></a>Импорт новой конфигурации модели ER

1. На странице **Конфигурации локализации** в разделе **Поставщики конфигурации** выберите плитку для поставщика конфигурации **Microsoft**.
2. Выберите **Репозитории**.
3. На странице **Репозитории локализации** выберите **Показать фильтры**.
4. Чтобы выбрать запись глобального репозитория, добавьте поле фильтра **Имя**.
5. В поле **Имя** введите **Глобальный**. Затем выберите оператор фильтра **содержит**.
6. Выберите **Применить**.
7. Выберите **[Открыть](../er-download-configurations-global-repo.md#open-configurations-repository)** для просмотра списка конфигураций электронной отчетности в выбранном репозитории.
8. На странице **Репозиторий конфигураций** в дереве конфигураций выберите **Модель платежа**.
9. Если на экспресс-вкладке **Версии** доступна кнопка **Импорт**, выберите ее, затем выберите **Да**.

    Если кнопка **Импорт** недоступна, вы уже импортировали версию выбранную версию конфигурации электронной отчетности **Модель платежа**.

10. Закройте страницу **Репозиторий конфигураций**, затем закройте страницу **Репозитории локализации**.

## <a name="add-a-new-er-format-configuration"></a>Добавление новой конфигурации формата электронной отчетности

Добавьте новый формат ER для анализа входящих банковских выписок в формате TXT.

1. На странице **Конфигурации локализации** выберите плитку **Конфигурации отчетности**.
2. На странице **Конфигурации** в дереве конфигураций на левой панели выберите **Модель платежа**.
3. Выберите **Создать конфигурацию**. 
4. В раскрывающемся диалоговом окне выполните следующие действия:

    1. В поле **Создать** введите **Формат, основанный на модели данных PaymentModel**.
    2. В поле **Имя** введите **Формат импорта банковской выписки (образец)**.
    3. В поле **Поддерживает импорт данных** выберите **Да**.
    4. Выберите **Создать конфигурацию**, чтобы завершить создание конфигурации.

## <a name="design-the-er-format-configuration--format"></a>Разработка конфигурации формата ER — формат

Разработайте формат электронной отчетности, который представляет ожидаемую структуру внешнего файла в формате TXT.

1. Для добавленной конфигурации формата **Формат импорта банковской выписок (образец)** выберите **Конструктор**.
2. На странице **Конструктор форматов** в дереве структуры формата в левой области выберите **Добавить корень**.
3. В появившемся диалоговом окне выполните следующие действия:

    1. В дереве выберите **Текст\\Последовательность**, чтобы добавить компонент формата **Последовательность**.
    2. В поле **Имя** введите **Корень**.
    3. В поле **Специальные знаки** выберите **Новая строка — Windows (CR LF)**. На основании этого параметра каждая строка в анализируемом файле будет рассматриваться как отдельная запись.
    4. Нажмите **ОК**.

4. Выберите **Добавить**.
5. В появившемся диалоговом окне выполните следующие действия:

    1. В дереве выберите **Текст\\Последовательность**.
    2. В поле **Имя** введите **Строки**.
    3. В поле **Кратность** выберите **Один — много**. На основании этого параметра ожидается, что по крайней мере одна строка будет представлена в файле анализа.
    4. Нажмите **ОК**.

6. В дереве выберите **Корень\\Строки**, затем выберите **Добавить последовательность**.
7. В появившемся диалоговом окне выполните следующие действия:

    1. В поле **Имя** введите **Поля**.
    2. В поле **Кратность** выберите **Ровно один**.
    3. Нажмите **ОК**.

8. В дереве выберите **Корень\\Строки\\Поля**, затем выберите **Добавить**.
9. В появившемся диалоговом окне выполните следующие действия:

    1. В дереве выберите **Текст\\Строка**.
    2. В поле **Имя** введите **IBAN**.
    3.. Нажмите **ОК**.

10. Нажмите **Сохранить**.

Конфигурация теперь настроена так, что каждая строка в файле анализа содержит только код IBAN.

![Конфигурация формата «Формат импорта банковской выписок (образец)» на странице конструктора форматов.](../media/design-expressions-app-class-er-01.png)

## <a name="design-the-er-format-configuration--mapping-to-a-data-model"></a>Разработка конфигурации формата ER — сопоставление с моделью данных

Разработайте сопоставление формата электронной отчетности, использующего информацию из файла анализа для заполнения модели данных.

1. На странице **Конструктор форматов** в области действий выберите **Сопоставить формат модели**.
2. На странице **Сопоставление модели и источника данных** в области действий выберите **Создать**.
3. В поле **Определение** выберите **BankToCustomerDebitCreditNotificationInitiation**.
4. В поле **Имя** введите **Сопоставление с моделью данных**.
5. Нажмите **Сохранить**.
6. Выберите **Конструктор**.
7. На странице **Конструктор сопоставления модели** в дереве **Типы источников данных** выберите **Dynamics 365 for Operations\\Класс**.
8. В разделе **Источники данных** выберите **Добавить корень**, чтобы добавить источник данных, который будет вызывать существующую логику приложения для проверки кодов IBAN.
9. В появившемся диалоговом окне выполните следующие действия:

    1. В поле **Имя** введите **Check\_codes**.
    2. В поле **Класс** введите или выберите **ISO7064**.
    3. Нажмите **ОК**.

10. В дереве **Типы источников данных** выполните следующие действия:

    1. Разверните источник данных **формат**.
    2. Разверните **формат\\Корень: Последовательность(Корень)**.
    3. Разверните **формат\\Корень: Последовательность(корень)\\Строки: Последовательность 1..\* (Строки)**.
    4. Разверните **формат\\Корень: Последовательность(Корень)\\Строки: Последовательность 1..\* (Строки)\\Поля: Последовательность 1..1 (Поля)**.

11. В дереве **Модель данных** выполните следующие действия:

    1. Разверните поле **Платежи** модели данных.
    2. Разверните **Платежи\\Счет кредитора(CreditorAccount)**.
    3. Разверните **Платежи\\Счет кредитора(CreditorAccount)\\Идентификация**.
    4. Разверните **Платежи\\Счет кредитора(CreditorAccount)\\Идентификация\\IBAN**.

12. Выполните следующие действия, чтобы привязать компоненты настроенного формата к полям модели данных:

    1. Выберите **формат\\Корень: Последовательность(корень)\\Строки: Последовательность 1..\* (Строки)**.
    2. Выберите **Платежи**.
    3. Выберите **Связать**. На основании этого параметра каждая строка в анализируемом файле будет рассматриваться как один платеж.
    4. Выберите **формат\\Корень: Последовательность(корень)\\Строки: последовательность 1..\* (строки)\\Поля: последовательность 1..1 (поля)\\IBAN: строка(IBAN)**.
    5. Выберите **Платежи\\Счет кредитора(CreditorAccount)\\Идентификация\\IBAN**.
    6. Выберите **Связать**. На основе этого параметра поле **IBAN** модели данных будет заполнено значением из файла синтаксического анализа.

    ![Привязка компонентов формата к полям модели данных на странице конструктор сопоставления моделей.](../media/design-expressions-app-class-er-02.png)

13. На вкладке **Проверки** выполните следующие шаги, чтобы добавить правило [проверки](../general-electronic-reporting-formula-designer.md#Validation), которое отображает сообщение об ошибке для любой строки в файле анализа, которая содержит недопустимый код IBAN:

    1. Выберите **Создать**, затем выберите **Изменить условие**.
    2. На странице **Конструктор формул** в дереве **Источник данных** разверните источник данных **Check\_codes**, который представляет класс приложения **ISO7064**, чтобы просмотреть доступные методы данного класса.
    3. Выберите **Check\_codes\\verifyMOD1271\_36**.
    4. Выберите **Добавить источник данных**.
    5. В поле **Формула** введите следующее [выражение](../general-electronic-reporting-formula-designer.md#Binding): **Check\_codes.verifyMOD1271\_36(format.Root.Rows.Fields.IBAN)**.
    6. Выберите **Сохранить** и закройте страницу.
    7. Выберите **Изменить сообщение**.
    8. На странице **Конструктор формул** в поле **Формула** введите **CONCATENATE("Обнаружен недопустимый код IBAN:&nbsp;", format.Root.Rows.Fields.IBAN)**.
    9. Выберите **Сохранить** и закройте страницу.

    На основе этих параметров условие проверки будет возвращать значение *[FALSE](../er-formula-supported-data-types-primitive.md#boolean)* для любого недопустимого кода IBAN путем вызова существующего метода **verifyMOD1271\_36** класса приложения **ISO7064**. Обратите внимание, что значение кода IBAN определяется динамически во время выполнения в качестве аргумента вызывающего метода на основе содержимого анализируемого текстового файла.

    ![Правило проверки на странице конструктора сопоставления модели.](../media/design-expressions-app-class-er-03.png)

14. Нажмите **Сохранить**.
15. Закройте страницу **Конструктор сопоставления моделей** и закройте страницу **Сопоставление модели и источника данных**.

## <a name="run-the-format-mapping"></a>Выполнение сопоставления формата

В целях тестирования выполните сопоставление формата с помощью ранее загруженного файла SampleIncomingMessage.txt. Созданные выходные данные будут включать данные, импортированные из выбранного текстового файла и перенесенные в модель пользовательских данных при реальном импорте.

1. На странице **Сопоставление модели и источника данных** выберите **Выполнить**.
2. На странице **Параметры электронного отчета** выберите **Обзор**, найдите загруженный файл **SampleIncomingMessage.txt** и выберите его.
3. Нажмите **ОК**.
4. Обратите внимание на то, что страница **Сопоставление модели и источника данных** показывает сообщение об ошибке о недопустимом коде IBAN.

    ![Результат выполнения сопоставления формата на странице сопоставления модели с источником данных.](../media/design-expressions-app-class-er-04.png)

5. Просмотрите выходные данные в формате XML, представляющем данные, которые были импортированы из выбранного файла, а затем перенесены в модель данных. Обратите внимание, что только три строки импортированного текстового файла были обработаны без ошибок. Код IBAN в строке 4 недопустим и был пропущен.

    ![Выходные данные XML.](../media/design-expressions-app-class-er-05.png)

[!INCLUDE[footer-include](../../../../includes/footer-banner.md)]
