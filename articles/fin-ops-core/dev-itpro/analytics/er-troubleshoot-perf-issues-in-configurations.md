---
title: Устранение проблем с производительностью в конфигурациях электронной отчетности
description: В этой статье объясняется, как найти и исправить проблемы с производительностью в конфигурациях электронной отчетности (ER).
author: NickSelin
ms.date: 05/12/2022
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ERModelMappingDesigner, EROperationDesigner, ERFormatMappingRunJobTable, ERParameters, ERSolutionTable
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: 220314
ms.assetid: ''
ms.search.region: Global
ms.author: maximbel
ms.search.validFrom: 2021-04-01
ms.dyn365.ops.version: 10.0.1
ms.openlocfilehash: 28ff68309bad7a6c1b6009ba03ef4b20aceb5194
ms.sourcegitcommit: 52b7225350daa29b1263d8e29c54ac9e20bcca70
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/03/2022
ms.locfileid: "8847350"
---
# <a name="troubleshooting-performance-issues-in-er-configurations"></a>Устранение проблем с производительностью в конфигурациях электронной отчетности

В этой статье объясняется, как найти и разрешить проблемы с производительностью в [конфигурациях](general-electronic-reporting.md#Configuration) [электронной отчетности](general-electronic-reporting.md) (ER).

Как правило, исследование производительности состоит из нескольких этапов.

1. [Соберите](#collecting-data) данные.
2. Проанализируйте собранные данные.
3. На основе результатов анализа используйте конфигурации электронной отчетности для [внесения изменений](#making-changes) или для принятия решения о сборе дополнительных данных.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="analyze-execution-time"></a>Анализ времени выполнения

Время выполнения может зависеть от непредсказуемых факторов, таких как другие задачи, выполняемые в той же среде, и кэширование, в котором используются данные при их первом вызове. Поэтому следует повторить выполнение и измерение несколько раз.

Иногда проблемы с производительностью не вызваны конфигурацией формата электронной отчетности, который используется для отчетности. Вместо этого они вызваны кодом X++, который используется для открытия этой конфигурации формата электронной отчетности.

1. В [центре действий](#infolog-time) или в [журнале событий](#event-log-time) посмотрите на время выполнения отчета.
2. Сравните время выполнения отчета с общим временем выполнения в сценарии.
3. Если время выполнения отчета намного меньше общего времени выполнения, рассмотрим объем данных, которые обрабатывает отчет:

    - Если отчет обрабатывает небольшой объем данных, проблема может быть связана со временем загрузки конфигурации.
    - Если отчет обрабатывает большой объем данных, проблема может быть связана с предварительной обработкой X++. Для анализа этого случая используйте [синтаксический анализатор трассировки](#analyze-trace-parser-trace).

    В других случаях смотрите следующие разделы.

4. Запустите несколько тестов, которые включают различные объемы данных, чтобы определить, как время выполнения зависит от объема данных.

### <a name="analyze-trace-parser-traces"></a><a name="analyze-trace-parser-trace"></a>Анализ трассировок синтаксического анализатора трассировки

Подготовьте небольшой пример или соберите несколько трассировок во время случайных частей генерации отчета.

Затем в [синтаксическом анализаторе трассировки](#trace-parser) сделайте стандартный анализ «снизу вверх» и ответьте на следующие вопросы:

- Какие методы потребляют больше всего времени?
- Какую часть общего времени используют эти методы?

Ответьте на те же вопросы для запросов.

Если вы видите, что методы имеют префикс "ER", перейти к следующему разделу.

Если вы видите, что методы или запросы возникли в наборе приложений, рассмотрите общие способы оптимизации (например, создайте индексы).

Проанализируйте количество вызовов. Если число значительно выше ожидаемого, рассмотрите кэширование соответствующих узлов конфигурации.

### <a name="analyze-database-calls"></a><a name="analyze-database-calls"></a>Анализ вызовов базы данных

Подготовь пример, который имеет небольшой объем данных, так что вы можете собрать [трассировку электронной отчетности](#electronic-reporting-traces).

Затем откройте трассировку в конструкторе сопоставления модели электронной отчетности и посмотрите на нижней части страницы. Ответьте на следующие вопросы:

- Есть ли дублирование запросов? Если есть, рассмотрите одно из следующих исправлений:

    - [Используйте кэширование](#use-caching), если вы считаете, что внутри одной родительской записи есть несколько вызовов.
    - [Используйте кэшированное, параметризированное вычисляемое поле](#cached-parameterized), если вы считаете, что внутри разных записей есть вызовы к одной и той же записи.
    - [Используйте источник данных **JOIN**](#use-join-datasource), если вам нужно считать значительное количество различных записей из базы данных.

- Соответствует ли количество запросов и полученных записей общему объему данных? Например, если документ содержит 10 строк, показывает ли статистика, что в отчет извлекает ровно 10 строк или 1000 строк? Если у вас есть значительное количество извлеченных записей, рассмотрите одно из следующих исправлений:

    - [Используйте функцию **FILTER** вместо функции **WHERE**](#filter) для обработки данных на стороне сервера Microsoft SQL Server.
    - Используйте кэширование, чтобы избежать извлечения одних и тех же данных.
    - [Используйте функции собранных данных](#collected-data), чтобы избежать извлечения одних и тех же данных для суммирования.

### <a name="analyze-perfview-traces"></a>Анализ трассировок PerfView

[PerfView](#perfview) является инструментом для опытных разработчиков. Подробнее о следующих шагах см. в разделе [Основы исследования общего времени](https://channel9.msdn.com/Series/PerfView-Tutorial/Tutorial-12-Wall-Clock-Time-Investigation-Basics).

1. Соберите трассировку с помощью времени потока.
2. Включите только стеки, которые используют **runUnattended**, чтобы фильтровать только поток, который имеет выполнение конфигурации. (Добавьте **runUnattended** в поле ввода **IncPats**.)
3. Сложите все время процессора, время сети и заблокированное время.
4. Загрузите [предустановки электронной отчетности для PerfView](https://download.microsoft.com/download/2/d/0/2d037b0f-ffd1-4d65-b64f-fcdf51f2c81f/ER_PerfViewPresets.xml).
5. Выберите **Электронная отчетность** \> **Другая предустановка**.
6. Посмотрите на имена:

    - Вы, вероятно, увидите код платформы, который потребляет больше всего времени.
    - Вы можете дважды нажать (или дважды щелкнуть) и перейти вверх через **вызывающих**.

        Если вы нашли классы с префиксом "ERExpression", и если они являются функциями, связанными с формулами, вы можете угадать имя функции на основе имени класса и посмотреть в репозитории электронной отчетности для просмотра атрибутов.

### <a name="fixes"></a>Исправления

- Если вы видите, что большая часть времени процессора потребляется запросами, постарайтесь уменьшить количество запросов:

    - [Просмотрите трассировку электронной отчетности](#analyze-database-calls) на предмет дублирования запросов.
    - Посмотрите, сколько записей извлечено, и оцените, сколько данных теоретически должно быть извлечено.

- Если вы видите, что большая часть времени процессора потребляется функциями, которые используются, попробуйте найти место в конфигурации, которое потребляет больше всего ресурсов.
- Если вы видите, что большая часть времени процессора потребляется функциями сбора данных, подумайте о замене их на команды *SQL группировать по* на стороне сопоставления модели.

### <a name="collecting-data"></a><a name="collecting-data"></a>Сбор данных

В зависимости от среды существует несколько способов сбора доступных данных:

- Получите общее время работы:

    - Из центра уведомлений
    - Из журнала событий

- Профилирование исполнения:

    - С помощью инструментов электронной отчетности
    - С помощью синтаксического анализатора трассировки
    - С помощью PerfView

#### <a name="collecting-data-in-a-production-environment"></a>Сбор данных в производственной среде

Иногда проблемы могут воспроизводиться только в производственной среде. Данные можно собирать следующими способами:

- С помощью трассировок [синтаксического анализатора трассировки](../perf-test/trace-trace-tutorial.md)
- С помощью трассировок [выполнения электронной отчетности](trace-execution-er-troubleshoot-perf.md)
- С помощью общего времени выполнения

#### <a name="collecting-data-in-a-development-environment"></a>Сбор данных в среде разработки

В дополнение к инструментам, которые могут быть использованы в производственной среде, есть несколько инструментов, которые можно использовать в среде разработки:

- Журнал событий (Microsoft-Dynamics-ElectronicReporting). Этот журнал может дать вам общее время выполнения.
- Общие инструменты .NET, такие как PerfView.

Кроме того, среда разработки дает больше гибкости для экспериментов. Например, можно отключить части отчетов, чтобы увидеть, как это влияет на время выполнения.

### <a name="tools"></a><a name="tools"></a>Сервис

#### <a name="execution-time-in-the-action-center"></a><a name="infolog-time"></a>Время выполнения в центре уведомлений

Электронная отчетность может показать время выполнения конфигурации в центре уведомлений. Этот параметр применяется только к конкретному пользователю и конкретной компании и только к интерактивным сеансам. Чтобы сделать эту функцию доступной, выполните следующие действия.

1. Перейдите в раздел **Администрирование организации** \> **Электронная отчетность** \> **Конфигурации**.
2. На странице **Конфигурации** в области действий на вкладке **Конфигурации** в группе **Дополнительные параметры** выберите **Параметры пользователя**.
3. В диалоговом окне **Параметры пользователя** установите для параметра **Показать время создания файла** значение **Да**.

#### <a name="execution-time-in-the-event-log"></a><a name="event-log-time"></a>Время выполнения в журнале событий

1. Откройте средство просмотра событий Windows.
2. В пункте **Журналы приложений и служб** откройте **Microsoft-Dynamics-ElectronicReporting/Operational**.
3. Найдите события **FormatMapingRun**, в которых **EventID=2**, поскольку эти события содержат информацию о прошедшем времени.

#### <a name="trace-parser-traces"></a><a name="trace-parser"></a>Трассировки синтаксического анализатора трассировки 

Поскольку электронная отчетность реализована на X++, для анализа производительности можно использовать обычные инструменты X++. Дополнительные сведения см. в разделе [Получение трассировок с помощью синтаксического анализатора трассировки](../perf-test/trace-trace-tutorial.md).

При этом подходе есть несколько ограничений. Поскольку часть электронной отчетности реализована на C#, будут доступны не все данные. Однако можно просмотреть сведения об использовании данных. Кроме того, выполнения длинных отчетов могут превысить ограничения для хранения трассировки.

#### <a name="er-traces"></a><a name="electronic-reporting-traces"></a>Трассировки электронной отчетности

Электронная отчетность может собирать свои собственные трассировки, и она содержит средства визуализации и анализа для этих трассировок. Дополнительные сведения см. в разделе [Трассировка выполнения форматов электронной отчетности для устранения неполадок, связанных с производительностью](trace-execution-er-troubleshoot-perf.md).

#### <a name="perfview"></a><a name="perfview"></a>PerfView

Поскольку X++ и электронная отчетность реализованы на платформе .NET, можно использовать общие инструменты .NET. Например, можно использовать бесплатное средство [PerfView](https://github.com/Microsoft/perfview).

Кроме того, можно собирать данные из командной строки. Например, следующий сценарий Windows PowerShell собирает время выполнения до тех пор, пока любое выполнение формата на компьютере не будет остановлено.

```powershell
c:\programs\PerfView collect "e:\traces\$(date -format "ddMMyyyy_hhmm").etl" `
    -CircularMB:20000 -ThreadTime `
    -NoNGenRundown `
    -StopOnEtwEvent:Microsoft-Dynamics-ElectronicReporting/FormatMappingRun/Stop
```

При этом подходе есть несколько ограничений. Вы должны иметь административный доступ к компьютеру. Кроме того, вы должны быть опытным разработчиком, так как здесь требуется интенсивное обучение.

### <a name="making-changes"></a><a name="making-changes"></a>Внесение изменений

#### <a name="use-caching"></a><a name="use-caching"></a>Использование кэширования

Хотя кэширование позволяет сократить время, необходимое для повторной выборки данных, кэш занимает память. Кэширование используется в случаях, когда объем загружаемых данных не слишком велик. Дополнительные сведения и пример, показывающий порядок использования кэширования, см. в разделе [Улучшение сопоставления модели на основе сведений, содержащихся в трассировке выполнения](trace-execution-er-troubleshoot-perf.md#improve-the-model-mapping-based-on-information-from-the-execution-trace).

#### <a name="reduce-volume-of-data-fetched"></a><a name="reduce-fetched-data"></a>Уменьшение объема получаемых данных

Можно уменьшить потребление памяти для кэширования, ограничив число полей в записях таблицы приложения, получаемых во время выполнения. В этом случае будут получены только те значения полей таблицы приложения, которые необходимы для сопоставления модели ER. Другие поля в этой таблице не будут получены. Таким образом уменьшается объем памяти, необходимый для кэширования выбранных записей. Для получения дополнительной информации см. раздел [Повышение производительности решений электронной отчетности путем уменьшения количества полей таблицы, выбираемых во время выполнения](er-reduce-fetched-fields-number.md).

#### <a name="use-a-cached-parameterized-calculated-field"></a><a name="cached-parameterized"></a>Использование кэшированного параметризованного вычисляемого поля

Иногда значения следует искать многократно. Примерами являются наименования счетов и номера счетов. Чтобы помочь экономить время, можно создать вычисляемое поле, имеющее параметры на верхнем уровне, а затем добавить поле в кэш.

Этот подход рекомендуется использовать только в том случае, если размер кэшированных данных мал. Дополнительные сведения см. в разделе [Повышение производительности решений электронной отчетности путем добавления параметризованных источников ВЫЧИСЛЯЕМОЕ ПОЛЕ](er-calculated-field-ds-performance.md).

#### <a name="use-a-join-data-source"></a><a name="use-join-datasource"></a>Использование источника данных JOIN

Источник данных **JOIN** позволяет выбирать несколько подключенных записей в одном запросе. Отдельный запрос не требуется использовать для получения каждой связанной записи. Например, если имеется 1000 строк, и при этом извлекаются данные номенклатур для каждой строки по отношению, у вас будет 1001 запрос (= 1000 + 1). При использовании источника данных **JOIN** для получения тех же данных будет использоваться только один запрос. Дополнительные сведения см. в разделе [Использование источников данных JOIN в сопоставлениях моделей электронной отчетности для извлечения данных из нескольких таблиц приложений](er-join-data-sources.md).

#### <a name="use-the-filter-function-instead-of-the-where-function"></a><a name="filter"></a>Использование функции FILTER вместо функции WHERE

Функция **[FILTER](er-functions-list-filter.md)** выполняет условия на SQL Server, в то время как функция **WHERE** выбирает все данные из списка, по одной записи за раз, и применяет условие для каждой записи. Например, необходимо выделить одну запись из 1000 записей. При использовании **WHERE** будут извлечены все из 1000 записей. Однако если используется функция **FILTER**, будет извлечена только одна запись. Функция **FILTER** также может использовать индексы на стороне базы данных.

#### <a name="using-collected-data-functions-or-an-accumulated-data-data-source"></a><a name="collected-data"></a>Использование функций собранных данных или источника данных накопленных данных

Если в конфигурации имеется компонент *группировать по*, который суммирует ранее извлеченные данные по отчетам, этот компонент будет снова извлекать все данные. Используя функции собранных данных, можно позволить электронной отчетности накапливать данные во время первой выборки. Дополнительные сведения см. в разделе [Электронная отчетность — настройка формата для инвентаризации и суммирования](tasks/er-format-counting-summing-2.md).

#### <a name="rewrite-parts-of-the-configuration-in-x"></a>Переопределение частей конфигурации в X++

Электронная отчетность поддерживает вызовы методов таблиц и классов, в том числе и расширений. Рекомендуется переписать части сопоставления модели в X++, чтобы повысить производительность.

Электронная отчетность может получать данные из следующих источников:

- Классы (источники данных **объект** и **класс**)
- Таблицы (источники данных **таблица** и **записи таблицы**)

[API-интерфейс электронной отчетности](er-apis-app73.md#how-to-access-internal-x-objects-by-using-erobjectsfactory) также предоставляет способ отправки предварительно рассчитанных данных из вызывающего кода. В набор приложений входят многочисленные примеры такого подхода.
