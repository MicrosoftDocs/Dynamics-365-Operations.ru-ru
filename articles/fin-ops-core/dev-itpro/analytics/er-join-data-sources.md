---
title: Использование источников данных JOIN в модели ER для извлечения данных из нескольких таблиц приложений
description: В этом разделе объясняется использование источников данных JOIN в электронной отчетности (ER).
author: NickSelin
ms.date: 04/26/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ERModelMappingDesigner, EROperationDesigner
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: 2019-03-01
ms.dyn365.ops.version: Release 10.0.1
ms.openlocfilehash: 5b4899cad01a0ed2424dcc5d29e9fb5cca65a6a9
ms.sourcegitcommit: c08a9d19eed1df03f32442ddb65a2adf1473d3b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2021
ms.locfileid: "6351105"
---
# <a name="use-join-data-sources-to-get-data-from-multiple-application-tables-in-electronic-reporting-er-model-mappings"></a>Использование источников данных JOIN в сопоставлениях модели электронной отчетности (ER) для извлечения данных из нескольких таблиц приложений

[!include[banner](../includes/banner.md)]

При настройке сопоставления или форматов модели электронной отчетности (ER) можно [добавить](#review) необходимые источники данных типа **соединение**. Во время разработки источник данных **соединение** настраивается как набор из нескольких источников данных, каждый из которых возвращает список записей. Для каждого источника данных за исключением первого необходимо определить необходимые условия для присоединения записей к текущим и предыдущим источникам данных. Во время выполнения настроенный источник данных типа **соединение** [возвращает](#executeERformat) отдельный объединенный список записей, содержащий поля из записей вложенных источников данных.

В настоящее время поддерживаются следующие типы соединений:

- Внешнее (левое) соединение:
    - Присоедините все записи к первому (крайнему левому) источнику данных, а затем любое сопоставление в соответствии с настроенными условиями для второго (крайнего правого) источника данных.
- Внутреннее (правое) соединение:
    - Присоедините только записи первого (крайнего левого) источника данных, и только записи второго (крайнего правого) источника данных, соответствующие друг другу в соответствии с настроенными условиями.

В настроенном источнике данных **соединение**, когда все источники данных являются типами **табличных записей**, выполнение источника данных соединения можно [выполнить на уровне базы данных](#analyze), используя один оператор SQL. Это утверждение сокращает число вызовов к базе данных, что повышает производительность сопоставления моделей. В противном случае в памяти будет выполнен источник **данных соединения**.

> [!NOTE]
> Использование функции **VALUEIN** в выражениях ER, определяющих условия объединения записей в источниках данных типа соединения, еще не поддерживается. Посетите страницу [Конструктор формул в электронной отчетности](general-electronic-reporting-formula-designer.md) для получения дополнительных сведений об этой функции.

Чтобы получить дополнительные сведения об этой функции, выполните пример в этой теме.

## <a name="example-use-join-data-sources-in-er-model-mappings"></a>Пример: использование источников данных JOIN в сопоставлениях модели ER

Следующие шаги описывают, как системный администратор или разработчик электронной отчетности может настроить сопоставление модели электронной отчетности (ER) для получения данных из нескольких таблиц приложений одновременно, используя источники данных типа **соединения** для повышения производительности доступа к данным. Эти шаги могут быть выполнены для любой компании Dynamics 365 Finance или в службах Regulatory Configuration Service (RCS).

### <a name="prerequisites"></a>Необходимые условия

Чтобы выполнить примеры в этом разделе, необходимо иметь доступ к одной из следующих возможностей в зависимости от того, какая служба используется для конкурирующих шагов:

**Доступ к Finance для одной из следующих ролей:**

- Разработчик электронной отчетности
- Консультант по функциональным возможностям электронной отчетности
- Системный администратор

**Доступ к службам RCS для одной из следующих ролей:**

- Разработчик электронной отчетности
- Консультант по функциональным возможностям электронной отчетности
- Системный администратор

Также необходимо сначала выполнить шаги в процедуре [Создание поставщика конфигурации и установка его в качестве активного](tasks/er-configuration-provider-mark-it-active-2016-11.md).

Предварительно необходимо загрузить и сохранить следующие примеры файлов конфигурации ER:

| **Описание содержания**  | **Имя файла**   |
|--------------------------|-----------------|
| Образец файла конфигурации **модели данных ER**, который используется как источник данных для примеров.| [Model to learn JOIN data sources.version.1.1.xml](https://download.microsoft.com/download/5/c/1/5c1d8a57-6ebd-425b-bc5d-c71dde92c6af/ModeltolearnJOINdatasources.version.1.xml) |
| Образец файла конфигурации **сопоставления модели ER**, который реализует модель данных ER для примеров. | [Mapping to learn JOIN data sources.version.1.1.xml](https://download.microsoft.com/download/9/2/f/92f339ca-41fc-4f5e-b458-6983c957d3dd/MappingtolearnJOINdatasources.version.1.1.xml)|
| Образец файла конфигурации **формата электронной отчетности**. Этот файл описывает данные, которыми требуется заполнить компонент формата электронной отчетности для примеров. | [Format to learn JOIN data sources.version.1.1.xml](https://download.microsoft.com/download/f/f/8/ff8f1b48-14d0-4c73-9145-bcdf8b5265bc/FormattolearnJOINdatasources.version.1.1.xml) |

### <a name="activate-a-configurations-provider"></a>Активация поставщика конфигураций

1. Получите доступ к финансам или RCS в первой сессии вашего веб-браузера.
2. Перейдите в раздел **Управление организацией \> Рабочие области \> Электронная отчетность**.
3. На странице **Конфигурации локализации** в разделе **Поставщики конфигурации** убедитесь, что поставщик конфигурации для демонстрационной компании [Litware, Inc.](http://www.litware.com) указан в списке и помечен как **Активный**. Если вы не видите этого поставщика конфигурации, выполните шаги в процедуре [Создание поставщика конфигурации и пометка его как активного](tasks/er-configuration-provider-mark-it-active-2016-11.md).

    ![Рабочая область электронной отчетности.](./media/GER-JoinDS-ActiveProvider.PNG)

### <a name="import-sample-er-configuration-files"></a>Импорт образца файлов конфигурации электронной отчетности

1. Выберите **Конфигурации отчетности**.
2. Импортируйте файл конфигурации модели данных электронной отчетности.
    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Нажмите **обзор**, чтобы найти файл **Model to learn JOIN data sources.version.1.1.xml**.
    4. Нажмите **ОК**.
3. Импортируйте файл конфигурации сопоставления модели электронной отчетности.
    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Нажмите **обзор**, чтобы найти файл **Mapping to learn JOIN data sources.version.1.1.xml**.
    4. Нажмите **ОК**.
4. Импорт файла конфигурации формата электронной отчетности.
    1. Выберите **Обменять**.
    2. Выберите **Загрузить из XML-файла**.
    3. Нажмите **обзор**, чтобы найти файл **Format to learn JOIN data sources.version.1.1.xml**.
    4. Нажмите **ОК**.
5. В дереве конфигураций разверните элемент **Модель для изучения источников данных JOIN** и другие элементы модели (когда это возможно).
6. Просмотрите список конфигураций ER в дереве, а также сведения о версии на экспресс-вкладке **версии** — они будут использоваться в качестве источника данных для образца отчета.

    ![Страница конфигураций электронной отчетности.](./media/GER-JoinDS-ConfigurationsTree.PNG)

### <a name="turn-on-execution-trace-options"></a>Включить параметры трассировки выполнения

1. Выбрать **КОНФИГУРАЦИИ**.
2. Выбор **Параметры пользователя**.
3. Задайте параметры трассировки выполнения, как показано на снимке экрана ниже.

    ![Страница параметров пользователя электронной отчетности.](./media/GER-JoinDS-Parameters.PNG)

    Если эти параметры включены, то при каждом выполнении импортированного файла формата ER будет создана трассировка выполнения. Используя подробные сведения о созданной трассировке выполнения, можно анализировать выполнение формата ER и компонентов сопоставления модели ER. Посетите страницу [Трассировка выполнения формата ER для устранения проблем с производительностью](trace-execution-er-troubleshoot-perf.md) для получения дополнительной информации о функции трассировки выполнения ER.

### <a name="review-er-model-mapping-part-1"></a>Проверка сопоставления модели ER (часть 1)

Проверьте настройки компонента сопоставления модели ER. Компонент настроен для доступа к информации о версиях ER, сведениях о конфигурациях и поставщиках конфигурации без использования источников данных типа **соединения**.

1. Выберите конфигурацию **Сопоставление для изучения источников данных JOIN**.
2. Выберите **конструктор**, чтобы открыть список сопоставлений.
3. Выберите **конструктор**, чтобы просмотреть сведения о сопоставлении.
4. Выберите **Показать сведения**.
5. В дереве конфигураций разверните элементы модели данных **Set1** и **Set1.Details**:

    1. Привязка **Details: Record list = Versions** указывает, что элемент **Set1.Details** привязан к источникам данных **версии**, возвращающим записи таблицы **ERSolutionVersionTable**. Каждая запись в этой таблице представляет отдельную версию конфигурации ER. Содержимое этой таблицы представлено на экспресс-вкладке **Версии** на странице **конфигурации**.
    2. Привязка **ConfigurationVersion: String = @.PublicVersionNumber** означает, что значение в открытой версии каждой конфигурации ER берется из поля **PublicVersionNumber** таблицы **ERSolutionVersionTable** и размещается в элементе **ConfigurationVersion**.
    3. Привязка **ConfigurationTitle: String = @.'>Relations'.Solution.Name** указывает, что имя конфигурации ER берется из поля **Имя** таблицы **ERSolutionTable**, используя отношение многие к одному (**'>Relations'**) между таблицами **ERSolutionVersionTable** и **ERSolutionTable**. Имена конфигураций ER текущего экземпляра приложения представлены в дереве конфигураций на странице **конфигурации**.
    4. Привязка **@.'>Relations'.Solution.'>Relations'.SolutionVendor.Name** означает, что имя поставщика конфигурации, которому принадлежит текущая конфигурация, берется из поля **Имя** таблицы **ERVendorTable**, используя отношение многие к одному между таблицами **ERSolutionTable** и **ERVendorTable**. Имена поставщиков конфигураций ER представлены в дереве конфигураций на странице **конфигурации** в заголовке страницы для каждой конфигурации. Полный список поставщиков конфигураций ER можно найти на странице таблицы **Администрирование организации \> Электронная отчетность \> Поставщик конфигурации**.

    ![Страница конструктора сопоставления модели ER, список привязанных элементов модели данных.](./media/GER-JoinDS-Set1Review.PNG)

6. В дереве конфигураций разверните элемент модели данных **Set1.Summary**:

    1. Привязка **VersionsNumber: Integer = VersionsSummary.aggregated.VersionsNumber** указывает, что элемент **Set1.Summary.VersionsNumber** связан с полем агрегирования **VersionsNumber** источника данных **VersionsSummary** типа **GroupBy**, который был настроен на возврат количества записей таблицы **ERSolutionVersionTable** через источник данных **версии**.

    ![Изменение страницы параметров "Группирование по".](./media/GER-JoinDS-Set1GroupByReview.PNG)

7. Закройте страницу.

### <a name="review-er-model-mapping-part-2"></a><a name="review"></a> Проверка сопоставления модели ER (часть 2)

Проверьте настройки компонента сопоставления модели ER. Компонент настроен для доступа к информации о версиях ER, сведениях о конфигурациях и поставщиках конфигурации с использованием источника данных типа **соединения**.

1. В дереве конфигураций разверните элементы модели данных **Set2** и **Set2.Details**. Привязка **Details: Record list = Details** указывает, что элемент **Set2.Details** привязан к источнику данных **Сведения**, настроенному в качестве источника данных типа **соединения**.

    ![Страница конструктора сопоставления модели ER с расширенными элементами модели данных Set2:Record.](./media/GER-JoinDS-Set2Review.PNG)

    Источник данных **соединения** можно добавить, выбрав источник данных **Функции\Соединение**:

    ![Страница конструктора сопоставления модели ER, тип источника данных join.](./media/GER-JoinDS-AddJoinDS.PNG)

2. Выберите источник данных **Сведения**.
3. Выберите **Правка** в области **источники данных**.
4. Выберите **Редактировать соединение**.
5. Выберите **Показать сведения**.

    ![Страница "Параметры источника данных JOIN".](./media/GER-JoinDS-JoinDSEditor.PNG)

    Эта страница используется для разработки необходимого источника данных **типа соединения**. Во время выполнения этот источник данных создаст отдельный объединенный список записей из источников данных в сетке **соединенный список**. Соединение записей будет начато из источника данных **ConfigurationProviders**, который находится в сетке в качестве первого (для него должен быть указан столбец **Тип**). Записи всех других источников данных будут присоединены к записям родительского источника данных в зависимости от его порядка в этой сетке. Все соединяемые источники данных должны быть настроены как источник данных, вложенный в целевой источник данных (источник данных `1Versions`, вложенный в `1Configurations`; источник данных `1Configurations` вложен в **ConfigurationProviders**). Каждый настроенный источник данных должен содержать условия для соединения. В источнике данных для данного конкретного **соединения** определены следующие соединения:

    - Каждая запись источника данных **ConfigurationProviders** (указанная в таблице **ERVendorTable**) объединяется только с записями **1Configurations** (указанная в таблице **ERSolutionTable**), имеющая одинаковое значение в полях **SolutionVendor** и **RecId**. Тип **внутреннего соединения** используется для данного соединения, а также следующие условия для сопоставления записей:

    ФИЛЬТР (Конфигурации, Configurations.SolutionVendor = ConfigurationProviders.RecId)

    - Каждая запись источника данных **1Configurations** (указанная в таблице **ERSolutionTable**) объединяется только с записями **1Versions** (указанная в таблице **ERSolutionVersionTable**), имеющая одинаковое значение в полях **Solution** и **RecId**. Тип **внутреннего соединения** используется для данного соединения, а также следующие условия для сопоставления записей:

    ФИЛЬТР (ConfigurationVersions, ConfigurationVersions.Solution = ConfigurationProviders.'1Configurations'.RecId)

    - Параметр **Выполнить** настроен как **запрос**, то есть этот источник данных соединения будет выполняться во время выполнения на уровне базы данных как прямой вызов SQL.

    Для объединения записей источников данных, представляющих таблицы приложений, можно указать условия соединения, используя пары полей, отличных от тех, которые описывают существующие в отношениях AOT между этими таблицами. Этот тип соединения можно настроить так, чтобы он выполнялся также на уровне базы данных.

6. Закройте страницу.
7. Выберите **Отмена**.
8. В дереве конфигураций разверните элемент модели данных **Set2.Summary**:

    - Привязка **VersionsNumber: Integer = DetailsSummary.aggregated.VersionsNumber** указывает, что элемент **Set2.Summary.VersionsNumber** связан с полем агрегирования **VersionsNumber** источника данных **DetailsSummary** типа **GroupBy**, который был настроен на возврат количества соединенных записей источника данных **Details** типа **соединения**.
    - Параметр местоположения **Выполнение** настроен как **запрос**, то есть этот источник данных **GroupBy** будет выполняться во время выполнения как прямой вызов SQL на уровне базы данных. Это поведение возможно из-за того, что базовый источник данных **Сведения** типа **соединения** настроен как выполненный на уровне базы данных.

    ![Страница "Параметры источника данных GROUPBY".](./media/GER-JoinDS-Set2GroupByReview.PNG)

9. Закройте страницу.
10. Выберите **Отмена**.

### <a name="execute-er-format"></a><a name="executeERformat"></a> Выполнение формата электронной отчетности

1. Получите доступ к Финансам или RCS во втором сеансе веб-браузера с использованием тех же учетных данных и компании, что и в первом сеансе.
2. Перейдите в раздел **Управление организацией \> Электронная отчетность \> Конфигурации**.
3. Разверните **Модель для изучения источников данных JOIN**.
4. Выберите конфигурацию **Формат для изучения источников данных JOIN**.
5. Выберите **Конструктор**.
6. Выберите **Показать сведения**.
7. Выберите **Сопоставление**.
8. Выберите **Развернуть/Свернуть**.

    Этот формат предназначен для заполнения созданного текстового файла новой строкой для каждой версии конфигурации ER (последовательность **версий**). Каждая созданная строка будет содержать имя поставщика конфигурации, который владеет текущей конфигурацией, именем конфигурации и версией конфигурации, разделенными точкой с запятой. Последняя строка созданного файла будет содержать число обнаруженных версий конфигураций ER (**сводная** последовательность).

    ![Страница конструктора формата ER, вкладка "Формат".](./media/GER-JoinDS-FormatReview.PNG)

    Источники данных **Дата** и **Сводка** используются для заполнения сведений о версии конфигурации создаваемого файла:

    - Данные из модели данных **Set1** используются при выборе **нет** для источника данных **селектор** во время выполнения на странице диалогового окна пользователя, если используется формат электронной отчетности.
    - Данные из модели данных **Set2** используются при выборе **Да** для источника данных **селектор** во время выполнения на странице диалогового окна пользователя.

    ![Страница конструктора формата ER, вкладка "Сопоставление".](./media/GER-JoinDS-FormatMappingReview.PNG)

9. Выберите **Выполнить**.
10. На странице диалогового окна выберите **нет** в поле **использовать источник данных JOIN**.
11. Нажмите **ОК**.
12. Просмотрите созданный файл.

    ![Параметры электронного отчета, созданный файл, не использует источник данных JOIN.](./media/GER-JoinDS-Set1Run.PNG)

#### <a name="analyze-er-format-execution-trace"></a>Анализ трассировки выполнения формата электронной отчетности

1. В первом сеансе финансов или RCS выберите **конструктор**.
2. Выберите **трассировка выполнения**.
3. В сетке **Трассировка производительности** выберите самую верхнюю запись последней трассировки выполнения в формате электронной отчетности, который использовался текущим компонентом сопоставления моделей.
4. Нажмите **ОК**.

    Статистика выполнения информирует вас о дублированных вызовах в таблицах приложения:

    - **ERSolutionTable** была вызвана столько раз, сколько имеется записей версий конфигурации в таблице **ERSolutionVersionTable**, в то время как количество таких вызовов может быть уменьшено в разы для повышения производительности.
    - **ERVendorTable** была вызвана дважды для каждой записи версии конфигурации, которая была обнаружена в таблице **ERSolutionVersionTable**, в то время как количество таких вызовов также может быть уменьшено.

    ![Статистика выполнения на странице конструктора сопоставления модели электронной отчетности.](./media/GER-JoinDS-Set1Run2.PNG)

5. Закройте страницу.

### <a name="execute-er-format"></a>Выполнение формата электронной отчетности

1. Перейдите на вкладку веб-браузера, используя второй сеанс финансов или RCS.
2. Выберите **Выполнить**.
3. На странице диалогового окна выберите **Да** в поле **использовать источник данных JOIN**.
4. Нажмите **ОК**.
5. Просмотрите созданный файл.

    ![Параметры электронного отчета, созданный файл, использует источник данных JOIN.](./media/GER-JoinDS-Set2Run.PNG)

#### <a name="analyze-er-format-execution-trace"></a><a name="analyze"></a> Анализ трассировки выполнения формата электронной отчетности

1. В первом сеансе финансов или RCS выберите **конструктор**.
2. Выберите **трассировка выполнения**.
3. В сетке **Трассировка производительности** выберите самую верхнюю запись, представляющую трассировку последнего выполнения в формате электронной отчетности, который использовался текущим компонентом сопоставления моделей.
4. Нажмите **ОК**.

    Статистические данные информируют о следующем:

    - База данных приложения вызывалась один раз для получения записей из таблиц **ERVendorTable**, **ERSolutionTable** и **ERSolutionVersionTable** для получения доступа к обязательным полям.

    ![Сведения статистики производительности страницы конструктора сопоставления модели электронной отчетности.](./media/GER-JoinDS-Set2Run2.PNG)

    - База данных приложения была вызвана один раз для расчета количества версий конфигурации с использованием соединений, настроенных в источнике данных **Сведения**.

    ![Страница конструктора сопоставления моделей ER, показывающая вызовы базы данных приложений.](./media/GER-JoinDS-Set2Run3.PNG)

## <a name="limitations"></a>Ограничения

Как можно увидеть из примера в этом разделе, источник данных **JOIN** может быть построен из нескольких источников данных, описывающих отдельные наборы данных с записями, которые в конечном итоге нужно объединить. Вы можете настроить эти источники данных с помощью встроенной в ER функцию [FILTER](er-functions-list-filter.md). При настройке источника данных так, чтобы он вызывался вне источника данных **JOIN**, можно использовать диапазоны компаний в качестве части условия для выбора данных. Исходная реализация источника данных **JOIN** не поддерживает источники данных этого типа. Например, при вызове источника данных с [FILTER](er-functions-list-filter.md) в области выполнения источника данных **FILTER**, если вызываемый источник данных содержит диапазоны компаний как часть условия выбора данных, возникает исключение.

В Microsoft Dynamics 365 Finance версии 10.0.12 (август 2020) можно использовать диапазоны компаний в качестве части условий выбора данных в источниках данных [FILTER](er-functions-list-filter.md), которые вызываются в области выполнения источника данных **JOIN**. Из-за ограничений в построителе [запросов](../dev-ref/xpp-library-objects.md#query-object-model) приложений диапазоны компаний поддерживаются только для первого источника данных **JOIN**.

### <a name="example"></a>Пример

Например, вам нужно выполнить единый вызов базы данных приложения, чтобы получить список проводок по внешней торговле нескольких компаний и данные о складской номенклатуре, указанной в этих проводках.

В этом случае вы настраиваете в сопоставлении моделей ER следующие артефакты:

- Корневой источник данных **Интрастат**, представляющий таблицу **Интрастат**.
- Корневой источник данных **Номенклатуры**, представляющий таблицу **InventTable**.
- Корневой источник данных **Компании**, который возвращает список компаний (в этом примере **DEMF** и **GBSI**) с нужными проводками. Код компании доступен в поле **Companies.Code**.
- Корневой источник данных **X1** с выражением `FILTER (Intrastat, VALUEIN(Intrastat.dataAreaId, Companies, Companies.Code))`. В качестве части условия для выбора данных это выражение содержит определение диапазонов компаний `VALUEIN(Intrastat.dataAreaId, Companies, Companies.Code)`.
- Источник данных **X2** в качестве вложенного элемента в источник данных **X1**. Он включает выражение `FILTER (Items, Items.ItemId = X1.ItemId)`.

Наконец, вы можете настроить источник данных **JOIN**, где **X1** — это первый источник данных, а **X2** — второй источник данных. Вы можете указать **Запрос** в качестве параметра **выполнения**, чтобы ER выполняла этот источник данных на уровне базы данных как прямой вызов SQL.

При запуске настроенного источника данных во время [трассировки](trace-execution-er-troubleshoot-perf.md) выполнения ER в в конструкторе сопоставления моделей ER отображается следующая инструкция (как часть трассировки производительности ER).

`SELECT ... FROM INTRASTAT T1 CROSS JOIN INVENTTABLE T2 WHERE ((T1.PARTITION=?) AND (T1.DATAAREAID IN (N'DEMF',N'GBSI') )) AND ((T2.PARTITION=?) AND (T2.ITEMID=T1.ITEMID AND (T2.DATAAREAID = T1.DATAAREAID) AND (T2.PARTITION = T1.PARTITION))) ORDER BY T1.DISPATCHID,T1.SEQNUM`

> [!NOTE]
> Если запустить источник данных **JOIN**, который был настроен таким образом, чтобы он содержал условия выбора данных, которые содержат диапазоны компаний для дополнительных источников данных выполняемого источника данных **JOIN**, произойдет ошибка.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Конструктор формул в электронной отчетности](general-electronic-reporting-formula-designer.md)

[Трассировка выполнения формата электронной отчетности для устранения проблем с производительностью](trace-execution-er-troubleshoot-perf.md)


[!INCLUDE[footer-include](../../../includes/footer-banner.md)]
