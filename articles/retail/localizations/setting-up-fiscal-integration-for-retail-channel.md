---
title: Настройка финансовой интеграции для каналов розничной торговли
description: В этом разделе приводятся инструкции по настройке функции финансовой интеграции для каналов розничной торговли.
author: josaw
manager: annbe
ms.date: 02/01/2019
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
ms.search.form: RetailFunctionalityProfile, RetailFormLayout, RetailParameters
audience: Application User
ms.reviewer: josaw
ms.search.scope: Core, Operations, Retail
ms.search.region: Global
ms.search.industry: Retail
ms.author: v-kikozl
ms.search.validFrom: 2018-11-1
ms.dyn365.ops.version: 8.1.1
ms.openlocfilehash: 685340141ed35f4a2b57742328c69d3bbf9a73d2
ms.sourcegitcommit: 70aeb93612ccd45ee88c605a1a4b87c469e3ff57
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/01/2019
ms.locfileid: "773335"
---
# <a name="set-up-the-fiscal-integration-for-retail-channels"></a>Настройка финансовой интеграции для каналов розничной торговли

[!include [banner](../includes/banner.md)]

## <a name="introduction"></a>Введение

В этом разделе приводятся инструкции по настройке функции финансовой интеграции для каналов розничной торговли. Дополнительные сведения о финансовой интеграции см. в разделе [Обзор финансовой интеграции для каналов розничной торговли](fiscal-integration-for-retail-channel.md).

Процесс настройки финансовой интеграции включает следующие задачи:

1. Настройка финансовых соединителей, представляющих финансовые устройства или службы, которые используются для целей финансовой регистрации, например финансовые принтеры.
2. Настройка поставщиков документов, создающих финансовые документы, которые будут регистрироваться в финансовых устройствах или службах с помощью финансовых соединителей.
3. Настройка процесса финансовой регистрации, определяющего последовательность шагов финансовой регистрации, и финансовых соединителей и поставщиков финансовых документов, используются для каждого шага.
4. Назначение процесса финансовой регистрации профилям функциональности POS.
5. Назначение технических профилей соединителей профилям оборудования.

## <a name="set-up-a-fiscal-registration-process"></a>Настройка процесса финансовой регистрации

Прежде чем использовать функцию финансовой интеграции, следует настроить следующие параметры.

1. Обновите параметры розничной торговли.

    1. На странице **Общие параметры розничной торговли** на вкладке **Общие сведения** задайте для параметра **Включить финансовую интеграцию** значение **Да**. На вкладке **Номерные серии** определите номерные серии для следующих ссылок:

        - Номер финансового технического профиля
        - Номер группы финансовых соединителей
        - Номер процесса регистрации

    2. На странице **Параметры розничной торговли** определите номерную серию для номера финансового функционального профиля.

    > [!NOTE]
    > Номерные серии являются необязательными. Номера для всех сущностей финансовой интеграции могут создаваться из номерных серий или вручную.

2. Отправьте конфигурации финансовых соединителей и поставщиков финансовых документов.

    Поставщик фискальных документов отвечает за создание финансовых документов, представляющих проводки по розничной торговле и событиям, которые зарегистрированы в POS, в формате, который также используется для взаимодействия с финансовым устройством или службой. Например, поставщик финансовых документов может создать представление финансового чека в формате XML.
    
    Финансовый соединитель несет ответственность за связь с финансовым устройством или службой. Например, финансовый соединитель может отправить финансовый чек, созданный поставщиком финансовых документов в формате XML, на финансовый принтер. Дополнительную информацию о компонентах финансовой интеграции см. в разделе [Примеры процесса финансовой регистрации и финансовой интеграции для финансовых устройств](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices).

    1. На странице **Финансовые соединители** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Финансовые соединители**) отправьте конфигурацию XML для каждого устройства или службы, которые планируется использовать в целях финансовой интеграции.

        > [!TIP]
        > Выбрав **Просмотр**, можно просмотреть все функциональные и технические профили, относящиеся к текущему финансовому соединителю.

    2. На странице **Поставщики финансовых документов** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Поставщики финансовых документов**) отправьте конфигурацию XML для каждого устройства или службы, которые планируется использовать.

        > [!TIP]
        > Выбрав **Просмотр**, можно просмотреть все функциональные и технические профили, относящиеся к текущему поставщику финансовых документов.

    Примеры конфигураций финансовых соединителей и поставщиков финансовых документов см. в разделе [Примеры финансовой интеграции в пакете SDK Retail](fiscal-integration-for-retail-channel.md#fiscal-integration-samples-in-the-retail-sdk).

    > [!NOTE]
    > Сопоставление данных считается частью поставщика финансовых документов. Чтобы настроить сопоставления различных данных для одного соединителя (например, специфичных для государства правил), следует создать различных поставщиков финансовых документов.

3. Создайте функциональные профили соединителей и технические профили соединителей.

    1. На странице **Функциональные профили соединителей** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Функциональные профили соединителей**) создайте функциональный профиль соединителей для каждой комбинации финансового соединителя и поставщика финансовых документов, относящихся к этому финансовому соединителю.

        1. Выберите название соединителя.
        2. Выберите поставщика документов.

        Можно изменить параметры сопоставления данных в функциональном профиле соединителя. Чтобы восстановить параметры по умолчанию, определенные в конфигурации поставщика финансовых документов, выберите **Обновить**.

        **Примеры**
    
        |   | Форматировать | Пример |
        |---|--------|---------|
        | **Настройки ставок НДС** | значение : VATrate | 1 : 2000, 2 : 1800 |
        | **Сопоставление кодов НДС** | VATcode : значение | vat20 : 1, vat18 : 2 |
        | **Сопоставление типов платежных средств** | TenderType : значение | Наличные : 1, Карта : 2 |

        > [!NOTE]
        > Функциональные профили соединителя связаны с конкретной компанией. Если планируется использовать одно и то же сочетание финансового соединителя и поставщика финансовых документов в разных компаниях, вы должны создать функциональный профиль соединителя для каждой компании.

    2. На странице **Технические профили соединителя** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Технические профили соединителей**) создайте технический профиль соединителя для каждого финансового соединителя.

        1. Выберите название соединителя.
        2. Выберите тип соединителя. Для устройств, подключенных к станции оборудования Hardware Station, выберите **Локальный**.

            > [!NOTE]
            > В настоящее время поддерживаются только локальные соединители.

        Параметры на вкладках **Устройство** и **Параметры** в техническом профиле соединителя можно изменить. Чтобы восстановить параметры по умолчанию, определенные в конфигурации финансового соединителя, выберите **Обновить**. Во время загрузки новой версии XML-конфигурации вы получите сообщение о том, что текущий финансовый соединитель или поставщик финансовых документов уже используется. Эта процедура не переопределяет изменения, которые ранее были вручную внесены в функциональные профили соединителей и технические профили соединителей. Чтобы применить набор параметров по умолчанию из новой конфигурации, на странице **Функциональные профили соединителей** или **Технические профили соединителей** выберите **Обновить**.

4. Создайте группы финансовых соединителей.

    Группа финансовых соединителей объединяет функциональные профили финансовых соединителей, которые выполняют одинаковые функции и используются на одном шаге в процессе финансовой регистрации. Например, если несколько моделей финансовых принтеров может использоваться в магазине розничной торговли, финансовые соединители для этих финансовых принтеров могут быть объединены в группу финансовых соединителей.
    
    1. На странице **Группа финансовых соединителей** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**) создайте новую группу финансовых соединителей.
    2. Добавление функциональных профилей в группу соединителей. На вкладке **Функциональные профили** выберите **Добавить** и выберите номер профиля. Каждый финансовый соединитель в группе соединителей может иметь только один функциональный профиль.
    3. Чтобы приостановить использование функционального профиля, задайте для параметра **Отключить** значение **Да**. Это изменение затрагивает только текущую группу соединителей. Можно продолжить использовать этот же функциональный профиль в других группах соединителей.

5. Создайте процесс финансовой регистрации.

    Процесс финансовой регистрации определяется последовательностью шагов регистрации и группой соединителей, которые используются на каждом шаге.
    
    1. На странице **Процесс финансовой регистрации** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**) создайте новую запись для каждого уникального процесса финансовой регистрации.
    2. Добавьте шаги регистрации в процесс:

        1. Выберите **Добавить**.
        2. Выберите тип финансового соединителя.
        3. В поле **Номер группы** выберите соответствующую группу финансовых соединителей.

6. Назначьте сущности процесса финансовой регистрации профилям POS.

    1. На странице **Профили функциональности POS** (**Розничная торговля \> Настройка канала \> Настройка POS \> Профили POS \> Профили функциональности**) назначьте процесс финансовой регистрации профилю функциональности POS. Выберите **Изменить**, затем на вкладке **Процесс финансовой регистрации** в поле **Номер процесса** выберите процесс.
    2. На странице **Профиль оборудования POS** (**Розничная торговля \> Настройка канала \> Настройка POS \> Профили POS \> Профили оборудования**) назначьте технические профили соединителей профилю оборудования. Выберите **Изменить**, добавьте строку на вкладке **Фискальная периферия**, затем в поле **Номер профиля** выберите технический профиль соединителя.

    > [!NOTE]
    > Можно добавить несколько технических профилей к одному профилю оборудования. Тем не менее профиль оборудования или профиль функциональности POS должен иметь только одно пересечение с любой из групп финансовых соединителей.

    Поток финансовой регистрации определяется процессом финансовой регистрации, а также некоторыми параметрами компонентов финансовой интеграции: расширение среды выполнения Commerce Runtime для поставщика финансовых документов и расширение Hardware Station для финансового соединителя.

    - Подписка событий и проводок на финансовую регистрацию заранее определена в поставщике финансовых документов.
    - Поставщик фискальных документов также отвечает за определение финансового соединителя, используемого для финансовой регистрации. Он сопоставляет функциональные профили соединителей, которые включаются в группу финансовых соединителей, указанную для текущего этапа процесса финансовой регистрации с техническим профилем соединителя, назначенного профилю оборудования станции Hardware Station, с которой сопряжен POS-терминал.
    - Поставщик фискальных документов использует параметры сопоставления данных из конфигурации поставщика фискальных документов для преобразования данных проводок/событий, таких как налоги и платежи, во время создания финансового документа.
    - Когда поставщик фискальных документов создает фискальный документ, финансовый соединитель может отправить его на финансовое устройство без изменений или проанализировать его и преобразовать в последовательность команд API-интерфейса устройства в зависимости от того, как обрабатывается связь.

7. На странице **Процесс финансовой регистрации** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**) выберите **Проверить**, чтобы проверить процесс финансовой регистрации.

    Рекомендуется запускать этот тип проверки в следующих случаях:
    
    - После завершения всех настроек для нового процесса регистрации, включая назначение процессов регистрации профилям функциональности POS и профилям оборудования.
    - После внесения изменений в существующий процесс финансовой регистрации, если эти изменения могут привести к выбору другого финансового соединителя во время выполнения (например, при изменении группы соединителей для шага процесса финансовой регистрации, включения функционального профиля соединителей в группу соединителей или добавление нового функционального профиля соединителей в группу соединителей).
    - После внесения изменений в назначение технических профилей соединителей профилям оборудования.

8. На странице **Планировщик распределения** запустите задания **1070** и **1090** для передачи данных в базу данных канала.

## <a name="set-up-fiscal-texts-for-discounts"></a>Настройка финансовых текстов для скидок

В некоторых случаях специальный текст необходимо печатать на финансовом чеке, если применяется скидка. Финансовые тексты для скидок можно настроить на странице **Группа финансовых соединителей** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Группы финансовых соединителей**).

- Для ручных скидок, которые применяются на POS, следует настроить финансовый текст для информационного кода или группы информационных кодов, которая указана в качестве информационного кода **Скидка для продукта** в профиле функциональности POS.

    1. На странице **Группа финансовых соединителей** выберите **Текст для фискального чека**.
    2. На вкладке **Информационные коды** выберите **Добавить** и выберите информационный код или группу информационных кодов.
    3. В поле **Номер инфокода** выберите значение.
    4. В поле **Номер дополнительного кода** выберите значение, если дополнительный код необходим для выбранного информационного кода.
    5. В поле **Текст для фискального чека** укажите финансовый текст, который следует печатать на фискальном чеке.
    6. Задайте для параметра **Печатать данные, введенные пользователем, на фискальном чеке** значение **Да**, чтобы заменить текст на фискальном чеке данными, которые пользователь вводит вручную в POS. Этот параметр применяется только к информационным кодам с типом ввода **Текст**.

    > [!NOTE]
    > Можно указать финансовый текст для нескольких информационных кодов для поддержки сценариев, где используются группы информационных кодов, связанные информационные коды и запущенные информационные коды. В этих сценариях фискальный чек будет содержать финансовые тексты из всех информационных кодов, которые связаны со строкой проводки, в которой были применены скидки.

- Для скидок, относящихся к конкретному каналу, следует определить финансовый текст для кода скидки.

    1. На странице **Группа финансовых соединителей** выберите **Текст для фискального чека**.
    2. На вкладке **Скидки** выберите **Добавить** и выберите код скидки.
    3. В поле **Текст для фискального чека** укажите финансовый текст, который следует печатать на фискальном чеке.

    > [!NOTE]
    > Если несколько скидок применены к одной и той же строке проводки, финансовый чек будет содержать финансовые тексты из всех скидок, которые связаны с этой строкой проводки.

## <a name="set-error-handling-settings"></a>Задание параметров обработки ошибок

Параметры обработки ошибок, доступные в финансовом интеграции, устанавливаются в процессе финансовой регистрации. Дополнительные сведения об обработке ошибок в финансовой интеграции см. в разделе [Обработка ошибок](fiscal-integration-for-retail-channel.md#error-handling).

1. На странице **Процесс финансовой регистрации** (**Розничная торговля \> Настройка канала \> Финансовая интеграция \> Процессы финансовой регистрации**) можно настроить следующие параметры для каждого шага процесса финансовой регистрации.

    - **Разрешить пропуск** — этот параметр включает параметр **Пропустить** в диалоговом окне обработки ошибок.
    - **Разрешить помечать как зарегистрированное** — этот параметр включает параметр **Пометить как зарегистрированный** в диалоговом окне обработки ошибок.

2. Параметры **Пропустить** и **Пометить как зарегистрированный** в диалоговом окне обработки ошибок требуют разрешения **Разрешить пропуск или пометку как зарегистрированный**. Поэтому на странице **Группы разрешений** (**Розничная торговля \> Сотрудники \> Группы разрешений**) включите разрешение **Разрешить пропуск или пометку как зарегистрированный**.
3. Параметры **Пропустить** и **Пометить как зарегистрированный** позволяют оператором вводить дополнительную информацию при сбое финансовой регистрации. Чтобы эта функциональная возможность стала доступна, следует указать информационные коды **Пропустить** и **Пометить как зарегистрированный** в группе финансовых соединителей. Вводимая операторами информация затем сохраняется как проводка информационного кода, которая связана с финансовой проводкой. Более подробные сведения об информационных кодах см. в разделе [Информационные коды и группы информационных кодов](../info-codes-retail.md).

    > [!NOTE]
    > Функция запуска **Продукт** не поддерживается для информационных кодов, которые используются для кодов **Пропустить** и **Пометить как зарегистрированный** в группах финансовых соединителей.

    - На странице **Группа финансовых соединителей** на вкладке **Инфокоды** выберите информационные коды или группы информационных кодов в полях **Пропустить** и **Пометить как зарегистрированный**.

    > [!NOTE]
    > Один финансовый документ и один нефинансовый документ могут быть созданы на любом этапе процесса финансовой регистрации. Расширение поставщика фискального документа определяет каждый тип проводки или события как связанный с финансовыми или нефинансовыми документами. Функция обработки ошибок применяется только для финансовых документов.
    >
    > - **Финансовый документ** — обязательный документ, который должен быть зарегистрирован успешно (например, фискальный чек).
    > - **Нефинансовый документ** — дополнительный документ для проводки или события (например, бланк подарочной карты).

## <a name="set-up-fiscal-xz-reports-from-the-pos"></a>Настройка финансовых отчетов X/Z на POS

Чтобы включить финансовые отчеты X/Z для запуска с POS, следует добавить новые кнопки в макет POS.

- На странице **Сетка кнопок** следуйте указаниям из раздела [Добавление пользовательских кнопок операций в макет POS в Retail Headquarters](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters) для установки конструктора и обновления макета POS.

    1. Выберите макет для обновления. 
    2. Добавьте новую кнопку и установите свойство кнопки **Печать фискального X-отчета**.
    3. Добавьте новую кнопку и установите свойство кнопки **Печать фискального Z-отчета**.
    4. На странице **График распределения** запустите задание **1090** для передачи изменений в базу данных канала.

